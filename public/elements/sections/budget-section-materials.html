<link rel="import" href="../budget-components/budget-material-list-item.html" />

<dom-module id="budget-section-materials">
  <style>
    .card {
      padding: 15px;
      margin: 15px;
      box-shadow: 0 0 8px #ccc;
    }
    @media(max-width: 768px) {
      .card {
        padding: 5px;
        margin: 5px 0px;
      }
    }

    #warningMessage {
      display : none;
      border-bottom: 1px solid #ffc599;
      padding: 20px 10px;
      text-align: center;
      background-color: #f8f8f8;
    }
    #errorMessage {
      display : none;
      border-bottom: 1px solid #e51c23;
      padding: 20px 10px;
      text-align: center;
      background-color: #f8f8f8;
    }
  </style>

  <template>

    <div id="warningMessage" class="text text-warning">
      <div style="padding: 10px"><i class="fa fa-warning"></i> Warning, you have unsaved changes to your materials.</div>
      <span id="unsavedFilterOuter"><input type="checkbox" id="unsavedFilter" on-click="filter" /> Only Show Unsaved Materials</span>
      <a class="btn btn-link" on-click="undo">Revert All Changes</a>
    </div>

    <div id="errorMessage" class="text text-danger">
      <div style="padding: 10px"><i class="fa fa-warning"></i> Warning, <span id="errorCount"></span> of your materials have errors.</div>
      <span id="errorFilterOuter"><input type="checkbox" id="errorFilter" on-click="filterErrors" /> Only Show Materials With Errors</span>
    </div>

    <h4 class="page-header">
      <div class="btn-group pull-right" style="margin-top:-10px" role="group">
        <a class="btn btn-primary" href="#material/create"><i class="fa fa-plus"></i> Create</a>
        <a class="btn btn-primary" href="#material/search"><i class="fa fa-search"></i> Find</a>
      </div>

      <i class="fa fa-cube"></i> Budget Materials List
    </h4>

    <div class="help-block">
      Below is a list of all materials currently available for this budget.  You can
      find and add materials to this budget using the 'Find' button or create a new material
      using the 'Create' button.
    </div>


    <div class="row">
      <div class="col-md-10 col-md-offset-1">

        <div class="form-horizontal" style="margin: 25px 0">
          <div class="form-group">
            <label for="filterInput" class="col-sm-2 control-label">Filter</label>
            <div class="col-sm-10">
              <input type="text" class="form-control" id="filterInput" placeholder="Filter By Name" on-input="filter">
            </div>
          </div>
          <div class="form-group">
            <label for="sortInput" class="col-sm-2 control-label">Sort</label>
            <div class="col-sm-10">
              <select type="text" class="form-control" id="sortInput" on-change="filter">
                <option value="name" selected>Name</option>
                <option value="type">Type</option>
                <option value="authority">Authority</option>
                <option value="price">Price</option>
              </select>
            </div>
          </div>
        </div>

        <budget-material-table id="table" on-error-update="onErrorUpdate"></budget-material-table>

        <div id="searchMsg"></div>

      </div>
    </div>

  </template>
</dom-module>

<script>
  Polymer({
    is : 'budget-section-materials',

    ready : function() {
      this.filterTimer = -1;
      this.updateTimer = -1;
      SDK.controllers.material.on('material-update', this.onMaterialsUpdated.bind(this));
      SDK.controllers.operation.on('material-added', this.onMaterialAdded.bind(this));
      SDK.controllers.material.on('material-removed', function(e) {
        this.$.table.onMaterialsUpdated();
        $(this.$.root).find('[material="'+e.material.name+'"]').remove();
        this.filter();
      }.bind(this));

      SDK.changes.on('material-state-update', this.onSaveStateUpdate.bind(this));
    },

    onSaveStateUpdate : function(e) {
      if( e.changes ) {
        this.$.warningMessage.style.display = 'block';
        this.$.unsavedFilterOuter.style.display = 'inline-block';
      } else {
        this.$.unsavedFilter.checked = false;
        this.$.warningMessage.style.display = 'none';
        this.$.unsavedFilterOuter.style.display = 'none';

        // make sure we are not filtering to unsaved if there are no unsaved
        this.filter();
      }
    },

    onMaterialAdded : function(e) {
      this.$.table.onMaterialsUpdated();
    },

    onMaterialsUpdated : function(e) {
      this.$.table.onMaterialsUpdated();
    },

    setData : function() {
      var materials = SDK.controllers.material.get();
      this.$.table.update(materials);
      this._filter();
    },

    onShow : function(params) {
      //if( params.length > 0 ) {
      //  this.$.filterInput.value = decodeURIComponent(params.join('/'));
      //}

      this._filter();
    },

    filter : function() {
      if( this.filterTimer != -1 ) clearTimeout(this.filterTimer);
      this.filterTimer = setTimeout(function(){
        this.filterTimer = -1;
        this._filter();
      }.bind(this));
    },

    _filter : function() {
      var txt = this.$.filterInput.value;

      var matched = this.$.table.setFiltersAndSort(txt, this.$.sortInput.value);


      if( matched == 0 && txt.length > 0 ) {
        this.$.searchMsg.innerHTML = '<div class="alert alert-warning">No results found for: '+txt +
        '.<div style="text-align:center"><a href="#material/create/'+encodeURIComponent(txt)+'"><i class="fa fa-plus"></i> Create "'+txt+'"</a>&nbsp;&nbsp;|&nbsp;&nbsp;'+
        '<a href="#material/search/'+encodeURIComponent(txt)+'"><i class="fa fa-search"></i> Find "'+txt+'"</a>'+
        '</div></div>';
      } else {
        this.$.searchMsg.innerHTML = '';
      }
    },

    onErrorUpdate : function(e) {
      var errors = e.detail;
      if( errors === 0 ) {
        this.$.errorMessage.style.display = 'none';
      } else {
        this.$.errorMessage.style.display = 'block';
      }
      this.$.errorCount.innerHTML = errors;
    },

    filterErrors : function(e) {
      this.$.filterInput.value = '';
      this.$.table.filterErrors($(e.currentTarget).is(':checked'));
    }
  });
</script>
