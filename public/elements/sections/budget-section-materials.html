<link rel="import" href="../budget-components/budget-material-list-item.html" />

<dom-module id="budget-section-materials">
  <style>
    .card {
      padding: 15px;
      margin: 15px;
      box-shadow: 0 0 8px #ccc;
    }
    @media(max-width: 768px) {
      .card {
        padding: 5px;
        margin: 5px 0px;
      }
    }

    #warningMessage {
      display : none;
      border-bottom: 1px solid #ffc599;
      padding: 20px 10px;
      text-align: center;
      background-color: #f8f8f8;
    }
    #errorMessage {
      display : none;
      border-bottom: 1px solid #e51c23;
      padding: 20px 10px;
      text-align: center;
      background-color: #f8f8f8;
    }
  </style>

  <template>

    <div id="warningMessage" class="text text-warning">
      <div style="padding: 10px"><i class="fa fa-warning"></i> Warning, you have unsaved changes to your materials.</div>
      <span id="unsavedFilterOuter"><input type="checkbox" id="unsavedFilter" on-click="filter" /> Only Show Unsaved Materials</span>
      <a class="btn btn-link" on-click="undo">Revert All Changes</a>
    </div>

    <div id="errorMessage" class="text text-danger">
      <div style="padding: 10px"><i class="fa fa-warning"></i> Warning, <span id="errorCount"></span> of your materials have errors.</div>
      <span id="errorFilterOuter"><input type="checkbox" id="errorFilter" on-click="filter" /> Only Show Materials With Errors</span>
    </div>

    <h4 class="page-header">
      <div class="btn-group pull-right" style="margin-top:-10px" role="group">
        <a class="btn btn-primary" on-click="showCreate"><i class="fa fa-plus"></i> New</a>
        <a class="btn btn-primary" on-click="import"><i class="fa fa-cloud-download"></i> Import</a>
      </div>

      <i class="fa fa-cube"></i> Materials
    </h4>

    <div style="text-align: center; padding: 25px 0 15px 0">

    </div>



    <div class="row">
      <div class="col-md-10 col-md-offset-1">

        <div class="form-horizontal" style="margin: 25px 0">
          <div class="form-group">
            <label for="filterInput" class="col-sm-2 control-label">Filter</label>
            <div class="col-sm-10">
              <input type="text" class="form-control" id="filterInput" placeholder="Filter Text" on-input="filter">
              <a class="btn btn-link" on-click="showSimpleTable">Simple Material Table</a>
            </div>
          </div>
        </div>

        <div id="searchMsg"></div>
        <div id="root"></div>

      </div>
    </div>

    <budget-simple-material-popup id="simpleTable"></budget-simple-material-popup>
  </template>
</dom-module>

<script>
  Polymer({
    is : 'budget-section-materials',

    ready : function() {
      this.filterTimer = -1;
      this.updateTimer = -1;
      SDK.controllers.material.on('material-update', this.onMaterialsUpdated.bind(this));
      SDK.controllers.operation.on('material-added', this.onMaterialAdded.bind(this));
      SDK.controllers.material.on('material-removed', function(e) {
        $(this.$.root).find('[material="'+e.material.name+'"]').remove();
        this.filter();
      }.bind(this));

      SDK.changes.on('material-state-update', this.onSaveStateUpdate.bind(this));
    },

    attached : function() {
      this.popup = document.querySelector('budget-material-popup');
    },

    import : function() {
      document.querySelector('budget-import-material-popup').show();
    },

    onSaveStateUpdate : function(e) {
      if( e.changes ) {
        this.$.warningMessage.style.display = 'block';
        this.$.unsavedFilterOuter.style.display = 'inline-block';
      } else {
        this.$.unsavedFilter.checked = false;
        this.$.warningMessage.style.display = 'none';
        this.$.unsavedFilterOuter.style.display = 'none';

        // make sure we are not filtering to unsaved if there are no unsaved
        this.filter();
      }
    },

    onMaterialAdded : function(e) {
      this.updateMaterialPanel(e.material, false);
    },

    onMaterialsUpdated : function(e) {
      var all = SDK.controllers.material.get();

      for( var key in all ) {
        if( all[key].type === 'simple' && key === e.replaced || key === e.material.name ) {
          this.updateMaterialPanel(e.material.name, e.replaced);
          break;
        }

        if( all[key].type === 'complex' && SDK.controllers.material.contains(all[key], e.material.name, e.replaced) ) {
          var replaced = null;
          if( key === e.replaced ) {
            replaced = e.replaced;
          }
          this.updateMaterialPanel(key, replaced);
        }
      }

      this.filter();
    },

    updateMaterialPanel : function(name, replaced) {
      var current = $(this.$.root).find('[material-name="'+(replaced || name)+'"]');
      var div = $(this.createTable(name));

      if( current.length == 0 ) {
        $(this.$.root).append(div);
      } else {
        div.insertAfter(current);
        current.remove();
      }
    },

    setData : function(data) {
      this.$.root.innerHTML = '';
      this.data = data;

      this.$.root.innerHTML = '';

      var materials = SDK.controllers.material.get();
      for( var name in materials ) {
        var material = materials[name];
        var div = this.createTable(material);
        this.$.root.appendChild(div);
      }

      this._filter();
    },

    onShow : function(params) {
      if( params.length > 0 ) {
        this.$.filterInput.value = decodeURIComponent(params.join('/'));
      }

      this._filter();
    },

    showCreate : function() {
      this.popup.create();
    },

    filter : function() {
      if( this.filterTimer != -1 ) clearTimeout(this.filterTimer);
      this.filterTimer = setTimeout(function(){
        this.filterTimer = -1;
        this._filter();
      }.bind(this));
    },

    _filter : function() {
      var txt = this.$.filterInput.value;

      var matched = [], showAll = false;
      if( txt == '' && !$(this.$.thisBudgetInput).is(':checked') ) {
        showAll = true;
      } else {
        matched = this.toNameArray(SDK.controllers.material.find(txt));
      }

      var opEles = this.querySelectorAll('budget-material-list-item');
      var errorCount = 0;
      for( var i = 0; i < opEles.length; i++ ) {
        errorCount += opEles[i].errorCount;
      }

      if( errorCount > 0 ) {
        this.$.errorCount.innerHTML = errorCount;
        this.$.errorMessage.style.display = 'block';
      } else {
        this.$.errorFilter.checked = false;
        this.$.errorMessage.style.display = 'none';
      }

      var onlyUnsaved = $(this.$.unsavedFilter).is(':checked');
      var onlyErrors = $(this.$.errorFilter).is(':checked');

      for( var i = 0; i < opEles.length; i++ ) {
        var ele = opEles[i];
        if( showAll || matched.indexOf(ele.getAttribute('material-name')) > -1 ) {
          if( onlyUnsaved && !ele.hasAttribute('has-changes') ) {
            ele.style.display = 'none';
          } else if( onlyErrors && !ele.hasAttribute('has-errors') ) {
            ele.style.display = 'none';
          } else {
            ele.style.display = 'block';
          }
        } else {
          ele.style.display = 'none';
        }
      };

      if( matched.length == 0 && !showAll ) {
        this.$.searchMsg.innerHTML = '<div class="alert alert-warning">No results found for: '+txt +
        '. <a style="cursor: pointer"><i class="fa fa-plus"></i> Create</a></div>';

        $(this.$.searchMsg)
          .find('a')
          .on('click', function() {
            document.querySelector('budget-material-popup').create(txt);
          });
      } else {
        this.$.searchMsg.innerHTML = '';
      }

      this.fire('error-update', errorCount > 0 ? true : false);
    },

    toNameArray : function(materials) {
      var arr = [], include;
      var thisBudget = $(this.$.thisBudgetInput).is(':checked');

      if( thisBudget ) {
        include = SDK.utils.getActiveMaterials();
      }

      materials.forEach(function(material){
        if( thisBudget ) {
          if( include.indexOf(material.name) > -1 ) {
            arr.push(material.name);
          }
        } else {
          arr.push(material.name);
        }

      });
      return arr;
    },

    createTable : function(material) {
      if( typeof material === 'string' ) {
        material = SDK.controllers.material.get(material);

        if( material.error ) {
          console.log('Unabled to show material in list');
          console.log(material);
          return;
        }
      }

      var ele = document.createElement('budget-material-list-item');
      ele.material = material;
      ele.addEventListener('edit-material', function(){
        document.querySelector('budget-material-popup').edit(material);
      });

      return ele;
    },

    updateFromEvent : function(ele) {
      if( this.updateTimer != -1 ) clearTimeout(this.updateTimer);

      this.updateTimer = setTimeout(function(){
        this.updateTimer = -1;
        this._updateFromEvent(ele);
      }.bind(this), 300);
    },

    _updateFromEvent : function(ele) {
      var m = SDK.controllers.material.get(ele.attr('material-name'));

      if( m.error ) {
        return console.log('Error updating material');
      }


      m.price = parseFloat(ele.find('.material-price').val());
      m.units = ele.find('budget-unit-selector')[0].getUnits();

      SDK.controllers.material.add(m, {replace: true});
    },

    showReviewPopup : function() {
      if( !ExpressAuth.user ) {
        document.querySelector('budget-login-popup').show();
        return;
      }
      document.querySelector('budget-material-review-popup').show();
    },

    showSimpleTable : function() {
      this.$.simpleTable.show();
    },

    undo : function() {
      if( !confirm('Are you sure you want to discard your changes?') ) {
        return;
      }

      var budget = SDK.getBudget();
      SDK.budget.get(budget.id, function(resp){
        SDK.changes.setOriginal(budget, resp.materials);
        SDK.changes.setUnsaved({});
        window.localStorage.setItem('unsaved-materials', '{}');

        if( resp.error ) {
          return alert('Error reloading budget data: '+resp.message);
        }

        var data = {
          budget : budget,
          materials : resp.materials
        }

        document.querySelector('ahb-budget').load(data);
      }.bind(this));
    },
  });
</script>
