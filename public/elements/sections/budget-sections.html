<link rel="import" href="budget-section-overview.html" />
<link rel="import" href="budget-section-operations.html" />
<link rel="import" href="budget-section-materials.html" />
<link rel="import" href="budget-section-setup.html" />

<dom-module id="budget-sections">
  <style>
    .section {
      display : none;
    }
    .nav > li {
      display: table-cell;
      width: 1%;
    }
    .nav > li > a {
      border-radius: 0;
    }
    .dropdown-menu.dropdown-menu-right a {
      text-align: left !important;
    }
    #unsavedMessage {
      padding: 5px;
      position: fixed;
      bottom : 0;
      right : 0;
      background-color: white;
      border-radius: 3px 0 0 0;
      box-shadow: 0 0 10px #333;
      cursor: pointer;
    }
  </style>

  <template>
    <div class="layout horizontal center" style="border-bottom: 1px solid #ccc">
      <div>
        <h5>
          Farm Budgets <small>Advanced Hardwood Biofuels</small>
        </h5>
      </div>
      <div class="flex" style="padding:5px; min-width: 92px">
        <div class="btn-group" style="display:none; white-space:nowrap" id="saveBudgetBtn">
          <button type="button" class="btn btn-warning" on-click="save" id="saveBudgetBtnInner">
            <i class="fa fa-save"></i><span class="hidden-xs"> Save Budget Changes</span>
          </button>
          <button type="button" class="btn btn-warning dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            <span class="caret"></span>
            <span class="sr-only">Toggle Dropdown</span>
          </button>
          <ul class="dropdown-menu">
            <li id="saveBtn"><a on-click="save"><i class="fa fa-save"></i> Save</a></li>
            <li id="saveNewBtn"><a on-click="clone"><i class="fa fa-clone"></i> Save as New Budget</a></li>
            <li id="undoBtn"><a on-click="undo"><i class="fa fa-undo"></i> Discard All Changes</a></li>

            <li id="loginTopBtn" style="display:none"><a href="/login.html"><i class="fa fa-sign-in"></i> Login to Save Changes</a></li>
          </ul>
        </div>
      </div>
      <div style="padding:10px">
        <ahb-account-login></ahb-account-login>
      </div>
      <div>
        <div class="btn-group">
          <a class="btn btn-default dropdown-toggle" style="border:none;box-shadow:none" data-toggle="dropdown">
            <i class="fa fa-ellipsis-v"></i>
          </a>
          <ul class="dropdown-menu dropdown-menu-right">
            <li><a class="btn btn-link" on-click="find"><i class="fa fa-search"></i> Find Budget</a></li>
            <li><a class="btn btn-link" on-click="startNew"><i class="fa fa-plus-circle"></i> Start from Scratch</a></li>
            <li><a class="btn btn-link" on-click="clone"><i class="fa fa-clone"></i> Save as New Budget</a></li>
            <li><a class="btn btn-link" on-click="reference"><i class="fa fa-code-fork"></i> Create Reference Budget</a></li>
            <li><a class="btn btn-link" on-click="import"><i class="fa fa-cloud-download"></i> Import Material</a></li>
            <li id="signOutBtn" style="display:none"><a class="btn btn-link"><i class="fa fa-sign-out"></i> Sign Out</a></li>
            <li><a class="btn btn-link" href="https://github.com/CSTARS/farm-budgets-app/issues" target="_blank"><i class="fa fa-bug"></i> Report Bug/Issue</a></li>
           </ul>
        </div>

      </div>
    </div>

    <ul class="nav nav-tabs nav-justified" id="tabs">
      <li role="presentation" class="active" id="btn-overview">
        <a href="#budget/overview"><i class="fa fa-dashboard"></i> Overview</a>
      </li>
      <li role="presentation" id="btn-operations">
        <a href="#budget/operations"><i class="fa fa-cogs"></i> Operations</a>
      </li>
      <li role="presentation" id="btn-materials">
        <a href="#budget/materials">
          <i class="fa fa-warning text text-warning" id="unsavedWarning" style="display:none"></i>
          <i class="fa fa-warning text text-danger" id="errorWarning" style="display:none"></i>
          <i class="fa fa-cube"></i>
          Materials List
        </a>
      </li>
      <li role="presentation" id="btn-setup">
        <a href="#budget/setup"><i class="fa fa-sliders"></i> My Setup</a>
      </li>
    </ul>

    <budget-section-overview id="overview" class="section"></budget-section-overview>
    <budget-section-operations id="operations" class="section"></budget-section-operations>
    <budget-section-materials
      id="materials"
      class="section"
      on-unsaved-update="onUnsavedUpdate"
      on-error-update="onErrorUpdate">
    </budget-section-materials>
    <budget-section-setup id="setup" class="section"></budget-section-setup>

    <div id="unsavedMessage" class="text text-warning animated flipInX" on-click="scrollTop" style="displayNone">
      <i class="fa fa-warning"></i> You have unsaved changes.
    </div>
  </template>
</dom-module>

<script>
  Polymer({
    is : 'budget-sections',

    ready : function() {
      $(window).on('hashchange', this.setSection.bind(this));

      document.querySelector('ahb-budget').addEventListener('budget-loaded', this.checkForChanges.bind(this));
      document.querySelector('budget-farm-editor').addEventListener('editor-close', this.checkForChanges.bind(this));

      // TODO: shouldn't we only need to check material add/remove for a budget?
      FB.materialController.on('material-update', this.checkForChanges.bind(this));
      FB.materialController.on('material-removed', this.checkForChanges.bind(this));

      FB.operationController.on('operation-update', this.checkForChanges.bind(this));
      FB.operationController.on('operation-remove', this.checkForChanges.bind(this));

      FB.changes.on('budget-diff', this.onDiffCheckComplete.bind(this));

      if( ExpressAuth && ExpressAuth.user ) {
        this.$.signOutBtn.style.display = 'block';
        this.$.signOutBtn.firstChild.setAttribute('href', ExpressAuth.path+'/logout');
      }

      this.changesTimer = -1;
      this.setSection();
    },

    attached : function() {
      this.checkForChanges();

      if( !ExpressAuth.user ) {
        this.$.saveBtn.style.display = 'none';
        this.$.saveNewBtn.style.display = 'none';
        this.$.loginTopBtn.style.display = 'block';
      }
    },

    scrollTop : function() {
      $('html, body').animate({ scrollTop: '0px' });
    },

    onUnsavedUpdate : function(e) {
      if( e.detail === true ) {
        this.$.unsavedWarning.style.display = 'inline-block';
      } else {
        this.$.unsavedWarning.style.display = 'none';
      }
    },

    onErrorUpdate : function(e) {
      if( e.detail === true ) {
        this.$.errorWarning.style.display = 'inline-block';
      } else {
        this.$.errorWarning.style.display = 'none';
      }
    },

    checkForChanges : function() {
      if( this.changesTimer != -1 ) clearTimeout(this.changesTimer);
      this.changesTimer = setTimeout(function(){
        this.changesTimer = -1;
        this._checkForChanges();
      }.bind(this), 100);
    },

    _checkForChanges : function() {
      FB.changes.checkBudget(FB.getBudget(), FB.materialController.asArray());
    },

    onDiffCheckComplete : function(diff) {

      if( diff.budget.length > 0 || diff.materialIds.length > 0 ) {
        this.$.saveBudgetBtnInner.innerHTML = 'Save Budget Changes';
        this.$.saveBudgetBtnInner.removeAttribute('disabled');
        this.$.saveBudgetBtn.style.display = 'inline-block';
        this.$.unsavedMessage.style.display = 'block';
        this.$.overview.showChangesWarning(true);
        return true;
      }

      this.$.saveBudgetBtn.style.display = 'none';
      this.$.unsavedMessage.style.display = 'none';
      this.$.overview.showChangesWarning(false);
      return false;
    },

    save : function() {
      if( !ExpressAuth.user ) {
        document.querySelector('budget-login-popup').show();
        return;
      }

      this.$.saveBudgetBtnInner.innerHTML = 'Saving...';
      this.$.saveBudgetBtnInner.setAttribute('disabled', 'disabled');
      FB.saveBudget(function(resp){
        this.$.saveBudgetBtnInner.innerHTML = 'Save Budget Changes';
        this.$.saveBudgetBtnInner.removeAttribute('disabled');

        if( resp.error ) {
          alert(resp.message);
        } else {
          this.$.saveBudgetBtn.style.display = 'none';
          this.$.unsavedMessage.style.display = 'none';
        }
      }.bind(this));
    },

    find : function() {
      document.querySelector('find-budget-popup').show();
    },

    setSection : function() {
      var parts = window.location.hash.replace(/#/,'').split('/');

      if( parts[0].toLowerCase() === 'link' && parts.length > 1 ) {
        var budget = document.querySelector('ahb-budget');
        budget.loadedFromLink = true;
        budget.reload(parts[1]);
        window.location = '#budget/overview';
        return;
      }

      // TODO: remove later
      if( parts.length == 1 && parts[0] == '' ) {
        window.location = '#budget/overview';
      }

      if( parts[0] != 'budget' ) return;

      $(this).find('.section').hide();
      $(this.$.tabs).find('li').removeClass('active');

      var section;
      if( this.$[parts[1]] ) {
        section = this.$[parts[1]];
        $(this.$.tabs).find('#btn-'+parts[1]).addClass('active');
      } else {
        section = this.$.overview;
        $(this.$.tabs).find('#btn-overview').addClass('active');
      }

      section.style.display = 'block';
      if( section.onShow ) section.onShow(parts.splice(2, parts.length-1));
    },

    setData : function(data) {
      var sections = this.querySelectorAll('.section');
      for( var i = 0; i < sections.length; i++ ) {
        if( sections[i].setData ) sections[i].setData(data);
      }
    },

    import : function() {
      document.querySelector('budget-import-material-popup').show();
    },

    reference : function() {
      document.querySelector('budget-create-reference').show();
    },

    undo : function() {
      if( !confirm('Are you sure you want to discard your changes?') ) {
        return;
      }
      document.querySelector('ahb-budget').reload(FB.getBudget().id, true);
    },

    clone : function() {
      if( FB.changes.hasChanges() && !confirm('Are you sure you want to clone this budget and save as new?') ) return;

      var data = {
        budget : FB.getBudget(),
        materials : FB.materialController.asArray()
      }
      data.budget.name = '';
      data.budget.id = FB.utils.guid();

      window.location = '#budget/overview';

      document.querySelector('ahb-budget').load(data);
      document.querySelector('budget-farm-editor').show(true);
      this.$.overview.updateTotal();
    },

    startNew : function() {
      if( FB.changes.hasChanges() && !confirm('Are you sure you want to start a new budget?  Any unsaved changes will be lost.') ) return;
      document.querySelector('ahb-budget').createNew();
      document.querySelector('budget-farm-editor').show();
      this.$.overview.updateTotal();
    }
  });
</script>
