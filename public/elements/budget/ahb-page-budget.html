<link rel="import" href="../widgets/ahb-interval-selector.html" />
<link rel="import" href="../widgets/ahb-unit-selector.html" />

<dom-module id="ahb-page-budget">
  <style>
      tr {
          opacity: 1;
          background-color: white;

          transition: all linear 200ms;
          -webkit-transition: all linear 200ms;
          -moz-transition: all linear 200ms;
          -ms-transition: all linear 200ms;
      }
      tr[removing] {
          opacity: 0;
      }

      .total {
          border-top: 1px solid #ccc;
          text-align: right;
          padding-top: 10px;
          color: #333;
      }
      .grandTotal {
          border-top: 1px solid #888;
          text-align: right;
          padding-top: 10px;
          /*font-weight: bold;*/
      }
      .addItem {
          position:absolute;
          left:0;
          top:0;
          background-color: white;
          padding: 10px;
          margin: 3px;
          border: 1px solid #ccc;
          border-radius: 4px;
          box-shadow: 0 0 5px #ccc;
          z-index: 1000;
      }
      tr.hover:hover {
          background-color: #eee;
      }
      .addTable td, .addTable th {
          padding: 5px;
          vertical-align: middle;
      }
      table tr td, table th  {
          white-space: nowrap;
      }
      .arrowIcon {
          font-size:25px
      }

      .item-row {
        margin: 5px 0 0 20px;
      }

      @media(max-width: 768px) {
          h2 {
              font-size: 18px !important;
          }
          .arrowIcon {
              font-size: 18px
          }
          .item-row {
            margin: 5px 0 0 3px;
          }
      }

      .lineitem {
        padding: 10px;
        margin: 10px;
        border-bottom: 1px solid #ccc;
      }

      /*.input-nostyle {
        color: orange;
        border-left: none;
        border-right: none;
        border-bottom: 1px solid #ccc;
        border-top: none;
        margin: 3px;
      }

      .input-label {
        color: #555;
        padding: 3px 5px;
      }*/

      input {
        color: orange;
      }

      .btn.btn-link {
        color: #888;
      }

      .btn.btn-link:hover {
        color: #2196f3;
      }

      sub {
        font-size: 60%;
        color: #444;
      }
  </style>

  <template>
      <div style="padding:10px" id="noData">
          <h4><ahb-icon icon="fa-warning"></ahb-icon> Actions Required</h4>
          <p>Please select a location, crop and farm size first!  Then we can calculate your budget.</a>
      </div>

      <budget-interval-selector></budget-interval-selector>

      <div style="padding:10px;display:none" id="main">

        <div style="padding:10px;margin-bottom:10px;border-bottom:1px solid #ccc">
            <div class="layout horizontal">
                <div class="flex">
                  <h4>
                    <span>{{cropLabel}}</span>,
                    <span>{{cropLocality}}</span>
                  </h4>
                </div>
                <div>
                    <a class="btn btn-link" on-click="expandAll"><i class="fa fa-toggle-down"></i> Expand All</a>
                    <a class="btn btn-link" on-click="collapseAll"><i class="fa fa-toggle-right"></i> Collapse All</a>
                </div>
            </div>
        </div>

        <h4>Duration:
          <input
            type="number"
            on-input="recalc"
            value="{{duration::input}}"
            class="form-control"
            style="width:75px; display:inline-block"/>
            <small>Months</small>
        </h4>

        <template is="dom-repeat" items="{{phases}}" as="phase">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 style="margin: 5px 0">
                <a
                  class="btn btn-link phase-toggle"
                  on-click="togglePhase"
                  phase$="[[phase.name]]">
                    <i class="fa fa-arrow-right"></i>
                </a>
                <span>{{phase.name}}</span>
                <a class="btn btn-link" on-click="toggleAddPhase" phase$="[[phase.name]]"><i class="fa fa-plus"></i></a>

                <input
                  type="text"
                  style="display:none; font-size: 16px"
                  phase$="[[phase.name]]"
                  placeholder="New Operation Name"
                  on-keypress="newOppInputKeyPress" />

                <small class="pull-right" style="font-size: 20px"><ahb-dollar-label value="[[phase.total]]"></ahb-dollar-label>/<span>{{phase.units}}</span></small>
              </h3>
            </div>
            <div class="panel-body" phase$="[[phase.name]]" style="display:none">

              <template is="dom-repeat" items="{{phase.operations}}" as="operation">
                <h4 class="page-header" style="margin-bottom:0;padding:0">
                  <a
                    class="btn btn-link opp-toggle"
                    on-click="toggleOperation"
                    phase$="[[phase.name]]"
                    operation$="[[operation.name]]">
                      <i class="fa fa-arrow-right"></i>
                  </a>
                  <span>{{operation.name}}</span>
                  <a
                    class="btn btn-link"
                    on-click="addLineItem"
                    phase$="[[phase.name]]"
                    operation$="[[operation.name]]">
                      <i class="fa fa-plus"></i>
                  </a>
                </h4>

                <div class="operation-panel" phase$="[[phase.name]]" operation$="[[operation.name]]" style="display:none">
                  <template is="dom-repeat" items="{{operation.materials}}" as="material">
                    <div class="layout horizontal item-row">
                      <div>
                        <a
                          class="btn btn-link"
                          on-click="removeItem"
                          material$="[[material.name]]"
                          phase$="[[phase.name]]"
                          operation$="[[operation.name]]">
                            <i class="fa fa-times"></i>
                        </a>
                      </div>
                      <div class="flex">
                        <input
                          type="text"
                          value="{{material.name::input}}"
                          on-input="recalc" />
                      </div>

                      <!--<div>
                        <div class="layout horizontal">  -->
                          <div class="flex">
                            <input
                              type="number"
                              value="{{material.amount::input}}"
                              on-input="recalc" />
                            <sub>Amount</sub>
                          </div>

                          <div class="flex">
                            <input
                              type="text"
                              value="{{material.units::input}}"
                              on-input="recalc" />
                              <sub>Units</sub>
                          </div>


                          <div class="flex" style="text-align:center">
                            <span class="input-label">@</span>&nbsp;
                          </div>
                      <!--  </div>
                      </div>-->

                      <div>

                            <span class="input-label" style="padding-right:0">$</span>

                            <input
                              type="number"
                              on-input="recalc"
                              value="{{material.price::input}}" />

                            <span class="input-label">/<span>{{material.units}}</span></span>


                      </div>

                      <div style="text-align:right">
                        <span class="input-label">
                          = <ahb-dollar-label value="[[material.total]]" style="font-weight: bold"></ahb-dollar-label>
                        </span>
                      </div>

                    </div>
                  </template>

                  <div style="margin-top: 10px; border-top: 1px solid #eee;"></div>
                </div>

                <h4>
                  <div class="layout horizontal">
                    <div class="flex"></div>

                    <div>
                      <small style="vertical-align: middle">
                        <ahb-dollar-label value="[[operation.subtotal]]"></ahb-dollar-label> <sub>Subtotal</sub>
                        x&nbsp;<span>{{operation.timeMultiplier}}</span> <sub>Interval</sub>&nbsp;</small>
                    </div>

                    <div style="white-space:nowrap">
                      <ahb-interval-selector
                        on-change="recalc"
                        interval="{{operation.interval}}"
                        interval-amount="{{operation.intervalAmount}}" ></ahb-interval-selector>
                    </div>
                    <!-- TODO: this seems very complex to handle -->
                    <!-- <ahb-unit-selector></ahb-unit-selector> -->

                    <div>
                      <small style="vertical-align: middle">&nbsp;=
                        <ahb-dollar-label value="[[operation.total]]"></ahb-dollar-label>/<span>{{operation.units}}</span>
                      </small>
                    </div>
                  </div>
                </h4>

              </template>
            </div>
          </div>
        </template>


        <h3 class="total">
            Subtotal = <ahb-dollar-label value="[[phaseTotal]]"></ahb-dollar-label> <small>/acre</small><br />
            <small> x <span>
            <input type="number"
              value="{{farmSize::input}}"
              style="width: 75px"
              on-input="recalc" />
            </span> acres</small>
        </h3>

        <h2 class="grandTotal">
            <div style="float:left">Total</div>
            <ahb-dollar-label value="[[grandTotal]]"></ahb-dollar-label>
        </h2>
        <h2 class="grandTotal">
            <div style="float:left">Annualized</div>
            <ahb-dollar-label value="[[annualized]]"></ahb-dollar-label>
        </h2>

        <h2 class="grandTotal" style="text-align: left">Cost Breakdown<h2>
        <div class="row">
          <div class="col-md-4" id="phaseChartRoot"></div>
          <div class="col-md-4" id="operationChartRoot"></div>
          <div class="col-md-4" id="materialChartRoot"></div>
        </div>

    </div>

  </template>
</dom-module>

<script src="demo.js"></script>
<script src="controller.js"></script>
