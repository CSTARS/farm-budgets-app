<!-- reusable popup for complex materials -->
<link rel="import" href="budget-material-advanced.html" />
<link rel="import" href="budget-material-history.html" />
<link rel="import" href="budget-material-remove.html" />

<script src="controls.js"></script> <!-- always needs to be first import -->
<script src="cancel.js"></script>
<script src="create.js"></script>
<script src="delete.js"></script>
<script src="edit.js"></script>
<script src="onInput.js"></script>
<script src="save.js"></script>
<script src="unique.js"></script>


<dom-module id="budget-material-popup">
  <template>
    <div class="modal fade" id="popup">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header" id="header">
            <button type="button" class="close" aria-label="Close" on-click="cancel"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title" id="title"></h4>
          </div>
          <div class="modal-body">


            <div class="form-horizontal" id="simplePanel">

              <div id="parentMaterial"></div>
              <div class="form-group">
                <label for="nameInput" class="col-sm-3 control-label">Name</label>
                <div class="col-sm-9">
                  <input type="text" id="nameInput" class="form-control" on-input="onNameInput" />
                  <div class="text text-danger" id="nameInputMessage"></div>
                </div>
              </div>

              <div class="form-group">
                <label for="nameInput" class="col-sm-3 control-label">Description</label>
                <div class="col-sm-9">
                  <textarea id="descriptionInput" class="form-control" on-input="onDescriptionInput"></textarea>
                </div>
              </div>

              <div class="form-group" id="unitsGroup">
                <label for="unitsInput" class="col-sm-3 control-label">Units</label>
                <div class="col-sm-9">
                  <div class="layout horizontal center">
                    <div>us$/</div>
                    <div class="flex">
                      <budget-unit-selector id="unitsInput" on-units-change="editUnits" block></budget-unit-selector>
                    </div>
                  </div>

                  <div id="unitsInputMsg"></div>
                </div>
              </div>

              <div class="form-group" id="priceGroup">
                <label for="priceInput" class="col-sm-3 control-label" id="priceLabel">Price</label>
                <div class="col-sm-9">
                  <input type="number" id="priceInput" class="form-control" on-input="onPriceInput"/>
                </div>
              </div>

              <div class="form-group" id="complexGroup">
                <label class="col-sm-3 control-label"><i class="fa fa-cubes"></i></label>
                <div class="col-sm-9">
                  <div class="checkbox">
                    <label>
                      <input type="checkbox" id="isComplexInput" on-click="toggleComplex"> Is complex material
                    </label>
                  </div>
                  <div class="help-block">This material requires other materials.</div>
                </div>
              </div>

            </div> <!-- end form -->

            <div id="complexPanel" style="display:none" class="animated fadeIn">
              <h4>Required Materials</h4>

              <div class="form-horizontal" style="margin: 25px 0">
                <div class="form-group">
                  <label for="materialSearchInput" class="col-sm-3 control-label">Add Materials</label>
                  <div class="col-sm-9">
                    <budget-material-search on-material-select="onMaterialSelect"></budget-material-search>

                    <a style="cursor:pointer" on-click="toggleUnique"><i class="fa fa-plus"></i> Create Unique Material</a>


                    <div id="createUniquePanel" style="display:none">
                      <div class="help-block">Create a new required material that is unique to (only used by) this material.</div>

                      <div class="form-horizontal" >
                        <div class="form-group">
                          <label for="uniqueNameInput" class="col-sm-2 control-label">Name</label>
                          <div class="col-sm-10">
                            <input type="text" id="uniqueNameInput" class="form-control" />
                          </div>
                        </div>

                        <div class="form-group" id="unitsGroup">
                          <label for="uniqueUnitsInput" class="col-sm-2 control-label">Units</label>
                          <div class="col-sm-10">
                            <div class="layout horizontal center">
                              <div>us$/</div>
                              <div class="flex">
                                <budget-unit-selector id="uniqueUnitsInput" block></budget-unit-selector>
                              </div>
                            </div>
                          </div>
                        </div>

                        <div class="form-group">
                          <label for="uniquePriceInput" class="col-sm-2 control-label">Price</label>
                          <div class="col-sm-10">
                            <input type="number" id="uniquePriceInput" class="form-control" />
                          </div>
                        </div>

                        <div class="form-group" id="unitsGroup">
                          <label class="col-sm-3 control-label"></label>
                          <div class="col-sm-9">
                            <div id="createUniqueMsg" class="text text-danger"></div>
                            <a class="btn btn-primary" id="createUniqueBtn" on-click="createUnique">Create</a>
                            <a class="btn btn-cancel" on-click="cancelCreateUnique">Cancel</a>
                          </div>
                        </div>
                      </div> <!-- end form -->
                    </div> <!-- end create unique panel -->

                  </div>
                </div>

              </div> <!-- end form -->

              <budget-materials-table
                id="materialTable"
                on-price-change="onPriceChange"
                on-delete="onMaterialDelete"
                on-edit-unique="onEditUnique">
              </budget-materials-table>

              <h4>Price <small ><span id="current-price"></span> <span id="current-units"></span></small></h4>

            </div>

            <budget-material-advanced id="advancedPanel" style="display:none" on-close-advanced="showSimple"></budget-material-advanced>
            <budget-material-history id="historyPanel" style="display:none" on-close-history="showSimple"></budget-material-history>
            <budget-material-remove id="removePanel" style="display:none" on-close-remove="showSimple"></budget-material-remove>


            <div id="authorityMessage"></div>

            <div class="horizontal layout center" id="footer">
              <div class="flex">
                <a class="btn btn-link" on-click="showRemove" id="removeBtn"><i class="fa fa-trash"></i> Remove</a>
                <a class="btn btn-link" on-click="showAdvanced" id="advancedBtn"><i class="fa fa-cog"></i> Advanced</a>
                <a class="btn btn-link" on-click="showHistory" id="historyBtn"><i class="fa fa-history"></i> History</a>
              </div>
              <div style="text-align:right">
                <a class="btn btn-primary" on-click="save" id="saveBtn">Save</a>
                <a class="btn btn-cancel" on-click="cancel">Cancel</a>
              </div>
            </div>


          </div> <!-- /.modal-body -->
        </div><!-- /.modal-content -->
      </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->
  </template>
</dom-modle>

<script>
  Polymer({
    is : 'budget-material-popup',

    behaviors : [BudgetMaterialPopup],

    ready : function() {
      this.popup = $(this.$.popup).modal({show: false, backdrop: 'static'});
      this.showingAdvanced = false;
      this.suggestTimer = -1;

      this.materialTableOptions = {
        noNotes: true
      };

      $(window).on('hashchange', function(){
        if( !this.showing ) return;

        // when we manually hit the back button bellow this event will be
        // triped again.  you can ignore it.
        if( this.ignoreNextHashEvent ) {
          this.ignoreNextHashEvent = false;
          return;
        }

        if( confirm('Do you want to save and close?') ) {
          this.save();
        } else {
          this.ignoreNextHashEvent = true;
          window.history.back();
        }
      }.bind(this));
    },

    updatePriceLabel : function() {
      this.$['current-price'].innerHTML = '$'+this.data.price.toFixed(2);

      var label = FB.units.getLabel(this.data.units);
      if( label != '' ) label = 'per '+label;
      this.$['current-units'].innerHTML = label;
    },

    recalc : function() {
      FB.materialController.materialRecalc(this.data);

      if( this.data.type == 'complex' ) {
        this.$.materialTable.setMaterials(this.data, this.materialTableOptions);
        this.updatePriceLabel();
      }
    },

    editUnits : function(e) {
      if( this.editUnitsTimer != -1 ) clearTimeout(this.editUnitsTimer);
      this.editUnitsTimer = setTimeout(function(){
        this.editUnitsTimer = -1;
        this._editUnits(e);
      }.bind(this), 200);
    },

    _editUnits : function(e) {
      if( e.detail.error ) return;

      if( this.data.type == 'complex' ) {
        //var oldUnits = this.data.units;
        var newUnits = e.detail.value;

        this.handleAmountUnitChange(newUnits)

        this.data.units = newUnits;
      } else {
        this.$.unitsInputMsg.innerHTML = '';
        this.data.units = FB.units.invert(e.detail.value);
      }

      this.recalc();
    },

    handleAmountUnitChange : function(newUnits) {
      if( !this.materialUnits || this.materialUnits == newUnits || Object.keys(this.data.materials).length == 0 ) {
        this.$.unitsInputMsg.innerHTML = '';
        return;
      }

      // prompt for update of child material amounts
      var prompt = $(
        '<div class="alert alert-dismissable alert-warning" style="margin-top: 5px">'+
          '<button type="button" class="close">×</button>'+
          '<h4>Question!</h4>'+
          '<p>You have updated your materials units from <b>'+this.materialUnits+'</b> to <b>'+newUnits+'</b>. '+
          'You should probably convert the amounts of each required material to match the unit change.</p>'+
          '<div class="layout horizontal" style="margin-top: 5px">'+
            '<div class="flex">'+
              '<button class="btn btn-default" convert>Convert '+this.materialUnits+'<i class="fa fa-long-arrow-right"></i>'+newUnits+'</button>'+
            '</div><div>'+
              '<button class="btn btn-warning" close>Ignore</button>'+
            '</div>'+
          '</div>'+
        '</div>'
      );
      $(this.$.unitsInputMsg).html('').append(prompt);

      prompt
        .find('[convert]')
        .on('click', function(){
          var error = this.$.materialTable.updateAmountFromUnits(this.materialUnits, newUnits);
          if( error ) {
            return alert(error.message);
          }

          this.materialUnits = newUnits;
          this.$.unitsInputMsg.innerHTML = '';
          this.recalc();
        }.bind(this));

      prompt
        .find('.close, [close]')
        .on('click', function(){
          this.materialUnits = newUnits;
          this.$.unitsInputMsg.innerHTML = '';
          this.recalc();
        }.bind(this));
    },

    suggest : function() {
      if( this.suggestTimer != -1 ) clearTimeout(this.suggestTimer);
      this.suggestTimer = setTimeout(function(){
        this.suggestTimer = -1;
        this._suggest();
      }.bind(this), 500);
    },

    _suggest : function() {
      var data = {
        query : {
          id : {'$nin' : this.currentIds},
          '$text' : {'$search' : this.data.name}
        }
      };
      var nameMatch = new RegExp('('+this.data.name.replace(/\s+/g,'|')+')', 'i');
      var localityMatch = new RegExp('('+this.data.locality.join('|')+')', 'i');

      $.post('/materials/find', data, function(resp) {
        var c = 0;
        var html = '<div class="well well-sm animated fadeIn">'+
            '<button type="button" class="close" aria-label="Close"><span aria-hidden="true">&times;</span></button>'+
            '<table style="width: 100%;color:#555">';

        for( var i = 0; i < resp.length; i++ ) {
          if( nameMatch.test(resp[i].name) ) {
            for( var j = 0; j < resp[i].locality.length; j++ ) {
              if( localityMatch.test(resp[i].locality[j]) ) {
                html += '<tr>'+
                  '<td><a style="cursor:pointer;padding:5px" index="'+i+'"><i class="fa fa-cloud-download"></i></a></td>'+
                  '<td><i class="fa fa'+(resp[i].type == 'complex' ? 'fa fa-cubes' : 'fa fa-cube')+'"></i> '+
                    resp[i].name + '</td>'+
                  '<td><i class="fa fa-map-marker"></i> '+ resp[i].locality.join(', ')+'</td>'+
                  '<td> <i class="fa fa-shield"></i> '+ resp[i].authority+'</td></tr>';
                c++;
                break;
              }
            }
          }
        }

        if( c > 0 ) {
          html = '<div class="help-block">Perhaps you want to import one of the following suggestions instead?</div>'+html+'</table></div>';
        } else {
          html = '';
        }

        this.$.nameInputMessage.innerHTML = html;
        $(this.$.nameInputMessage)
          .find('a')
          .on('click', function(e){
            var index = parseInt(e.currentTarget.getAttribute('index'));
            this.cancel();
            setTimeout(function(){
              document.querySelector('budget-import-material-popup').showImport(resp[index], this.data.name, this.data.locality.join(' '));
            }.bind(this), 250);
          }.bind(this));
        $(this.$.nameInputMessage)
          .find('button')
          .on('click', function(){
            $(this).parent().remove();
          });
      }.bind(this));
    }
  })
</script>
