<dom-module id="budget-material-remove">
  <template>
    <style>
      :host {
        display: block;
      }
      #budgetlist : {
        max-height: 300px;
        overflow: auto;
      }
    </style>

    <h4 class="page-header" style="margin-top:0">Please Review Options</h4>


    <h5><i class="fa fa-times"></i> Remove material from budget</h5>

    <div style="padding:15px">
      <a class="btn btn-primary" on-click="fireRemove"><i class="fa fa-times"></i> Remove</a>
    </div>

    <h5><i class="fa fa-times"></i> Remove material from budget & <i class="fa fa-trash"></i> permanently delete material</h5>

    <div style="padding:15px">
      <div id="budgets">
        <div class="text text-warning">Warning! This material is used by to follow budgets: </div>
        <div id="budgetlist" style="margin:0 10px"></div>
      </div>
    </div>

    <a class="btn btn-primary" id="deleteBtn" on-click="fireDelete"></a>

    <div class="modal-footer">
      <a class="btn btn-link pull-right" on-click="back"><i class="fa fa-arrow-left"></i> Back</a>
    </div>

  </template>
  <script>
    Polymer({
      is: 'budget-material-remove',

      update : function(material) {
        $(this.$.deleteBtn).addClass('disabled').html('Checking...');
        this.$.budgets.style.display = 'none';

        $.get('/budget/uses?material='+material.id, function(resp){
          if( resp.error ) {
            return alert(resp.message);
          }

          var c = 0;
          var html = '<table class="table">'+
                        '<tr><th><i class="fa fa-dollar"></i> Budget Name</th><th>Farm Name</th>'+
                        '<th><i class="fa fa-leaf"></i> Crop</th><th><i class="fa fa-authority"></i> Authority</th>'+
                        '<th><i class="fa fa-map-marker"></i> Location</th></tr>';
          var budgetId = FB.getBudget().id;
          for( var i = 0; i < resp.length; i++ ) {
            if( resp.id === budgetId ) continue;
            html +=
              '<tr>'+
                '<td>'+resp[i].name+'</td>'+
                '<td>'+resp[i].farm.name+'</td>'+
                '<td>'+resp[i].commodity+'</td>'+
                '<td>'+resp[i].authority+'</td>'+
                '<td>'+resp[i].locality.join(', ')+'</td>'+
              '</div>';
            c++;
          }

          if( c > 0 ) {
            this.$.budgetlist.innerHTML = html;
            this.$.budgets.style.display = 'block';
          }

          $(this.$.deleteBtn).removeClass('disabled').html('<i class="fa fa-times"></i> Remove&nbsp;&nbsp;&&nbsp;&nbsp;<i class="fa fa-trash"></i> Delete');
        }.bind(this));
      },

      fireRemove : function() {
        this.fire('remove');
      },

      fireDelete : function() {
        this.fire('delete');
      },


      back : function() {
        this.fire('close-remove');
      }
    });
  </script>
</dom-module>
