<dom-module id="budget-setup-authority-editor">
  <template>
    <style>
      :host {
        display: block;
      }
      .item {
        padding: 10px;
        margin: 10px;
        border: 1px solid #ccc;
      }
    </style>

    <h4 class="page-header" style="margin-top:0"><i class="fa fa-shield"></i> <span>{{authName}}</span></h4>
    <textarea class="form-control">{{authDescription}}</textarea>
    <a class="btn btn-primary">Save Description</a>

    <h5 class="page-header" ><i class="fa fa-group"></i> Authority Members</h5>

    <div class="row">
      <div class="col-sm-6">
        <div class="form-horizontal">
          <div class="form-group">
            <label for="newMemeberSearch" class="col-sm-3 control-label">Add Member</label>
            <div class="col-sm-9">
              <input type="text" id="newMemeberSearch" class="form-control" on-input="searchMembers"  placeholder="Search Members"/>

              <template is="dom-repeat" items="{{searchResults}}">
                <div style="padding:10px 0">
                  <a class="btn btn-primary" on-click="grantAccess" index$="{{index}}"><i class="fa fa-user-plus"></i></a>
                  <span>{{item.username}}</span>
                  (<span>{{item.name}}</span>)
                </div>
              </template>
            </div>
          </div>
        </div>
      </div>
      <div class="col-sm-6">
        <ul class="list-group">
          <template is="dom-repeat" items="{{users}}">
            <li class="list-group-item">
              <span style="font-weight:bold">{{item}}</span>
              <a class="btn btn-link pull-right" on-click="removeAccess" index$="{{index}}"><i class="fa fa-user-times"></i></a>
            </li>
          </template>
        </ul>
      </div>
    </div>

    <div id="budgets">
      <h4 class="page-header"><i class="fa fa-dollar"></i> Budgets</h4>
    </div>

    <template is="dom-repeat" items="{{budgets}}">
      <div class="item">
        <budget-list-item budget="{{item}}"></budget-list-item>
      </div>
    </template>

  </template>
  <script>
    Polymer({
      is: 'budget-setup-authority-editor',

      properties : {
        authority : {
          type : String,
          observer : 'authorityObserver'
        }
      },

      ready : function() {
        this.searchTimer = -1;
        this.searchResults = [];
      },

      authorityObserver : function() {
        if( !this.authority ) return;
        this.update();
        this.updateBudgets();
      },

      update : function() {
        $.get('/authority/get?name='+this.authority, this.onResponse.bind(this));
      },

      updateBudgets : function() {
        var query = JSON.stringify({"authority": this.authority});
        $.get('/budget/find?query='+query, function(resp){
          this.budgets = resp;
        }.bind(this));
      },

      onResponse : function(resp) {
        if( resp.error ) {
          return alert(resp.message);
        }

        this.data = resp;
        this.authName = resp.name;
        this.authDescription = resp.description;
        this.users = resp.users;
      },

      searchMembers : function() {
        if( this.searchTimer !== -1 ) clearTimeout(this.searchTimer);
        this.searchTimer = setTimeout(function(){
          this.searchTimer = -1;
          this._searchMembers();
        }.bind(this), 300);
      },

      _searchMembers : function() {
        var query = this.$.newMemeberSearch.value;
        if( query.length === 0 ) {
          this.searchResults = [];
          return;
        }

        $.get('/members/search/?q='+query, function(resp) {
          if( resp.error ) {
            alert(resp.error);
          }

          for( var i = resp.length-1; i >= 0; i-- ) {
            if( this.users.indexOf(resp[i].username) > -1 ) {
              resp.splice(i, 1);
            }
          }

          this.searchResults = resp;
        }.bind(this));
      },

      grantAccess : function(e) {
        var index = parseInt(e.currentTarget.getAttribute('index'));
        var user = this.searchResults[index];
        this.searchResults = [];
        this.$.newMemeberSearch.value = '';

        $.get('/authority/grantAccess?name='+this.authority+'&username='+user.username, function(resp){
          if( resp.error ) {
            alert(resp.message);
            return;
          }

          this.update();
        }.bind(this));
      },

      removeAccess : function(e) {
        var index = parseInt(e.currentTarget.getAttribute('index'));
        var user = this.users[index];

        if( !confirm('Are you sure you want to remove user: '+user) ) {
          return;
        }

        this.splice('users', index);

        $.get('/authority/removeAccess?name='+this.authority+'&username='+user, function(resp){
          if( resp.error ) {
            alert(resp.message);
            return;
          }

          this.update();
        }.bind(this));
      }
    });
  </script>
</dom-module>
