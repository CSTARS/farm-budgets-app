<dom-module id="material-editor-table">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <div style="padding: 10px;">
      <input type="text" class="form-control" placeholder="Search Text" id="textInput" on-keyup="onKeyUp"/>
    </div>

    <div id="filters" style="padding: 10px"></div>

    <div class="layout horizontal" style="border-top: 1px solid #eee">
      <div class="well">
        <h4 class="page-header" style="margin-top:5px">Filters</h4>

        <h5>Authority</h5>
        <template is="dom-repeat" items="{{authorityFilters}}">
          <div><a class="btn btn-link" on-click="addFilter" filter="authority">{{item}}</a></div>
        </template>

        <h5>Location</h5>
        <template is="dom-repeat" items="{{locationFilters}}">
          <div><a class="btn btn-link" on-click="addFilter" filter="locality">{{item}}</a></div>
        </template>
      </div>
      <div class="flex" style="padding: 20px">

        <div class="layout horizontal center">
          <div class="flex" id="totalLabel">

          </div>
          <div class="flex" style="text-align: center">
            <select class="form-control" style="display:inline-block; width: 65px" on-change="onNumPerPageChange" value="10">
              <option value="5">5</option>
              <option value="10" selected>10</option>
              <option value="25">25</option>
              <option value="50">50</option>
              <option value="100">100</option>
            </select> Per Page
          </div>
          <div class="flex" style="text-align:right">
            <span class="btn-group">
              <a class="btn btn-default" on-click="previous"><i class="fa fa-arrow-left"></i></a>
              <a class="btn btn-default" on-click="next"><i class="fa fa-arrow-right"></i></a>
            </span>

            <a class="btn btn-danger" on-click="removeSelected" id="delete" style="display:none"><i class="fa fa-trash"></i> Delete Selected</a>
          </div>
        </div>

        <div id="table"></div>
      </div>
    </div>

    <material-editor-delete-popup id="deletePopup" on-complete="query"></material-editor-delete-popup>

  </template>
  <script>
    Polymer({
      is: 'material-editor-table',

      ready : function() {
        this.results = [];
        this.locationFilters = [];
        this.authorityFilters = [];
        this.itemsPerPage = 10;
        this.page = 0;

        this.setEmptyQuery();

        this.queryTimer = -1;
      },

      attached : function() {
        this.query();
      },

      onKeyUp : function() {
        var value = this.$.textInput.value;

        this.page = 0;

        if( value === '' ) {
          if( this.q.$text ) {
            delete this.q.$text;
          }
        } else {
          if( !this.q.$text ) {
            this.q.$text = {};
          }
          this.q.$text.$search = value;
        }

        this.bufferedQuery();
      },

      bufferedQuery : function() {
        if( this.queryTimer !== -1 ) clearTimeout(this.queryTimer);

        this.queryTimer = setTimeout(function(){
          this.queryTimer = -1;
          this.query();
        }.bind(this), 200);
      },

      previous : function() {
        if( this.page === 0 ) return;
        this.page -= 1;
        this.query();
      },

      next : function() {
        if( (this.page+1) * this.itemsPerPage > this.resp.total ) return;
        this.page += 1;
        this.query();
      },

      query : function() {
        var params = {
          query : JSON.stringify(this.q),
          start : this.itemsPerPage * this.page,
          stop : this.itemsPerPage * (this.page+1)
        }

        $.get('/materials/search', params, function(resp){
          this.resp = resp;
          this.results = resp.results;

          this.cleanFilters(resp.filters);

          this.locationFilters = resp.filters.locality.sort();
          this.authorityFilters = resp.filters.authority.sort();

          this.selected = [];

          this.render();
          this.onSelectedUpdate();
        }.bind(this));
      },

      update : function(material) {
        var name = material.name;
        if( material.rename ) {
          name = material.rename;
        }
        delete material.rename;

        for( var i = 0; i < this.results.length; i++ ) {
          if( this.results[i].name == name ) {
            this.results[i] = material;
            break;
          }
        }
      },

      render : function() {
        var html = '<table class="table">', m;

        html += '<tr>'+
          '<th><a style="cursor:pointer" all>All</a> | <a style="cursor:pointer" none>None</a></th>'+
          '<th>Type</th>'+
          '<th>Name</th>'+
          '<th><i class="fa fa-shield"></i> Authority</th>'+
          '<th><i class="fa fa-map-marker"></i> Locality</th>'+
          '<th><i class="fa fa-dollar"></i> Price</th>'+
          '<th><i class="fa fa-hourglass-o"></i> Year</th>'+
          '<th>Class</th>'+
          '<th># Required</th>'+
          '<th># Unique</th>'+
          '<th>Edit</th>'+
        '</tr>';

        for( var i = 0; i < this.results.length; i++ ) {
          var m = this.results[i];
          html += '<tr>';

          // row selector
          html += '<td><input type="checkbox" index="'+i+'" /></td>';

          // set row icon
          html += '<td><i class="fa fa-cube'+(m.type === 'complex' ? 's' : '')+'"</td>';

          // set row name
          html += '<td>'+m.name+'</td>';

          // set authority
          html += '<td>'+m.authority+'</td>';

          // set locality
          html += '<td>'+m.locality.join(', ')+'</td>';

          // set authority
          html += '<td>'+(m.price !== undefined ? '$'+m.price.toFixed(2) : '')+'</td>';

          // set year
          html += '<td>'+(m.year || '')+'</td>';

          // set class
          html += '<td>'+(m.class || '')+'</td>';

          // set num required materials
          html += '<td>';
          if( m.materials && m.type === 'complex') {
            html += Object.keys(m.materials).length;
          }
          html +='</td>';

          // set num required materials
          html += '<td>';
          if( m.unique && m.type === 'complex') {
            html += Object.keys(m.unique).length;
          }
          html +='</td>';

          html += '<td><a style="cursor:pointer" index="'+i+'" edit><i class="fa fa-pencil"></i></a></td>';

          html += '</tr>';
        }

        this.$.table.innerHTML = html+'</table>';

        // wire events
        $(this.$.table)
          .find('a[edit]')
          .on('click', function(e){
            var index = parseInt(e.currentTarget.getAttribute('index'));
            this.fire('edit', this.results[index]);
          }.bind(this));

        $(this.$.table)
          .find('input[type="checkbox"]')
          .on('click', function(e){
            var index = e.currentTarget.getAttribute('index');

            if( e.currentTarget.checked ) {
              this.selected.push(index);
            } else {
              this.selected.splice(this.selected.indexOf(index), 1);
            }

            this.onSelectedUpdate();
          }.bind(this));

        $(this.$.table)
          .find('a[all]')
          .on('click', function(e){
            $(this.$.table).find('input[type="checkbox"]').prop('checked', true);
            this.selected = [];
            for( var i = 0; i < this.results.length; i++ ) this.selected.push(i+'');
            this.onSelectedUpdate();
          }.bind(this));

        $(this.$.table)
          .find('a[none]')
          .on('click', function(e){
            $(this.$.table).find('input[type="checkbox"]').prop('checked', false);
            this.selected = [];
            this.onSelectedUpdate();
          }.bind(this));

        this.renderControls();
      },

      renderControls : function() {
        this.$.totalLabel.innerHTML = '<h5>'+(this.resp.start+1)+' to '+(this.resp.stop)+' of '+this.resp.total+'</h5>';
      },

      renderFilters : function() {
        if( !this.q.$and ) {
          this.$.filters.innerHTML = '';
          return;
        }

        var html = '';
        for( var i = 0; i < this.q.$and.length; i++ ) {
          var filter = this.q.$and[i];
          html += ' <a index="'+i+'" class="btn btn-primary"><i class="fa fa-times"></i> '+filter[this.getFilter(filter)]+'</a> ';
        }
        this.$.filters.innerHTML = html;

        $(this.$.filters)
          .find('a')
          .on('click', function(e){
            this.q.$and.splice(parseInt(e.currentTarget.getAttribute('index')), 1);
            if( this.q.$and.length === 0 ) {
              delete this.q.$and;
            }

            $(e.currentTarget).remove();
            this.query();
          }.bind(this));
      },

      addFilter : function(e) {
        if( !this.q.$and ) {
          this.q.$and = [];
        }
        var f = {};
        f[e.currentTarget.getAttribute('filter')] = e.currentTarget.innerHTML;
        this.q.$and.push(f);
        this.page = 0;

        this.renderFilters();
        this.query();
      },

      getFilter : function(obj) {
        return Object.keys(obj)[0];
      },

      cleanFilters : function(filters) {
        if( !this.q.$and ) return;

        for( var i = filters.locality.length-1; i >= 0; i-- ) {
          if( this._isActive('locality', filters.locality[i]) ) {
            filters.locality.splice(i, 1);
          }
        }

        for( var i = filters.authority.length-1; i >= 0; i-- ) {
          if( this._isActive('authority', filters.authority[i]) ) {
            filters.authority.splice(i, 1);
          }
        }
      },

      _isActive : function(type, filter) {
        for( var i = 0; i < this.q.$and.length; i++ ) {
          if( this.q.$and[i][type] === filter ) {
            return true;
          }
        }
        return false;
      },

      onNumPerPageChange : function(e) {
        this.itemsPerPage = parseInt(e.currentTarget.value);
        this.query();
      },

      setEmptyQuery : function() {
        this.q = {};

        if( ExpressAuth.user ) {
          this.q.authority = {
            $in : $.extend(true, [], ExpressAuth.user.authorities)
          }
          this.q.authority.$in.push(ExpressAuth.user.username);
        };
      },

      onSelectedUpdate : function() {
        if( this.selected.length === 0 ) {
          this.$.delete.style.display = 'none';
        } else {
          this.$.delete.style.display = 'inline-block';
        }
      },

      removeSelected : function() {
        var materials = [];
        for( var i = 0; i < this.selected.length; i++ ) {
          materials.push(this.results[parseInt(this.selected[i])]);
        }

        this.$.deletePopup.show(materials);
      }
    });
  </script>
</dom-module>
