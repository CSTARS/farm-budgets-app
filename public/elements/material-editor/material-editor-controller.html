<dom-module id="material-editor-controller">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <div style="border-bottom: 1px solid #ccc">
      <h5>
        <div class="layout horizontal center">
          <div class="flex">
            Farm Budget <small>Materials</small>
          </div>
          <div>
            <a class="btn btn-default" href="#budget/overview"><i class="fa fa-dollar"></i> Budget</a>
            <a class="btn btn-default" href="#material/search" id="find"><i class="fa fa-search"></i> Find</a>
            <a class="btn btn-default" href="#material/create" id="create"><i class="fa fa-plus"></i> Create</a>
          </div>
        </div>
      </h5>
    </div>

    <material-editor-table id="search" on-edit="onTableEdit"></material-editor-table>
    <div class="container">
      <material-editor-form id="form" style="display:none;margin-top: 25px"></material-editor-form>
    </div>

  </template>
  <script>
    Polymer({
      is: 'material-editor-controller',

      ready : function() {
        this.allowed = ['search', 'edit', 'create'];
        $(window).on('hashchange', this.setPage.bind(this));
      },

      attached : function() {
        this.setPage();
      },

      setPage : function() {
        var parts = window.location.hash.replace(/#/,'').split('/');

        if( parts[0] !== 'material' ) {
          this.style.display = 'none';
          return;
        }

        var page = 'search';
        if( parts.length > 1 ) page = parts[1];

        if( this.allowed.indexOf(page) === -1 ) {
          return window.location = '#material/search';
        }

        if( page === 'edit' && parts.length <= 2 ) {
          return window.location = '#material/search';
        }

        this.$.create.style.display = 'inline-block';
        this.$.find.style.display = 'inline-block';

        this.style.display = 'block';
        if( page === 'search' ) {
          this.$.search.style.display = 'block';
          this.$.form.style.display = 'none';
          this.$.find.style.display = 'none';
        } else {
          this.$.form.style.display = 'block';
          this.$.search.style.display = 'none';

          if( page === 'edit' ) {
            this.$.form.edit(parts[2]);
          } else {
            this.$.create.style.display = 'none';
            this.$.form.create();
          }
        }
      },

      onTableEdit : function(e) {
        this.$.table.style.display = 'none';
        this.$.form.edit(e.detail);
        this.$.form.style.display = 'block';
      },

      onFormDone : function(e) {
        this.$.table.style.display = 'block';
        this.$.form.style.display = 'none';

        this.$.table.update(e.detail);
        this.$.table.render();
      },

      onSaveError : function(e) {
        this.table.query(); // refresh the table on error
      }
    });
  </script>
</dom-module>
