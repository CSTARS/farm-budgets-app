<dom-module id="budget-unit-selector">
  <style>
    :host {
      display: block;
      width: 100px;
      position: relative;
    }
    #message {
      position: absolute;
      padding: 3px;
      border: 1px solid #ccc;
      background-color: white;
      display: none;
      z-index: 100;
    }
    #input {
      display : block;
    }
    #icon {
      position : absolute;
      bottom : 3px;
      right: 0px;
    }
  </style>

  <template>
    <i id="icon" class="text text-danger fa fa-warning"></i><input id="input" type="text" class="form-control text" on-input="onChange" on-blur="onBlur" on-focus="onFocus">
    <div id="message"></div>
  </template>
</dom-module>

<script>
  Polymer({
    is : 'budget-unit-selector',

    properties : {
      units : {
        type : String,
        observer: 'setUnits'
      },
      block : {
        type : Boolean,
        observer: 'setDisplayBlock',
        value : false
      }
    },

    attached : function() {
      this.checkError();
      this.onBlur();
    },

    setDisplayBlock : function() {
      if( this.block ) {
        this.style.display = 'block';
        this.$.input.style.display = 'block';
        this.style.width = '100%';
      } else {
        this.style.display = 'inline-block';
        this.$.input.style.display = 'inline-block';
      }
    },

    setUnits : function() {
      this.$.input.value = this.units;
      this.checkError();
    },

    getUnits : function() {
      return this.$.input.value;
    },

    onChange : function(){
      if( this.$.input.value == '' ) {
        this.clearError();
        return;
      }

      this.checkError();
      this.fire('units-change', {
        value : this.$.input.value,
        error : this.error
      });
    },

    checkError : function() {
      try {
        FB.ucum.parse(this.$.input.value);
      } catch(e) {
        $(this).addClass('has-error');
        $(this.$.input).addClass('text-danger');
        this.error = true;

        this.$.icon.style.display = 'inline';

        this.$.message.innerHTML = '<div class="text text-danger">Invalid Units</div>'+this.getReminders();
        return;
      }
      this.clearError();
    },

    clearError : function() {
      this.error = false;
      $(this).removeClass('has-error');
      $(this.$.input).removeClass('text-danger');
      this.$.message.innerHTML = '<span class="text text-success">Valid</span>';

      this.$.icon.style.display = 'none';
    },

    onFocus : function() {
      this.$.message.style.display = 'block';

      if( this.block ) return;
      this.style.width = '150px';
      this.$.input.style.width = '150px';
    },

    onBlur : function() {
      this.$.message.style.display = 'none';

      if( this.block ) return;
      this.style.width = '100px';
      this.$.input.style.width = '100px';
    },

    getReminders : function() {
      var parts = this.$.input.value.replace(/[\]\[\.\/]/g, ' ').replace(/\s+/g,' ').trim().toLowerCase().split(' ');

      var reminders = [];
      for( var i = 0; i < parts.length; i++ ) {
        if( FB.units.lookup[parts[i]] && FB.units.lookup[parts[i]].symbol != parts[i]) {
          reminders.push('<b>'+parts[i]+'</b> = '+FB.units.lookup[parts[i]].symbol);
        }
      }

      if( reminders.length == 0 ) return '';
      return '<div class="well well-sm"><div>Reminders</div><div>'+reminders.join('</div><div>')+'</div></div>';
    }
  });
</script>

<!--
<dom-module id="budget-unit-selector">
  <template>
    <span id="label"></span><select id="select" on-change="onChange" style="padding-right: 15px"></select>
  </template>
</dom-module>

<script>
  Polymer({
    is : 'budget-unit-selector',

    properties : {
      units : {
        type : String,
        observer: 'updateSelector'
      }
    },

    attached : function() {
      this.updateSelector();
    },

    updateSelector : function() {
      if( !this.units ) return;

      var list = [];
      var unit = '';

      if( this.units.indexOf('/') > -1 ) {
        var label = this.units.split('/');
        this.$.label.innerHTML = FB.units.getLabel(label[0], true)+'/';
        unit = label[1];
      } else {
        unit = this.units;
      }

      var likeUnits = FB.units.getLikeUnits(unit);
      var html = '';

      if( likeUnits.length == 0 ) {
        html += '<option value="'+unit+'">'+unit+'</option>';
      } else {
        unit = FB.units.getLabel(unit);
        for( var i = 0; i < likeUnits.length; i++ ) {
          html += '<option value="'+likeUnits[i].symbol+'" '+(likeUnits[i].name == unit ? 'selected' : '')+'>' +
                  likeUnits[i].name+'</option>';
        }
      }

      this.$.select.innerHTML = html;
    },

    onChange : function(){
      this.fire('units-change', this.$.select.value);
    }
  });
</script>
-->
