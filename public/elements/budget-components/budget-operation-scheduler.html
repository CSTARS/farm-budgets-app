<dom-module id="budget-operation-scheduler">
  <style>
    :host {
      display: block;
      position: relative;
      padding: 4px;
      border-radius: 4px;
    }
    :host:hover {
      background-color: #f8f8f8;
      color: #2196f3;
    }
    #inputPanel {
      font-size: 14px;
      color: #333;
    }
    #title {
      cursor: pointer;
    }
    .length-label {
      padding: 10px;
      color: #666;
    }
  </style>

  <template>

    <div on-click="toggle" id="title">
      <div><i class="fa fa-calendar-o"></i> Schedule: <span>{{displayText}}</span> <i class="fa fa-pencil" id="edit" style="display:none"></i></div>
      <div><small id="dateRangeText"></small></div>
    </div>

    <div id="inputPanel">
      <div class="form-horizontal">

        <div class="form-group" id="dates">
          <label for="datesInput" class="col-sm-3 control-label"><i class="fa fa-calendar-plus-o"></i> Add Dates</label>
          <div class="col-sm-9">
            <input id="datesInput" class="form-control" placeholder="New Date (mm/dd/yyyy)"/>

            <div id="selectedDates">


              <template is="dom-repeat" items="{{data}}">
                <div>

                  <div class="layout horizontal" style="margin-top:15px">
                    <div class="flex"><h6 style="padding-right: 20px">{{item.date}}</h6></div>

                    <div class="length-label">Length:</div>
                    <div>
                      <input type="number" value="{{item.length}}" class="form-control" style="max-width: 75px; margin-right: 5px" />
                    </div>

                    <div>
                      <select value="{{item.units}}" class="form-control">
                        <option value="day">Day(s)</option>
                        <option value="month">Month(s)</option>
                        <option value="year">Year(s)</option>
                      </select>
                    </div>

                    <div class="flex">
                      <a class="btn btn-link" index="{{index}}" on-click="removeDate"><i class="fa fa-calendar-times-o"></i></a>
                    </div>
                  </div> <!-- end inline form -->

                </div>
              </template>
            </div>

          </div>
        </div>
      </div> <!-- end form -->

    </div> <!-- end input panel -->
  </template>
</dom-module>

<script>
  Polymer({
    is : 'budget-operation-scheduler',

    ready : function() {
      this.displayText = '';
      this.dateRangeText = '';

      this.data = [];
      this.dates = [];

      $(this.$.datesInput)
        .datepicker({
          format: 'mm/dd/yyyy',
          orientation : 'top auto'
        })
        .on('changeDate', function(e){
          this.dates.push({
            date : e.date,
            length : 1,
            units : 'month'
          });
          this.update();
          $(this.$.datesInput).datepicker('hide');
        }.bind(this));

      $(this.$.title)
        .on('mouseover', function(){
          this.$.edit.style.display = 'inline';
        }.bind(this))
        .on('mouseleave', function(){
          this.$.edit.style.display = 'none';
        }.bind(this))

      this.update();
    },

    attached : function() {
      this.popup = document.querySelector('budget-schedule-popup');
      this.removeChild(this.$.inputPanel);
    },

    set : function(data) {
      this.data = data;

      this.dates = [];
      for( var i = 0; i < data.length; i++ ) {
        this.dates.push({
          length : data[i].length,
          units : data[i].units,
          date : new Date(data[i].date)
        })
      }

      this.update(true);
    },

    update : function(noEvent) {
      this.$.dates.style.display = 'block';
      this.displayText = ' x'+this.dates.length;

      this.dates.sort(function(a, b){
        if( a.date.getTime() > b.date.getTime() ) return 1;
        else if( a.date.getTime() < b.date.getTime() ) return -1;
        return 0;
      });

      var tmp = [];
      for( var i = 0; i < this.dates.length; i++ ) {
        tmp.push(this.toDateString(this.dates[i]));
      }

      this.data = tmp;

      if( this.dates.length > 1 ) {
        this.dateRangeText = this.toDateString(this.dates[0]).date + ' <i class="fa fa-long-arrow-right"></i> 'Â +
                            this.toDateString(this.dates[this.dates.length-1]).date;
      } else if( this.dates.length == 1 ) {
        this.dateRangeText = this.toDateString(this.dates[0]).date;
      } else {
        this.dateRangeText = '';
      }
      this.$.dateRangeText.innerHTML = this.dateRangeText;

      if( !noEvent ) this.fire('schedule-update', this.data);
    },

    toDateString : function(d) {
      return {
        length : d.length,
        units : d.units,
        date : (d.date.getYear()+1900)+'-'+(d.date.getMonth()+1)+'-'+(d.date.getDate())
      }
    },

    removeDate : function(e) {
      var index = parseInt(e.currentTarget.getAttribute('index'));

      this.data.splice(index, 1);
      this.dates.splice(index, 1);

      this.update();
    },

    toggle : function() {
      this.popup.setBody(this.$.inputPanel);
      this.popup.show();
    }
  });
</script>
