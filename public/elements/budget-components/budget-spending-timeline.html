<dom-module id="budget-spending-timeline">
  <style>
    :host {
      display : block;
    }
  </style>
  <template>
    <div id="chart" style="height: 450px"></div>

    <div class="horizontal layout">
      <div>
        <div class="btn-group" role="group">
          <button type="button" class="btn btn-primary" id="opBtn" on-click="byOperation">By Operation</button>
          <button type="button" class="btn btn-default" id="totalBtn" on-click="byTotal">Total</button>
          <button type="button" class="btn btn-default" id="cumulativeBtn" on-click="byCumlative">Cumulative</button>
        </div>
      </div>
      <div class="flex" id="selected" style="padding: 5px"></div>
    </div>
  </template>
</dom-module>

<script>
  Polymer({
    is : 'budget-spending-timeline',

    attached : function() {
      this.type = 'all';

      $(window).on('resize', this.drawChart.bind(this));

      this.handlerSet = false;
      FB.operationController.on('total-update', this.drawChart.bind(this));
    },

    byOperation : function() {
      if( this.type == 'all' ) return;
      this.type = 'all';
      this.$.opBtn.className = 'btn btn-primary';
      this.$.totalBtn.className = 'btn btn-default';
      this.$.cumulativeBtn.className = 'btn btn-default';
      this.updateData();
      this.drawChart();
    },

    byTotal : function() {
      if( this.type == 'total' ) return;
      this.type = 'total';
      this.$.opBtn.className = 'btn btn-default';
      this.$.cumulativeBtn.className = 'btn btn-default';
      this.$.totalBtn.className = 'btn btn-primary';
      this.updateData();
      this.drawChart();
    },

    byCumlative : function() {
      if( this.type == 'cumulative' ) return;
      this.type = 'cumulative';
      this.$.opBtn.className = 'btn btn-default';
      this.$.cumulativeBtn.className = 'btn btn-primary';
      this.$.totalBtn.className = 'btn btn-default';
      this.updateData();
      this.drawChart();
    },

    onShow : function() {
      this.drawChart();
    },

    updateData  : function() {
      this.$.selected.innerHTML = '';

      var operations = FB.operationController.get();
      var header = ['Month'];

      if( this.type == 'all' ) {
        for( var i = 0; i < operations.length; i++ ) {
          header.push(operations[i].name);
        }
      } else if( this.type == 'cumulative' ) {
        header.push('cumulative');
      } else {
        header.push('total');
      }
      this.data = [header];

      var c = 0;

      for( var i = 0; i < this.months.length; i++ ) {
        var arr = [this.months[i].month];

        if( this.type == 'all' ) {
          for( var j = 0; j < operations.length; j++ ) {
            if( this.months[i][operations[j].name] ) {
              arr.push(parseFloat(this.months[i][operations[j].name].toFixed(2)));
            } else {
              arr.push(1);
            }
          }
        } else if( this.type == 'cumulative' ) {
          c += this.months[i].total || 0;
          arr.push(parseFloat(c.toFixed(2)));
        } else {
          arr.push(parseFloat(this.months[i].total.toFixed(2)) || 1);
        }

        this.data.push(arr);
      }
    },

    drawChart : function(e) {
      if( e && e.spendingByMonth ) {
        this.months = e.spendingByMonth;
        this.updateData();
      }

      if( !window.google && !this.handlerSet ) {
        googleChartLoadHandlers.push(this.drawChart.bind(this));
        this.handlerSet = true;
        return;
      }

      if( !this.data ) return;

      if( this.data.length == 1 ) {
        this.$.chart.innerHTML = '<i class="fa fa-warning"></i> No Data';
        this.chart = null;
        return;
      }


      if( !this.chart ) {
        this.$.chart.innerHTML = '';
        var container = this.$.chart;

        this.chart = new google.visualization.LineChart(container);
        google.visualization.events.addListener(this.chart, 'select', function(){
          var selection = chart.getSelection()[0];
          this.show(selection.row);
        }.bind(this));
      }

      var dataTable = google.visualization.arrayToDataTable(this.data);

      this.chart.draw(dataTable, {
        vAxis : {
          logScale : true
        },
        animation:{
          duration: 800,
          easing: 'out',
        },
      });


    },

    show : function(row) {
      var info = this.months[row];
      var html = '<div class="well"><h5>'+info.month+'</h5>';

      for( var key in info ) {
        if( key == 'month' ) continue;
        if( key == 'total' ) {
          html += '<div><b>'+key+': </b><ahb-dollar-label value="'+info[key]+'"></ahb-dollar-label></div>';
        } else {
          html += '<div><a href="#budget/operations/'+key+'">'+key+':</a> <ahb-dollar-label value="'+info[key]+'"></ahb-dollar-label></div>';
        }
      }

      this.$.selected.innerHTML = html+'</div>';
    }

  })
</script>
