<dom-module id="budget-macro-edit-material">
  <style>
    input[type="number"] {
      width : 50px;
      display : inline-block;
    }
    input[type="text"] {
      width : 100px;
      display : inline-block;
    }
    .edit-trash {
      vertical-align: top;
    }
  </style>

  <template>


    <div class="layout horizontal" id="complex" style="display:none">
      <div class="flex"><budget-macro id="complexName"></budget-macro></div>
      <div class="flex">
        <input type="number" class="form-control" on-input="fireAmountChange" />
        <budget-unit-selector id="complexUnits" on-units-change="fireUnitsChange"></budget-unit-selector>
      </div>
      <div class="total"></div>
      <div><a class="btn btn-link edit-trash" on-click="fireDelete"><i class="fa fa-trash"></i></a></div>
   </div>


    <div class="layout horizontal" id="simple" style="display:none">
      <div><b id="simpleName"></b></div>
      <div class="flex" style="text-align:center">
        <input type="number" id="simpleInput" class="form-control" on-input="fireAmountChange" />
        <budget-unit-selector id="simpleUnits" on-units-change="fireUnitsChange"></budget-unit-selector>
      </div>
      <div class="total"></div>
      <div><a class="btn btn-link edit-trash" on-click="fireDelete"><i class="fa fa-trash"></i></a></div>
    </div>

    <div id="error" style="display:none" class="text-danger" id="errorMaterialLabel"></div>

  </template>
</dom-module>

<script>
  Polymer({
    is : 'budget-macro-edit-material',

    init : function(config) {
      this.unitTimer = -1;
      this.amountTimer = -1;

      this.config = config;
      this.config.materialImpl = this.config.complexMaterial.materials[this.config.material.name];
      this.render();
    },

    reset : function() {
      this.$.error.style.display = 'none';
      this.$.complex.style.display = 'none';
      this.$.simple.style.display = 'none';
    },

    render : function() {
      this.reset();

      if( this.config.material.error ) {
        this.$.error.style.display = 'block';
        this.$.errorMaterialLabel.innerHTML = 'Unknown material: '+this.config.material.name;
        return;
      }

      var amount = this.config.materialImpl.amount;
      var price = this.config.material.price;

      if( this.config.material.type == 'complex' ) {

        this.$.complex.style.display = 'flex';
        this.$.complexName.setMaterial(this.config.material.name);
        this.$.complexUnits.units = this.getUnits();
        this.$.complexInput.value = amount;

      } else {

        this.$.simple.style.display = 'flex';
        this.$.simpleName.innerHTML = this.config.material.name;
        this.$.simpleInput.value = amount;
        this.$.simpleUnits.units = this.getUnits();

      }

      $(this).find('.total').html('= $'+this.config.materialImpl.price.toFixed());

      this.setErrorStatus();

      //$(this).find('.macroUnits').html(FB.units.getLabel(this.config.complexMaterial.units));
    },

    getUnits : function() {
      return this.config.materialImpl.units;
    },

    setErrorStatus : function() {
      if( !this.config.materialImpl.error ) {
        this.$.error.style.display = 'none';
      } else {
        this.$.error.innerHTML = this.config.materialImpl.error.message+': '+this.config.materialImpl.error.math+
          (this.config.materialImpl.error.debug ? '<br />'+this.config.materialImpl.error.debug : '');
        this.$.error.style.display = 'block';
      }
    },

    splitUnits : function() {
      var units = this.getUnits();
      var parts = units.split('/');

      if( parts.length == 1 ) {
        return [parts[0], this.config.complexMaterial.units];
      }

      var denominator = parts.splice(parts.length-1, 1)[0];

      return [parts.join('/'), denominator]
    },

    updateAmountFromUnits : function(to) {
      try {
        //this.config.materialImpl.amount = FB.ucum.convert(this.config.materialImpl.amount, from, to);

        var str = '('+FB.units.math.cleanDollars(this.config.materialImpl.units)+').('+
                  FB.units.math.cleanDollars(to) + ').(' +
                  FB.units.math.cleanDollars(this.config.material.units)+')';

        var value = FB.ucum.canonicalize(str);
        this.config.materialImpl.amount = value.value * this.config.materialImpl.originalAmount;
        console.log(' convert: '+str);

        this.$.complexInput.value = this.config.materialImpl.amount;
        this.$.simpleInput.value = this.config.materialImpl.amount;

        this.config.materialImpl.error = null;
      } catch(e) {
        this.config.materialImpl.error = {
          error : true,
          message : 'Unable to convert',
          math : str
        }
      }

      this.setErrorStatus();
    },

/*
    getUnitsLabel : function() {
      var units = this.getUnits();

      var val = FB.ucum.parse('('+FB.units.math.cleanDollars(units)+').('+FB.units.math.cleanDollars(this.config.complexMaterial.units)+')');
      var keys = Object.keys(val.units);

      var n = [], d = [];
      for( var key in val.units ) {
        if( val.units[key] == 1) n.push(key);
        else d.push(key);
      }

      val = n.join('.');
      if( d.length > 0 ) val += '/'+d.join('.');

      return val;
    },
*/
    fireUnitsChange : function(e) {
      if( this.unitTimer == -1 ) clearTimeout(this.unitTimer);

      this.unitTimer = setTimeout(function(){
        this.unitTimer = -1;
        this._fireUnitsChange(e);
      }.bind(this), 200);
    },

    _fireUnitsChange : function(e) {
      if( e.detail.error ) return;

      this.config.materialImpl.units = e.detail.value;

      FB.materialController.recalc();
      $(this).find('.total').html('= $'+this.config.materialImpl.price.toFixed());
      this.setErrorStatus();
      this.config.onUnitsChange(this.config.materialImpl, e.detail.value);
    },

    fireAmountChange : function(e) {
      if( this.amountTimer == -1 ) clearTimeout(this.amountTimer);

      this.amountTimer = setTimeout(function(){
        this.amountTimer = -1;
        this._fireAmountChange(e);
      }.bind(this), 200);
    },

    _fireAmountChange : function(e) {
      this.config.materialImpl.amount = parseInt(e.target.value);
      this.config.materialImpl.originalAmount = this.config.materialImpl.amount;

      FB.materialController.recalc();
      $(this).find('.total').html('= $'+this.config.materialImpl.price.toFixed());
      this.setErrorStatus();
      this.config.onAmountChange(this.config.materialImpl, parseInt(e.target.value));
    },

    fireDelete : function() {
      this.config.onDelete(this.config.material);
      $(this).remove();
    }

  })
</script>
