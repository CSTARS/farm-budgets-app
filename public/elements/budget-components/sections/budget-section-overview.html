<dom-module id="budget-section-overview">
  <style>
    :host {
      display: block;
      padding-top: 25px;
    }
    .card {
      padding: 15px;
      margin: 15px;
      box-shadow: 0 0 8px #ccc;
    }
  </style>
  <template>

    <div class="row">
      <div class="col-md-6">

        <div class="card">
          <h4><i class="fa fa-info-circle"></i> Farm Information</h4>
          <table class="table">
            <tbody id="tbody">
              <tr>
                <td>Farm Size</td>
                <td><input type="number" class="form-control" id="sizeInput" on-input="onFarmSizeChange"/></td>
              </tr>
            </tbody>
          </table>
        </div>

      </div>
      <div class="col-md-6">

        <div class="card">
          <h4 class="page-header" style="margin-top: 11px"><i class="fa fa-dollar"></i> Total</h4>
          <budget-total id="total"></budget-total>
        </div>

      </div>
    </div>

    <div class="card">
      <h4><i class="fa fa-calendar-o"></i> Operation Timeline</h4>
      <budget-timeline id="timeline"></budget-timeline>

      <h4>Spending Timeline</h4>
      <budget-spending-timeline id="spendingTimeline"></budget-spending-timeline>
    </div>

    <a class="btn btn-link" on-click="toggleDebug">Toggle Debug</a>
    <div class="card" id="debug" style="display:none">
      <h4>JSON (debug)</h4>
      <textarea id="json" class="form-control" style="height: 400px"></textarea>
    </div>
  </template>
</dom-module>

<script>
  Polymer({
    is : 'budget-section-overview',

    ready : function() {
      FB.operationController.on('total-update', this.setJsonDump.bind(this));
    },

    setData : function(data) {
      if( !data.farm ) return;

      this.$.total.setData(data.farm);

      for( var key in data.farm ) {
        if( key == 'size' ) {
          this.$.sizeInput.value = data.farm[key];
        } else {
          var row = $('<tr><td>'+key+'</td><td>'+data.farm[key]+'</td></tr>')[0];
          this.$.tbody.appendChild(row);
        }
      }
    },

    onFarmSizeChange : function() {
      this.$.total.farm.size = this.$.sizeInput.value;
      this.$.total.onTotalUpdate();
    },

    onShow : function(params) {
      this.$.timeline.onShow();
      this.$.spendingTimeline.onShow();

      if( params.length > 0 && params[0] === 'debug' ) {
        this.$.debug.style.display = 'block';
        this.setJsonDump();
      } else {
        this.$.debug.style.display = 'none';
      }
    },

    toggleDebug : function() {
      if( this.$.debug.style.display == 'block' ) {
        window.location = '#budget/overview';
      } else {
        window.location = '#budget/overview/debug';
      }
    },

    setJsonDump : function() {
      if( !window.appData ) return;

      // get latest data
      var arr = [];

      var materials = FB.materialController.get();

      for( var key in materials.materials ) arr.push(materials.materials[key]);
      for( var key in materials.complex ) arr.push(materials.complex[key]);

      appData.materials = arr;
      appData.operations = FB.operationController.get();

      this.$.json.innerHTML = JSON.stringify(appData, '', '  ');
    }
  });
</script>
