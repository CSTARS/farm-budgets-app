<dom-module id="budget-section-materials">
  <style>
    .card {
      padding: 15px;
      margin: 15px;
      box-shadow: 0 0 8px #ccc;
    }
  </style>

  <template>

    <div class="row">
      <div class="col-md-10 col-md-offset-1">

        <div class="form-horizontal" style="margin: 25px 0">
          <div class="form-group">
            <label for="filterInput" class="col-sm-2 control-label">Filter</label>
            <div class="col-sm-10">
              <input type="text" class="form-control" id="filterInput" placeholder="Filter Text" on-input="filter">

              <div class="checkbox">
                <label>
                  <input type="checkbox" id="thisBudgetInput" checked on-click="_filter"> Only materials used in this budget.
                </label>
              </div>
            </div>
          </div>
        </div>

        <div id="root"></div>

      </div>
    </div>
  </template>
</dom-module>

<script>
  Polymer({
    is : 'budget-section-materials',

    ready : function() {
      this.filterTimer = -1;
      this.updateTimer = -1;
    },

    setData : function(data) {
      this.data = data;

      this.data.materials.forEach(function(material){
        var div = this.createTable(material);
        this.$.root.appendChild(div);
      }.bind(this));

      this._filter();
    },

    onShow : function(params) {
      if( params.length > 0 ) {
        this.$.filterInput.value = params[0];
      }

      this._filter();
    },

    filter : function() {
      if( this.filterTimer != -1 ) clearTimeout(this.filterTimer);
      this.filterTimer = setTimeout(function(){
        this.filterTimer = -1;
        this._filter();
      }.bind(this));
    },

    _filter : function() {
      var txt = this.$.filterInput.value;

      var matched = [], showAll = false;
      if( txt == '' && !$(this.$.thisBudgetInput).is(':checked') ) {
        showAll = true;
      } else {
        matched = this.toNameArray(FB.materialController.find(txt));
      }

      var opEles = this.querySelectorAll('[material]');
      for( var i = 0; i < opEles.length; i++ ) {
        var ele = opEles[i];
        if( showAll || matched.indexOf(ele.getAttribute('material')) > -1 ) {
          ele.style.display = 'block';
        } else {
          ele.style.display = 'none';
        }
      };
    },

    toNameArray : function(materials) {
      var arr = [], include;
      var thisBudget = $(this.$.thisBudgetInput).is(':checked');

      if( thisBudget ) {
        include = FB.utils.getActiveMaterials();
      }

      materials.forEach(function(material){
        if( thisBudget ) {
          if( include.indexOf(material.name) > -1 ) {
            arr.push(material.name);
          }
        } else {
          arr.push(material.name);
        }

      });
      return arr;
    },

    createTable : function(material) {
      var html =
        '<div class="style-scope budget-section-materials card" material="'+material.name+'">'+
          '<h5 class="material-name">'+(material.type == 'complex' ? '<i class="fa fa-cubes"></i> ' : '<i class="fa fa-cube"></i> ')+material.name+'</h5>'+
          '<div>'+(material.description || '')+'</div>'+
          '<table class="table">' +
            '<tr><th>Class</th><th>Price</th><th>Units</th></tr>' +
            '<tr>' +
              '<td class="material-class">'+(material.type == 'complex' ? 'Complex Material' : material.class)+'</td>' +
              (material.type == 'complex' ?
                '<td class="material-price">'+(material.price || '')+'</td>' :
                '<td><input type="number" class="form-control material-price" value="'+(material.price || '')+'" /></td>'
              ) +
              '<td><budget-unit-selector units="'+(material.units || '')+'" ></budget-unit-selector></td>' +
            '</tr>' +
          '</table>' +
        '</div>';

      var row = $(html);

      row.find('.material-price').on('input', function(){
        this.updateFromEvent(row);
      }.bind(this));
      row.find('budget-unit-selector').on('units-change', function(){
        this.updateFromEvent(row);
      }.bind(this));

      return row[0];
    },

    updateFromEvent : function(ele) {
      if( this.updateTimer != -1 ) clearTimeout(this.updateTimer);

      this.updateTimer = setTimeout(function(){
        this.updateTimer = -1;
        this._updateFromEvent(ele);
      }.bind(this), 300);
    },

    _updateFromEvent : function(ele) {
      console.log('updating');
      var item = {
        name : ele.find('.material-name').html(),
        price : parseFloat(ele.find('.material-price').val()),
        'class' : ele.find('.material-class').html(),
        units : ele.find('budget-unit-selector')[0].getUnits()
      };

      FB.materialController.add(item, {replace: true});
      FB.operationController.recalc();
    }
  });
</script>
