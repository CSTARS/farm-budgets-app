<dom-module id="ahb-budget">
  <template>
    <budget-sections id="sections"></budget-sections>
  </template>
</dom-module>

<script>
  Polymer({
    is : 'ahb-budget',

    properties : {
      example : {
        type : String
      }
    },

    attached : function() {
      var id = window.localStorage.getItem('current-budget');

      if( id ) {
        $.get('/budget/get?id='+id, function(resp){
          if( resp.error ) {
            alert(resp.message);
            document.querySelector('find-budget-popup').show();
          } else {
            this.load(resp);
          }
        }.bind(this));
      } else {
        document.querySelector('find-budget-popup').show();
      }
    },

    load : function(appData) {
      FB.reset();
      window.appData = appData;
      window.localStorage.setItem('current-budget', appData.id);

      var options = {
        noEvent : true,
        noRecalc : true
      }

      appData.materials.forEach(function(material){
        FB.materialController.add(material, options);
      });

      FB.materialController.recalc();

      FB.operationController.setFarmSize(appData.farm && appData.farm.size ? parseInt(appData.farm.size) : 1);
      appData.operations.forEach(function(operation){
        FB.operationController.add(operation, options);
      });

      FB.operationController.recalc();

      this.$.sections.setData(appData);

      if( this.saveElement ) {
        this.saveElement.onBudgetLoad(appData);
      }
    }

  });
</script>
