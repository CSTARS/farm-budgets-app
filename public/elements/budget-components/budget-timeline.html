<dom-module id="budget-timeline">
  <style>
    :host {
      display : block;
    }
  </style>
  <template>
    <div id="chart" style="height: 450px"></div>
  </template>
</dom-module>

<script>
  Polymer({
    is : 'budget-timeline',

    attached : function() {
      $(window).on('resize', this.drawChart.bind(this));

      this.handlerSet = false;
      FB.operationController.on('total-update', this.drawChart.bind(this));
    },

    onShow : function() {
      this.drawChart();
    },

    drawChart : function(e) {
      if( e && e.range ) this.data = e.range.all;

      if( !window.google && !this.handlerSet ) {
        googleChartLoadHandlers.push(this.drawChart.bind(this));
        this.handlerSet = true;
        return;
      }

      if( !this.data ) return;

      this.$.chart.innerHTML = '';

      var container = this.$.chart;
      var chart = new google.visualization.Timeline(container);
      var dataTable = new google.visualization.DataTable();

      dataTable.addColumn({ type: 'string', id: 'Operation' });
      dataTable.addColumn({ type: 'date', id: 'Start' });
      dataTable.addColumn({ type: 'date', id: 'End' });

      var arr = [];
      this.data.forEach(function(d){
        var end = new Date(d.date.getTime()+this.getIntervalTime(d));
        arr.push([d.name, d.date, end]);
      }.bind(this));

      dataTable.addRows(arr);
      chart.draw(dataTable);

      google.visualization.events.addListener(chart, 'select', function(){
        try {
          window.location = '#budget/operations/'+arr[chart.getSelection()[0].row][0];
        } catch(e) {
          console.log(e);
        }
      });
    },

    getIntervalTime : function(date) {
      var l = parseInt(date.length);
      if( date.units == 'year' ) {
        return l * 86400000 * 365;
      } else {
        return l * 86400000 * 30;
      }
    }


  })
</script>
