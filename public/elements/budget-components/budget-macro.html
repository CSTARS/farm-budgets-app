<!--
  TODO: need to integrate https://github.com/jmandel/ucum.js
-->

<dom-module id="budget-macro">
  <style>
    :host {
      display: inline-block;
    }

    #expand {
      cursor: pointer;
    }
    #expand:hover {
      color: #2196f3;
    }

    .btn-group > .btn.btn-default {
      transition: all 300ms linear;
      -moz-transition: all 300ms linear;
      -ms-transition: all 300ms linear;
    }

    .btn-group > .btn.btn-default.nohover {
      border-top: 1px solid transparent !important;
      border-left: 1px solid transparent !important;
      box-shadow: none !important;
      -moz-box-shadow: none !important;
      -ms-box-shadow: none !important;
      -webkit-box-shadow: none !important;
    }
  </style>

  <template>
    <div id="edit" class="animated fadeIn">
      <div class="form-horizontal">

        <div class="form-group">
          <label for="nameInput" class="col-sm-3 control-label">Name</label>
          <div class="col-sm-9">
            <input type="text" id="nameInput" class="form-control" />
          </div>
        </div>

        <div class="form-group">
          <label for="unitsInput" class="col-sm-3 control-label">Units</label>
          <div class="col-sm-9">
            <input type="text" id="unitsInput" class="form-control" on-keyup="editUnits" />
          </div>
        </div>

        <div class="form-group">
          <label for="materialSearchInput" class="col-sm-3 control-label">Add Materials</label>
          <div class="col-sm-9" style="position: relative">
            <input type="text" id="materialSearchInput" placeholder="Search by item name" class="form-control" on-keyup="search"/>
            <div id="resultsPopup" style="display:none;z-index:1000;position:absolute;background-color:white;padding:10px;border: 1px solid #ccc"></div>

            <div class="help-block">Use search box to find materials by name.  Complex materials can include
            other complex materials. Or <a style="cursor:pointer"><i class="fa fa-plus"></i> create new material</a></div>
          </div>
        </div>


        <div class="form-group">
          <label for="materialSearchInput" class="col-sm-3 control-label">Materials</label>
          <div class="col-sm-9" style="position: relative" id="edit-items"></div>
        </div>

      </div> <!-- end form -->
    </div>

    <table>
      <tr>
        <td>
          <div class="btn-group animated fadeIn" role="group" style="display:none">
            <a class="btn btn-default nohover" on-click="edit"><i class="fa fa-pencil"></i></a>
            <a class="btn btn-default nohover" on-click="toggleView" id="toggleView"><i class="fa fa-angle-down"></i></a>
          </div>
        </td>
        <td style="padding-left: 5px">
          <span id="expand"><i class="fa fa-cubes"></i> <span id="nameLabel"></span></span>
          <span id="otherLabel"></span>
          <budget-unit-selector id="unitSelector" on-units-update="onUnitsUpdate"></budget-unit-selector><span>)</span>
        </td>
      </tr>
      <tr>
        <td id="main" colspan="2"></td>
      </tr>
    </table>

  </template>
</dom-module>

<script>
  Polymer({
    is : 'budget-macro',

    properties : {
      material : {
        type : String
      }
    },

    ready : function() {
      this.editUnitsTimer = -1;
      this.data = {
        name : '[Not Set]',
        materials : {},
        price : 0,
        units : ''
      };
      this.showingBtns = false;

      this.removeChild(this.$.edit);

      FB.materialController.on('material-update', this.onUpdate.bind(this));

      $(this).hover(function(){
        $(this).find('.nohover').removeClass('nohover');
      },function(){
        $(this).find('.btn-group > .btn').addClass('nohover');
      });

      $(this.$.expand).on('click',function() {
        if( this.showingBtns ) {
          $(this).find('.btn-group').hide();
          $(this.$.main).hide();
        } else {
          $(this).find('.btn-group').show();
          $(this.$.main).show();
        }
        this.showingBtns = !this.showingBtns;
      }.bind(this));
    },

    attached : function() {
      this.popup = document.querySelector('budget-complex-material-popup');
      this.render();

      if( this.material ) {
        var m = FB.materialController.get(this.material);
        if( m.error ) return;
        this.data = m;
        this.render(this.renderType);
      }
    },

    rerender : function() {
      this.render(this.renderType);
    },

    // render display. type
    render : function(type) {
      this.renderType = type;

      this.$.nameLabel.innerHTML = '<b>'+this.data.name+'</b> ';
      this.$.otherLabel.innerHTML = '('+(this.unitsPrice !== undefined ? this.unitsPrice : this.data.price.toFixed(2))+' ';

      this.$.unitSelector.units = this.data.units;
      this.$.unitSelector.updateSelector();

      if( this.renderType == 'tree' ) {
        this.renderTree();
        this.$.toggleView.innerHTML = '<i class="fa fa-angle-up"></i>';
      } else if( this.renderType == 'compressed' ) {
        this.renderCompressed();
        this.$.toggleView.innerHTML = '<i class="fa fa-angle-double-down"></i>';
      } else {
        this.renderNormal();
        this.$.toggleView.innerHTML = '<i class="fa fa-angle-down"></i>';
      }
    },

    toggleView : function(e) {
      if( e && e.preventDefault ){
        e.preventDefault();
        e.stopPropagation();
      }

      if( this.renderType == 'tree' ) {
        this.render('normal');
      } else if ( this.renderType == 'compressed' ) {
        this.render('tree');
      } else {
        this.render('compressed');
      }
    },

    renderNormal : function() {
      this.$.main.innerHTML = '';
    },

    renderTree : function() {
      var list = [];
      this.getTreeMaterialList(this.data.materials, '', list);

      var html = '<ul class="list-group animated zoomIn" style="padding-top:5px">';
      for( var i = 0; i < list.length; i++ ) {
        html += '<li class="list-group-item">' +
            '<i>'+list[i].path + '</i> <b>' +list[i].name + '</b>&nbsp;&nbsp;&nbsp;&nbsp;<span class="badge">' +
            (list[i].type == 'complex' ? '<i class="fa fa-cubes"></i>' : '') +
              '<span class="badge">$'+list[i].price.toFixed(2)+'/'+list[i].units+' x '+list[i].conversion+list[i].units+'</span>'
          '</li>';
      }

      this.$.main.innerHTML = html+'</ul>';
    },

    renderCompressed : function() {
      var list = [];
      this.getCompressedMaterialList(this.data.materials, list);

      var html = '<ul class="list-group animated zoomIn" style="padding-top:5px">';
      for( var i = 0; i < list.length; i++ ) {
        html += '<li class="list-group-item">' +
            list[i].count+'x <b>' + list[i].name + '</b>&nbsp;&nbsp;&nbsp;&nbsp;<span class="badge"> ' +
            (list[i].type == 'complex' ? '<i class="fa fa-cubes"></i>' : '') +
            ' $'+list[i].price.toFixed(2)+'/'+list[i].units+'</span>'
          '</li>';
      }

      this.$.main.innerHTML = html+'</ul>';
    },

    getCompressedMaterialList : function(materials, list) {
      for( var material in materials ) {
        var m = FB.materialController.get(material);
        if( m.error ) continue;

        var index = this.listMaterialIndex(list, m.name);
        if( index == -1 ) {
          var item = $.extend(true, {}, m);
          item.count = 1;
          list.push(item);
        } else {
          list[index].count++;
        }

        if( m.type === 'complex' && m.materials) {
          this.getCompressedMaterialList(m.materials, list);
        }
      }
    },

    getTreeMaterialList : function(materials, path, list) {
      for( var material in materials ) {
        var m = FB.materialController.get(material);
        if( m.error ) continue;

        var item = $.extend(true, {}, m);
        item.path = path;
        item.conversion = materials[material].amount;
        list.push(item);

        if( m.type === 'complex' &&  m.materials) {
          var p = path+m.name+' - ';
          this.getTreeMaterialList(m.materials, p, list);
        }
      }
    },

    listMaterialIndex : function(list, name) {
      for( var i = 0; i < list.length; i++ ) {
        if( list[i].name == name ) return i;
      }
      return -1;
    },

    search : function() {
      var results = FB.materialController.find(this.$.materialSearchInput.value);

      if( this.listMaterialIndex(results, this.data.name) > -1 ) {
        results.splice(this.listMaterialIndex(results, this.data.name), 1);
      }

      for( var material in this.data.materials ) {
        var index = this.listMaterialIndex(results, material);
        if( index > -1 ) {
          results.splice(index, 1);
        }
      }

      if( results.length > 0 ) {
        var html = '';
        console.log(results);

        for( var i = 0; i < results.length; i++ ) {
          html += '<div><a class="btn btn-link" index="'+i+'"><i class="fa fa-plus"></i> '+
                  results[i].name+'</a>'+(results[i].type == 'complex' ? ' <i class="fa fa-cubes"></i>' : '')+
                  '<div class="help-block">'+(results[i].class || '')+' '+(results[i].price || '')+' '+FB.units.getLabel(results[i].units || '', true)+'</div>'
                  '</div>';
        }
        $(this.$.resultsPopup)
          .html(html)
          .find('a')
          .on('click', function(e){
            this.addItemFromSearch(e, results);
          }.bind(this));

        this.$.resultsPopup.style.display = 'block';
      } else {
        this.$.resultsPopup.style.display = 'none';
      }
    },

    addItemFromSearch : function(e, results) {
      var ele = $(e.currentTarget);
      ele.parent().remove();
      var index = parseInt(ele.attr('index'));
      this.data.materials[results[index].name] = 1, // TODO: get real conversion value
      this.renderEditList();
      this.$.resultsPopup.style.display = 'none';
      this.$.materialSearchInput.value = '';
    },

    edit : function(e) {
      if( e && e.preventDefault ){
        e.preventDefault();
        e.stopPropagation();
      }

      this.changesString = JSON.stringify(this.data);
      this.$.nameInput.value = this.data.name;
      this.$.unitsInput.value = this.data.units;
      this.popup.setBody(this.$.edit);
      this.popup.show(this.onEditComplete.bind(this));
      this.renderEditList();
    },

    editUnits : function() {
      if( this.editUnitsTimer != -1 ) clearTimeout(this.editUnitsTimer);
      this.editUnitsTimer = setTimeout(function(){
        this.editUnitsTimer = -1;
        this._editUnits();
      }.bind(this), 200);
    },

    _editUnits : function() {
      this.data.units = this.$.unitsInput.value;
      this.renderEditList();
    },

    renderEditList : function() {
      var html = '';
      for( var material in this.data.materials ) {
        var m = FB.materialController.get(material);

        if( m.error ) {
          html += '<div lass="text-danger">Error, unknown material: '+material+'</div>';
        } else if( m.type == 'complex' ) {
          html +=
            '<div class="layout horizontal">'+
              '<div class="flex"><budget-macro material="'+m.name+'"></budget-macro></div>'+
              '<div>with <input type="number" material="'+material+'" value="'+this.data.materials[material].amount+'" style="width:50px;display:inline-block" class="form-control" />'+m.units+'/'+this.data.units+'</div>'+
              '<div><a class="btn btn-link edit-trash" style="vertical-align:top" index="'+material+'"><i class="fa fa-trash"></i></a></div>'+
          '</div>';
        } else {
          html +=
            '<div class="layout horizontal">'+
              '<div class="flex"><b>'+m.name+'</b> ($<span id="'+material+'-price-label">'+this.data.materials[material].price.toFixed(2) +
                '</span>/<budget-unit-selector units="'+(this.data.materials[material].units || m.units)+'" material="'+material+'"></budget-unit-selector>)</div>'+
              '<div>with <input type="number" material="'+material+'" value="'+this.data.materials[material].amount +
                  '" style="width:50px;display:inline-block" class="form-control"> per '+FB.units.getLabel(this.data.units)+'</div>'+
              '<div><a class="btn btn-link edit-trash" index="'+material+'"><i class="fa fa-trash"></i></a></div>'+
            '</div>';
        }
      }
      html += '<h4>Price <small id="current-price">$'+this.data.price.toFixed(2)+'/'+this.data.units+'</small></h4>';

      var ele = $(this.$['edit-items']).html(html);
      ele.find('a.edit-trash')
        .on('click', function(e){
          var ele = $(e.currentTarget);
          var material = ele.attr('index');

          ele.parent().parent().remove();
          delete this.data.materials[material];
        }.bind(this));

      ele.find('input[type="number"]')
        .on('change', function(e){
          var target = $(e.currentTarget);
          var material = target.attr('material');
          this.data.materials[material].amount = parseInt(target.val());

          FB.materialController.recalc();
          ele.find('#current-price').html('$'+this.data.price.toFixed(2));
        }.bind(this));

      ele.find('budget-unit-selector')
        .on('units-change', function(e){
          var target = $(e.currentTarget);
          var material = target.attr('material');
          console.log(e.originalEvent.detail);
          this.data.materials[material].units = e.originalEvent.detail;

          FB.materialController.recalc();
          ele.find('#'+material+'-price-label').html(this.data.materials[material].price.toFixed(2));
          ele.find('#current-price').html('$'+this.data.price.toFixed(2));
        }.bind(this));


    },

    onEditComplete : function() {
      var newName = this.$.nameInput.value;
      var oldName = this.data.name;
      this.data.name = newName;
      this.data.units = this.$.unitsInput.value;

      // detect changes
      if( this.changesString == JSON.stringify(this.data) ) {
        return;
      }

      var options = {replace: true};
      if( newName != oldName ) options.rename = oldName;

      FB.materialController.add(this.data, options);

      this.render(this.renderType);
    },

    // fired whenever any material is updated
    onUpdate : function(e) {
      // renaming something in our list?
      if( e.replaced && this.data.materials[e.replaced] !== undefined ) {
        this.data.materials[e.material.name] = this.data.materials[e.replaced];
        delete this.data.materials[e.replaced];
      }

      // if the material name is not in our chain, we can quit
      if( !this.has(e.material.name) ) {
        return;
      }

      // rerender
      this.render(this.renderType);
    },


    has : function(material) {
      if( material == this.data.name ) return true;
      return this._has(material, this.data.materials);
    },

    _has : function(material, materials) {
      //if( !scope ) scope = this;

      for( var material in materials ) {
        var m = FB.materialController.get(material);
        if( m.error ) continue;

        if( m.name === material ) return true;
        if( m.type === 'complex' && m.materials ) {
          return this._has(material, m.materials);
        }
      }
      return false;
    }
  });
</script>
