
<dom-module id="budget-macro">
  <style>
    :host {
      display: inline-block;
    }
    :host.open {
      background-color: #f8f8f8;
      border-radius: 4px;
      padding: 5px
    }

    #expand {
      cursor: pointer;
    }
    #expand:hover {
      color: #2196f3;
    }

    .btn-group > .btn.btn-default {
      transition: all 300ms linear;
      -moz-transition: all 300ms linear;
      -ms-transition: all 300ms linear;
    }

    .btn-group > .btn.btn-default.nohover {
      border-top: 1px solid transparent !important;
      border-left: 1px solid transparent !important;
      box-shadow: none !important;
      -moz-box-shadow: none !important;
      -ms-box-shadow: none !important;
      -webkit-box-shadow: none !important;
    }
  </style>

  <template>

    <table>
      <tr>
        <td>
          <span id="expand"><i class="fa fa-cubes" id="icon"></i> <span id="nameLabel"></span></span>
        </td>
        <td>
          <div style="width: 102px;display:none;" id="btns">
            <div class="btn-group" role="group" style="padding-left: 15px">
              <a class="btn btn-default nohover" id="editBtn"><i class="fa fa-pencil"></i></a>
              <a class="btn btn-default nohover" on-click="toggleView" id="toggleView"><i class="fa fa-angle-down"></i></a>
            </div>
          </div>
        </td>
      </tr>
      <tr>
        <td colspan="2"><div id="main" style="display:none"></div></td>
      </tr>
    </table>

  </template>
</dom-module>

<script>
  Polymer({
    is : 'budget-macro',

    properties : {
      material : {
        type : String,
        observer : 'updateMaterial'
      }
    },

    ready : function() {
      this.editUnitsTimer = -1;

      this.data = {
        name : '[Not Set]',
        materials : {},
        price : 0,
        units : ''
      };

      FB.materialController.on('material-update', this.onUpdate.bind(this));

      $(this).hover(function(){
        $(this).find('.nohover').removeClass('nohover');
      },function(){
        $(this).find('.btn-group > .btn').addClass('nohover');
      });

      $(this.$.expand).on('click',function() {
        $(this.$.main).toggle();
        $(this.$.btns).toggle();
        $(this).toggleClass('open');
      }.bind(this));
    },

    attached : function() {
      this.popup = document.querySelector('budget-complex-material-popup');
      this.render();
      this.updateMaterial();
    },

    updateMaterial : function(material) {
      if( material ) this.material = material;
      if( !this.material ) return;

      var m = FB.materialController.get(this.material);

      // TODO: set error message!!
      if( m.error ) {
        return alert(JSON.stringify(m));
      }

      this.$.editBtn.setAttribute('href','#budget/materials/'+m.name);

      this.data = m;

      // first time check for bad units
      try {
        FB.ucum.parse(m.units);
      } catch(e) {
        this.$.unitsInput.error = true;
      }

      this.render(this.renderType);
    },

    rerender : function() {
      this.render(this.renderType);
    },

    // render display. type
    render : function(type) {
      this.renderType = type;
      this.$.nameLabel.innerHTML = '<b>'+this.data.name+'</b> ';

      if( this.renderType == 'tree' ) {
        this.renderTree();
        this.$.toggleView.innerHTML = '<i class="fa fa-angle-down"></i>';
      } else {
        this.renderCompressed();
        this.$.toggleView.innerHTML = '<i class="fa fa-angle-double-down"></i>';
      }

      this.checkError();
    },

    checkError : function() {
      for( var key in this.data.materials ) {
        if( this.data.materials[key].error ) {
          this.$.icon.className = 'fa fa-warning';
          this.$.icon.style.color = 'red';
          this.error = true;
          return;
        }
      }

      this.error = false;
      this.$.icon.className = 'fa fa-cubes';
      this.$.icon.style.color = '';
    },

    toggleView : function(e) {
      if( e && e.preventDefault ){
        e.preventDefault();
        e.stopPropagation();
      }

      if( this.renderType == 'tree' ) {
        this.render('compressed');
      } else {
        this.render('tree');
      }
    },

    renderTree : function() {
      var list = [];
      this.getTreeMaterialList(this.data.materials, '', list);

      var html = '<table class="table" style="padding-top:5px;margin-bottom:0">';
      for( var i = 0; i < list.length; i++ ) {
        html += '<tr><td>' +
            '<i>'+list[i].path + '</i> '+
            (list[i].type == 'complex' ? '<b><i class="fa fa-cubes"></i>' +list[i].name + '</b>' : '<budget-material material="'+list[i].name+'"></budget-material>' )+'</td><td>' +

              list[i].amount+' '+FB.units.getLabel(list[i].units, true)+' = $'+
              list[i].price.toFixed(2)+' </span>'
          '</td></tr>';
      }

      this.$.main.innerHTML = this.getPriceLabel()+html+'</table>';
    },

    getPriceLabel : function() {
      return '<div class="text text-success" style="text-align:center;padding-top:5px">$' +
            (this.data.price ? this.data.price.toFixed(2) : '0')  +
            ' per '+FB.units.getLabel(this.data.units, true)+'</div>';
    },

    renderCompressed : function() {
      var list = [];
      this.getCompressedMaterialList(this.data.materials, list);

      var html = '<table class="table" style="padding-top:5px;margin-bottom:0">';
      for( var i = 0; i < list.length; i++ ) {
        html += '<tr><td>' +
            list[i].count+'x ' +
            (list[i].type == 'complex' ? '<b><i class="fa fa-cubes"></i>' +list[i].name + '</b>' : '<budget-material material="'+list[i].name+'"></budget-material>' )+'</td><td>' +
            ' '+(list[i].price ? list[i].price.toFixed(2) : '')+' '+FB.units.getLabel(list[i].units, true)+'</span>'
          '</td></tr>';
      }

      this.$.main.innerHTML = this.getPriceLabel()+html+'</table>';
    },

    getCompressedMaterialList : function(materials, list) {
      for( var material in materials ) {
        var m = FB.materialController.get(material);
        if( m.error ) continue;

        var index = this.listMaterialIndex(list, m.name);
        if( index == -1 ) {
          var item = $.extend(true, {}, m);
          item.count = 1;
          list.push(item);
        } else {
          list[index].count++;
        }

        if( m.type === 'complex' && m.materials) {
          this.getCompressedMaterialList(m.materials, list);
        }
      }
    },

    getTreeMaterialList : function(materials, path, list) {
      for( var material in materials ) {
        var m = FB.materialController.get(material);
        if( m.error ) continue;

        var item = $.extend(true, {}, m);
        item.path = path;
        item.amount = materials[material].amount;
        item.units = materials[material].units;
        item.price = materials[material].price;
        list.push(item);

        if( m.type === 'complex' &&  m.materials) {
          var p = path+m.name+' - ';
          this.getTreeMaterialList(m.materials, p, list);
        }
      }
    },

    listMaterialIndex : function(list, name) {
      for( var i = 0; i < list.length; i++ ) {
        if( list[i].name == name ) return i;
      }
      return -1;
    },

    // fired whenever any material is updated
    onUpdate : function(e) {
      // renaming something in our list?
      if( e.replaced && this.data.materials[e.replaced] !== undefined ) {
        this.data.materials[e.material.name] = this.data.materials[e.replaced];
        delete this.data.materials[e.replaced];
      }

      // if the material name is not in our chain, we can quit
      if( !this.has(e.material.name) ) {
        return;
      }

      // rerender
      this.render(this.renderType);
    },


    has : function(material) {
      if( material == this.data.name ) return true;
      return this._has(material, this.data.materials);
    },

    _has : function(material, materials) {
      //if( !scope ) scope = this;

      for( var material in materials ) {
        var m = FB.materialController.get(material);
        if( m.error ) continue;

        if( m.name === material ) return true;
        if( m.type === 'complex' && m.materials ) {
          return this._has(material, m.materials);
        }
      }
      return false;
    }
  });
</script>
