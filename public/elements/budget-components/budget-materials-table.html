<script>
  Polymer({
    is : 'budget-materials-table',

    ready : function() {
      this.defaultCols = ['Material', 'Notes', 'Amount', 'Units', 'Price', 'SubTotal', 'Remove'];
      this.cols = [];
      this.style.display = 'block';
      this.controllers = [];

    },

    setOptions : function(options) {
      this.options = options;
    },

    setMaterials : function(data, options) {
      if( options ) this.setOptions(options);

      this.controllers = []
      this.data = data;
      this.initTable(Object.keys(this.data.materials).length);

      var c = 2;

      for( var material in this.data.materials ) {
        var m = FB.materialController.get(material);
        var row = this.initRow(c, m);
        this.controllers.push(row);
        c++;
      }
    },

    initRow : function(row, material) {
      return new FB.MaterialTableRow(
        this.querySelector('table[main] > tbody > tr:nth-child('+row+')'),
        {
          cols : this.cols,
          material : material,
          complexMaterial : this.data,
          isOperation : this.options.isOperation,

          onDelete : function(material) {
            delete this.data.materials[material.name];
          }.bind(this),

          onAmountChange : function(material, amount) {
            this.fire('price-change', this.data.price);
          }.bind(this),

          onUnitsChange : function(material, units) {
            this.fire('price-change', this.data.price);
          }.bind(this)
        }
      );
    },

    updateAmountFromUnits : function(from, to) {
      for( var i = 0; i < this.controllers.length; i++ ) {
        this.controllers[i].updateAmountFromUnits(from, to);
      }
    },

    initTable : function(rows) {
      var table = '<table class="table" main>', cell;
      if( !this.options ) this.options = {};

      this.cols = $.extend(true, [], this.defaultCols);
      if( this.options.noRemove ) this.cols.splice(this.cols.indexOf('Remove'), 1);
      if( this.options.noNotes ) this.cols.splice(this.cols.indexOf('Notes'), 1);

      for( var i = 0; i <= rows; i++ ) {
        if( i == 0 ) cell = 'th';
        else cell = 'td';

        table += '<tr>';
        for( var j = 0; j < this.cols.length; j++ ) {
          table += '<'+cell+' type="'+this.cols[j]+'">'+(i == 0 && this.cols[j] != 'Remove' ? this.cols[j] : '')+'</'+cell+'>';
        }
        table += '</tr>';
      }
      this.innerHTML = table+'</table>';
    }
  });

  // controller for the material table row
  FB.MaterialTableRow = function(ele, config){
    var $ele = $(ele), amountTimer = -1, unitTimer = -1, cols = {};

    config.materialImpl = config.complexMaterial.materials[config.material.name];

    for( var i = 0; i < config.cols.length; i++ ) {
      cols[config.cols[i]] = $ele.find('[type="'+config.cols[i]+'"]');
    }

    var nameLabel;
    if( config.material.type == 'complex' ) {
      nameLabel = $('<budget-macro></budget-macro>');
    } else {
      nameLabel = $('<budget-material></budget-material>');
    }
    cols.Material.append(nameLabel);

    var errorLabel = $('<div style="display:none" class="text text-danger"></div>');
    cols.Material.append(errorLabel);

    var unitsInput = $('<budget-unit-selector></budget-unit-selector>');
    unitsInput.on('units-change', fireUnitsChange);
    cols.Units.append(unitsInput);

    var amountInput = $('<input type="number" class="form-control" />');
    amountInput.on('input', fireAmountChange);
    cols.Amount.append(amountInput);

    var subtotal = $('<ahb-dollar-label decimal></ahb-dollar-label>');
    cols.SubTotal.append(subtotal);

    var notesInput;
    if( cols.Notes ) {
      notesInput = $('<input type="text" class="form-control" />');
      cols.Notes.append(notesInput);
    }

    cols.Price.css('white-space', 'nowrap');

    var removeBtn;
    if( cols.Remove ) {
      removeBtn = $('<a class="btn btn-link"><i class="fa fa-trash"></i></a>');
      cols.Remove.append(removeBtn);
    }

    function render() {
      if( config.material.error ) {
        errorLabel.show();
        errorLabel.html('Unknown material: '+config.material.name);
        return;
      }

      nameLabel[0].material = config.material.name;
      unitsInput[0].units = config.materialImpl.units
      amountInput.val(config.materialImpl.amount);

      cols.Price.html(
        config.material.price.toFixed(2) +
        (config.material.type === 'complex' ? ' $/' : ' ') +
        FB.units.getLabel(config.material.units, true)
      );

      setPrice();

      if( cols.Notes ) {
        notesInput.val(config.materialImpl.note);
      }

      setErrorStatus();
    }

    function setErrorStatus() {
      if( !config.materialImpl.error ) {
        errorLabel.hide();
      } else {
        if( typeof config.materialImpl.error.math == 'object' ) debugger;
        errorLabel.html(config.materialImpl.error.message+': '+config.materialImpl.error.math+
          (config.materialImpl.error.debug ? '<br />'+config.materialImpl.error.debug : ''));
        errorLabel.show();
      }
    }

    function updateAmountFromUnits(from, to) {
      try {
        /*var str = '('+FB.units.math.cleanDollars(config.materialImpl.units)+').('+
                  FB.units.math.cleanDollars(to) + ').(' +
                  FB.units.math.cleanDollars(config.material.units)+')';*/
        var str = '('+FB.units.math.cleanDollars(to)+')/('+
                  FB.units.math.cleanDollars(from) + ')';

        var value = FB.ucum.canonicalize(str);
        config.materialImpl.amount = value.value * config.materialImpl.amount;
        console.log(' convert: '+str);

        amountInput.val(config.materialImpl.amount);

        config.materialImpl.error = null;
      } catch(e) {
        config.materialImpl.error = {
          error : true,
          message : 'Unable to convert',
          math : str
        }
      }

      setErrorStatus();
    }

    function fireUnitsChange(e) {
      if( unitTimer == -1 ) clearTimeout(unitTimer);

      unitTimer = setTimeout(function(){
        unitTimer = -1;
        _fireUnitsChange(e);
      }, 200);
    }

    function _fireUnitsChange(e) {
      if( e.originalEvent.detail.error ) return;

      config.materialImpl.units = e.originalEvent.detail.value;

      FB.materialController.recalc();
      FB.operationController.recalc();

      setPrice();

      setErrorStatus();
      config.onUnitsChange(config.materialImpl, e.originalEvent.detail.value);
    }

    function fireAmountChange(e) {
      if( amountTimer == -1 ) clearTimeout(amountTimer);

      amountTimer = setTimeout(function(){
        amountTimer = -1;
        _fireAmountChange(e);
      }.bind(), 200);
    }

    function _fireAmountChange(e) {
      config.materialImpl.amount = parseInt(e.originalEvent.target.value);
      config.materialImpl.originalAmount = config.materialImpl.amount;

      FB.materialController.recalc();
      FB.operationController.recalc();

      setPrice();

      setErrorStatus();
      config.onAmountChange(config.materialImpl, parseInt(e.originalEvent.target.value));
    }

    function fireDelete() {
      config.onDelete(config.material);
      $ele.remove();
    }

    function setPrice() {
      subtotal[0].value = config.materialImpl.price;
    }

    render();

    return {
      updateAmountFromUnits : updateAmountFromUnits
    }

  };
</script>
