<script>
  Polymer({
    is : 'budget-materials-table',

    properties : {
        readonly : {
          type : Boolean,
          value : function() {
            return false;
          }
        }
    },

    ready : function() {
      this.defaultCols = ['Material', 'Notes', 'Amount', 'Units', 'Price', 'SubTotal', 'Remove'];
      this.cols = [];
      this.style.display = 'block';
      this.style.overflowX = 'auto';
      this.controllers = [];
    },

    setOptions : function(options) {
      this.options = options;
    },

    setMaterials : function(data, options) {
      if( options ) this.setOptions(options);

      this.controllers = []
      this.data = data;

      // this is an operations materials
      if( Array.isArray(this.data.materials) ) {
        this.initTable(this.data.materials.length);

        for( var i = 0; i < this.data.materials.length; i++ ) {
          var m = FB.materialController.get(this.data.materials[i].name);
          var row = this.initRow(i+2, m, this.data.materials[i]);
          this.controllers.push(row);
        }

      // this is a complex materials table
      } else {
        this.initTable(Object.keys(this.data.materials).length);
        var c = 2;
        for( var material in this.data.materials ) {
          // first we check the unique materials
          var m;
          if( this.data.unique && this.data.unique[material] ) {
            m = {
              name : material,
              type : 'unique',
              parent : this.data.name,
              price : this.data.unique[material].price,
              units : this.data.unique[material].units
            };
          } else {
            m = FB.materialController.get(material);
          }
          var row = this.initRow(c, m, this.data.materials[material]);
          this.controllers.push(row);
          c++;
        }
      }

    },

    initRow : function(row, material, materialImpl) {
      return new FB.MaterialTableRow(
        this.querySelector('table[main] > tbody > tr:nth-child('+row+')'),
        {
          cols : this.cols,
          material : material,
          complexMaterial : this.data,
          readonly : this.readonly,
          isOperation : this.options.isOperation,
          materialImpl : materialImpl,

          onDelete : function(material) {
            this.recalc();

            if( Array.isArray(this.data.materials) && this.data.materials.length == 0 ) {
              this.innerHTML = ''; // remove table
            } else if( Object.keys(this.data.materials).length == 0 ) {
              this.innerHTML = ''; // remove table
            }

            this.fire('delete', material);
          }.bind(this),

          onAmountChange : function(material, amount) {
            this.recalc();
            this.fire('price-change', this.data.price);

          }.bind(this),

          onUnitsChange : function(material, units) {
            this.recalc();
            this.fire('price-change', this.data.price);
          }.bind(this)
        }
      );
    },

    recalc : function() {
      // sniff out material or operation
      if( this.data.schedule ) {
        FB.operationController.recalc();
      } else {
        FB.materialController.recalc();
      }
    },

    updateAmountFromUnits : function(from, to) {
      var value;

      try {
        value = FB.ucum.convert(1, FB.units.cleanDollars(from), FB.units.cleanDollars(to));
        if( value == 0 ) value = 1;
        value = 1 / value;
      } catch(e) {
        return {
          error : true,
          message : e,
        }
      }

      for( var i = 0; i < this.controllers.length; i++ ) {
        this.controllers[i].updateAmountFromUnits(value);
      }

      return null;
    },

    initTable : function(rows) {
      if( rows == 0 ) {
        this.innerHTML = '';
        return;
      }

      var table = '<table class="table" main>', cell;
      if( !this.options ) this.options = {};

      this.cols = $.extend(true, [], this.defaultCols);
      if( this.options.noRemove ) this.cols.splice(this.cols.indexOf('Remove'), 1);
      if( this.options.noNotes ) this.cols.splice(this.cols.indexOf('Notes'), 1);

      for( var i = 0; i <= rows; i++ ) {
        if( i == 0 ) cell = 'th';
        else cell = 'td';

        table += '<tr>';
        for( var j = 0; j < this.cols.length; j++ ) {
          table += '<'+cell+' type="'+this.cols[j]+'">'+(i == 0 && this.cols[j] != 'Remove' ? this.cols[j] : '')+'</'+cell+'>';
        }
        table += '</tr>';
      }
      this.innerHTML = table+'</table>';
    }
  });

  // controller for the material table row
  FB.MaterialTableRow = function(ele, config){
    var $ele = $(ele), amountTimer = -1, unitTimer = -1, cols = {};

    /* BASEPRICE
    var isBasePrice = false;
    if( config.material.name == config.complexMaterial.name+'--Base Price' ) {
      isBasePrice = true;
    } */

    for( var i = 0; i < config.cols.length; i++ ) {
      cols[config.cols[i]] = $ele.find('[type="'+config.cols[i]+'"]');
    }

    var nameLabel;
    if( config.material.type == 'complex' ) {
      nameLabel = $('<budget-macro></budget-macro>');
    } else {
      nameLabel = $('<budget-material></budget-material>');
      if( config.material.type == 'unique' ) {
        nameLabel.attr('parent', config.material.parent);
      }
    }
    cols.Material.append(nameLabel);

    var errorLabel = $('<div style="display:none" class="text text-danger"></div>');
    cols.Material.append(errorLabel);

    var unitsInput = $('<budget-unit-selector '+(config.material.fixed || config.readonly ? 'disabled' : '')+'></budget-unit-selector>');
    unitsInput.on('units-change', fireUnitsChange);
    cols.Units.append(unitsInput);

    var amountInput = $('<input type="number" class="form-control" style="min-width: 50px" '+(config.readonly ? 'disabled' : '')+' />');
    amountInput.on('input', fireAmountChange);
    cols.Amount.append(amountInput);

    var subtotal = $('<ahb-dollar-label decimal></ahb-dollar-label>');
    cols.SubTotal.append(subtotal);

    var notesInput;
    if( cols.Notes ) {
      notesInput = $('<input type="text" class="form-control" style="min-width: 100px" '+(config.readonly ? 'disabled' : '')+' />');
      notesInput.on('input', updateNotes);
      cols.Notes.append(notesInput);
    }

    cols.Price.css('white-space', 'nowrap');

    var removeBtn;
    if( cols.Remove ) {
      removeBtn = $('<a class="btn btn-link" '+(config.readonly ? 'style="display:none"' : '')+' ><i class="fa fa-trash"></i></a>');
      removeBtn.on('click', fireDelete);
      cols.Remove.append(removeBtn);
    }

    function render() {
      setErrorStatus();

      nameLabel[0].material = config.material.name;
      unitsInput[0].units = config.materialImpl.units
      amountInput.val(parseFloat(config.materialImpl.amount.toFixed(4)));


      cols.Price.html(
        (config.material.price ? config.material.price.toFixed(2) : '') +
        getUnits(config.material)
      );

      setPrice();

      if( cols.Notes ) {
        notesInput.val(config.materialImpl.note);
      }
    }

    function getUnits(material) {
      var u = FB.units.getLabel(material.units, true);
      if( material.type === 'complex' ) {
        if( u === '$' ) {
          return '';
        }
        return ' $/'+u;
      }
      return ' ' + u;
    }

    function setErrorStatus() {
      if( !config.materialImpl.error ) {
        errorLabel.hide();
      } else {
        errorLabel.html(config.materialImpl.message);
        errorLabel.show();
      }
    }

    function updateAmountFromUnits(value) {
      config.materialImpl.amount = value * config.materialImpl.amount;
      amountInput.val(config.materialImpl.amount);
    }

    function fireUnitsChange(e) {
      if( unitTimer == -1 ) clearTimeout(unitTimer);

      unitTimer = setTimeout(function(){
        unitTimer = -1;
        _fireUnitsChange(e);
      }, 200);
    }

    function _fireUnitsChange(e) {
      if( e.originalEvent.detail.error ) return;

      config.materialImpl.units = e.originalEvent.detail.value;

      setErrorStatus();
      config.onUnitsChange(config.materialImpl, e.originalEvent.detail.value);
      setPrice();
    }

    function fireDelete(e) {
      if( Array.isArray(config.complexMaterial.materials) ) {
        for( var i = 0; i < config.complexMaterial.materials.length; i++ ) {
          if( config.complexMaterial.materials[i].id == config.materialImpl.id ) {
            config.complexMaterial.materials.splice(i, 1);
            break;
          }
        }
      } else {
        delete config.complexMaterial.materials[config.material.name];
      }

      $ele.remove();

      config.onDelete(config.materialImpl);
    }

    function fireAmountChange(e) {
      if( amountTimer == -1 ) clearTimeout(amountTimer);

      amountTimer = setTimeout(function(){
        amountTimer = -1;
        _fireAmountChange(e);
      }.bind(), 200);
    }

    function _fireAmountChange(e) {
      config.materialImpl.amount = parseFloat(e.originalEvent.target.value);
      config.materialImpl.originalAmount = config.materialImpl.amount;

      setErrorStatus();
      config.onAmountChange(config.materialImpl, parseFloat(e.originalEvent.target.value));
      setPrice();
    }

    function setPrice() {
      subtotal[0].value = config.materialImpl.price;
    }

    function updateNotes() {
      config.materialImpl.notes = notesInput.val();
    }

    render();

    return {
      updateAmountFromUnits : updateAmountFromUnits
    }

  };
</script>
