<dom-module id="budget-material-info">
  <template>
    <style>
      :host {
        display: none;
      }
      #loading {
        display: none;
        text-align: center;
        padding: 10px;
        font-size: 22px;
      }
      #mainTable {
        font-size: 22px;
      }
    </style>

    <div id="loading">
      <i class="fa fa-spinner fa-spin"></i>
    </div>

    <div id="loaded">
      <h4 id="name" class="page-header" style="margin-top: 5px"></h4>

      <div style="padding: 0 10px">
        <div class="row">
          <div class="col-sm-6">
            <table id="mainTable">
              <tr style="color: #888">
                <td><i class="fa fa-map-marker"></i>&nbsp;</td>
                <td id="locality" style="text-transform:capitalize"></td>
              </tr>
              <tr style="color: #888">
                <td><i class="fa fa-shield"></i>&nbsp;</td>
                <td id="authority"></td>
              </tr>
            </table>
          </div>
          <div class="col-sm-6">
            <div class="well" id="description"></div>
          </div>
        </div>

        <table class="table" style="margin-top: 25px">
          <tr id="yearRow">
            <td><i class="fa fa-hourglass-o"></i> Year</td>
            <td id="year" colspan="2"></td>
          </tr>
          <tr id="classRow">
            <td>Class</td>
            <td id="class" colspan="2"></td>
          </tr>
          <tr id="requiredRow">
            <td>Required Materials</td>
            <td id="required"></td>
            <td id="chart"></td>
          </tr>
        </table>

        <div id="sourcePanel">
          <h5 class="page-header">Source</h5>
          <div id="sourceContent"></div>
        </div>

        <div id="usedBy" style="border-top: 1px solid #ccc"></div>
        <div id="requiredBy"></div>
      </div>
    </div>

  </template>
  <script>
    Polymer({
      is: 'budget-material-info',

      properties : {
        // should be the material id
        material : {
          type : 'string',
          value : function() {
            return ''
          },
          observer : 'update'
        },
        budgetView : {
          type : Boolean,
          value : function() {
            return false
          }
        }
      },

      ready : function() {
        this.showing = false;
      },

      show : function() {
        this.showing = true;
        this.style.display = 'block';
        this.update();
      },

      hide : function() {
        this.style.display = 'none';
        this.showing = false;
      },

      update : function() {
        if( !this.material ) return;
        if( !this.showing ) return;

        //if( this._material && this.material === this._material.getId() ) {
        //  return;
        //}

        try {
          this._material = new SDK.Material(SDK.controllers.material.getById(this.material));
          this.render();
          return;
        } catch(e) {}

        this.loading(true);
        SDK.materials.get(this.material, function(resp){
          this.loading(false);
          if( resp.error ) {
            return alert(resp.message);
          }

          this._material = new SDK.Material(resp);
          this.render();
        }.bind(this));
      },

      render : function() {
        var m = this._material;
        this.$.name.innerHTML =
            '<i class="fa fa-cube' + (m.getType() === 'complex' ? 's' : '') + '"></i> ' +
            m.getName()+
            (m.getType() === 'simple' || this.budgetView ? ' <small><ahb-dollar-label value="'+m.getPrice()+'"></ahb-dollar-label></small>' : '');

        this.$.description.innerHTML = m.getDescription();
        this.$.description.style.display = m.getDescription() ? 'block' : 'none';

        this.$.locality.innerHTML = m.getLocality().join(', ');
        this.$.authority.innerHTML = m.getAuthority();
        this.$.class.innerHTML = m.getClass();

        if( m.getSource() ) {
          this.$.sourcePanel.style.display = 'block';
          this.$.sourceContent.innerHTML = marked(m.getSource());
        } else {
          this.$.sourcePanel.style.display = 'none';
        }

        if( this.budgetView ) {
          this.setUsedByOps();
          this.setRequiredBy();
        } else {
          this.$.usedBy.style.display = 'none';
          this.$.requiredBy.style.display = 'none';
        }


        var errors = m.getErrors();

        if( m.getType() === 'simple' ) {
          this.$.year.innerHTML = m.getYear() || '';
          this.$.requiredRow.style.display = 'none';
        } else {
          this.$.yearRow.style.display = 'none';
          this.$.requiredRow.style.display = 'table-row';

          var unique = m.getUniqueMaterials();
          var materials = m.getRequiredMaterials();
          var list = '<table class="table">'+
            '<tr><th>Material</th>'+
              '<th>Amount</th>'+
              '<th>Units</th>'+
              (this.budgetView ? '<th>Price</th>' : '')+
            '</tr>';



          var chartData = [['Material','%']];

          for( var key in materials ) {
            var rm = materials[key];

            var name;
            if( unique[key] ) {
              name = '*<b>'+key+'</b>';
            } else if( this.budgetView ) {
              name = '<material-label material="'+key+'"></material-label>';
            } else {
              name = key;
            }

            list += '<tr>'+
                    '<td>'+name+'</td>'+
                    '<td>'+rm.amount+'</td>'+
                    '<td><span class="label label-default">'+rm.units+'</span></td>'+
                    (this.budgetView ? '<td><ahb-dollar-label value="'+rm.price+'"></ahb-dollar-label>' : '')+
                  '</tr>';

            if( this.budgetView ) {
              chartData.push([key, parseInt(100*(rm.price / m.getPrice())) ]);
            }

            if( errors && errors.materials && errors.materials[key] ) {
              list += '<tr><td colspan="'+(this.budgetView ? 4 : 3)+'" style="border:none">' +
                        '<ul class="text text-danger"><li>'+errors.materials[key].join('</li><li>')+'</li></ul>'+
                      '</td></tr>';
            }
          }
          list += '</table>';
          if( Object.keys(unique).length > 0 ) {
            list += '<div class="help-block">*Unique Material</div>';
          }

          this.$.required.innerHTML = list;

          if( this.budgetView ) {
            var chart = new google.visualization.PieChart(this.$.chart);
            var s = $(window).width() / 8;
            this.$.chart.style.width = s+'px';
            this.$.chart.style.height = s+'px';
            chart.draw(google.visualization.arrayToDataTable(chartData), {legend: 'none'});
          }
        }
      },

      setUsedByOps : function() {
        this.$.usedBy.style.display = 'block';
        var operations = SDK.controllers.operation.get();
        var usedBy = [];

        for( var i = 0; i < operations.length; i++ ) {
          for( var j = 0; j < operations[i].materials.length; j++ ) {
            if( operations[i].materials[j].name == this._material.getName() ) {
              usedBy.push('<a href="/#budget/operations/'+encodeURIComponent(operations[i].name)+'">'+operations[i].name+'</a>');
              break;
            }
          }
        }
        this.$.usedBy.innerHTML = usedBy.length > 0 ? ('Used in Operation(s): '+usedBy.join(', ')) : '';
      },

      setRequiredBy : function() {
        this.$.requiredBy.style.display = 'block';
        var materials = SDK.controllers.material.get();
        var requiredBy = [];

        for( var name in materials ) {
          if( !materials[name].materials ) continue;
          if( materials[name].materials[this._material.getName()] ) {
            requiredBy.push('<a href="/#budget/materials/'+encodeURIComponent(name)+'">'+name+'</a>');
          }
        }
        this.$.requiredBy.innerHTML = requiredBy.length > 0 ? ('Required By: '+requiredBy.join(', ')) : '';
      },

      loading : function(loading) {
        this.$.loading.style.display = loading ? 'block' : 'none';
        this.$.loaded.style.display = !loading ? 'block' : 'none';
      }
    });
  </script>
</dom-module>
