<dom-module id="budget-total">
  <template>
    <h4 style="text-align:right">Duration: <span class="text text-primary" id="durationText"></span></h4>
    <h4 style="text-align:right">
      Crop Lifetime Total:
      <ahb-dollar-label id="totalLabel"></ahb-dollar-label> <small>Per Acre</small>
    </h4>
    <h4 style="text-align:right">
      Crop Lifetime Total:
      <ahb-dollar-label id="completeTotalLabel"></ahb-dollar-label> <small>Total</small>
    </h4>
    <h4 style="text-align:right">Average Monthly Cost: <ahb-dollar-label id="average"></ahb-dollar-label> <small>Per Acre</small></h4>
    <h4 style="text-align:right">Average Yearly Cost: <ahb-dollar-label id="averageYear"></ahb-dollar-label> <small>Per Acre</small></h4>
  </template>
</dom-module>

<script>
  Polymer({
    is : 'budget-total',

    attached : function() {
      FB.operationController.on('total-update', this.onTotalUpdate.bind(this));

      // make sure a total hasn't already been set
      var total = FB.operationController.getCurrentTotal();
      if( total !== null ) {
        this.onTotalUpdate(total);
      }
    },

    setData : function(farm) {
      this.farm = farm;
      this.onTotalUpdate();
    },

    onTotalUpdate : function(e) {
      if( e ) this.data = e;
      if( !this.data ) return;

      this.$.totalLabel.value = this.data.total / ((this.farm && this.farm.size) ? parseInt(this.farm.size) : 1);

      this.$.completeTotalLabel.value = this.data.total;

      if( this.data.range.start !== null && this.data.range.stop !== null ) {
        var months = this.data.spendingByMonth.length;

        this.$.durationText.innerHTML = months+' months <br /><small>('+this.toDateString(this.data.range.start)+' - '+this.toDateString(this.data.range.stop)+')</small>';

        this.$.average.value = this.data.total / months / ((this.farm && this.farm.size) ? parseInt(this.farm.size) : 1);

        var years = months / 12;
        if( years < 1 ) years = 1;
        this.$.averageYear.value = (this.data.total / years) / ((this.farm && this.farm.size) ? parseInt(this.farm.size) : 1);
      } else {
        this.$.durationText.innerHTML = 'Unknown';
      }
    },

    toDateString : function(d) {
      return (d.getMonth()+1)+'/'+(d.getYear()+1900);
    }
  })
</script>
