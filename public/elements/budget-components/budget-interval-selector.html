<dom-module id="budget-interval-selector">
  <style>
    :host {
      display: block;
      position: relative;
    }
    #inputPanel {
      padding: 0 10px 10px 10px;
      min-width: 300px;
      width: 400px;
      display: none;
      position: absolute;
      margin: 5px;
      border: 1px solid #ccc;
      box-shadow: 0 0 5px #888;
    }
  </style>

  <template>

    <div>
      Schedule: <span>{{displayText}}</span> <a class="btn btn-link" on-click="toggle"><i class="fa fa-pencil"></i></a>
    </div>

    <div id="inputPanel" style="display:none">
      <div style="text-align:right">
        <a class="btn btn-link" on-click="toggle" style="color: #888"><i class="fa fa-remove"></i></a>
      </div>

      <div class="form-horizontal">
        <div class="form-group">
          <label for="scheduleInput" class="col-sm-2 control-label">Schedule</label>
          <div class="col-sm-10">
            <select class="form-control" id="scheduleInput" on-input="onScheduleInput">
              <option value="One Time">One Time</option>
              <option value="Yearly">Yearly</option>
              <option value="Biannually">Biannually</option>
              <option value="Quarterly">Quarterly</option>
              <option value="Custom">Select Dates</option>
            </select>
          </div>
        </div>

        <div class="form-group" id="dates" style="display:none">
          <label for="datesInput" class="col-sm-2 control-label">Dates</label>
          <div class="col-sm-10">
            <input id="datesInput" />

            <div id="selectedDates">
              <template is="dom-repeat" items="{{dateArray}}">
                <div>
                  <span>{{item}}</span> <a class="btn btn-link" index="{{index}}" on-click="removeDate"><i class="fa fa-remove"></i></a><div>
                </div>
              </template>
            </div>
          </div>
        </div>
      </div> <!-- end form -->

    </div> <!-- end input panel -->
  </template>
</dom-module>

<script>
  Polymer({
    is : 'budget-interval-selector',

    ready : function() {
      this.type = '';
      this.dateArray = [];
      this.displayText = '';

      this.data = {
        duration : 36,
        dates : [],
        type : 'One Time'
      };

      $(this.$.datesInput)
        .datepicker({
          format: 'mm/dd/yyyy',
          orientation : 'top auto'
        })
        .on('changeDate', function(e){
          this.data.dates.push(e.date);
          this.update();
          $(this.$.datesInput).datepicker('hide');
        }.bind(this));

      this.update();
    },

    set : function(data) {
      this.data = data;
      this.update();
    },

    onScheduleInput : function(e) {
      this.data.type = e.currentTarget.value;
      this.update();
    },

    update : function() {
      this.type = this.data.type;



      if( this.type == 'Custom' ) {
        this.$.dates.style.display = 'block';
        this.displayText = this.type+' (x'+this.data.dates.length+')';
      } else {
        this.$.dates.style.display = 'none';

        if( this.type == 'One Time') this.displayText = this.type+' (x1)';
        else if( this.type == 'Yearly') this.displayText = this.type+' ('+Math.ceil(this.data.duration/12)+' x 1)';
        else if( this.type == 'Biannually') this.displayText = this.type+' ('+Math.ceil(this.data.duration/12)+' x 2)';
        else if( this.type == 'Quarterly') this.displayText = this.type+' ('+Math.ceil(this.data.duration/12)+' x 4)';
      }

      var tmp = [];
      for( var i = 0; i < this.data.dates.length; i++ ) {
        tmp.push(this.toDateString(this.data.dates[i]));
      }
      this.dateArray = tmp;
    },

    toDateString : function(date) {
      return (date.getYear()+1900)+'-'+(date.getMonth()+1)+'-'+(date.getDate());
    },

    removeDate : function(e) {
      var index = parseInt(e.currentTarget.getAttribute('index'));
      this.dateArray.splice(index, 1);
      this.data.dates.splice(index, 1);
    },

    toggle : function() {
      if( this.$.inputPanel.style.display == 'none' ) {
        this.$.inputPanel.style.top = $(this).height()+'px';
        this.$.inputPanel.style.display = 'block';
      } else {
        this.$.inputPanel.style.display = 'none';
      }
    }
  });
</script>
