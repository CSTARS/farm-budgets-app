<!-- reusable popup for complex materials -->
<link rel="import" href="budget-material-advanced.html" />


<dom-module id="budget-material-popup">
  <template>
    <div class="modal fade" id="popup">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" aria-label="Close" on-click="cancel"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title" id="title"></h4>
          </div>
          <div class="modal-body">


            <div class="form-horizontal" id="simplePanel">

              <div id="parentMaterial"></div>
              <div class="form-group">
                <label for="nameInput" class="col-sm-3 control-label">Name</label>
                <div class="col-sm-9">
                  <input type="text" id="nameInput" class="form-control" on-input="onNameInput" />
                  <div class="text text-danger" id="nameInputMessage"></div>
                </div>
              </div>

              <div class="form-group">
                <label for="nameInput" class="col-sm-3 control-label">Description</label>
                <div class="col-sm-9">
                  <textarea id="descriptionInput" class="form-control" on-input="onDescriptionInput"></textarea>
                </div>
              </div>

              <div class="form-group" id="unitsGroup">
                <label for="unitsInput" class="col-sm-3 control-label">Units</label>
                <div class="col-sm-9">
                  <div class="layout horizontal center">
                    <div>us$/</div>
                    <div class="flex">
                      <budget-unit-selector id="unitsInput" on-units-change="editUnits" block></budget-unit-selector>
                    </div>
                  </div>

                  <div id="unitsInputMsg"></div>
                </div>
              </div>

              <div class="form-group" id="priceGroup">
                <label for="priceInput" class="col-sm-3 control-label" id="priceLabel">Price</label>
                <div class="col-sm-9">
                  <input type="number" id="priceInput" class="form-control" on-input="onPriceInput"/>
                  <!--
                    <div class="help-block animated slideInRight" id="priceMessage" style="display:none">*A base price is not required for complex materials.</div>
                  -->
                </div>
              </div>

              <div class="form-group" id="complexGroup">
                <label class="col-sm-3 control-label"><i class="fa fa-cubes"></i></label>
                <div class="col-sm-9">
                  <div class="checkbox">
                    <label>
                      <input type="checkbox" id="isComplexInput" on-click="toggleComplex"> Is complex material
                    </label>
                  </div>
                  <div class="help-block">This material requires other materials.</div>
                </div>
              </div>

            </div> <!-- end form -->

            <div id="complexPanel" style="display:none" class="animated fadeIn">
              <h4>Required Materials</h4>

              <div class="form-horizontal" style="margin: 25px 0">
                <div class="form-group">
                  <label for="materialSearchInput" class="col-sm-3 control-label">Add Materials</label>
                  <div class="col-sm-9">
                    <budget-material-search on-material-select="onMaterialSelect"></budget-material-search>

                    <a style="cursor:pointer" on-click="toggleUnique"><i class="fa fa-plus"></i> Create Unique Material</a>


                    <div id="createUniquePanel" style="display:none">
                      <div class="help-block">Create a new required material that is unqiue (only used by) the
                        <span id="nameLabel"></span> material.</div>

                      <div class="form-horizontal" >

                        <div class="form-group">
                          <label for="optionInput" class="col-sm-2 control-label">Class</label>
                          <div class="col-sm-10">
                            <budget-class-selector id="uniqueClassInput" on-change="onUniqueClassChange"></budget-class-selector>
                          </div>
                        </div>

                        <div class="form-group">
                          <label for="uniqueNameInput" class="col-sm-2 control-label">Name</label>
                          <div class="col-sm-10">
                            <input type="text" id="uniqueNameInput" class="form-control" />
                          </div>
                        </div>

                        <div class="form-group" id="unitsGroup">
                          <label for="uniqueUnitsInput" class="col-sm-2 control-label">Units</label>
                          <div class="col-sm-10">
                            <div class="layout horizontal center">
                              <div>us$/</div>
                              <div class="flex">
                                <budget-unit-selector id="uniqueUnitsInput" block></budget-unit-selector>
                              </div>
                            </div>
                          </div>
                        </div>

                        <div class="form-group">
                          <label for="uniquePriceInput" class="col-sm-2 control-label">Price</label>
                          <div class="col-sm-10">
                            <input type="number" id="uniquePriceInput" class="form-control" />
                          </div>
                        </div>

                        <div class="form-group" id="unitsGroup">
                          <label class="col-sm-3 control-label"></label>
                          <div class="col-sm-9">
                            <div id="createUniqueMsg" class="text text-danger"></div>
                            <a class="btn btn-primary" on-click="createUnique">Create</a>
                            <a class="btn btn-cancel" on-click="cancelCreateUnique">Cancel</a>
                          </div>
                        </div>
                      </div> <!-- end form -->
                    </div> <!-- end create unique panel -->

                  </div>
                </div>

              </div> <!-- end form -->

              <budget-materials-table id="materialTable" on-price-change="onPriceChange" on-delete="onMaterialDelete"></budget-materials-table>

              <h4>Price <small ><span id="current-price"></span> <span id="current-units"></span></small></h4>

            </div>

            <budget-material-advanced id="advancedPanel" style="display:none" on-close-advanced="hideAdvanced"></budget-material-advanced>

            <div class="horizontal layout center" id="footer">
              <div class="flex">
                <a class="btn btn-link" on-click="delete"><i class="fa fa-trash"></i> Delete</a>
                <a class="btn btn-link" on-click="toggleAdvanced"><i class="fa fa-cog"></i> Advanced</a>
              </div>
              <div style="text-align:right">
                <a class="btn btn-primary" on-click="save">Save</a>
                <a class="btn btn-cancel" on-click="cancel">Cancel</a>
              </div>
            </div>


          </div> <!-- /.modal-body -->
        </div><!-- /.modal-content -->
      </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->
  </template>
</dom-modle>

<script>
  Polymer({
    is : 'budget-material-popup',

    ready : function() {
      this.popup = $(this.$.popup).modal({show: false, backdrop: 'static'});
      this.showingAdvanced = false;

      this.materialTableOptions = {
        noNotes: true
      };

      $(window).on('hashchange', function(){
        if( !this.showing ) return;

        // when we manually hit the back button bellow this event will be
        // triped again.  you can ignore it.
        if( this.ignoreNextHashEvent ) {
          this.ignoreNextHashEvent = false;
          return;
        }

        if( confirm('Do you want to save and close?') ) {
          this.save();
        } else {
          this.ignoreNextHashEvent = true;
          window.history.back();
        }
      }.bind(this));
    },

    show : function() {
      this.showing = true;
      this.popup.modal('show');
    },

    hide : function() {
      this.showing = false;
      this.popup.modal('hide');
    },

    hideAdvanced : function() {
      this.$.simplePanel.style.display = 'block';
      this.$.footer.style.display = 'flex';
      if( this.data.type == 'complex' ) {
        this.$.complexPanel.style.display = 'block';
      }
      this.$.advancedPanel.style.display = 'none';
      this.showingAdvanced = false;
    },

    toggleAdvanced : function() {
      if( !this.showingAdvanced ) {
        this.$.simplePanel.style.display = 'none';
        this.$.complexPanel.style.display = 'none';
        this.$.advancedPanel.style.display = 'block';
        this.$.footer.style.display = 'none';
        this.showingAdvanced = true;
      } else {
        this.hideAdvanced();
      }
    },

    cancel : function() {
      // remove any unique materials as they were added to the material
      // controller so things didn't break
      if( this.data.type == 'complex' ) {
        for( var key in this.data.materials ) {
          if( key.match(/--/) ) {
            FB.materialController.remove(key);
          }
        }
      }

      // if we were creating
      if( this.action == 'create' ) {
        // not sure we need to do anything right now...

      // cancel an edit
      } else {
        var materials = []

        // reset any original unique materials
        for( var i = 0; i < this.originalUniqueMaterials.length; i++ ) {
          materials.push(this.originalUniqueMaterials[i]);
        }
        materials.push(this.originalData);

        FB.materialController.bulkAdd(materials, {replace: true});
      }

      this.hide();
    },

    edit : function(material, creatingUniqueName) {
      if( this.showing && this.data.name != material.name ) {
        if( confirm('Do you want to save your changes before editing new material?') ) {
          this.save(true);
        } else {
          return;
        }
      }

      this.action = 'edit';
      this.$.title.innerHTML = '<i class="fa fa-pencil"></i> Edit Material';

      this.data = material;
      this.$.advancedPanel.data = material;

      // make a copy for if we cancel
      this.originalData = $.extend(true, {}, this.data);
      this.originalUniqueMaterials = [];

      if( this.data.name.match(/--/) ) {
        var parts = this.data.name.split('--');
        this.parentMaterial = parts[0];
        this.$.parentMaterial.innerHTML = '<h5 style="border-bottom: 1px solid #ccc; text-align:center">Parent: '+parts[0]+'</h5>';
        this.$.nameInput.value = parts[1];

        this.$.complexGroup.style.display = 'none';
      } else {
        this.$.complexGroup.style.display = 'block';
        this.$.parentMaterial.innerHTML = '';
        this.$.nameInput.value = this.data.name;
      }

      this.$.descriptionInput.value = this.data.description || '';
      this.$.unitsInputMsg.innerHTML = '';

      if( this.data.type == 'complex' ) {
        this.setComplex(true);
        this.$.unitsInput.setUnits(this.data.units);

        this.$.priceInput.value = '';

        // keep track of what we assume the amounts for this material are expecting
        this.materialUnits = this.data.units;

        // snapshot all definitions of unique materials
        for( var key in this.data.materials ) {
          if( key.match(/--/) ) {
            this.originalUniqueMaterials.push($.extend(true, {}, FB.materialController.get(key)));
          }
        }

      } else {
        this.$.unitsInput.setUnits(FB.units.invert(this.data.units));
        this.$.priceInput.value = this.data.price;
        this.setComplex(false);
      }

      if( creatingUniqueName ) {
        this.$.uniqueNameInput.value = creatingUniqueName;
        $(this.$.createUniquePanel).show();
      }

      this.recalc();

      this.show();
    },

    create : function(name) {
      var root = '';
      if( name && name.indexOf('--') > -1 ) {
        root = name.split('--')[0];
      }


      if( this.showing && !(this.action == 'edit' && this.data.name == root) ) {
        if( confirm('Do you want to save your changes before creating new material?') ) {
          this.save(true);
        } else {
          return;
        }
      }

      // see if we actually are trying to create a unique child
      if( root ) {
        var parts = name.split('--');
        var m = FB.materialController.get(parts[0]);
        if( m.type == 'complex' ) {
          this.edit(m, parts[1]);
          return;
        }
      }

      this.data = {
        type : 'simple',
        name : name || '',
        units : '',
        description : '',
        price : 0
      };
      this.action = 'create';

      this.$.title.innerHTML = '<i class="fa fa-cube"></i> Create Material';
      this.$.complexGroup.style.display = 'block';

      this.$.nameInput.value = name || '';
      this.$.unitsInput.setUnits('');
      this.$.unitsInputMsg.innerHTML = '';
      this.$.priceInput.value = '';
      this.$.descriptionInput.value = '';
      this.setComplex(false);

      this.parentMaterial = null;
      this.$.parentMaterial.innerHTML = '';

      this.show();
    },

    onMaterialSelect : function(e) {
      var materialDef = e.detail;

      var materialImpl = {
        name : materialDef.name,
        amount : 1
      }

      if( materialDef.type == 'complex' ) {
        materialImpl.units = materialDef.units;
      } else {
        materialImpl.units = FB.units.invert(materialDef.units);
      }

      this.data.materials[materialImpl.name] = materialImpl;
      this.recalc();
    },


    setComplex : function(isComplex) {
      // regarless, dismiss the units exhange message
      this.$.unitsInputMsg.innerHTML = '';

      if( isComplex ) {
        this.$.isComplexInput.setAttribute('checked', 'checked');
        this.$.isComplexInput.checked = true;
        this.$.complexPanel.style.display = 'block';

        this.$.priceGroup.style.display = 'none';

        this.$.materialTable.setMaterials(this.data, this.materialTableOptions);
        this.updatePriceLabel();
      } else {
        this.$.isComplexInput.removeAttribute('checked');
        this.$.isComplexInput.checked = false;
        this.$.complexPanel.style.display = 'none';

        this.$.priceGroup.style.display = 'block';
      }
    },

    save : function(noHide) {
      if( this.data.name == '' ) {
        this.$.nameInputMessage.innerHTML = 'A material name is required';
        return;
      } else if( this.data.name.indexOf('--') > -1 ) {
        this.$.nameInputMessage.innerHTML = '"--" is reserved and not allowed in the material name.';
        return;
      }
      this.$.nameInputMessage.innerHTML = '';

      this.$.advancedPanel.save();

      var options = {};
      if( this.action == 'edit' ) {
        options.replace = true;

        // if the name has changed, make sure we preform a rename
        if( this.originalData.name != this.data.name ) {
          options.rename = this.originalData.name;
        }
      }

      var result = FB.materialController.add(this.data, options);

      if( result.error ) {
        return alert(result.message);
      }

      // now re-save all required materials, this time we will fire events
      var materials = [];
      if( this.data.type == 'complex' ) {
        for( var key in this.data.materials ) {
          var m = FB.materialController.get(key);
          if( !m.error ) {
            materials.push(m);
          }
        }
      }
      FB.materialController.bulkAdd(materials, {replace: true});

      if( typeof noHide !== 'boolean' || !noHide ) this.hide();
    },

    delete : function() {
      if( !confirm('Are you sure you want to delete this material?') ) return;

      var usedBy = {
        operations : [],
        materials : []
      };

      var operations = FB.operationController.get();
      for( var i = 0; i < operations.length; i++ ) {
        if( !operations[i].materials ) continue;
        if( operations[i].materials[this.data.name] ) {
          usedBy.operations.push(operations[i]);
        }
      }

      var materials = FB.materialController.get().complex;
      for( var key in materials ) {
        if( !materials[key].materials ) continue;
        if( materials[key].materials[this.data.name] ) {
          usedBy.materials.push(materials[key]);
        }
      }

      if( usedBy.operations.length > 0 || usedBy.materials.length > 0 ) {
        if( !confirm('This material is used by '+usedBy.operations.length+' operation(s) and '+usedBy.materials.length+' material(s).  '+
              'Are you still sure you want to delete?  It will be removed from these operations and materials.') ) {
          return;
        }
      }

      // remove from all operations
      var updates = usedBy.operations;
      for( var i = 0; i < usedBy.operations.length; i++ ) {
        delete usedBy.operations[i].materials[this.data.name];
      }
      FB.operationController.bulkAdd(updates, {replace: true});

      // remove from all materials
      updates = usedBy.materials;
      for( var i = 0; i < usedBy.materials.length; i++ ) {
        delete usedBy.materials[i].materials[this.data.name];
      }

      // remove this item
      FB.materialController.remove(this.data.name);

      // if this is complex and has unique materials, remove those as well
      if( this.data.type == 'complex' ) {
        for( var key in this.data.materials ) {
          if( key.match(/--/) ) {
            FB.materialController.remove(key);
          }
        }
      }

      FB.materialController.bulkAdd(updates, {replace: true});

      this.hide();
    },

    /**
     * Start fired by the material table
     */
    onPriceChange : function() {
      FB.materialController.materialRecalc(this.data);

      // do not call recalc, will update material table
      this.updatePriceLabel();
    },

    onMaterialDelete : function(e) {
      this.updatePriceLabel();
    },
    /**
     * End fired by the material table
     */

    /**
     * Start main input control Fn's
     */
    onNameInput : function() {
      var newName = this.$.nameInput.value;

      if( this.parentMaterial ) {
        newName = this.parentMaterial+'--'+newName;
      }

      if( this.data.name == newName || newName == '' ) return;

      var m = FB.materialController.get(newName);
      if( !m.error ) {
        this.$.nameInputMessage.innerHTML = 'A material with this name already exists';
        return;
      }
      this.$.nameInputMessage.innerHTML = '';

      this.$.nameLabel.innerHTML = newName;
      this.data.name = newName;

      // if complex, we need to update the name of all unique materials
      if( this.data.type == 'complex' ) {
        var updated = [];

        for( var key in this.data.materials ) {

          // only want to update unique stuff
          if( key.indexOf('--') > -1 ) {
            // first lets update impl
            var m = this.data.materials[key];
            delete this.data.materials[key];
            var newName = this.data.name+'--'+m.name.replace(/.*--/, '');
            m.name = newName;
            updated.push(m);

            // now update def
            m = FB.materialController.get(key);
            if( m.error ) {
              console.log('BADNESS!');
              continue;
            }
            m.name = newName;

            FB.materialController.add(m, {
              rename: key,
              noRecalc : true,
              noEvent : true
            });

          }
        }

        for( var i = 0; i < updated.length; i++ ) {
          this.data.materials[updated[i].name] = updated[i];
        }

        this.$.materialTable.setMaterials(this.data, this.materialTableOptions);
      }
    },

    onDescriptionInput : function() {
      this.data.description = this.$.descriptionInput.value;
    },

    recalc : function() {
      FB.materialController.materialRecalc(this.data);

      if( this.data.type == 'complex' ) {
        this.$.materialTable.setMaterials(this.data, this.materialTableOptions);
        this.updatePriceLabel();
      }
    },

    updatePriceLabel : function() {
      this.$['current-price'].innerHTML = '$'+this.data.price.toFixed(2);

      var label = FB.units.getLabel(this.data.units);
      if( label != '' ) label = 'per '+label;
      this.$['current-units'].innerHTML = label;
    },

    onPriceInput : function() {
      var val = this.$.priceInput.value;

      /* BASEPRICE
      if( val == '' && this.data.type == 'complex' ) {
        FB.materialController.remove(this.getBasePriceName());
        delete this.data.materials[this.getBasePriceName()];
        this.recalc();
        return;
      } */

      var val = parseFloat(val);
      if( isNaN(val) ) return;

      this.data.price = val;

      this.recalc();
    },

    toggleComplex : function() {
      if( !this.data ) return;

      if( this.data.materials ) {
        var keys = Object.keys(this.data.materials).length;

        // BASEPRICE
        // var hasBase = this.data.materials[this.getBasePriceName()];
        // if( keys === 0 || (keys === 1 && hasBase) ){
        if( keys === 0 ){
          delete this.data.materials;
          delete this.data.class;
          this.data.type = 'simple';

          if( this.data.units ) {
            this.data.units = FB.units.invert(this.data.units);
          }

          this.setComplex(false);

        } else if ( confirm('Are your sure you want to make this a simple material?  All required '+
              'materials will be removed') ) {

          delete this.data.materials;
          delete this.data.class;
          this.data.type = 'simple';
          if( this.data.units ) {
            this.data.units = FB.units.invert(this.data.units);
          }

          this.setComplex(false);
        } else {
          this.setComplex(true);
        }

      } else {
        this.data.type = 'complex';
        this.data.materials = {};

        if( this.data.units ) {
          this.data.units = FB.units.invert(this.data.units);
        }

        // as there a simple price set?  make it the base price material
        if( this.data.price !== undefined ) {
          var price = parseFloat(this.$.priceInput.value);

          if( !isNaN(price) ) {

            this.data.materials.Estimate = {
              amount : price,
              units : 'us$'
            }

            this.recalc();
          }
        }


        this.setComplex(true);
      }
    },

    editUnits : function(e) {
      if( this.editUnitsTimer != -1 ) clearTimeout(this.editUnitsTimer);
      this.editUnitsTimer = setTimeout(function(){
        this.editUnitsTimer = -1;
        this._editUnits(e);
      }.bind(this), 200);
    },

    _editUnits : function(e) {
      if( e.detail.error ) return;

      if( this.data.type == 'complex' ) {
        //var oldUnits = this.data.units;
        var newUnits = e.detail.value;

        this.handleAmountUnitChange(newUnits)

        this.data.units = newUnits;
      } else {
        this.$.unitsInputMsg.innerHTML = '';
        this.data.units = FB.units.invert(e.detail.value);
      }

      this.recalc();
    },

    handleAmountUnitChange : function(newUnits) {
      if( !this.materialUnits || this.materialUnits == newUnits || Object.keys(this.data.materials).length == 0 ) {
        this.$.unitsInputMsg.innerHTML = '';
        return;
      }

      // prompt for update of child material amounts
      var prompt = $(
        '<div class="alert alert-dismissable alert-warning" style="margin-top: 5px">'+
          '<button type="button" class="close">×</button>'+
          '<h4>Question!</h4>'+
          '<p>You have updated your materials units from <b>'+this.materialUnits+'</b> to <b>'+newUnits+'</b>. '+
          'You should probably convert the amounts of each required material to match the unit change.</p>'+
          '<div class="layout horizontal" style="margin-top: 5px">'+
            '<div class="flex">'+
              '<button class="btn btn-default" convert>Convert '+this.materialUnits+'<i class="fa fa-long-arrow-right"></i>'+newUnits+'</button>'+
            '</div><div>'+
              '<button class="btn btn-warning" close>Ignore</button>'+
            '</div>'+
          '</div>'+
        '</div>'
      );
      $(this.$.unitsInputMsg).html('').append(prompt);

      prompt
        .find('[convert]')
        .on('click', function(){
          var error = this.$.materialTable.updateAmountFromUnits(this.materialUnits, newUnits);
          if( error ) {
            return alert(error.message);
          }

          this.materialUnits = newUnits;
          this.$.unitsInputMsg.innerHTML = '';
          this.recalc();
        }.bind(this));

      prompt
        .find('.close, [close]')
        .on('click', function(){
          this.materialUnits = newUnits;
          this.$.unitsInputMsg.innerHTML = '';
          this.recalc();
        }.bind(this));
    },


    /**
     * End main input control Fn's
     */


    /**
     * Start Create Unique Fn's
     */
    createUnique : function() {
      var data = {
        class : this.$.uniqueClassInput.getValue(),
        name : this.$.uniqueNameInput.value,
        units : this.$.uniqueUnitsInput.getUnits(),
        price : parseFloat(this.$.uniquePriceInput.value)
      }

      if( data.name == '' ) {
        this.$.createUniqueMsg.innerHTML = 'You must provide a material name';
        return;
      } else if( isNaN(data.price) ) {
        this.$.createUniqueMsg.innerHTML = 'Invalid price';
        return;
      } else if( this.$.uniqueUnitsInput.error ) {
        this.$.createUniqueMsg.innerHTML = 'You must provide valid units';
        return;
      }

      // we are almost good to go
      // update name
      data.name = this.data.name+'--'+data.name;
      data.units = 'us$/'+data.units;

      // add to global controller, make sure no issues
      var resp = FB.materialController.add(data, {
        replace : true,
        noRecalc : true,
        noEvent : true
      });
      if( resp.error ) {
        this.$.createUniqueMsg.innerHTML = resp.message;
        return;
      }

      // do we need to add a simple impl?
      if( !this.data.materials[data.name] ) {
        var impl = {
          name : data.name,
          amount : 1,
          units : FB.units.invert(data.units)
        }
        this.data.materials[impl.name] = impl;
      }


      this.recalc();

      // this just resets and hides
      this.cancelCreateUnique();
    },

    onUniqueClassChange : function() {
      if( this.$.uniqueNameInput.value == '' || this.$.uniqueClassInput.isClass(this.$.uniqueNameInput.value) ) {
        this.$.uniqueNameInput.value = this.$.uniqueClassInput.getValue();
      }
    },

    cancelCreateUnique : function() {
      this.$.uniqueNameInput.value = '';
      this.$.uniqueUnitsInput.units = '';
      this.$.uniquePriceInput.value = '';
      this.$.createUniqueMsg.innerHTML = '';

      this.toggleUnique();
    },

    toggleUnique : function() {
      $(this.$.createUniquePanel).toggle();
    },
    /**
     * End Create Unique Fn's
     */
  })
</script>
