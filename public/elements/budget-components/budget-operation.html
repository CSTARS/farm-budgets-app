<link rel="import" href="budget-operation-scheduler.html" />

<dom-module id="budget-operation">
  <style>
    :host {
      display: block;
      padding: 15px;
      margin: 15px;
      box-shadow: 0 0 8px #ccc;
    }
  </style>

  <template>

    <h4 class="page-header" style="margin-top: 5px; text-transform: capitalize">
      <div style="margin-bottom: 5px"><a on-click="toggleContent" class="btn btn-default" style="font-size:17px"><i class="fa fa-toggle-right" id="icon"></i></a>

      <input type="text" class="form-control" style="display:none; width: 300px" id="nameInput" on-keyup="onNameInputKeyUp" on-blur="saveNewName" />
      <span id="nameLabel" style="cursor:pointer" on-mouseenter="onMouseEnterName" on-mouseleave="onMouseLeaveName" on-click="editName" ></span>
      <span id="nameMsg" class="text text-danger" style="font-size: 14px"></span>
      <i class="fa fa-pencil" style="display:none" id="renameIcon"></i>

      <i class="fa fa-warning text text-danger" style="display:none" id="errorIcon"></i>
    </h4>

    <div class="row">
      <div class="col-sm-8">
        <h5>
          <budget-operation-scheduler on-schedule-update="onScheduleUpdate" id="schedule"></budget-operation-scheduler>
        </h5>
      </div>
      <div class="col-sm-4">
        <table class="padding: 15px">
          <tr>
            <td><h4>Subtotal</h4></td>
            <td style="padding-left: 10px ">
              <h4 class="text text-success"><ahb-dollar-label id="subtotal"></ahb-dollar-label>
              <span id="subtotalInfo"></span></h4>
            </td>
          </tr>
          <tr>
            <td><h4>Total</h4></td>
            <td style="padding-left: 10px "><h4 class="text text-success" ><ahb-dollar-label id="total"></ahb-dollar-label></h4></td>
          </tr>
        </table>
      </div>
    </div>

    <div id="content" style="display:none" class="animated zoomIn">
      <div class="form-horizontal" style="margin: 25px 0 ">
        <div class="form-group">
          <label for="materialSearchInput" class="col-sm-3 control-label">Add Materials</label>
          <div class="col-sm-9">
            <budget-material-search on-material-select="onMaterialSelect"></budget-material-search>
          </div>
        </div>
      </div>

      <budget-materials-table id="materialTable" on-price-change="updateTotals" on-delete="onMaterialDelete"></budget-materials-table>
    </div>

  </template>
</dom-module>

<script>
  Polymer({
    is : 'budget-operation',

    properties : {
      operationname : {
        type : String,
        observer : 'update'
      }
    },

    ready : function() {
      this.firstScheduleEvent = true;
      FB.operationController.on('operation-update', this.onOperationUpdate.bind(this));
    },

    attached : function() {
      if( this.operation ) this.update();
    },

    // fired from operation controller
    onOperationUpdate : function(operation) {
      if( !this.operation ) return;
      if( operation.name != this.operation.name ) return;

      this.render();
    },

    // fire from schedule element
    onScheduleUpdate : function(e) {
      if( !this.operation ) return;

      this.operation.schedule = e.detail;
      FB.operationController.recalc();
      this.updateTotals();
    },

    update : function() {
      this.operation = FB.operationController.get(this.operationname);
      this.$.schedule.set(this.operation.schedule, this.operation.name);
      this.render();
    },

    showError : function(show) {
      if( show ) this.$.errorIcon.style.display = 'inline';
      else this.$.errorIcon.style.display = 'none';
    },

    checkError : function() {
      for( var i = 0; i < this.operation.materials.length; i++ ) {
        if( this.operation.materials[i].error ) {
          this.showError(true);
          return;
        }
      }
      this.showError(false);
    },

    render : function() {
      if( !this.$.materialTable.setMaterials ) return;

      this.$.nameLabel.innerHTML = this.operation.name;

      if( !this.operation.materials ) return;

      this.$.materialTable.setMaterials(this.operation, {isOperation : true});
      this.updateTotals();
      this.checkError();
    },

    updateTotals : function() {
      var scheduled = this.operation.schedule ? this.operation.schedule.length : 0;
      $(this.$.total).attr('value', this.operation.total);
      $(this.$.subtotal).attr('value', this.operation.subtotal);
      $(this.$.subtotalInfo).html('<span style="color:#888">x'+scheduled+'</span>');
    },

    onMaterialDelete : function(e) {
      FB.operationController.add(this.operation, {replace: true});
      this.updateTotals();
    },

    onMaterialSelect : function(e) {
      var material = e.detail;

      FB.operationController.addUpdateMaterial(
        this.operation,
        {
          name : material.name,
          amount : 1,
          units : material.units
        }
      );

      FB.operationController.add(this.operation, {replace: true});
      this.render();
    },

    toggleContent : function() {
      if( this.$.content.style.display == 'block' ) {
        this.$.content.style.display = 'none'
        this.$.icon.className = 'fa fa-toggle-right';
      } else {
        this.$.content.style.display = 'block'
        this.$.icon.className = 'fa fa-toggle-down';
      }
    },

    onMouseEnterName : function() {
      this.$.renameIcon.style.display = 'inline-block';
    },

    onMouseLeaveName : function() {
      this.$.renameIcon.style.display = 'none';
    },

    editName : function() {
      this.$.nameLabel.style.display = 'none';
      this.$.nameInput.style.display = 'inline-block';
      this.$.nameInput.value = this.operation.name;
      this.$.nameInput.focus();
    },

    onNameInputKeyUp : function(e) {
      if( e.which == 13 ) this.$.nameInput.blur();
    },

    saveNewName : function() {
      if( this.$.nameInput.value.replace(/\s/g, '') == '' ) {
        this.$.nameMsg.innerHTML = 'Invalid Name.';
        return;
      }

      var op = FB.operationController.get(this.$.nameInput.value);
      if( !op.error && this.operation.name !== this.$.nameInput.value ) {
        this.$.nameMsg.innerHTML = 'Invalid Name. An operation with this name already exists';
        return;
      }

      this.$.nameMsg.innerHTML = '';
      var oldName = this.operation.name;
      this.operation.name = this.$.nameInput.value;
      this.$.nameLabel.innerHTML = this.operation.name;
      this.$.nameLabel.style.display = 'inline-block';
      this.$.nameInput.style.display = 'none';

      FB.operationController.add(this.operation,
          {
            noRecalc: true,
            noEvents: true,
            rename : oldName
          }
      );
    }

  });
</script>
