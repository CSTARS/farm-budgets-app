<link rel="import" href="budget-operation-scheduler.html" />

<dom-module id="budget-operation">
  <style>
    :host {
      display: block;
      border-bottom: 1px solid #ccc;
    }
  </style>

  <template>

    <div class="row">
      <div class="col-sm-8">
        <h4>
          <div style="margin-bottom: 5px"><a on-click="toggleContent" style="cursor:pointer"><i class="fa fa-toggle-right" id="icon"></i></a>
            <span id="nameLabel"></span>
            <i class="fa fa-warning text text-danger" style="display:none" id="errorIcon"></i>
          </div>
          <small><budget-operation-scheduler on-schedule-update="onScheduleUpdate" id="schedule"></budget-operation-scheduler></small>
        </h4>
      </div>
      <div class="col-sm-4">
        <table class="padding: 15px">
          <tr>
            <td><h4>Subtotal</h4></td>
            <td style="padding-left: 10px ">
              <h4 class="text text-success"><ahb-dollar-label id="subtotal"></ahb-dollar-label>
              <span id="subtotalInfo"></span></h4>
            </td>
          </tr>
          <tr>
            <td><h4>Total</h4></td>
            <td style="padding-left: 10px "><h4 class="text text-success" ><ahb-dollar-label id="total"></ahb-dollar-label></h4></td>
          </tr>
        </table>
      </div>
    </div>

    <div id="content" style="display:none" class="animated slideInRight"></div>

  </template>
</dom-module>

<script>
  Polymer({
    is : 'budget-operation',

    properties : {
      operationid : {
        type : String,
        observer : 'update'
      }
    },

    ready : function() {
      FB.operationController.on('operation-update', this.onOperationUpdate.bind(this));
    },

    attached : function() {
      if( this.operation ) this.render();
    },

    // fired from operation controller
    onOperationUpdate : function(operation) {
      if( !this.operation ) return;
      if( operation.id != this.operation.id ) return;

      this.render();
    },

    // fire from schedule element
    onScheduleUpdate : function(e) {
      if( !this.operation ) return;

      this.operation.schedule = e.detail;
      FB.operationController.recalc();
      this.updateTotals();
    },

    update : function() {
      this.operation = FB.operationController.get(this.operationid);
      this.$.schedule.set(this.operation.schedule);
      this.render();
    },

    showError : function(show) {
      if( show ) this.$.errorIcon.style.display = 'inline';
      else this.$.errorIcon.style.display = 'none';
    },

    render : function() {
      this.$.nameLabel.innerHTML = this.operation.name;
      this.showError(false);

      this.$.content.innerHTML = '';
      if( !this.operation.materials ) return;

      this.materialsArray = [];
      var html = '<table class="table"><tr><th>Material</th><th>Notes</th><th>Amount</th><th>Price</th></tr>';

      for( var m in this.operation.materials ) {
        var materialDef = FB.materialController.get(m);
        var materialImpl = this.operation.materials[m];

        if( materialImpl.error ) {
          this.showError(true);
          html += '<tr><td colspan="4"><div class="text text-danger">'+this.operation.materials[m].error.message+'</div></td>';
          continue;
        }
        if( materialDef.type == 'complex' ) {
          html += '<tr><td><budget-macro material="'+m+'"></budget-macro></td>';
        } else {
          html += '<tr><td><budget-material material="'+m+'"></budget-material></td>';
        }
        html += '<td><input type="text" class="form-control" value="'+(materialImpl.note ? materialImpl.note.replace(/"/g,'\'') : '')+'" /></td>'+
                '<td><input type="number" class="form-control op-amount" material="'+m+'" style="max-width: 100px" value="'+this.operation.materials[m].amount+'" /></td>'+
                '<td class="price" material="'+m+'"><ahb-dollar-label value="'+this.operation.materials[m].price.toFixed(2)+'"></ahb-dollar-label></td></tr>';
      }

      this.$.content.innerHTML = html+'</table>';

      this.updateTotals();

      $(this.$.content)
        .find('input.op-amount')
        .on('change', function(e){
          var ele = $(e.currentTarget);
          var material = ele.attr('material');

          var m = this.operation.materials[material];
          m.amount = parseInt(ele.val());

          FB.operationController.recalc();

          $(this.$.content).find('.price[material="'+material+'"] ahb-dollar-label').attr('value', m.price.toFixed(2));
        this.updateTotals();
        }.bind(this));

      $(this.$.content)
        .find('budget-macro')
        .on('units-change', function(e){
          var ele = $(e.currentTarget);
          var material = ele.attr('material');

          var m = this.operation.materials[material];
          m.units = e.originalEvent.detail;

          FB.operationController.recalc();

          $(this.$.content).find('.price[material="'+material+'"] ahb-dollar-label').attr('value', m.price.toFixed(2));
          this.updateTotals();
        }.bind(this));
    },

    updateTotals : function() {
      var scheduled = this.operation.schedule ? this.operation.schedule.length : 0;
      $(this.$.total).attr('value', this.operation.total);
      $(this.$.subtotal).attr('value', this.operation.subtotal);
      $(this.$.subtotalInfo).html('<span style="color:#888">x'+scheduled+'</span>');
    },

    toggleContent : function() {
      if( this.$.content.style.display == 'block' ) {
        this.$.content.style.display = 'none'
        this.$.icon.className = 'fa fa-toggle-right';
      } else {
        this.$.content.style.display = 'block'
        this.$.icon.className = 'fa fa-toggle-down';
      }
    }

  });
</script>
