<dom-module id="budget-material-list-item">
  <template>
    <style>
      :host {
        display: block;
      }
      #errors {
        margin: 20px 5px;
      }
    </style>

    <div class="style-scope budget-section-materials card" material-table>
      <h5 class="material-name" style="margin-bottom: 5px">
        <div class="layout horizontal center">
          <div class="flex">
            <div>
              <span id="icon"></span>
              <span id="name"></span>
            </div>
          </div>
          <div style="text-align:right">
            <span id="fixed" class="label label-warning">Fixed</span>
            <a id="editIcon" class="btn btn-default btn-lg" style="margin-bottom: 5px" on-click="edit"><i class="fa fa-pencil"></i></a>
            <div id="changesMessage" style="font-size:12px" class="text text-warning"></div>
          </div>
        </div>
      </h5>

      <div class="alert alert-danger" id="errors"></div>

      <div class="help-block" style="margin-bottom: 15px" id="otherInfo"></div>
      <div style="overflow-x:auto">
        <table class="table">
          <tr>
            <th>Class</th>
            <th>Price</th>
            <th>Units</th>
          </tr>
          <tr>
            <td id="class" class="material-class"></td>
            <td class="material-price"><ahb-dollar-label id="price"></ahb-dollar-label></td>
            <td id="units"></td>
          </tr>
        </table>
      </div>

      <div style="padding:10px">
        <div id="usedBy"></div>
        <div id="requiredBy"></div>
      </div>

      <div id="msg"></div>
    </div>

  </template>
  <script>
    Polymer({
      is: 'budget-material-list-item',

      properties : {
        material : {
          type : Object,
          observer : 'update'
        },
        hasChanges : {
          type : Boolean,
          reflectToAttribute : true,
          value : function() {
            return false;
          }
        },
        hasErrors : {
          type : Boolean,
          reflectToAttribute : true,
          value : function() {
            return false;
          }
        }
      },

      ready : function() {
        this.changesTimer = -1;
        this.errorCount = 0;
      },

      edit : function() {
        this.fire('edit-material');
      },

      update : function() {
        if( !this.material ) return;

        this.setAttribute('material-name', this.material.name);

        this.$.icon.innerHTML = '<i class="fa fa-cube'+(this.material.type === 'complex' ? 's' : '')+'"></i>';
        this.$.name.innerHTML = this.material.name;

        if( this.material.fixed ) {
          this.$.fixed.style.display = 'block';
          this.$.editIcon.style.display = 'none';
        } else {
          this.$.fixed.style.display = 'none';
          this.$.editIcon.style.display = 'inline-block';
        }

        this.errorCount = 0;
        var errors = '';
        if( this.material.recalcErrors && this.material.recalcErrors.length > 0 ) {
          errors += '<i class="fa fa-warning"></i> This material has errors.<ul>';
          for( var key in this.material.materials ) {
            if( this.material.materials[key].message ) {
              this.errorCount++;
              errors +=
                '<li><b>'+key+':</b> '+this.material.materials[key].message+
                  (this.material.materials[key].code === 3 ? ' <a style="cursor:pointer" material="'+key+'"><i class="fa fa-cloud-download"></i> Import</a>' : '')+
                '</li>';
            }
          }
          errors += '</ul>';
          this.$.errors.innerHTML = errors;
          this.$.errors.style.display = 'block';
          this.hasErrors = true;

          $(this.$.errors)
            .find('a')
            .on('click', function(e){
              var material = e.currentTarget.getAttribute('material');
              document.querySelector('budget-import-material-popup').show(material);
            });
        } else {
          this.hasErrors = false;
          this.$.errors.style.display = 'none';
        }

        var otherInfo = '';
        if( this.material.authority ) {
          otherInfo +='<i class="fa fa-shield"></i> '+this.material.authority;
        }
        if( this.material.locality ) {
          if( this.material.authority ) {
            otherInfo += ' | ';
          }
          otherInfo += '<i class="fa fa-map-marker"></i> <span style="text-transform:capitalize">'+this.material.locality.join(', ')+'</span>';
        }
        if( this.material.description ) {
          if( this.material.authority || this.material.locality ) {
            otherInfo += ' | ';
          }
          otherInfo += this.material.description;
        }
        this.$.otherInfo.innerHTML = otherInfo;

        this.$.class.innerHTML = this.material.type == 'complex' ? 'Complex Material' : (this.material.class || 'Other');
        this.$.price.value = this.material.price || '0';

        this.$.units.innerHTML = this.material.units;

        this.setUsedByOps();
        this.setRequiredBy();
        this.setChanges();
      },

      // need to buffer this as we may still be in the process of tracking changes when
      // this element is created, cause the element to think there are changes when
      // there are none.
      setChanges : function() {
        if( this.changesTimer == -1 ) clearTimeout(this.changesTimer);
        this.changesTimer = setTimeout(function(){
          this.changesTimer = -1;
          this._setChanges();
        }.bind(this), 500);
      },

      _setChanges : function() {
        if( !this.material.id ) return;

        var changes = FB.changes.hasChanges(this.material);
        var unsaved = FB.changes.getUnsaved()[this.material.id];
        if( !changes && !unsaved ) {
          this.hasChanges = false;
          this.$.changesMessage.innerHTML = '';
          this.$.editIcon.className = 'btn btn-default btn-lg';
          return;
        }

        this.hasChanges = true;
        if( ExpressAuth.user ) {
          this.$.changesMessage.innerHTML = 'You have unsaved changes to this material.  Click <i class="fa fa-pencil"></i> to save.';
        } else {
          this.$.changesMessage.innerHTML = 'You have unsaved changes to this material.  You must login to save.';
        }

        this.$.editIcon.className = 'btn btn-warning btn-lg';
      },

      setUsedByOps : function() {
        var operations = FB.operationController.get();
        var usedBy = [];
        for( var i = 0; i < operations.length; i++ ) {
          for( var j = 0; j < operations[i].materials.length; j++ ) {
            if( operations[i].materials[j].name == this.material.name ) {
              usedBy.push('<a href="/#budget/operations/'+operations[i].name+'">'+operations[i].name+'</a>');
              break;
            }
          }
        }
        this.$.usedBy.innerHTML = usedBy.length > 0 ? ('Used in Operation(s): '+usedBy.join(', ')) : '';
      },

      setRequiredBy : function() {
        var complexMaterials = FB.materialController.get().complex;
        var requiredBy = [];
        for( var name in complexMaterials ) {
          if( !complexMaterials[name].materials ) continue;
          if( complexMaterials[name].materials[this.material.name] ) {
            requiredBy.push('<a href="/#budget/materials/'+name+'">'+name+'</a>');
          }
        }
        this.$.requiredBy.innerHTML = requiredBy.length > 0 ? ('Required By: '+requiredBy.join(', ')) : '';
      }
    });
  </script>
</dom-module>
