<dom-module id="budget-material">
  <style>
    :host {
      display: inline-block;
    }
    #label {
      white-space: nowrap;
    }
    #label:hover {
      color: #2196f3;
    }
  </style>

  <template>
    <div id="label" style="cursor:pointer" on-click="toggle">
      <b><i class="fa fa-cube" id="icon"></i> <span id="nameLabel"></span></b>
      <span id="forLabel"></span>
    </div>
    <div id="error" class="text text-danger"></div>
    <div id="price" style="white-space: nowrap">
      <div id="otherInfo" class="help-block"></div>
      <span id="priceLabel"></span>
      <span id="unitLabel"></span>
      <a class="btn btn-link" id="edit"><i class="fa fa-edit"></i></a>
    </div>
  </template>
</dom-module>

<script>
  Polymer({
    is : 'budget-material',

    properties : {
      material : {
        type : String,
        observer : 'changeObserver'
      },
      showPrice : {
        type : Boolean,
        observer : 'changeObserver',
        value : false
      },
      parent : {
        type : String,
        observer : 'changeObserver',
        value : function() {
          return '';
        }
      }
    },

    ready : function() {
      this.currentstate = null;
    },

    attached : function() {
      this.render();
    },

    changeObserver : function() {
      this.render();
    },

    render : function(material) {
      if( material && typeof material == 'string' ) {
        this.material = material;
      }

      if( this.currentstate === this.material+this.parent ) {
        return; // nothing to do;
      } else {
        this.currentstate = this.material+this.parent;
      }

      this.updatePrice();
      this.showError();

      if( !this.material ) {
        return;
      }

      var m;
      if( this.parent ) {
        this.$.forLabel.innerHTML = '(for '+this.parent+')';
        // to edit this material, we need to fire an event
        this.$.edit.removeAttribute('href');
        this.$.edit.addEventListener('click', this.fireEditUnique.bind(this), false);
        var complex = FB.materialController.get(this.parent);
        if( complex.error ) return this.showError(complex);

        if( !complex.unique || !complex.unique[this.material] ) {
          return this.showError({message: 'Error finding unique material: '+this.material});
        }

        var unique = complex.unique[this.material];
        m = {
          name : this.material,
          units : unique.units,
          price : unique.price
        }

      } else {
        this.$.forLabel.innerHTML = '';
        this.$.edit.href = '#budget/materials/'+this.material;
        this.$.edit.removeEventListener('click', this.fireEditUnique, false);

        m = FB.materialController.get(this.material);
        if( m.error ) return this.showError(m);
      }



      var otherInfo = '';
      if( m.authority ) {
        otherInfo +='<i class="fa fa-shield"></i> '+m.authority;
      }
      if( m.locality ) {
        if( m.authority ) {
          otherInfo += ' | ';
        }
        otherInfo += '<i class="fa fa-map-marker"></i> <span style="text-transform:capitalize">'+m.locality.join(', ')+'</span>';
      }
      this.$.otherInfo.innerHTML = otherInfo;

      if( m.fixed ) {
        this.$.edit.style.display = 'none';
        this.$.nameLabel.innerHTML = this.material+' <span class="label label-warning">Fixed</span>';
      } else {
        this.$.edit.style.display = 'inline-block';
        this.$.nameLabel.innerHTML = this.material;
      }


      // TODO: don't think this is the best place for this error checkError
      // but at least we are getting it on screen
      if( m.price === undefined ) {
        return this.showError({message: 'No price set for this material'});
      }

      this.$.priceLabel.innerHTML = m.price;
      this.$.unitLabel.innerHTML = FB.units.getLabel(m.units, true);
      //this.data.materials[material].price.toFixed(2)
    },

    fireEditUnique : function() {
      this.fire('edit-unique', this.material);
    },

    showError : function(err) {
      if( !err ) {
        this.$.error.style.display = 'none';
        this.$.label.style.display = 'block';
        return;
      }

      this.$.error.style.display = 'block';
      this.$.label.style.display = 'none';
      this.$.error.innerHTML = err.message;

      if( err.code === 3 ) {
        var a = $('<a class="btn btn-link"><i class="fa fa-circle-plus"></i></a>');
        a.on('click', function(){
          document.querySelector('budget-material-popup').create(err.name);
        });
        $(this.$.error).append(a);
      }
    },

    toggle : function() {
      this.showPrice = !this.showPrice;
      this.updatePrice();
    },

    updatePrice : function() {
      if( this.showPrice ) this.$.price.style.display = 'block';
      else this.$.price.style.display = 'none';
    }
  });
</script>
