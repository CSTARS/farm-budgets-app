<dom-module id="find-budget-list">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <input type="text" class="form-control" placeholder="Text Search" id="textSearch" on-keyup="onKeyUp" />
    <div class="help-block">Text search on budget name, farm name, crop and localition name</div>

    <div id="noData"></div>

    <template is="dom-repeat" items="{{data}}">
      <div class="panel panel-default">
        <div class="panel-body">
          <budget-list-item on-budget-select="select" budget="{{item}}"></budget-list-item>
        </div>
      </div>
    </template>

  </template>
  <script>
    Polymer({
      is: 'find-budget-list',

      ready : function() {
        this.cache = {};
        this.countCache = {};
        this.update();
      },

      update : function(locality, crop) {
        this.locality = locality;
        this.crop = crop;

        var query = FB.utils.queryHelper(locality, crop, this.$.textSearch.value);
        query = encodeURIComponent(JSON.stringify(query));

        if( this.cache[query] ) {
          this.onResponse(this.cache[query]);
        } else {
          $.get('/budget/find?query='+query, function(resp){
            this.cache[query] = resp;
            this.onResponse(resp);
          }.bind(this));
        }

        if( this.countCache[query] ) {
          this.onCountResponse(this.countCache[query]);
        } else {
          $.get('/budget/findCount?query='+query, function(resp){
            this.countCache[query] = resp;
            this.onCountResponse(resp);
          }.bind(this));
        }
      },

      onKeyUp : function() {
        if( this.searchTimer != -1 ) clearTimeout(this.searchTimer);
        this.searchTimer = setTimeout(function(){
          this.searchTimer = -1;
          this.update(this.locality, this.crop);
        }.bind(this), 200);
      },

      onCountResponse : function(resp) {
        this.fire('budget-count', resp.count);
      },

      show : function(locality, crop) {
        this.update(locality, crop);
      },

      onResponse : function(resp) {
        if( resp.error ) {
          return alert(resp.message);
        }

        if( resp.length === 0 ) {
          this.$.noData.innerHTML = 'No budgets found.';
        } else {
          this.$.noData.innerHTML = '';
        }

        this.data = resp;
      }
    });
  </script>
</dom-module>
