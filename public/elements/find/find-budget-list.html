<dom-module id="find-budget-list">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <input type="text" class="form-control" placeholder="Text Search" id="textSearch" on-keyup="onKeyUp" />
    <div class="help-block">A generic text search on budget name, farm name, crop and localition name</div>

    <div id="noData"></div>

    <template is="dom-repeat" items="{{data}}">
      <div class="panel panel-default">
        <div class="panel-body">
          <h4>
            <span>{{item.name}}</span>
            <small><i class="fa fa-shield"></i> <span>{{item.authority}}</span></small>
            <span class="pull-right"><a class="btn btn-primary" on-click="select" index$="{{index}}" style="margin-top:-10px">Select</a></span>
          </h4>

          <table class="table">
            <tr class="text text-success">
              <td>Crop</td>
              <td><i class="fa fa-leaf"></i> <span>{{item.farm.commodity}}</span></td>
            </tr>
            <tr class="text text-primary">
              <td>Location</td>
              <td><i class="fa fa-map-marker"></i> <span style="text-transform:capitalize">{{item.localityStr}}</span></td>
            </tr>
            <tr>
              <td>Farm Name</td>
              <td>{{item.farm.farm}}</td>
            </tr><tr>
              <td>Size</td>
              <td><span>{{item.farm.size}}<span> <span>{{item.farm.unit}}</span></td>
            </tr>
          </table>
        </div>
      </div>
    </template>

  </template>
  <script>
    Polymer({
      is: 'find-budget-list',

      ready : function() {
        this.cache = {};
        this.countCache = {};
        this.update();
      },

      update : function(locality, crop) {
        this.locality = locality;
        this.crop = crop;

        var query = FB.utils.queryHelper(locality, crop, this.$.textSearch.value);
        query = encodeURIComponent(JSON.stringify(query));

        if( this.cache[query] ) {
          this.onResponse(this.cache[query]);
        } else {
          $.get('/budget/find?query='+query, function(resp){
            this.cache[query] = resp;
            this.onResponse(resp);
          }.bind(this));
        }

        if( this.countCache[query] ) {
          this.onCountResponse(this.countCache[query]);
        } else {
          $.get('/budget/findCount?query='+query, function(resp){
            this.countCache[query] = resp;
            this.onCountResponse(resp);
          }.bind(this));
        }
      },

      onKeyUp : function() {
        if( this.searchTimer != -1 ) clearTimeout(this.searchTimer);
        this.searchTimer = setTimeout(function(){
          this.searchTimer = -1;
          this.update(this.locality, this.crop);
        }.bind(this), 200);
      },

      onCountResponse : function(resp) {
        this.fire('budget-count', resp.count);
      },

      show : function(locality, crop) {
        this.update(locality, crop);
      },

      onResponse : function(resp) {
        if( resp.error ) {
          return alert(resp.message);
        }

        if( resp.length === 0 ) {
          this.$.noData.innerHTML = 'No budgets found.';
        } else {
          this.$.noData.innerHTML = '';
        }

        for( var i = 0; i < resp.length; i++ ) {
          resp[i].localityStr = resp[i].locality.join(', ');
        }

        this.data = resp;
      },

      select : function(e) {
        var index = parseInt(e.currentTarget.getAttribute('index'));
        var id = this.data[index].id;

        $.get('/budget/get?id='+id, function(resp){
          if( resp.error ) {
            return alert(resp.message);
          }
          this.fire('budget-select', resp);
        }.bind(this));
      }
    });
  </script>
</dom-module>
