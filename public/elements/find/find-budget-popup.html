<link rel="import" href="find-budget-location.html">
<link rel="import" href="find-budget-crop.html">
<link rel="import" href="find-budget-list.html">

<dom-module id="find-budget-popup">
  <template>
    <style>
      :host {
        display: block;
      }
      .nav-list-item {
        border-bottom: 1px solid #eee;
        margin-bottom: 10px;
      }
    </style>

    <div class="modal fade" id="popup">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" aria-label="Close" data-dismiss="modal"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title">Find Budget</h4>
          </div>
          <div class="modal-body">

            <div class="row">
              <div class="col-sm-4">
                <div class="nav-list-item">
                  <div><a class="btn btn-link" on-click="showMap"><i class="fa fa-map-pin"></i> Location</a></div>
                  <div style="text-align:right">
                    <budget-location-filter-display id="locationBtns" style="display:inline-block" size="small" on-location-update="onLocationUpdate"></budget-location-filter-display>
                  </div>
                </div>
                <div class="nav-list-item">
                  <div>
                    <a class="btn btn-link" on-click="showCrop"><i class="fa fa-leaf"></i> Crop</a>
                    <span id="cropCountLabel"></span>
                  </div>
                  <div id="currentCrop" style="text-align:right"></div>
                </div>
                <div class="nav-list-item">
                  <div>
                    <a class="btn btn-link" on-click="showBudget"><i class="fa fa-dollar"></i> Budget</a>
                    <span id="budgetCountLabel"></span>
                  </div>
                </div>
              </div>
              <div class="col-sm-8" id="panels">

                <find-budget-location
                  id="locationPage"
                  on-location-select="onLocationSelect"
                  on-filters-update="onFiltersUpdate">
                </find-budget-location>

                <find-budget-crop id="cropPage" on-crop-select="onCropSelect" on-crop-count="onCropCount"></find-budget-crop>
                <find-budget-list id="budgetPage" on-budget-select="onBudgetSelect" on-budget-count="onBudgetCount"></find-budget-list>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>

  </template>
  <script>
    Polymer({
      is: 'find-budget-popup',

      ready : function() {
        this.locationKeys = ['state', 'county', 'zipCode'];
        this.crop = '';

        this.popup = $(this.$.popup).remove();
        $('body').append(this.popup);
        this.popup.modal({show: false});
      },

      show : function() {
        this.popup.modal('show');
        this.showBudget();
      },

      hidePanels : function() {
        $(this.$.panels).children().hide();
      },

      showMap : function() {
        this.panel = 'map';
        this.hidePanels();
        this.$.locationPage.style.display = 'block';

        this.$.locationPage.showMap();
        setTimeout(function(){
          this.$.locationPage.resize();
        }.bind(this), 300);
      },

      showCrop : function() {
        this.panel = 'crop';
        this.hidePanels();
        this.$.cropPage.style.display = 'block';

        //this.$.cropPage.show(this.locality);
      },

      showBudget : function() {
        this.panel = 'budget';
        this.hidePanels();
        this.$.budgetPage.style.display = 'block';

        this.$.budgetPage.show(this.locality, this.crop);
      },

      onCropSelect : function(e) {
        this.crop = e.detail;
        this.$.currentCrop.innerHTML = '<span class="label label-primary" style="cursor:pointer"><i class="fa fa-remove"></i> '+this.crop+'</span>';

        $(this.$.currentCrop)
          .find('span')
          .on('click', function(){
            this.crop = '';
            this.$.currentCrop.innerHTML = '';

            this.$.budgetPage.show(this.locality, this.crop);
            this.$.cropPage.show(this.locality);
          }.bind(this));
        this.$.budgetPage.update(this.locality, this.crop);
      },

      onBudgetSelect : function(e) {
        this.popup.modal('hide');
        setTimeout(function(){
          document.querySelector('ahb-budget').load(e.detail);
        }, 200);
      },

      onCropCount : function(e) {
        this.$.cropCountLabel.innerHTML = '('+e.detail+')';
      },

      onBudgetCount : function(e) {
        this.$.budgetCountLabel.innerHTML = '('+e.detail+')';
      },

      onLocationSelect : function(e) {
        this.locality = e.detail;
        this.$.cropPage.update(this.locality);
        this.$.budgetPage.update(this.locality, this.crop);
        this.updateLocationBtns();
      },

      onFiltersUpdate : function(e) {
        this.locality = e.detail;
        this.$.cropPage.update(this.locality);
        this.$.budgetPage.update(this.locality, this.crop);
        this.updateLocationBtns();
      },

      updateLocationBtns : function() {
        this.$.locationBtns.value = this.locality;
        this.$.cropPage.update(this.locality);
        this.$.budgetPage.update(this.locality, this.crop);
        this.$.locationBtns.update(); // this should fire!?
      },

      onLocationUpdate : function(e) {
        this.locality = e.detail;
        this.$.cropPage.update(this.locality);
        this.$.budgetPage.update(this.locality, this.crop);

        this.$.locationPage.filters = this.locality;
        this.$.locationPage.renderFilterBtns();
      }

    });
  </script>
</dom-module>
