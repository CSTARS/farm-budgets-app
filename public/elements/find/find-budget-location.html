<dom-module id="find-budget-location">
  <style>
      :host {
          display: block;
          height: 100%;
          position: relative;
      }

      google-map {
          display: block;
          height: 100%;
      }

      .location {
          position: absolute;
          top: 0;
          left: 0;
          width:100%;
          background-color: rgba(255,255,255, .7);
          padding: 5px;
          border-bottom: 1px solid white;
      }

      .phoneBreak {
          display: none;
      }
      @media(max-width: 768px) {
          .phoneBreak {
              display: block;
          }
      }
  </style>

  <template>

    <ul class="nav nav-tabs nav-justified" id="tabs">
      <li role="presentation" class="active" id="btnMap" on-click="showMap">
        <a><i class="fa fa-map-o"></i> Map</a>
      </li>
      <li role="presentation" id="btnText" on-click="showManual">
        <a><i class="fa fa-terminal"></i> Manual</a>
      </li>
    </ul>

    <div id="mapPanel" style="height:400px; position:relative">
      <google-map id="map" latitude="37.77493" longitude="-122.41942" on-google-map-ready="initMap"></google-map>

      <div class="location">
          <div id="searching" style="display:none">
              <div class="layout horizontal">
                  <div class="flex">
                      <input type="text" class="form-control" id="textBox" on-keypress="setSearchTimer" />
                  </div>
                  <div style="padding: 10px">
                      <i class="fa fa-circle-o-notch fa-spin" id="loadingIcon" style="display:none"></i>
                  </div>
                  <div>
                      <a class="btn btn-default" on-click="stopSearch"><i class="fa fa-remove"></i></a>
                  </div>
              </div>

              <div id="resultsPanel"></div>
          </div>

          <div id="emptySearch">
              <div class="layout horizontal">
                  <div class="flex self-center">
                      <a class="btn btn-default" on-click="startSearch"><i class="fa fa-search" ></i> Search</a>
                  </div>
                  <div class="self-center" style="text-align:right; padding-top:4px">
                      Click map to select Location
                  </div>
              </div>
          </div>

          <div id="completedSearch" style="display:none">
              <div class="layout horizontal">
                  <div class="flex self-center">
                      <a class="btn btn-default" on-click="startSearch"><i class="fa fa-search" ></i> Search</a>
                  </div>

                  <div style="text-align:right; padding-top:4px;" class="self-center" id="currentLocation"></div>
              </div>
          </div>
      </div>
    </div>

    <div id="textPanel" style="padding-top: 15px">
      <div class="form-horizontal">
        <div class="form-group">
          <label for="locationInput" class="col-md-2 control-label">Location</label>
          <div class="col-md-10">
            <input type="text" class="form-control" id="locationInput" placeholder="Comma Separate" on-keyup="onKeyUp" on-blur="onBlur" />
            <budget-location-filter-display id="locationBtns" on-location-update="onLocationUpdate"></budget-location-filter-display>
          </div>
        </div>
      </div>

    </div>

  </template>
</dom-module>

<script>
  Polymer({
    is : 'find-budget-location',

      onKeyUp : function(e) {
        if( e.which == 13 ) this.setFiltersFromText();
      },

      onBlur : function() {
        this.setFiltersFromText();
      },

      setFiltersFromText : function() {
        if( this.$.locationInput.value.length == 0 ) return;

        this.filters = this.$.locationInput.value.split(',');
        var firstState = -1;
        for( var i = 0; i < this.filters.length; i++ ) {
          this.filters[i] = this.filters[i].trim().toLowerCase();
          if( FB.utils.states[this.filters[i]] && firstState == -1 ) {
            firstState = i;
          } else if( FB.utils.statesLookup[this.filters[i]] ) {
            this.filters[i] = FB.utils.statesLookup[this.filters[i]];
            if( firstState == -1 ) firstState = i;
          }
        }

        // look if there is a state filter, if there is replace
        if( firstState != -1 ) {
          var filter = this.filters.splice(firstState, 1)[0];
          this.filters.splice(0,0,filter);
        }

        this.$.locationInput.value = '';

        this.renderFilterBtns();
        this.fire('filters-update', this.filters);
      },

      renderFilterBtns : function() {
        this.$.locationBtns.value = this.filters;
        this.$.locationBtns.update();
      },

      onLocationUpdate : function(e) {
        this.filters = e.detail;
        this.fire('filters-update', this.filters);
      },

      showMap : function() {
        this.$.btnText.className = '';
        this.$.btnMap.className = 'active';
        this.$.mapPanel.style.display = 'block';
        this.$.textPanel.style.display = 'none';
        this.$.map.resize();
      },

      showManual : function() {
        this.$.btnText.className = 'active';
        this.$.btnMap.className = '';
        this.$.mapPanel.style.display = 'none';
        this.$.textPanel.style.display = 'block';
      },

      updateCropText : function() {
          var cropLocality = [];
          if( !this.crops ) {
            this.cropText = '';
            return;
          }

          if( this.crops.state.length > 0 ) cropLocality.push('Statewide');
          if( this.crops.county.length > 0 ) cropLocality.push('County');
          if( this.crops.zipCode.length > 0 ) cropLocality.push('Zipcode');

          if( cropLocality.length == 0 ) {
              this.cropText = 'Currently no crops found for this location.'
          } else {
              this.cropText = 'Crop Locality: '+cropLocality.join(', ');
          }
      },

      updateText : function() {
        if( !this.location ) return;
        this.updateCropText();

        this.$.currentLocation.innerHTML = this.location.county+', '+this.location.state+', '+
          this.location.zipCode+'<br /><span>'+this.cropText+'</span>';
      },

      resize : function() {
          this.$.map.resize();
      },

      startSearch : function() {
          this.$.emptySearch.style.display = 'none';
          this.$.completedSearch.style.display = 'none';
          this.$.searching.style.display = 'block';
          this.$.textBox.focus();
      },

      stopSearch : function() {
        this.$.emptySearch.style.display = 'none';
        this.$.searching.style.display = 'none';
        this.$.completedSearch.style.display = 'block';
      },

      setSearchTimer : function() {
          this.loading = true;
          this.cropText = '';
          if( this.searchTimer != -1 ) clearTimeout(this.searchTimer);
          this.searchTimer = setTimeout(this.search.bind(this), 500);
      },

      search: function() {
        this.query = this.$.textBox.value;

        if (this.query && this.map) {
          /*var places = new google.maps.places.PlacesService(this.map);
          places.textSearch({query: this.query+' United States'}, this.gotResults.bind(this));*/
          $.get('https://maps.googleapis.com/maps/api/geocode/json?address='+this.query+'&components=country:USA', this.gotResults.bind(this));
        }
      },

      gotResults: function(resp, status) {
          this.loading = false;
          this.results = resp.results.splice(0,5);
          this.renderResults();
      },

      loading : function(loading) {

      },

      renderResults : function() {
        var html = '', loc;
        for( var i = 0; i < this.results.length; i++ ) {
          html += '<div>'+
            '<a index="'+i+'" class="btn btn-link" style="margin-bottom:0">'+
              '<i class="fa fa-map-marker"></i> '+this.results[i].formatted_address+
            '</a></div>';
        }

        this.$.resultsPanel.innerHTML = html;

        $(this.$.resultsPanel)
          .find('a')
          .on('click', this.selectLocation.bind(this));
      },

      selectLocation : function(e) {
          var loc = this.results[parseInt(e.currentTarget.getAttribute('index'))];
          this.map.setCenter(loc.geometry.location);

          this.setLocation(loc, true);
          this.stopSearch();
      },

      initMap : function() {
        this.map = this.$.map.map;

        google.maps.event.addListener(this.map, 'click', function(e) {
            this.llLookUp(e.latLng.lat(), e.latLng.lng(), true);
        }.bind(this));

        this.map.setOptions({
            mapTypeControl: false,
            panControl: false,
            zoomControl: true,
            zoomControlOptions: {
                style: google.maps.ZoomControlStyle.DEFAULT,
                position: google.maps.ControlPosition.LEFT_CENTER
            },
            streetViewControl: false
        });
      },

      setLocation : function(loc, recheck) {
          this.location = {};

          if( loc.geometry && loc.geometry.location ) {
              this.location.latitude = loc.geometry.location.lat;
              this.location.longitude = loc.geometry.location.lng;
              this.location.fixedLat = this.location.latitude.toFixed(4);
              this.location.fixedLng = this.location.longitude.toFixed(4);

              if( this.marker ) this.marker.setMap(null);
              this.marker = new google.maps.Marker({
                  position: new google.maps.LatLng(this.location.latitude, this.location.longitude),
                  map: this.map
              });
          }

          for( var i = 0; i < loc.address_components.length; i++ ) {
              if( loc.address_components[i].types.indexOf('administrative_area_level_2') > -1 ) {
                  this.location.county = loc.address_components[i].long_name;
              } else if ( loc.address_components[i].types.indexOf('administrative_area_level_1') > -1 ) {
                  this.location.state = loc.address_components[i].long_name;
              } else if ( loc.address_components[i].types.indexOf('postal_code') > -1) {
                  this.location.zipCode = loc.address_components[i].long_name;
              }
          }

          if( !this.location.county || !this.location.state || !this.location.zipCode ) {
              if( recheck ) this.llLookUp(this.location.latitude, this.location.longitude, false);
              else alert('Location Lookup Error :(');
          }

          this.updateText();
          this.stopSearch();

          this.filters = [this.location.state, this.location.county, this.location.zipCode];
          this.renderFilterBtns();

          this.fire('location-select', this.filters);
      },

      llLookUp : function(lat, lng, recheck) {
          $.get('http://maps.googleapis.com/maps/api/geocode/json?latlng='+lat+','+lng+'&sensor=false', function(resp) {
              if( resp.results.length > 0 ) {
                  this.setLocation(resp.results[0], recheck);
              }
              // TODO: how do we want to handle case w/ no resp?
          }.bind(this));
      }
  });


var STATES = {
  "alabama": "AL",
  "alaska": "AK",
  "american samoa": "AS",
  "arizona": "AZ",
  "arkansas": "AR",
  "california": "CA",
  "colorado": "CO",
  "connecticut": "CT",
  "delaware": "DE",
  "district of columbia": "DC",
  "federated states of micronesia": "FM",
  "florida": "FL",
  "georgia": "GA",
  "guam": "GU",
  "hawaii": "HI",
  "idaho": "ID",
  "illinois": "IL",
  "indiana": "IN",
  "iowa": "IA",
  "kansas": "KS",
  "kentucky": "KY",
  "louisiana": "LA",
  "maine": "ME",
  "marshall islands": "MH",
  "maryland": "MD",
  "massachusetts": "MA",
  "michigan": "MI",
  "minnesota": "MN",
  "mississippi": "MS",
  "missouri": "MO",
  "montana": "MT",
  "nebraska": "NE",
  "nevada": "NV",
  "new hampshire": "NH",
  "new jersey": "NJ",
  "new mexico": "NM",
  "new york": "NY",
  "north carolina": "NC",
  "north dakota": "ND",
  "northern mariana islands": "MP",
  "ohio": "OH",
  "oklahoma": "OK",
  "oregon": "OR",
  "palau": "PW",
  "pennsylvania": "PA",
  "puerto rico": "PR",
  "rhode island": "RI",
  "south carolina": "SC",
  "south dakota": "SD",
  "tennessee": "TN",
  "texas": "TX",
  "utah": "UT",
  "vermont": "VT",
  "virgin islands": "VI",
  "virginia": "VA",
  "washington": "WA",
  "west virginia": "WV",
  "wisconsin": "WI",
  "wyoming": "WY"
}
</script>
