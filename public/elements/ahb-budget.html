<dom-module id="ahb-budget">
  <template>
    <budget-sections id="sections"></budget-sections>
  </template>
</dom-module>

<script>
  Polymer({
    is : 'ahb-budget',

    attached : function() {
      var id = window.localStorage.getItem('current-budget');

      if( id ) {
        $.get('/budget/get?id='+id, function(resp){
          if( resp.error ) {

            // check local data if error (probably new, unsaved budget)
            var localdata = window.localStorage.getItem(id);
            if( localdata ) {
              try {
                localdata = JSON.parse(localdata);
                this.load(localdata);
                return;
              } catch(e) {}
            }

            this.showFindPopup();
            return;
          }

          FB.changes.setOriginal(resp.budget, resp.materials);
          if( !this.checkLocal(id) ) {
            this.load(resp);
          }
        }.bind(this));
      } else {
        this.createNew();
        this.showFindPopup();
      }
    },

    showFindPopup : function() {
      document
        .querySelector('budget-welcome-splash')
        .addEventListener('splash-close', function(){
          if( this.loadedFromLink ) return;
          setTimeout(function(){
            document.querySelector('find-budget-popup').show();
          }, 300);
        }.bind(this));
    },

    checkLocal : function(id) {
      try {
        var localdata = window.localStorage.getItem(id);
        localdata = JSON.parse(localdata);
        FB.localdata = localdata;

        if( !localdata.materials ) {
          localdata.materials = [];
        }

        var hasChanges = false;
        if( localdata ) {
          hasChanges = FB.changes.forceCheckAll(localdata.budget, localdata.materials);
        }

        if( localdata && !ExpressAuth.user ) {
          this.load(localdata);
          return true;
        } else if( localdata && hasChanges ) {
          this.load(localdata);
          return true;
        }
      } catch(e) {
        debugger;
        console.log(e);
        alert('Failed to load from local storage :(');
      }
      return false;
    },

    load : function(data) {
      FB.reset(true);

      if( !data.budget.materials ) {
        data.budget.materials = [];
      }
      if( !data.budget.operations ) {
        data.budget.operations = [];
      }

      if( data.budget.id ) {
        window.localStorage.setItem('current-budget', data.budget.id);
      } else {
        window.localStorage.setItem('current-budget', '');
      }


      FB.load(data);

      this.$.sections.setData(data);

      if( this.saveElement ) {
        this.saveElement.onBudgetLoad(data);
      }
      FB.localsave();

      this.fire('budget-loaded');
    },

    reload : function(id, force) {
      if( FB.changes.hasChanges() && !force ) {
        if( !confirm('Are you sure you want to load this budget?  You have unsaved changes') ) {
          return;
        }
      }

      $.get('/budget/get?id='+id, function(resp){
        if( resp.error ) {
          return alert('Error reloading budget data: '+resp.message);
        }

        FB.changes.setOriginal(resp.budget, resp.materials);
        FB.changes.setUnsaved({});
        window.localStorage.setItem('unsaved-materials', '{}');

        window.localStorage.clear();

        this.load(resp);
      }.bind(this));
    },

    createNew : function() {
      var newData = {
        budget : {
          id : FB.utils.guid(),
          authority : ExpressAuth.user ? ExpressAuth.user.username : '',
          locality : [],
          name : '',
          commodity : '',
          farm : {
            name : '',
            units : '[acr_us]',
            size : 1
          },
          operations : [],
        },
        materials : []
      };

      FB.changes.setOriginal(newData.budget, newData.materials);
      this.load(newData);
    }

  });
</script>
