<dom-module id="ahb-budget">
  <template>
    <budget-sections id="sections"></budget-sections>
  </template>
</dom-module>

<script>
  Polymer({
    is : 'ahb-budget',

    attached : function() {
      var id = window.localStorage.getItem('current-budget');

      if( id ) {
        $.get('/budget/get?id='+id, function(resp){
          if( resp.error ) {
            // check local data if error (probably new, unsaved budget)
            var localdata = window.localStorage.getItem(id);
            if( localdata ) {
              try {
                localdata = JSON.parse(localdata);
                this.load(localdata);
                FB.save.init({});
                return;
              } catch(e) {}
            }

            document.querySelector('find-budget-popup').show();
            return;
          }

          FB.save.init(resp);
          if( !this.checkLocal(id) ) {
            this.load(resp);
          }
        }.bind(this));
      } else {
        document.querySelector('find-budget-popup').show();
      }
    },

    checkLocal : function(id) {
      try {
        var localdata = window.localStorage.getItem(id);
        localdata = JSON.parse(localdata);

        var materialIds = [];
        if( localdata.materials ) {
          for( var i = 0; i < localdata.materials.length; i++ ) {
            if( !localdata.materials[i].id ) {
              continue;
            }
            materialIds.push(localdata.materials[i].id);
          }
        }

        if( localdata && !ExpressAuth.user ) {
          this.load(localdata);
          return true;
        } else if( localdata &&
            (FB.save.checkBudget(localdata) || FB.save.checkMaterials(materialIds)) &&
            confirm('You have a local budget with changes, would you like to load that?  If no, your '+
                    'local changes will be discarded.') ) {

          this.load(localdata);
          return true;
        }
      } catch(e) {
        console.log(e);
        alert('Failed to load from local storage :(');
      }
      return false;
    },

    load : function(budget) {
      FB.reset();

      if( !budget.materials ) {
        budget.materials = [];
      }
      if( !budget.operations ) {
        budget.operations = [];
      }

      window.localStorage.setItem('current-budget', budget.id);

      FB.load(budget);

      this.$.sections.setData(budget);

      if( this.saveElement ) {
        this.saveElement.onBudgetLoad(budget);
      }
      FB.localsave();

      this.fire('budget-loaded');
    },

    reload : function(id) {
      $.get('/budget/get?id='+id, function(resp){
        FB.save.init(resp);

        if( resp.error ) {
          return alert('Error reloading budget data: '+resp.message);
        }

        this.load(resp);
      }.bind(this));
    }

  });
</script>
