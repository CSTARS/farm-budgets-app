<polymer-element name="ahb-page-location" attributes="location crops">
    <template>
        <style>
            :host {
                display: block;
                height: 100%;
            }
            google-map {
                display: block;
                height: 100%;
            }
            .location {
                position: absolute;
                top: 0;
                left: 0;
                width:100%;
                background-color: rgba(0,0,0, .7);
                color: white;
                padding: 5px;
                border-bottom: 1px solid black;
            }
            ahb-icon {
                display: inline-block;
                margin: 5px;
                cursor: pointer;
            }
            .search-btn {
                display : inline-block;
                cursor : pointer;
                border: 1px solid white;
                border-radius: 3px;
                box-shadow : 0 0 3px black;
                padding: 3px 6px 3px 1px;
                margin: 3px;
            }
            .search-btn:hover {
                background-color: rgba(255,255,255,.2);
            }
            
            .phoneBreak {
                display: none;
            }
            @media(max-width: 768px) {
                .phoneBreak {
                    display: block;
                }
            }
        </style>
        <google-map-search map="{{map}}" query="Pizza" result="{{result}}"></google-map-search>
        <google-map id="map" map="{{map}}" latitude="37.77493" longitude="-122.41942" on-google-map-ready="{{initMap}}">
            <google-map-marker hidden?="{{location == null}}" latitude="{{location.latitude}}" longitude="{{location.longitude}}"></google-map-marker>
        </google-map>

        <div class="location">
            <core-collapse opened="{{searching}}">
                <div layout horizontal>
                    <div flex>
                        <input type="text" class="form-control" value="{{query}}" id="textBox" />
                    </div>
                    <div>
                        <ahb-icon icon="fa-circle-o-notch fa-spin" hidden?="{{!loading}}"></ahb-icon>
                    </div>
                    <div>
                        <ahb-icon icon="fa-remove" on-tap="{{stopSearch}}"></ahb-icon>
                    </div>
                </div>
                <template repeat="{{loc, i in results}}">
                    <div><a index="{{i}}" class="btn btn-link" style="margin-bottom:0" on-tap="{{selectLocation}}"><ahb-icon icon="fa-map-marker"></ahb-icon>&nbsp;{{loc.formatted_address}}</a></div>
                </template>
            </core-collapse>
            <core-collapse opened="{{!searching && location == null}}">
                <div layout horizontal>
                    <div flex self-center>
                        <div class="search-btn" on-tap="{{startSearch}}"><ahb-icon icon="fa-search" ></ahb-icon>&nbsp;Search</div>
                    </div>
                    <div self-center style="text-align:right;padding-top:4px;color: white">
                        Click map to select Location
                    </div>
                </div>
            </core-collapse>
            <core-collapse opened="{{!searching && location != null}}">
                <div layout horizontal>
                    <div flex self-center>
                        <div class="search-btn" on-tap="{{startSearch}}"><ahb-icon icon="fa-search" ></ahb-icon>&nbsp;Search</div>
                    </div>
                    <div style="text-align:right;padding-top:4px;color: white" hidden?="{{loading}}" self-center>
                        {{location.county}}, {{location.state}}, {{location.zipCode}}<br /> 
                        <span>{{cropText}}</span>
                    </div>
                    <div self-center hidden?="{{!loading}}">Loading...</div>
                </div>
            </core-collapse>
        </div>
    </template>
    <script>
        Polymer('ahb-page-location', {
            map : null, // actual js map
            results : [],
            query : '',
            searching : false,
            loading : false,
            location : null,
            searchTimer : -1,

            cropText : '',

            observe : {
                query : 'setSearchTimer',
                'crops.state' : 'updateCropText',
                'crops.county' : 'updateCropText',
                'crops.zipCode' : 'updateCropText',
            },

            updateCropText : function() {
                var cropLocality = [];
                if( this.crops.state.length > 0 ) cropLocality.push('Statewide');
                if( this.crops.county.length > 0 ) cropLocality.push('County');
                if( this.crops.zipCode.length > 0 ) cropLocality.push('Zipcode');

                if( cropLocality.length == 0 ) {
                    this.cropText = 'Currently no crops found for this location.'
                } else {
                    this.cropText = 'Crop Locality: '+cropLocality.join(', ');
                }
            },

            resize : function() {
                this.$.map.resize();
            },

            startSearch : function() {
                this.searching = true;
                this.async(function(){
                    this.$.textBox.focus();
                });
            },

            stopSearch : function() {
                this.searching = false;
            },

            setSearchTimer : function() {
                this.loading = true;
                this.cropText = '';
                if( this.searchTimer != -1 ) clearTimeout(this.searchTimer);
                this.searchTimer = setTimeout(this.search.bind(this), 500);
            },

            search: function() {
                if (this.query && this.map) {
                  /*var places = new google.maps.places.PlacesService(this.map);
                  places.textSearch({query: this.query+' United States'}, this.gotResults.bind(this));*/
                  $.get('https://maps.googleapis.com/maps/api/geocode/json?address='+this.query+'&components=country:USA', this.gotResults.bind(this));
                }
            },

            gotResults: function(resp, status) {
                this.loading = false;
                this.results = resp.results.splice(0,5);
            },

            selectLocation : function(e) {
                var loc = this.results[parseInt(e.currentTarget.getAttribute('index'))];
                this.map.setCenter(loc.geometry.location);
                
                this.setLocation(loc, true);
                this.searching = false;
            },

            initMap : function() {
                google.maps.event.addListener(this.map, 'click', function(e) {
                    this.llLookUp(e.latLng.lat(), e.latLng.lng(), true);
                }.bind(this));

                this.map.setOptions({
                    mapTypeControl: false,
                    panControl: false,
                    zoomControl: true,
                    zoomControlOptions: {
                        style: google.maps.ZoomControlStyle.DEFAULT,
                        position: google.maps.ControlPosition.LEFT_CENTER
                    },
                    streetViewControl: false
                })
            },

            setLocation : function(loc, recheck) {
                this.location = {};

                if( loc.geometry && loc.geometry.location ) {
                    this.location.latitude = loc.geometry.location.lat;
                    this.location.longitude = loc.geometry.location.lng;
                    this.location.fixedLat = this.location.latitude.toFixed(4);
                    this.location.fixedLng = this.location.longitude.toFixed(4);
                }

                for( var i = 0; i < loc.address_components.length; i++ ) {
                    if( loc.address_components[i].types.indexOf('administrative_area_level_2') > -1 ) {
                        this.location.county = loc.address_components[i].long_name;
                    } else if ( loc.address_components[i].types.indexOf('administrative_area_level_1') > -1 ) {
                        this.location.state = loc.address_components[i].long_name;
                    } else if ( loc.address_components[i].types.indexOf('postal_code') > -1) {
                        this.location.zipCode = loc.address_components[i].long_name;
                    }
                }

                if( !this.location.county || !this.location.state || !this.location.zipCode ) {
                    if( recheck ) this.llLookUp(this.location.latitude, this.location.longitude, false);
                    else alert('Location Lookup Error :(');
                }
            },

            llLookUp : function(lat, lng, recheck) {
                $.get('http://maps.googleapis.com/maps/api/geocode/json?latlng='+lat+','+lng+'&sensor=false', function(resp) {
                    if( resp.results.length > 0 ) {
                        this.setLocation(resp.results[0], recheck);
                    }
                    // TODO: how do we want to handle case w/ no resp?
                }.bind(this));
            }
        });
    </script>
</polymer-element>