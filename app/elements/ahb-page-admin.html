<polymer-element name="ahb-page-admin" attributes="schema">
    <template>
        <style>
            .card {
                padding: 10px;
                margin: 10px;
                box-shadow: 0 0 5px #888;
            }
            .margin {
                margin-left: 15px;
            }
            .add {
                margin: 5px;
                padding: 10px;
                background-color: #f8f8f8;
                border-radius: 3px;
            }
            paper-tabs::shadow #selectionBar {
              background-color: #ccc;
            }
            paper-tabs /deep/ paper-ripple#ink {
              color: #eee;
            }
        </style>
        <div style="padding:10px">
            <div hidden?="{{!checking}}">
                Checking auth....
            </div>
            <div hidden?="{{checking || loggedIn}}">
                <a class="btn btn-primary" href="/auth/google">Login</a>
            </div>
            <div hidden?="{{checking || !loggedIn}}">
                Hello {{user.emails[0].value}},

                <paper-tabs selected="{{currentTab}}">
                    <paper-tab>Edit</paper-tab>
                    <paper-tab>Import</paper-tab>
                    <paper-tab>Schema</paper-tab>
                </paper-tabs>

                <div hidden?="{{currentTab != 0}}">
                    <h4>Select a state and crop to admin budget</h4>
                    <table class="table">
                        <tr>
                            <td>State</td>
                            <td>
                                <select value="{{selectedState}}" class="form-control">
                                    <option></option>
                                    <template repeat="{{state in states}}">
                                        <option value="{{state}}">{{state}}</option>
                                    </template>
                                </select>
                            </td>
                        <tr>
                        <tr>
                            <td>Crop</td>
                            <td>
                                <select value="{{selectedCrop}}" class="form-control">
                                    <option></option>
                                    <template repeat="{{crop in crops}}">
                                        <option value="{{crop}}">{{crop}}</option>
                                    </template>
                                </select>
                            </td>
                        <tr>
                    </table>           

                    <div hidden?="{{selectedState == ''}}" class="card">
                        <h4>State Costs: <span style="color:#888">{{selectedState}}</span></h4>
                        <div class="margin">
                            <table class="table">
                                <tr>
                                    <th>Item</th>
                                    <th>Category</th>
                                    <th>$ Cost</th>
                                    <th>Unit</th>
                                    <th></th>
                                </tr>
                                <tr template repeat="{{cost in stateCosts}}">
                                    <td>{{cost.item}}</td>
                                    <td>{{catLookup[cost.item]}}</td>
                                    <td>${{cost.cost}}</td>
                                    <td>{{cost.unit}}</td>
                                    <td><a class="btn btn-link" on-click="{{removeCost}}" item="{{cost.item}}">
                                        <ahb-icon icon="fa-trash"></ahb-icon>&nbsp;Remove</a>
                                    </td>
                                </tr>
                                <tr style="background-color:#eee">
                                    <td>
                                        <select value="{{new.cost.item}}" class="form-control">
                                            <option></option>
                                            <template repeat="{{item in items}}">
                                                <option value="{{item.key}}">{{item.label}}</option>
                                            </template>
                                        </select>
                                    </td>
                                    <td></td>
                                    <td>
                                        <input type="number" value="{{new.cost.cost}}" class="form-control" />
                                    </td>
                                    <td>
                                        <input type="text" value="{{new.cost.unit}}" class="form-control" />
                                    </td>
                                    <td>
                                        <a class="btn btn-default" on-click="{{addCost}}"><ahb-icon icon="fa-plus"></ahb-icon>&nbsp;Add / Update</a>
                                    </td>
                                </tr>
                            </table> 

                        </div>
                    </div>

                    <div hidden?="{{selectedState == '' || selectedCrop == ''}}" class="card">
                        <h4>Crop Items: <span style="color:#888">{{selectedState}}, {{selectedCrop}}</span></h4>
                        <div class="margin">
                            <table class="table">
                                <tr>
                                    <th>Item</th>
                                    <th>Category</th>
                                    <th># Amount</th>
                                    <th>Cost</th>
                                    <th>Unit</th>
                                    <th></th>
                                </tr>
                                <tr template repeat="{{item in cropItems}}">
                                    <td>{{item.item}}</td>
                                    <td>{{catLookup[item.item]}}</td>
                                    <td>{{item.amount}}</td>
                                    <td>
                                        <span hidden?="{{item.cCost.value == ''}}">${{item.cCost.value}}</span>
                                        <span hidden?="{{item.cCost.error == ''}}" style="color:red">{{item.cCost.error}}</span>
                                    </td>
                                    <td>{{item.unit}}</td>
                                    <td><a class="btn btn-link" on-click="{{removeCropItem}}" item="{{item.item}}">
                                        <ahb-icon icon="fa-trash"></ahb-icon>&nbsp;Remove</a>
                                    </td>
                                </tr>
                                <tr style="background-color:#eee">
                                        <td>
                                            <select value="{{new.cropItem.item}}" class="form-control">
                                                <option></option>
                                                <template repeat="{{item in items}}">
                                                    <option value="{{item.key}}">{{item.label}}</option>
                                                </template>
                                            </select>
                                        </td>
                                        <td></td>
                                        <td>
                                            <input type="number" value="{{new.cropItem.amount}}" class="form-control" />
                                        </td>
                                        <td></td>
                                        <td>
                                            <input type="text" value="{{new.cropItem.unit}}" class="form-control" />
                                        </td>
                                        <td>
                                            <a class="btn btn-default" on-click="{{addCropItem}}"><ahb-icon icon="fa-plus"></ahb-icon>&nbsp;Add / Update</a>
                                        </td>
                                    </tr>
                            </table> 

                        </div>
                    </div>
                </div>
                <!-- end tab panel -->

                <div hidden?="{{currentTab != 1}}">
                    <ahb-admin-import 
                        states="{{states}}"
                        crops="{{crops}}"
                        catLookup="{{catLookup}}">
                    </ahb-admin-import>
                </div>

                <div hidden?="{{currentTab != 2}}">
                    <ahb-admin-schema schema="{{schema}}"></ahb-admin-schema>
                </div>
            </div>
        </div>
    </template>
    <script>
        Polymer('ahb-page-admin', {
            loggedIn : false,
            checking : true,
            user : null,

            crops : ['Alfalfa','Alfalfa Seed','Asparagus','Barley','Blueberries','Broccoli','Canola','Corn Grains','Corn Silage','Cotton','Dry Beans','Fescue Seed','Grass / Hay','Lentil','Oats','Orchard Grass Seed','Potatoes','Ryegrass Seed','Sorghum','Spring Wheat','Sudangrass','Sugar Beet','Winter Wheat'],

            currentTab : 0,

            states : ["Alabama","Alaska","American Samoa","Arizona","Arkansas","California","Colorado","Connecticut","Delaware","District Of Columbia","Federated States Of Micronesia","Florida","Georgia","Guam","Hawaii","Idaho","Illinois","Indiana","Iowa","Kansas","Kentucky","Louisiana","Maine","Marshall Islands","Maryland","Massachusetts","Michigan","Minnesota","Mississippi","Missouri","Montana","Nebraska","Nevada","New Hampshire","New Jersey","New Mexico","New York","North Carolina","North Dakota","Northern Mariana Islands","Ohio","Oklahoma","Oregon","Palau","Pennsylvania","Puerto Rico","Rhode Island","South Carolina","South Dakota","Tennessee","Texas","Utah","Vermont","Virgin Islands","Virginia","Washington","West Virginia","Wisconsin","Wyoming"],

            items : [],

            selectedCrop : '',
            selectedState : '',

            observe : {
                selectedState : 'update',
                selectedCrop : 'update',
                schema : 'updateSchema'
            },

            cropItems : [],
            stateCosts : [],

            'new' : {
                cost : {
                    item : '',
                    unit : '',
                    cost : ''
                },
                cropItem : {
                    item : '',
                    unit : '',
                    amount : ''
                }
            },

            catLookup : {},

            ready : function() {
                $.get('/rest/user', this.onAuthCheckComplete.bind(this));
            },

            updateSchema : function() {
                for( var key in this.schema ) {
                    for( var i = 0; i < this.schema[key].length; i++ ) {
                        this.items.push({
                            key : this.schema[key][i].item,
                            label : this.schema[key][i].item+' : '+key
                        });
                        this.catLookup[this.schema[key][i].item] = key;

                        if( this.schema[key][i].alt ) {
                            for( var j = 0; j < this.schema[key][i].alt.length; j++ ) {
                                this.catLookup[this.schema[key][i].alt[j]] = key;
                            }
                        }
                        
                    }
                }
            },


            onAuthCheckComplete : function(resp) {
                this.checking = false;
                if( resp.error ) return;

                this.loggedIn = true;
                this.user = resp;
            },

            update : function() {
                this.cropItems = [];
                this.stateCosts = [];

                if( this.selectedState == '' ) return;


                var location = encodeURIComponent(JSON.stringify({state: this.selectedState}));
                $.get('/rest/getCosts?location='+location, function(resp){
                    if( resp.error ) return alert(resp.message);

                    console.log(resp);
                    for( var i = 0; i < resp.results.length; i++ ) {
                        this.stateCosts.push({
                            item : resp.results[i].item,
                            cost : resp.results[i].cost,
                            unit : resp.results[i].unit,
                            sortVal : this.catLookup[resp.results[i].item]+resp.results[i].item
                        });
                    }

                    this.stateCosts.sort(function(a, b){
                        if( a.sortVal < b.sortVal ) return -1;
                        if( a.sortVal > b.sortVal ) return 1;
                        return 0;
                    });

                }.bind(this));

                

                if( this.selectedCrop == '' ) return;

                var location = encodeURIComponent(JSON.stringify({state: this.selectedState}));
                $.get('/rest/getCropItems?location='+location+'&crop='+this.selectedCrop, function(resp){
                    if( resp.error ) return alert(resp.message);

                    console.log(resp);
                    for( var i = 0; i < resp.results.length; i++ ) {
                        this.cropItems.push({
                            item : resp.results[i].item,
                            amount : resp.results[i].amount,
                            unit : resp.results[i].unit,
                            sortVal : this.catLookup[resp.results[i].item]+resp.results[i].item,
                            cCost : this.getCurrentCost(resp.results[i]),
                        });
                    }

                    this.cropItems.sort(function(a, b){
                        if( a.sortVal < b.sortVal ) return -1;
                        if( a.sortVal > b.sortVal ) return 1;
                        return 0;
                    });
                }.bind(this));
            },

            getCurrentCost : function(item) {
                var noCost = false;

                var found = false, i;
                for( i = 0; i < this.stateCosts.length; i++ ) {
                    if( this.stateCosts[i].item == item.item ) {
                        found = true;
                        break;
                    }
                }

                if( !found ) {
                    return {
                        value : '',
                        error : 'No state cost set'
                    }
                }

                var cost = this.stateCosts[i]; 
                if( cost.unit != item.unit ) {
                    return {
                        value : '',
                        error : 'Units do not match'
                    }
                }

                return {
                    value : parseFloat(cost.cost) * parseFloat(item.amount),
                    error : ''
                }
            },

            removeCost : function(e) {
                var item = e.currentTarget.getAttribute('item');
                if( !confirm('Are your sure you want to remove: '+item+'?') ) return;

                item = {
                    location : {
                        state : this.selectedState
                    },
                    item : item
                }

                $.ajax({
                    type : 'POST',
                    url : '/rest/removeCost',
                    data : item,
                    success : function(resp) {}
                });

                delete this.db.costs[this.selectedState][item.item];

                this.update();
            },

            addCost : function() {
                if( this.new.cost.item == '' || this.new.cost.cost == '' || this.new.cost.cost == '0' ) {
                    return alert('Please provide a unit and a cost');
                }

                var item = {
                    state : this.selectedState,
                    item : this.new.cost.item,
                    cost : this.new.cost.cost,
                    unit : this.new.cost.unit
                }

                $.ajax({
                    type : 'POST',
                    url : '/rest/addCost',
                    data : item,
                    success : function(resp) {
                        this.update();
                    }
                });
                
                this.new.cost = {
                    item : '',
                    unit : '',
                    cost : ''
                };
            },

            removeCropItem : function(e) {
                var item = e.currentTarget.getAttribute('item');
                if( !confirm('Are your sure you want to remove: '+item+'?') ) return;

                item = {
                    location : {
                        state : this.selectedState
                    },
                    crop : this.selectedCrop,
                    item : item
                }

                $.ajax({
                    type : 'POST',
                    url : '/rest/removeCropItem',
                    data : item,
                    success : function(resp) {
                        this.update();
                    }
                });
            },

            addCropItem : function() {
                if( this.new.cropItem.item == '' || this.new.cropItem.amount == '' || this.new.cropItem.unit == '0' ) {
                    return alert('Please provide a unit and amount');
                }

                var item = {
                    state : this.selectedState,
                    crop : this.selectedCrop,
                    item : this.new.cropItem.item,
                    amount : this.new.cropItem.amount,
                    unit : this.new.cropItem.unit
                }

                $.ajax({
                    type : 'POST',
                    url : '/rest/addCropItem',
                    data : item,
                    success : function(resp) {
                        this.update();
                    }
                });

                this.new.cropItem = {
                    item : '',
                    unit : '',
                    amount : ''
                };
            }

        });
    </script>
</polymer-element>