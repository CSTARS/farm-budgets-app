<polymer-element name="ahb-page-crop" attributes="selectedCrop selectedLocality farmSize location crops">
    <template>
        <style>
            google-map {
                height: 300px;
                display: block;
            }
        </style>

        <div style="padding: 10px">

            <div hidden?="{{location == null}}">
                <h4>Location</h4>
                <table class="table">
                    <tr>
                        <td>Lat / Lng</td>
                        <td>{{location.fixedLat}}, {{location.fixedLng}}</td>
                    </tr>
                    <tr>
                        <td>County</td>
                        <td>{{location.county}}</td>
                    </tr>
                    <tr>
                        <td>State</td>
                        <td>{{location.state}}</td>
                    </tr>
                    <tr>
                        <td>Zip Code</td>
                        <td>{{location.zipCode}}</td>
                    </tr>
                </table>
            </div>
            <div hidden?="{{location != null}}">
                <h4><ahb-icon icon="fa-warning"></ahb-icon>&nbsp;Don't forget to select a location!</h4>
            </div>

            <h2>Set Crop and Farm Parameters</h2>

            <table class="table">
                <tr>
                    <td>Select Crop:</td>
                    <td>
                        <select value="{{selectedCropAndLocality}}">
                            <option></option>
                            <template repeat="{{crop in crops.state}}">
                                <option value="{{crop}}::statewide">{{crop}} (Statewide - {{location.state}})</option>
                            </template>
                            <template repeat="{{crop in crops.county}}">
                                <option value="{{crop}}::county">{{crop}} ({{location.county}})</option>
                            </template>
                            <template repeat="{{crop in crops.zipCode}}">
                                <option value="{{crop}}::zipcode">{{crop}} ({{location.zipCode}})</option>
                            </template>
                        </select> 
                    </td>
                </tr>
                <tr>
                    <td>Farm Size:</td>
                    <td>
                        <input type="number" class="form-control" style="width:100px;display:inline-block" value="{{farmSize}}" /> ac
                    </td>
                </tr>
            </table>

        </div>
    </template>
    <script>
        Polymer('ahb-page-crop', {
            crops : {
                state : [],
                county : [],
                zipCode : []
            },

            selectedCrop : '',
            selectedLocality : '',
            selectedCropAndLocality : '',
            farmSize : 0,

            firstTime : true,

            observe : {
                'location.county' : 'updateCrops',
                'location.state' : 'updateCrops',
                'location.zipCode' : 'updateCrops',
                'selectedCropAndLocality' : 'updateSelected'
            },

            updateSelected : function() {
                var parts = this.selectedCropAndLocality.split('::');
                this.selectedCrop = parts[0];
                this.selectedLocality = parts[1];
            },

            updateCrops : function() {
                $.get('/rest/getCropsForLocation?location='+encodeURIComponent(JSON.stringify(this.location)), function(resp) {
                    this.crops = resp;

                    if( this.firstTime && 
                        (this.crops.state.length > 0 || this.crops.county.length > 0 || this.crops.zipCode.length > 0 ) ) {
                        this.firstTime = false;
                        window.location.hash = 'crop';
                    }
                }.bind(this));
            }
        })
    </script>
</polymer-element>