<polymer-element name="ahb-page-budget" attributes="defaultSchema farmSize selectedCrop selectedLocality location">
    <template>
        <style>
            tr {
                opacity: 1;
                background-color: white;

                transition: all linear 200ms;
                -webkit-transition: all linear 200ms;
                -moz-transition: all linear 200ms;
                -ms-transition: all linear 200ms;
            }
            tr[removing] {
                opacity: 0;
            }
            ahb-icon {
                display: inline-block;

                transition: all 300ms linear;
                -moz-transition: all 300ms linear;
                -webkit-transition: all 300ms linear;
                -ms-transition: all 300ms linear;

                transform: rotate(0deg);
                -webkit-transform: rotate(0deg);
                -moz-transform: rotate(0deg);
                -ms-transform: rotate(0deg);
            }
            ahb-icon[opened] {
                transform: rotate(90deg);
                -webkit-transform: rotate(90deg);
                -moz-transform: rotate(90deg);
                -ms-transform: rotate(90deg);
            }
            .total {
                border-top: 1px solid #ccc;
                text-align: right;
                padding-top: 10px;
                color: #333;
            }
            .grandTotal {
                border-top: 1px solid #888;
                text-align: right;
                padding-top: 10px;
                font-weight: bold;
            }
            .addItem {
                position:absolute;
                left:0;
                top:0;
                background-color: white;
                padding: 10px;
                margin: 3px;
                border: 1px solid #ccc;
                border-radius: 4px;
                box-shadow: 0 0 5px #ccc;
                z-index: 1000;
            }
            tr.hover:hover {
                background-color: #eee;
            }
            .addTable td, .addTable th {
                padding: 5px;
                vertical-align: middle;
            }
            table tr td, table th  {
                white-space: nowrap;
            }
            .arrowIcon {
                font-size:25px
            }
            @media(max-width: 768px) {
                h2 {
                    font-size: 18px !important;
                }
                .arrowIcon {
                    font-size: 18px
                }
            }
        </style>

        <div style="padding:10px" hidden?="{{!(farmSize == '' || farmSize == 0 || selectedCrop == '' || location == null)}}">
            <h4><ahb-icon icon="fa-warning"></ahb-icon> Actions Required</h4>
            <p>Please select a location, crop and farm size first!  Then we can calculate your budget.</a>
        </div>

        <div style="padding:10px;" hidden?="{{farmSize == '' || farmSize == 0 || selectedCrop == '' || location == null}}">
        <!--<div style="padding:10px;">-->


            <div style="padding:10px;margin-bottom:10px;border-bottom:1px solid #ccc">
                <div layout horizontal>
                    <div>
                        <a class="btn btn-link" on-click="{{expandAll}}"><ahb-icon icon="fa-toggle-down"></ahb-icon>&nbsp;Expand</a>
                        <a class="btn btn-link" on-click="{{collapseAll}}"><ahb-icon icon="fa-toggle-right"></ahb-icon>&nbsp;Collapse</a>
                    </div>
                    <div flex style="text-align:right">
                        <a class="btn btn-link" on-click="{{toggleAddCustom}}"><ahb-icon icon="fa-plus"></ahb-icon>&nbsp;Add Custom</a>
                    </div>
                </div>

                <core-collapse opened="{{showAddCustom}}">
                    <div style="overflow:auto" horizontal end-justified layout>
                        <table class="addTable">
                            <tr>
                                <th>Category</th>
                                <th>Item</th>
                                <th># Units</th>
                                <th>Unit Cost</th>
                                <th>Measurement Units</th>
                                <th></th>
                            </tr>
                            <tr>
                                <td>
                                    <select value="{{custom.category}}">
                                        <option></option>
                                        <template repeat="{{category in schema}}">
                                            <option value="{{category.name}}">{{category.name}}</option>
                                        </template>
                                    </select>
                                </td>
                                <td>
                                    <input type="text" class="form-control" value="{{custom.item}}" style="width:125px" />
                                </td>
                                <td style="white-space:nowrap">
                                    #&nbsp;<input type="number" class="form-control" value="{{custom.amount}}" style="width:75px;display:inline-block"/>
                                </td>
                                <td>
                                    $&nbsp;<input type="number" class="form-control" value="{{custom.cost}}" style="width:75px;display:inline-block" />
                                </td>
                                <td>
                                    <input type="text" class="form-control" value="{{custom.units}}" style="width:75px" />
                                </td>
                                <td>
                                    <a class="btn btn-link" on-click="{{addCustomItem}}"><ahb-icon icon="fa-plus-square-o" ></ahb-icon>&nbsp;Add</a>
                                </td>
                            </tr>
                        </table>
                    </div>
                </core-collapse>
            </div>


            <template repeat="{{itemSchema in schema}}">
                <h2>
                    <div layout horizontal>
                        <div flex>
                            <a class="btn btn-link"
                                name="{{itemSchema.name}}" 
                                on-click="{{toggle}}">
                                <ahb-icon 
                                    class="arrowIcon"
                                    icon="fa-arrow-right" 
                                    opened?="{{opened[itemSchema.name]}}" >
                                </ahb-icon>
                            </a> 
                            <span style="vertical-align:middle">{{itemSchema.name}}</span>

                            <template bind if="{{removed[itemSchema.name]}}">
                                <a class="btn btn-link" style="vertical-align:middle" on-click="{{toggleRemoved}}" category="{{itemSchema.name}}">
                                    <ahb-icon icon="fa-plus"></ahb-icon>&nbsp;Add
                                </a>
                                <div style="display:inline;position:relative">
                                    <core-collapse opened="{{removed[itemSchema.name].opened}}" class="addItem">
                                        <template repeat="{{item, i in removed[itemSchema.name].items}}">
                                            <div><a class="btn btn-link" 
                                                    on-click="{{addItem}}"
                                                    category="{{itemSchema.name}}"
                                                    index="{{i}}">
                                                    <ahb-icon icon="fa-plus"></ahb-icon>&nbsp;{{item.item}}
                                                </a>
                                            </div>
                                        </template>
                                    </core-collapse>
                                </div>
                            </template>
                        </div>
                        <div>
                            <span style="vertical-align:middle;">${{itemSchema.totalText}}</span>
                        </div>
                    </div>
                </h2>

                <core-collapse opened="{{opened[itemSchema.name]}}">
                    <div style="margin-left:15px;overflow:auto">
                        <table class="table">
                            <tr>
                                <th>Item</th>
                                <th># Units</th>
                                <td></th>
                                <th>Unit Cost</th>
                                <th>Item Total</th>
                                <th></th>
                            </tr>
                            <tr template repeat="{{budgetItem in itemSchema.schema}}" removing?="{{budgetItem.removing}}" class="hover">
                                <td removing?="{{budgetItem.removing}}" >{{budgetItem.item}}</td>
                                <td removing?="{{budgetItem.removing}}">
                                    <input 
                                        type="number" 
                                        class="form-control" 
                                        style="width:100px;display:inline-block" 
                                        value="{{budgetItem.value}}" 
                                        on-change="{{updateTotals}}" /> 
                                </td>
                                <td style="vertical-align:middle" removing?="{{budgetItem.removing}}">
                                    <ahb-icon icon="fa-times"></ahb-icon>
                                </td>
                                <td removing?="{{budgetItem.removing}}">
                                    <span style="vertical-align:middle">$&nbsp;</span>
                                    <input 
                                        type="number" 
                                        class="form-control" 
                                        style="width:100px;display:inline-block" 
                                        value="{{budgetItem.unitCost}}" 
                                        on-change="{{updateTotals}}" />
                                    <span hidden?="{{budgetItem.unit == ''}}">&nbsp;/&nbsp;</span>
                                    <span style="vertical-align:middle">{{budgetItem.unit}}</span>
                                </td>
                                <td>${{budgetItem.totalText}}</td>
                                <td align="right" removing?="{{budgetItem.removing}}">
                                    <a class="btn btn-link" 
                                        category="{{itemSchema.name}}"
                                        name="{{budgetItem.item}}"
                                        on-click="{{removeItem}}">
                                        <ahb-icon icon="fa-minus-square-o"></ahb-icon>&nbsp;Remove
                                    </a>
                                </td>
                            </tr>
                        </table>
                    </div>
                </core-collapse>
            </template>
            <h2 class="total">
                ${{totalText}}
                <div style="color:#888;font-size: 18px">x {{farmSize}} acres</div>
            </h2>
            <h2 class="grandTotal">
                <div style="float:left">Total</div>
                ${{grandTotal}}
            </h2>
        </div>

    </template>
    <script>
        Polymer('ahb-page-budget', {
            schema : [],
            removed : {},
            opened : {},
            total : 0,
            totalText : '',
            grandTotal : '',
            showAddCustom : false,

            catLookup : {},

            observe : {
                selectedCrop : '_checkUpdate',
                farmSize : '_checkUpdate',
                location : '_checkUpdate',
                defaultSchema : '_setLookup'
            },

            // for add custom items
            custom : {
                category : '',
                item : '',
                amount : '',
                cost : '',
                units : ''
            },

            _setLookup : function() {
                for( var key in this.defaultSchema ) {
                    for( var i = 0; i < this.defaultSchema[key].length; i++ ) {
                       this.catLookup[this.defaultSchema[key][i].item] = key;
                    }
                }
            },

            updateTotals : function() {
                this.total = 0;
                var item;

                for( var i = 0; i < this.schema.length; i++ ) {
                    this.schema[i].total = 0;
                    for( var j = 0; j < this.schema[i].schema.length; j++ ) {
                        item = this.schema[i].schema[j];
                        item.total = parseFloat(item.value) * parseFloat(item.unitCost)
                        item.totalText = item.total.toFixed(2);
                        this.schema[i].total += item.total;
                    }
                    this.schema[i].totalText = this.schema[i].total.toFixed(2);
                    this.total += this.schema[i].total;
                }
                
                this.totalText = this.total.toFixed(2);
                this.grandTotal = (this.total * parseFloat(this.farmSize)).toFixed(2);
            },

            removeItem : function(e) {
                var name = e.currentTarget.getAttribute('name');
                var category = e.currentTarget.getAttribute('category');
                var item = this.getBudgetItemByName(category, name);
                
                if( !item ) return;

                item.removing = true;
                setTimeout(function(){
                    item.removing = false;
                    this.removeBudgetItemByName(category, name);
                    this.updateTotals();
                }.bind(this), 300);
            },

            getBudgetItemByName : function(category, name) {
                for( var i = 0; i < this.schema.length; i++ ) {
                    if( this.schema[i].name == category ) {
                        var items = this.schema[i].schema;
                        for( var j = 0; j < items.length; j++ ) {
                            if( items[j].item == name ) return items[j];
                        }
                    }
                }
                return null;
            },

            removeBudgetItemByName : function(category, name) {
                for( var i = 0; i < this.schema.length; i++ ) {
                    if( this.schema[i].name == category ) {
                        var items = this.schema[i].schema;
                        for( var j = 0; j < items.length; j++ ) {
                            if( items[j].item == name ) {
                                if( !this.removed[category] ) this.removed[category] = { opened: false, items : []};
                                this.removed[category].items.push(items.splice(j,1)[0]);
                                return;
                            }
                        }
                    }
                }
            },

            addItem : function(e) {
                var category = e.currentTarget.getAttribute('category');
                var index = parseInt(e.currentTarget.getAttribute('index'));

                var item = this.removed[category].items.splice(index, 1)[0];
                for( var i = 0; i < this.schema.length; i++ ) {
                    if( this.schema[i].name == category ) {
                        this.schema[i].schema.push(item);
                        break;
                    }
                }

                if( this.removed[category].items.length == 0 ) delete this.removed[category];
                else this.removed[category].opened = false;

                this.updateTotals();
            },

            toggleRemoved : function(e) {
                var category = e.currentTarget.getAttribute('category');
                this.removed[category].opened = !this.removed[category].opened;
            },

            toggle : function(e) {
                var name = e.currentTarget.getAttribute('name');
                this.opened[name] = !this.opened[name];
            },

            toggleAddCustom : function() {
                this.showAddCustom = !this.showAddCustom;
                if( !this.showAddCustom ) {
                    this.custom = {
                        category : '',
                        item : '',
                        amount : '',
                        cost : '',
                        units : ''
                    }
                }
            },

            addCustomItem : function() {
                if( this.custom.category == '' ) return alert('Please provide a category');
                if( this.custom.item == '' ) return alert('Please provide an item name');
                if( this.custom.amount == '' ) return alert('Please provide the number of units');
                if( this.custom.cost == '' ) return alert('Please provide the cost per unit');

                for( var i = 0; i < this.schema.length; i++ ) {
                    if( this.schema[i].name == this.custom.category ) {
                        this.schema[i].schema.push({
                            item : this.custom.item,
                            value : this.custom.amount,
                            unitCost : this.custom.cost,
                            unit : this.custom.units,
                            total : 0,
                            removing : false,
                            custom : true
                        })
                    }
                }

                this.toggleAddCustom();
                this.updateTotals();
            },

            _checkUpdate : function() {
                if( this.location && this.selectedCrop && this.selectedCrop != '' && this.farmSize && this.farmSize != '' ) {
                    this.loadLocalityBudget();
                }
            },

            loadLocalityBudget : function() {
                var loc = {};

                if( this.selectedLocality == 'zipCode' ) {
                    loc.zipCode = this.location.zipCode;
                } else if ( this.selectedLocality == 'county' ) {
                    loc.county = this.location.county;
                    loc.state = this.location.state;
                } else {
                    loc.state = this.location.state
                }

                $.get('/rest/getBudgetForLocality?location='+encodeURIComponent(JSON.stringify(loc))+
                            '&crop='+this.selectedCrop, 
                    function(resp) {
                        this.setBudget(resp);
                    }.bind(this)
                );
            },

            setBudget : function(budgetItems) {
                this.schema = [];
                this.opened = {};

                var tmpSchema = {};
                for( var i = 0; i < budgetItems.length; i++ ) {
                    var item = budgetItems[i];
                    var cat = this.catLookup[item.item] || 'Other';

                    if( !tmpSchema[cat] ) {
                        this.opened[cat] = false;
                        tmpSchema[cat] = {
                            total : 0,
                            name : cat,
                            schema : []
                        }
                    }

                    item.value = parseFloat(item.amount);
                    item.unitCost = parseFloat(item.cost);
                    item.total = 0;
                    item.removing = false;

                    tmpSchema[cat].schema.push(item);
                }

                for( var key in tmpSchema ) {
                    this.schema.push(tmpSchema[key]);
                }
                this.updateTotals();
            },

            expandAll : function() {
                for( var key in this.opened ) this.opened[key] = true;
            },

            collapseAll : function() {
                for( var key in this.opened ) this.opened[key] = false;
            }
        });
    </script>
</polymer-element>