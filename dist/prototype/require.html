<html><head><meta charset="UTF-8"><script>(function () {
function resolve() {
document.body.removeAttribute('unresolved');
}
if (window.WebComponents) {
addEventListener('WebComponentsReady', resolve);
} else {
if (document.readyState === 'interactive' || document.readyState === 'complete') {
resolve();
} else {
addEventListener('DOMContentLoaded', resolve);
}
}
}());
Polymer = {
Settings: function () {
var user = window.Polymer || {};
location.search.slice(1).split('&').forEach(function (o) {
o = o.split('=');
o[0] && (user[o[0]] = o[1] || true);
});
var wantShadow = user.dom === 'shadow';
var hasShadow = Boolean(Element.prototype.createShadowRoot);
var nativeShadow = hasShadow && !window.ShadowDOMPolyfill;
var useShadow = wantShadow && hasShadow;
var hasNativeImports = Boolean('import' in document.createElement('link'));
var useNativeImports = hasNativeImports;
var useNativeCustomElements = !window.CustomElements || window.CustomElements.useNative;
return {
wantShadow: wantShadow,
hasShadow: hasShadow,
nativeShadow: nativeShadow,
useShadow: useShadow,
useNativeShadow: useShadow && nativeShadow,
useNativeImports: useNativeImports,
useNativeCustomElements: useNativeCustomElements
};
}()
};
(function () {
var userPolymer = window.Polymer;
window.Polymer = function (prototype) {
var ctor = desugar(prototype);
prototype = ctor.prototype;
var options = { prototype: prototype };
if (prototype.extends) {
options.extends = prototype.extends;
}
Polymer.telemetry._registrate(prototype);
document.registerElement(prototype.is, options);
return ctor;
};
var desugar = function (prototype) {
var base = Polymer.Base;
if (prototype.extends) {
base = Polymer.Base._getExtendedPrototype(prototype.extends);
}
prototype = Polymer.Base.chainObject(prototype, base);
prototype.registerCallback();
return prototype.constructor;
};
window.Polymer = Polymer;
if (userPolymer) {
for (var i in userPolymer) {
Polymer[i] = userPolymer[i];
}
}
Polymer.Class = desugar;
}());
Polymer.telemetry = {
registrations: [],
_regLog: function (prototype) {
console.log('[' + prototype.is + ']: registered');
},
_registrate: function (prototype) {
this.registrations.push(prototype);
Polymer.log && this._regLog(prototype);
},
dumpRegistrations: function () {
this.registrations.forEach(this._regLog);
}
};
Object.defineProperty(window, 'currentImport', {
enumerable: true,
configurable: true,
get: function () {
return (document._currentScript || document.currentScript).ownerDocument;
}
});
Polymer.RenderStatus = {
_ready: false,
_callbacks: [],
whenReady: function (cb) {
if (this._ready) {
cb();
} else {
this._callbacks.push(cb);
}
},
_makeReady: function () {
this._ready = true;
this._callbacks.forEach(function (cb) {
cb();
});
this._callbacks = [];
},
_catchFirstRender: function () {
requestAnimationFrame(function () {
Polymer.RenderStatus._makeReady();
});
}
};
if (window.HTMLImports) {
HTMLImports.whenReady(function () {
Polymer.RenderStatus._catchFirstRender();
});
} else {
Polymer.RenderStatus._catchFirstRender();
}
Polymer.ImportStatus = Polymer.RenderStatus;
Polymer.ImportStatus.whenLoaded = Polymer.ImportStatus.whenReady;
Polymer.Base = {
__isPolymerInstance__: true,
_addFeature: function (feature) {
this.extend(this, feature);
},
registerCallback: function () {
this._registerFeatures();
this._doBehavior('registered');
},
createdCallback: function () {
Polymer.telemetry.instanceCount++;
this.root = this;
this._doBehavior('created');
this._initFeatures();
},
attachedCallback: function () {
Polymer.RenderStatus.whenReady(function () {
this.isAttached = true;
this._doBehavior('attached');
}.bind(this));
},
detachedCallback: function () {
this.isAttached = false;
this._doBehavior('detached');
},
attributeChangedCallback: function (name) {
this._attributeChangedImpl(name);
this._doBehavior('attributeChanged', arguments);
},
_attributeChangedImpl: function (name) {
this._setAttributeToProperty(this, name);
},
extend: function (prototype, api) {
if (prototype && api) {
Object.getOwnPropertyNames(api).forEach(function (n) {
this.copyOwnProperty(n, api, prototype);
}, this);
}
return prototype || api;
},
mixin: function (target, source) {
for (var i in source) {
target[i] = source[i];
}
return target;
},
copyOwnProperty: function (name, source, target) {
var pd = Object.getOwnPropertyDescriptor(source, name);
if (pd) {
Object.defineProperty(target, name, pd);
}
},
_log: console.log.apply.bind(console.log, console),
_warn: console.warn.apply.bind(console.warn, console),
_error: console.error.apply.bind(console.error, console),
_logf: function () {
return this._logPrefix.concat([this.is]).concat(Array.prototype.slice.call(arguments, 0));
}
};
Polymer.Base._logPrefix = function () {
var color = window.chrome || /firefox/i.test(navigator.userAgent);
return color ? [
'%c[%s::%s]:',
'font-weight: bold; background-color:#EEEE00;'
] : ['[%s::%s]:'];
}();
Polymer.Base.chainObject = function (object, inherited) {
if (object && inherited && object !== inherited) {
if (!Object.__proto__) {
object = Polymer.Base.extend(Object.create(inherited), object);
}
object.__proto__ = inherited;
}
return object;
};
Polymer.Base = Polymer.Base.chainObject(Polymer.Base, HTMLElement.prototype);
if (window.CustomElements) {
Polymer.instanceof = CustomElements.instanceof;
} else {
Polymer.instanceof = function (obj, ctor) {
return obj instanceof ctor;
};
}
Polymer.isInstance = function (obj) {
return Boolean(obj && obj.__isPolymerInstance__);
};
Polymer.telemetry.instanceCount = 0;
(function () {
var modules = {};
var lcModules = {};
var DomModule = function () {
return document.createElement('dom-module');
};
DomModule.prototype = Object.create(HTMLElement.prototype);
Polymer.Base.extend(DomModule.prototype, {
constructor: DomModule,
createdCallback: function () {
this.register();
},
register: function (id) {
var id = id || this.id || this.getAttribute('name') || this.getAttribute('is');
if (id) {
this.id = id;
modules[id] = this;
lcModules[id.toLowerCase()] = this;
}
},
import: function (id, selector) {
var m = modules[id] || lcModules[id.toLowerCase()];
if (!m) {
forceDocumentUpgrade();
m = modules[id];
}
if (m && selector) {
m = m.querySelector(selector);
}
return m;
}
});
var cePolyfill = window.CustomElements && !CustomElements.useNative;
if (cePolyfill) {
var ready = CustomElements.ready;
CustomElements.ready = true;
}
document.registerElement('dom-module', DomModule);
if (cePolyfill) {
CustomElements.ready = ready;
}
function forceDocumentUpgrade() {
if (cePolyfill) {
var script = document._currentScript || document.currentScript;
if (script) {
CustomElements.upgradeAll(script.ownerDocument);
}
}
}
}());
Polymer.Base._addFeature({
_prepIs: function () {
if (!this.is) {
var module = (document._currentScript || document.currentScript).parentNode;
if (module.localName === 'dom-module') {
var id = module.id || module.getAttribute('name') || module.getAttribute('is');
this.is = id;
}
}
if (this.is) {
this.is = this.is.toLowerCase();
}
}
});
Polymer.Base._addFeature({
behaviors: [],
_prepBehaviors: function () {
if (this.behaviors.length) {
this.behaviors = this._flattenBehaviorsList(this.behaviors);
}
this._prepAllBehaviors(this.behaviors);
},
_flattenBehaviorsList: function (behaviors) {
var flat = [];
behaviors.forEach(function (b) {
if (b instanceof Array) {
flat = flat.concat(this._flattenBehaviorsList(b));
} else if (b) {
flat.push(b);
} else {
this._warn(this._logf('_flattenBehaviorsList', 'behavior is null, check for missing or 404 import'));
}
}, this);
return flat;
},
_prepAllBehaviors: function (behaviors) {
for (var i = behaviors.length - 1; i >= 0; i--) {
this._mixinBehavior(behaviors[i]);
}
for (var i = 0, l = behaviors.length; i < l; i++) {
this._prepBehavior(behaviors[i]);
}
this._prepBehavior(this);
},
_mixinBehavior: function (b) {
Object.getOwnPropertyNames(b).forEach(function (n) {
switch (n) {
case 'hostAttributes':
case 'registered':
case 'properties':
case 'observers':
case 'listeners':
case 'created':
case 'attached':
case 'detached':
case 'attributeChanged':
case 'configure':
case 'ready':
break;
default:
if (!this.hasOwnProperty(n)) {
this.copyOwnProperty(n, b, this);
}
break;
}
}, this);
},
_doBehavior: function (name, args) {
this.behaviors.forEach(function (b) {
this._invokeBehavior(b, name, args);
}, this);
this._invokeBehavior(this, name, args);
},
_invokeBehavior: function (b, name, args) {
var fn = b[name];
if (fn) {
fn.apply(this, args || Polymer.nar);
}
},
_marshalBehaviors: function () {
this.behaviors.forEach(function (b) {
this._marshalBehavior(b);
}, this);
this._marshalBehavior(this);
}
});
Polymer.Base._addFeature({
_getExtendedPrototype: function (tag) {
return this._getExtendedNativePrototype(tag);
},
_nativePrototypes: {},
_getExtendedNativePrototype: function (tag) {
var p = this._nativePrototypes[tag];
if (!p) {
var np = this.getNativePrototype(tag);
p = this.extend(Object.create(np), Polymer.Base);
this._nativePrototypes[tag] = p;
}
return p;
},
getNativePrototype: function (tag) {
return Object.getPrototypeOf(document.createElement(tag));
}
});
Polymer.Base._addFeature({
_prepConstructor: function () {
this._factoryArgs = this.extends ? [
this.extends,
this.is
] : [this.is];
var ctor = function () {
return this._factory(arguments);
};
if (this.hasOwnProperty('extends')) {
ctor.extends = this.extends;
}
Object.defineProperty(this, 'constructor', {
value: ctor,
writable: true,
configurable: true
});
ctor.prototype = this;
},
_factory: function (args) {
var elt = document.createElement.apply(document, this._factoryArgs);
if (this.factoryImpl) {
this.factoryImpl.apply(elt, args);
}
return elt;
}
});
Polymer.nob = Object.create(null);
Polymer.Base._addFeature({
properties: {},
getPropertyInfo: function (property) {
var info = this._getPropertyInfo(property, this.properties);
if (!info) {
this.behaviors.some(function (b) {
return info = this._getPropertyInfo(property, b.properties);
}, this);
}
return info || Polymer.nob;
},
_getPropertyInfo: function (property, properties) {
var p = properties && properties[property];
if (typeof p === 'function') {
p = properties[property] = { type: p };
}
if (p) {
p.defined = true;
}
return p;
}
});
Polymer.CaseMap = {
_caseMap: {},
dashToCamelCase: function (dash) {
var mapped = Polymer.CaseMap._caseMap[dash];
if (mapped) {
return mapped;
}
if (dash.indexOf('-') < 0) {
return Polymer.CaseMap._caseMap[dash] = dash;
}
return Polymer.CaseMap._caseMap[dash] = dash.replace(/-([a-z])/g, function (m) {
return m[1].toUpperCase();
});
},
camelToDashCase: function (camel) {
var mapped = Polymer.CaseMap._caseMap[camel];
if (mapped) {
return mapped;
}
return Polymer.CaseMap._caseMap[camel] = camel.replace(/([a-z][A-Z])/g, function (g) {
return g[0] + '-' + g[1].toLowerCase();
});
}
};
Polymer.Base._addFeature({
_prepAttributes: function () {
this._aggregatedAttributes = {};
},
_addHostAttributes: function (attributes) {
if (attributes) {
this.mixin(this._aggregatedAttributes, attributes);
}
},
_marshalHostAttributes: function () {
this._applyAttributes(this, this._aggregatedAttributes);
},
_applyAttributes: function (node, attr$) {
for (var n in attr$) {
if (!this.hasAttribute(n) && n !== 'class') {
this.serializeValueToAttribute(attr$[n], n, this);
}
}
},
_marshalAttributes: function () {
this._takeAttributesToModel(this);
},
_takeAttributesToModel: function (model) {
for (var i = 0, l = this.attributes.length; i < l; i++) {
this._setAttributeToProperty(model, this.attributes[i].name);
}
},
_setAttributeToProperty: function (model, attrName) {
if (!this._serializing) {
var propName = Polymer.CaseMap.dashToCamelCase(attrName);
var info = this.getPropertyInfo(propName);
if (info.defined || this._propertyEffects && this._propertyEffects[propName]) {
var val = this.getAttribute(attrName);
model[propName] = this.deserialize(val, info.type);
}
}
},
_serializing: false,
reflectPropertyToAttribute: function (name) {
this._serializing = true;
this.serializeValueToAttribute(this[name], Polymer.CaseMap.camelToDashCase(name));
this._serializing = false;
},
serializeValueToAttribute: function (value, attribute, node) {
var str = this.serialize(value);
(node || this)[str === undefined ? 'removeAttribute' : 'setAttribute'](attribute, str);
},
deserialize: function (value, type) {
switch (type) {
case Number:
value = Number(value);
break;
case Boolean:
value = value !== null;
break;
case Object:
try {
value = JSON.parse(value);
} catch (x) {
}
break;
case Array:
try {
value = JSON.parse(value);
} catch (x) {
value = null;
console.warn('Polymer::Attributes: couldn`t decode Array as JSON');
}
break;
case Date:
value = new Date(value);
break;
case String:
default:
break;
}
return value;
},
serialize: function (value) {
switch (typeof value) {
case 'boolean':
return value ? '' : undefined;
case 'object':
if (value instanceof Date) {
return value;
} else if (value) {
try {
return JSON.stringify(value);
} catch (x) {
return '';
}
}
default:
return value != null ? value : undefined;
}
}
});
Polymer.Base._addFeature({
_setupDebouncers: function () {
this._debouncers = {};
},
debounce: function (jobName, callback, wait) {
return this._debouncers[jobName] = Polymer.Debounce.call(this, this._debouncers[jobName], callback, wait);
},
isDebouncerActive: function (jobName) {
var debouncer = this._debouncers[jobName];
return debouncer && debouncer.finish;
},
flushDebouncer: function (jobName) {
var debouncer = this._debouncers[jobName];
if (debouncer) {
debouncer.complete();
}
},
cancelDebouncer: function (jobName) {
var debouncer = this._debouncers[jobName];
if (debouncer) {
debouncer.stop();
}
}
});
Polymer.version = '1.0.9';
Polymer.Base._addFeature({
_registerFeatures: function () {
this._prepIs();
this._prepAttributes();
this._prepBehaviors();
this._prepConstructor();
},
_prepBehavior: function (b) {
this._addHostAttributes(b.hostAttributes);
},
_marshalBehavior: function (b) {
},
_initFeatures: function () {
this._marshalHostAttributes();
this._setupDebouncers();
this._marshalBehaviors();
}
});</script>

<script>Polymer.Base._addFeature({
_prepTemplate: function () {
this._template = this._template || Polymer.DomModule.import(this.is, 'template');
if (this._template && this._template.hasAttribute('is')) {
this._warn(this._logf('_prepTemplate', 'top-level Polymer template ' + 'must not be a type-extension, found', this._template, 'Move inside simple <template>.'));
}
if (this._template && !this._template.content && HTMLTemplateElement.bootstrap) {
HTMLTemplateElement.decorate(this._template);
HTMLTemplateElement.bootstrap(this._template.content);
}
},
_stampTemplate: function () {
if (this._template) {
this.root = this.instanceTemplate(this._template);
}
},
instanceTemplate: function (template) {
var dom = document.importNode(template._content || template.content, true);
return dom;
}
});
(function () {
var baseAttachedCallback = Polymer.Base.attachedCallback;
Polymer.Base._addFeature({
_hostStack: [],
ready: function () {
},
_pushHost: function (host) {
this.dataHost = host = host || Polymer.Base._hostStack[Polymer.Base._hostStack.length - 1];
if (host && host._clients) {
host._clients.push(this);
}
this._beginHost();
},
_beginHost: function () {
Polymer.Base._hostStack.push(this);
if (!this._clients) {
this._clients = [];
}
},
_popHost: function () {
Polymer.Base._hostStack.pop();
},
_tryReady: function () {
if (this._canReady()) {
this._ready();
}
},
_canReady: function () {
return !this.dataHost || this.dataHost._clientsReadied;
},
_ready: function () {
this._beforeClientsReady();
this._setupRoot();
this._readyClients();
this._afterClientsReady();
this._readySelf();
},
_readyClients: function () {
this._beginDistribute();
var c$ = this._clients;
for (var i = 0, l = c$.length, c; i < l && (c = c$[i]); i++) {
c._ready();
}
this._finishDistribute();
this._clientsReadied = true;
this._clients = null;
},
_readySelf: function () {
this._doBehavior('ready');
this._readied = true;
if (this._attachedPending) {
this._attachedPending = false;
this.attachedCallback();
}
},
_beforeClientsReady: function () {
},
_afterClientsReady: function () {
},
_beforeAttached: function () {
},
attachedCallback: function () {
if (this._readied) {
this._beforeAttached();
baseAttachedCallback.call(this);
} else {
this._attachedPending = true;
}
}
});
}());
Polymer.ArraySplice = function () {
function newSplice(index, removed, addedCount) {
return {
index: index,
removed: removed,
addedCount: addedCount
};
}
var EDIT_LEAVE = 0;
var EDIT_UPDATE = 1;
var EDIT_ADD = 2;
var EDIT_DELETE = 3;
function ArraySplice() {
}
ArraySplice.prototype = {
calcEditDistances: function (current, currentStart, currentEnd, old, oldStart, oldEnd) {
var rowCount = oldEnd - oldStart + 1;
var columnCount = currentEnd - currentStart + 1;
var distances = new Array(rowCount);
for (var i = 0; i < rowCount; i++) {
distances[i] = new Array(columnCount);
distances[i][0] = i;
}
for (var j = 0; j < columnCount; j++)
distances[0][j] = j;
for (var i = 1; i < rowCount; i++) {
for (var j = 1; j < columnCount; j++) {
if (this.equals(current[currentStart + j - 1], old[oldStart + i - 1]))
distances[i][j] = distances[i - 1][j - 1];
else {
var north = distances[i - 1][j] + 1;
var west = distances[i][j - 1] + 1;
distances[i][j] = north < west ? north : west;
}
}
}
return distances;
},
spliceOperationsFromEditDistances: function (distances) {
var i = distances.length - 1;
var j = distances[0].length - 1;
var current = distances[i][j];
var edits = [];
while (i > 0 || j > 0) {
if (i == 0) {
edits.push(EDIT_ADD);
j--;
continue;
}
if (j == 0) {
edits.push(EDIT_DELETE);
i--;
continue;
}
var northWest = distances[i - 1][j - 1];
var west = distances[i - 1][j];
var north = distances[i][j - 1];
var min;
if (west < north)
min = west < northWest ? west : northWest;
else
min = north < northWest ? north : northWest;
if (min == northWest) {
if (northWest == current) {
edits.push(EDIT_LEAVE);
} else {
edits.push(EDIT_UPDATE);
current = northWest;
}
i--;
j--;
} else if (min == west) {
edits.push(EDIT_DELETE);
i--;
current = west;
} else {
edits.push(EDIT_ADD);
j--;
current = north;
}
}
edits.reverse();
return edits;
},
calcSplices: function (current, currentStart, currentEnd, old, oldStart, oldEnd) {
var prefixCount = 0;
var suffixCount = 0;
var minLength = Math.min(currentEnd - currentStart, oldEnd - oldStart);
if (currentStart == 0 && oldStart == 0)
prefixCount = this.sharedPrefix(current, old, minLength);
if (currentEnd == current.length && oldEnd == old.length)
suffixCount = this.sharedSuffix(current, old, minLength - prefixCount);
currentStart += prefixCount;
oldStart += prefixCount;
currentEnd -= suffixCount;
oldEnd -= suffixCount;
if (currentEnd - currentStart == 0 && oldEnd - oldStart == 0)
return [];
if (currentStart == currentEnd) {
var splice = newSplice(currentStart, [], 0);
while (oldStart < oldEnd)
splice.removed.push(old[oldStart++]);
return [splice];
} else if (oldStart == oldEnd)
return [newSplice(currentStart, [], currentEnd - currentStart)];
var ops = this.spliceOperationsFromEditDistances(this.calcEditDistances(current, currentStart, currentEnd, old, oldStart, oldEnd));
var splice = undefined;
var splices = [];
var index = currentStart;
var oldIndex = oldStart;
for (var i = 0; i < ops.length; i++) {
switch (ops[i]) {
case EDIT_LEAVE:
if (splice) {
splices.push(splice);
splice = undefined;
}
index++;
oldIndex++;
break;
case EDIT_UPDATE:
if (!splice)
splice = newSplice(index, [], 0);
splice.addedCount++;
index++;
splice.removed.push(old[oldIndex]);
oldIndex++;
break;
case EDIT_ADD:
if (!splice)
splice = newSplice(index, [], 0);
splice.addedCount++;
index++;
break;
case EDIT_DELETE:
if (!splice)
splice = newSplice(index, [], 0);
splice.removed.push(old[oldIndex]);
oldIndex++;
break;
}
}
if (splice) {
splices.push(splice);
}
return splices;
},
sharedPrefix: function (current, old, searchLength) {
for (var i = 0; i < searchLength; i++)
if (!this.equals(current[i], old[i]))
return i;
return searchLength;
},
sharedSuffix: function (current, old, searchLength) {
var index1 = current.length;
var index2 = old.length;
var count = 0;
while (count < searchLength && this.equals(current[--index1], old[--index2]))
count++;
return count;
},
calculateSplices: function (current, previous) {
return this.calcSplices(current, 0, current.length, previous, 0, previous.length);
},
equals: function (currentValue, previousValue) {
return currentValue === previousValue;
}
};
return new ArraySplice();
}();
Polymer.EventApi = function () {
var Settings = Polymer.Settings;
var EventApi = function (event) {
this.event = event;
};
if (Settings.useShadow) {
EventApi.prototype = {
get rootTarget() {
return this.event.path[0];
},
get localTarget() {
return this.event.target;
},
get path() {
return this.event.path;
}
};
} else {
EventApi.prototype = {
get rootTarget() {
return this.event.target;
},
get localTarget() {
var current = this.event.currentTarget;
var currentRoot = current && Polymer.dom(current).getOwnerRoot();
var p$ = this.path;
for (var i = 0; i < p$.length; i++) {
if (Polymer.dom(p$[i]).getOwnerRoot() === currentRoot) {
return p$[i];
}
}
},
get path() {
if (!this.event._path) {
var path = [];
var o = this.rootTarget;
while (o) {
path.push(o);
o = Polymer.dom(o).parentNode || o.host;
}
path.push(window);
this.event._path = path;
}
return this.event._path;
}
};
}
var factory = function (event) {
if (!event.__eventApi) {
event.__eventApi = new EventApi(event);
}
return event.__eventApi;
};
return { factory: factory };
}();
Polymer.domInnerHTML = function () {
var escapeAttrRegExp = /[&\u00A0"]/g;
var escapeDataRegExp = /[&\u00A0<>]/g;
function escapeReplace(c) {
switch (c) {
case '&':
return '&amp;';
case '<':
return '&lt;';
case '>':
return '&gt;';
case '"':
return '&quot;';
case '\xA0':
return '&nbsp;';
}
}
function escapeAttr(s) {
return s.replace(escapeAttrRegExp, escapeReplace);
}
function escapeData(s) {
return s.replace(escapeDataRegExp, escapeReplace);
}
function makeSet(arr) {
var set = {};
for (var i = 0; i < arr.length; i++) {
set[arr[i]] = true;
}
return set;
}
var voidElements = makeSet([
'area',
'base',
'br',
'col',
'command',
'embed',
'hr',
'img',
'input',
'keygen',
'link',
'meta',
'param',
'source',
'track',
'wbr'
]);
var plaintextParents = makeSet([
'style',
'script',
'xmp',
'iframe',
'noembed',
'noframes',
'plaintext',
'noscript'
]);
function getOuterHTML(node, parentNode, composed) {
switch (node.nodeType) {
case Node.ELEMENT_NODE:
var tagName = node.localName;
var s = '<' + tagName;
var attrs = node.attributes;
for (var i = 0, attr; attr = attrs[i]; i++) {
s += ' ' + attr.name + '="' + escapeAttr(attr.value) + '"';
}
s += '>';
if (voidElements[tagName]) {
return s;
}
return s + getInnerHTML(node, composed) + '</' + tagName + '>';
case Node.TEXT_NODE:
var data = node.data;
if (parentNode && plaintextParents[parentNode.localName]) {
return data;
}
return escapeData(data);
case Node.COMMENT_NODE:
return '<!--' + node.data + '-->';
default:
console.error(node);
throw new Error('not implemented');
}
}
function getInnerHTML(node, composed) {
if (node instanceof HTMLTemplateElement)
node = node.content;
var s = '';
var c$ = Polymer.dom(node).childNodes;
c$ = composed ? node._composedChildren : c$;
for (var i = 0, l = c$.length, child; i < l && (child = c$[i]); i++) {
s += getOuterHTML(child, node, composed);
}
return s;
}
return { getInnerHTML: getInnerHTML };
}();
Polymer.DomApi = function () {
'use strict';
var Settings = Polymer.Settings;
var getInnerHTML = Polymer.domInnerHTML.getInnerHTML;
var nativeInsertBefore = Element.prototype.insertBefore;
var nativeRemoveChild = Element.prototype.removeChild;
var nativeAppendChild = Element.prototype.appendChild;
var nativeCloneNode = Element.prototype.cloneNode;
var nativeImportNode = Document.prototype.importNode;
var DomApi = function (node) {
this.node = node;
if (this.patch) {
this.patch();
}
};
if (window.wrap && Settings.useShadow && !Settings.useNativeShadow) {
DomApi = function (node) {
this.node = wrap(node);
if (this.patch) {
this.patch();
}
};
}
DomApi.prototype = {
flush: function () {
Polymer.dom.flush();
},
_lazyDistribute: function (host) {
if (host.shadyRoot && host.shadyRoot._distributionClean) {
host.shadyRoot._distributionClean = false;
Polymer.dom.addDebouncer(host.debounce('_distribute', host._distributeContent));
}
},
appendChild: function (node) {
var handled;
this._removeNodeFromHost(node, true);
if (this._nodeIsInLogicalTree(this.node)) {
this._addLogicalInfo(node, this.node);
this._addNodeToHost(node);
handled = this._maybeDistribute(node, this.node);
}
if (!handled && !this._tryRemoveUndistributedNode(node)) {
var container = this.node._isShadyRoot ? this.node.host : this.node;
addToComposedParent(container, node);
nativeAppendChild.call(container, node);
}
return node;
},
insertBefore: function (node, ref_node) {
if (!ref_node) {
return this.appendChild(node);
}
var handled;
this._removeNodeFromHost(node, true);
if (this._nodeIsInLogicalTree(this.node)) {
saveLightChildrenIfNeeded(this.node);
var children = this.childNodes;
var index = children.indexOf(ref_node);
if (index < 0) {
throw Error('The ref_node to be inserted before is not a child ' + 'of this node');
}
this._addLogicalInfo(node, this.node, index);
this._addNodeToHost(node);
handled = this._maybeDistribute(node, this.node);
}
if (!handled && !this._tryRemoveUndistributedNode(node)) {
ref_node = ref_node.localName === CONTENT ? this._firstComposedNode(ref_node) : ref_node;
var container = this.node._isShadyRoot ? this.node.host : this.node;
addToComposedParent(container, node, ref_node);
nativeInsertBefore.call(container, node, ref_node);
}
return node;
},
removeChild: function (node) {
if (factory(node).parentNode !== this.node) {
console.warn('The node to be removed is not a child of this node', node);
}
var handled;
if (this._nodeIsInLogicalTree(this.node)) {
this._removeNodeFromHost(node);
handled = this._maybeDistribute(node, this.node);
}
if (!handled) {
var container = this.node._isShadyRoot ? this.node.host : this.node;
if (container === node.parentNode) {
removeFromComposedParent(container, node);
nativeRemoveChild.call(container, node);
}
}
return node;
},
replaceChild: function (node, ref_node) {
this.insertBefore(node, ref_node);
this.removeChild(ref_node);
return node;
},
_hasCachedOwnerRoot: function (node) {
return Boolean(node._ownerShadyRoot !== undefined);
},
getOwnerRoot: function () {
return this._ownerShadyRootForNode(this.node);
},
_ownerShadyRootForNode: function (node) {
if (!node) {
return;
}
if (node._ownerShadyRoot === undefined) {
var root;
if (node._isShadyRoot) {
root = node;
} else {
var parent = Polymer.dom(node).parentNode;
if (parent) {
root = parent._isShadyRoot ? parent : this._ownerShadyRootForNode(parent);
} else {
root = null;
}
}
node._ownerShadyRoot = root;
}
return node._ownerShadyRoot;
},
_maybeDistribute: function (node, parent) {
var fragContent = node.nodeType === Node.DOCUMENT_FRAGMENT_NODE && !node.__noContent && Polymer.dom(node).querySelector(CONTENT);
var wrappedContent = fragContent && Polymer.dom(fragContent).parentNode.nodeType !== Node.DOCUMENT_FRAGMENT_NODE;
var hasContent = fragContent || node.localName === CONTENT;
if (hasContent) {
var root = this._ownerShadyRootForNode(parent);
if (root) {
var host = root.host;
this._updateInsertionPoints(host);
this._lazyDistribute(host);
}
}
var parentNeedsDist = this._parentNeedsDistribution(parent);
if (parentNeedsDist) {
this._lazyDistribute(parent);
}
return parentNeedsDist || hasContent && !wrappedContent;
},
_tryRemoveUndistributedNode: function (node) {
if (this.node.shadyRoot) {
if (node._composedParent) {
nativeRemoveChild.call(node._composedParent, node);
}
return true;
}
},
_updateInsertionPoints: function (host) {
host.shadyRoot._insertionPoints = factory(host.shadyRoot).querySelectorAll(CONTENT);
},
_nodeIsInLogicalTree: function (node) {
return Boolean(node._lightParent !== undefined || node._isShadyRoot || this._ownerShadyRootForNode(node) || node.shadyRoot);
},
_parentNeedsDistribution: function (parent) {
return parent && parent.shadyRoot && hasInsertionPoint(parent.shadyRoot);
},
_removeNodeFromHost: function (node, ensureComposedRemoval) {
var hostNeedsDist;
var root;
var parent = node._lightParent;
if (parent) {
root = this._ownerShadyRootForNode(node);
if (root) {
root.host._elementRemove(node);
hostNeedsDist = this._removeDistributedChildren(root, node);
}
this._removeLogicalInfo(node, node._lightParent);
}
this._removeOwnerShadyRoot(node);
if (root && hostNeedsDist) {
this._updateInsertionPoints(root.host);
this._lazyDistribute(root.host);
} else if (ensureComposedRemoval) {
removeFromComposedParent(parent || node.parentNode, node);
}
},
_removeDistributedChildren: function (root, container) {
var hostNeedsDist;
var ip$ = root._insertionPoints;
for (var i = 0; i < ip$.length; i++) {
var content = ip$[i];
if (this._contains(container, content)) {
var dc$ = factory(content).getDistributedNodes();
for (var j = 0; j < dc$.length; j++) {
hostNeedsDist = true;
var node = dc$[j];
var parent = node.parentNode;
if (parent) {
removeFromComposedParent(parent, node);
nativeRemoveChild.call(parent, node);
}
}
}
}
return hostNeedsDist;
},
_contains: function (container, node) {
while (node) {
if (node == container) {
return true;
}
node = factory(node).parentNode;
}
},
_addNodeToHost: function (node) {
var checkNode = node.nodeType === Node.DOCUMENT_FRAGMENT_NODE ? node.firstChild : node;
var root = this._ownerShadyRootForNode(checkNode);
if (root) {
root.host._elementAdd(node);
}
},
_addLogicalInfo: function (node, container, index) {
saveLightChildrenIfNeeded(container);
var children = factory(container).childNodes;
index = index === undefined ? children.length : index;
if (node.nodeType === Node.DOCUMENT_FRAGMENT_NODE) {
var c$ = Array.prototype.slice.call(node.childNodes);
for (var i = 0, n; i < c$.length && (n = c$[i]); i++) {
children.splice(index++, 0, n);
n._lightParent = container;
}
} else {
children.splice(index, 0, node);
node._lightParent = container;
}
},
_removeLogicalInfo: function (node, container) {
var children = factory(container).childNodes;
var index = children.indexOf(node);
if (index < 0 || container !== node._lightParent) {
throw Error('The node to be removed is not a child of this node');
}
children.splice(index, 1);
node._lightParent = null;
},
_removeOwnerShadyRoot: function (node) {
if (this._hasCachedOwnerRoot(node)) {
var c$ = factory(node).childNodes;
for (var i = 0, l = c$.length, n; i < l && (n = c$[i]); i++) {
this._removeOwnerShadyRoot(n);
}
}
node._ownerShadyRoot = undefined;
},
_firstComposedNode: function (content) {
var n$ = factory(content).getDistributedNodes();
for (var i = 0, l = n$.length, n, p$; i < l && (n = n$[i]); i++) {
p$ = factory(n).getDestinationInsertionPoints();
if (p$[p$.length - 1] === content) {
return n;
}
}
},
querySelector: function (selector) {
return this.querySelectorAll(selector)[0];
},
querySelectorAll: function (selector) {
return this._query(function (n) {
return matchesSelector.call(n, selector);
}, this.node);
},
_query: function (matcher, node) {
node = node || this.node;
var list = [];
this._queryElements(factory(node).childNodes, matcher, list);
return list;
},
_queryElements: function (elements, matcher, list) {
for (var i = 0, l = elements.length, c; i < l && (c = elements[i]); i++) {
if (c.nodeType === Node.ELEMENT_NODE) {
this._queryElement(c, matcher, list);
}
}
},
_queryElement: function (node, matcher, list) {
if (matcher(node)) {
list.push(node);
}
this._queryElements(factory(node).childNodes, matcher, list);
},
getDestinationInsertionPoints: function () {
return this.node._destinationInsertionPoints || [];
},
getDistributedNodes: function () {
return this.node._distributedNodes || [];
},
queryDistributedElements: function (selector) {
var c$ = this.childNodes;
var list = [];
this._distributedFilter(selector, c$, list);
for (var i = 0, l = c$.length, c; i < l && (c = c$[i]); i++) {
if (c.localName === CONTENT) {
this._distributedFilter(selector, factory(c).getDistributedNodes(), list);
}
}
return list;
},
_distributedFilter: function (selector, list, results) {
results = results || [];
for (var i = 0, l = list.length, d; i < l && (d = list[i]); i++) {
if (d.nodeType === Node.ELEMENT_NODE && d.localName !== CONTENT && matchesSelector.call(d, selector)) {
results.push(d);
}
}
return results;
},
_clear: function () {
while (this.childNodes.length) {
this.removeChild(this.childNodes[0]);
}
},
setAttribute: function (name, value) {
this.node.setAttribute(name, value);
this._distributeParent();
},
removeAttribute: function (name) {
this.node.removeAttribute(name);
this._distributeParent();
},
_distributeParent: function () {
if (this._parentNeedsDistribution(this.parentNode)) {
this._lazyDistribute(this.parentNode);
}
},
cloneNode: function (deep) {
var n = nativeCloneNode.call(this.node, false);
if (deep) {
var c$ = this.childNodes;
var d = factory(n);
for (var i = 0, nc; i < c$.length; i++) {
nc = factory(c$[i]).cloneNode(true);
d.appendChild(nc);
}
}
return n;
},
importNode: function (externalNode, deep) {
var doc = this.node instanceof Document ? this.node : this.node.ownerDocument;
var n = nativeImportNode.call(doc, externalNode, false);
if (deep) {
var c$ = factory(externalNode).childNodes;
var d = factory(n);
for (var i = 0, nc; i < c$.length; i++) {
nc = factory(doc).importNode(c$[i], true);
d.appendChild(nc);
}
}
return n;
}
};
Object.defineProperty(DomApi.prototype, 'classList', {
get: function () {
if (!this._classList) {
this._classList = new DomApi.ClassList(this);
}
return this._classList;
},
configurable: true
});
DomApi.ClassList = function (host) {
this.domApi = host;
this.node = host.node;
};
DomApi.ClassList.prototype = {
add: function () {
this.node.classList.add.apply(this.node.classList, arguments);
this.domApi._distributeParent();
},
remove: function () {
this.node.classList.remove.apply(this.node.classList, arguments);
this.domApi._distributeParent();
},
toggle: function () {
this.node.classList.toggle.apply(this.node.classList, arguments);
this.domApi._distributeParent();
},
contains: function () {
return this.node.classList.contains.apply(this.node.classList, arguments);
}
};
if (!Settings.useShadow) {
Object.defineProperties(DomApi.prototype, {
childNodes: {
get: function () {
var c$ = getLightChildren(this.node);
return Array.isArray(c$) ? c$ : Array.prototype.slice.call(c$);
},
configurable: true
},
children: {
get: function () {
return Array.prototype.filter.call(this.childNodes, function (n) {
return n.nodeType === Node.ELEMENT_NODE;
});
},
configurable: true
},
parentNode: {
get: function () {
return this.node._lightParent || (this.node.__patched ? this.node._composedParent : this.node.parentNode);
},
configurable: true
},
firstChild: {
get: function () {
return this.childNodes[0];
},
configurable: true
},
lastChild: {
get: function () {
var c$ = this.childNodes;
return c$[c$.length - 1];
},
configurable: true
},
nextSibling: {
get: function () {
var c$ = this.parentNode && factory(this.parentNode).childNodes;
if (c$) {
return c$[Array.prototype.indexOf.call(c$, this.node) + 1];
}
},
configurable: true
},
previousSibling: {
get: function () {
var c$ = this.parentNode && factory(this.parentNode).childNodes;
if (c$) {
return c$[Array.prototype.indexOf.call(c$, this.node) - 1];
}
},
configurable: true
},
firstElementChild: {
get: function () {
return this.children[0];
},
configurable: true
},
lastElementChild: {
get: function () {
var c$ = this.children;
return c$[c$.length - 1];
},
configurable: true
},
nextElementSibling: {
get: function () {
var c$ = this.parentNode && factory(this.parentNode).children;
if (c$) {
return c$[Array.prototype.indexOf.call(c$, this.node) + 1];
}
},
configurable: true
},
previousElementSibling: {
get: function () {
var c$ = this.parentNode && factory(this.parentNode).children;
if (c$) {
return c$[Array.prototype.indexOf.call(c$, this.node) - 1];
}
},
configurable: true
},
textContent: {
get: function () {
var nt = this.node.nodeType;
if (nt === Node.TEXT_NODE || nt === Node.COMMENT_NODE) {
return this.node.textContent;
} else {
var tc = [];
for (var i = 0, cn = this.childNodes, c; c = cn[i]; i++) {
if (c.nodeType !== Node.COMMENT_NODE) {
tc.push(c.textContent);
}
}
return tc.join('');
}
},
set: function (text) {
var nt = this.node.nodeType;
if (nt === Node.TEXT_NODE || nt === Node.COMMENT_NODE) {
this.node.textContent = text;
} else {
this._clear();
if (text) {
this.appendChild(document.createTextNode(text));
}
}
},
configurable: true
},
innerHTML: {
get: function () {
var nt = this.node.nodeType;
if (nt === Node.TEXT_NODE || nt === Node.COMMENT_NODE) {
return null;
} else {
return getInnerHTML(this.node);
}
},
set: function (text) {
var nt = this.node.nodeType;
if (nt !== Node.TEXT_NODE || nt !== Node.COMMENT_NODE) {
this._clear();
var d = document.createElement('div');
d.innerHTML = text;
var c$ = Array.prototype.slice.call(d.childNodes);
for (var i = 0; i < c$.length; i++) {
this.appendChild(c$[i]);
}
}
},
configurable: true
}
});
DomApi.prototype._getComposedInnerHTML = function () {
return getInnerHTML(this.node, true);
};
} else {
DomApi.prototype.querySelectorAll = function (selector) {
return Array.prototype.slice.call(this.node.querySelectorAll(selector));
};
DomApi.prototype.getOwnerRoot = function () {
var n = this.node;
while (n) {
if (n.nodeType === Node.DOCUMENT_FRAGMENT_NODE && n.host) {
return n;
}
n = n.parentNode;
}
};
DomApi.prototype.cloneNode = function (deep) {
return this.node.cloneNode(deep);
};
DomApi.prototype.importNode = function (externalNode, deep) {
var doc = this.node instanceof Document ? this.node : this.node.ownerDocument;
return doc.importNode(externalNode, deep);
};
DomApi.prototype.getDestinationInsertionPoints = function () {
var n$ = this.node.getDestinationInsertionPoints && this.node.getDestinationInsertionPoints();
return n$ ? Array.prototype.slice.call(n$) : [];
};
DomApi.prototype.getDistributedNodes = function () {
var n$ = this.node.getDistributedNodes && this.node.getDistributedNodes();
return n$ ? Array.prototype.slice.call(n$) : [];
};
DomApi.prototype._distributeParent = function () {
};
Object.defineProperties(DomApi.prototype, {
childNodes: {
get: function () {
return Array.prototype.slice.call(this.node.childNodes);
},
configurable: true
},
children: {
get: function () {
return Array.prototype.slice.call(this.node.children);
},
configurable: true
},
textContent: {
get: function () {
return this.node.textContent;
},
set: function (value) {
return this.node.textContent = value;
},
configurable: true
},
innerHTML: {
get: function () {
return this.node.innerHTML;
},
set: function (value) {
return this.node.innerHTML = value;
},
configurable: true
}
});
var forwards = [
'parentNode',
'firstChild',
'lastChild',
'nextSibling',
'previousSibling',
'firstElementChild',
'lastElementChild',
'nextElementSibling',
'previousElementSibling'
];
forwards.forEach(function (name) {
Object.defineProperty(DomApi.prototype, name, {
get: function () {
return this.node[name];
},
configurable: true
});
});
}
var CONTENT = 'content';
var factory = function (node, patch) {
node = node || document;
if (!node.__domApi) {
node.__domApi = new DomApi(node, patch);
}
return node.__domApi;
};
Polymer.dom = function (obj, patch) {
if (obj instanceof Event) {
return Polymer.EventApi.factory(obj);
} else {
return factory(obj, patch);
}
};
Polymer.Base.extend(Polymer.dom, {
_flushGuard: 0,
_FLUSH_MAX: 100,
_needsTakeRecords: !Polymer.Settings.useNativeCustomElements,
_debouncers: [],
_finishDebouncer: null,
flush: function () {
for (var i = 0; i < this._debouncers.length; i++) {
this._debouncers[i].complete();
}
if (this._finishDebouncer) {
this._finishDebouncer.complete();
}
this._flushPolyfills();
if (this._debouncers.length && this._flushGuard < this._FLUSH_MAX) {
this._flushGuard++;
this.flush();
} else {
if (this._flushGuard >= this._FLUSH_MAX) {
console.warn('Polymer.dom.flush aborted. Flush may not be complete.');
}
this._flushGuard = 0;
}
},
_flushPolyfills: function () {
if (this._needsTakeRecords) {
CustomElements.takeRecords();
}
},
addDebouncer: function (debouncer) {
this._debouncers.push(debouncer);
this._finishDebouncer = Polymer.Debounce(this._finishDebouncer, this._finishFlush);
},
_finishFlush: function () {
Polymer.dom._debouncers = [];
}
});
function getLightChildren(node) {
var children = node._lightChildren;
return children ? children : node.childNodes;
}
function getComposedChildren(node) {
if (!node._composedChildren) {
node._composedChildren = Array.prototype.slice.call(node.childNodes);
}
return node._composedChildren;
}
function addToComposedParent(parent, node, ref_node) {
var children = getComposedChildren(parent);
var i = ref_node ? children.indexOf(ref_node) : -1;
if (node.nodeType === Node.DOCUMENT_FRAGMENT_NODE) {
var fragChildren = getComposedChildren(node);
for (var j = 0; j < fragChildren.length; j++) {
addNodeToComposedChildren(fragChildren[j], parent, children, i + j);
}
node._composedChildren = null;
} else {
addNodeToComposedChildren(node, parent, children, i);
}
}
function addNodeToComposedChildren(node, parent, children, i) {
node._composedParent = parent;
children.splice(i >= 0 ? i : children.length, 0, node);
}
function removeFromComposedParent(parent, node) {
node._composedParent = null;
if (parent) {
var children = getComposedChildren(parent);
var i = children.indexOf(node);
if (i >= 0) {
children.splice(i, 1);
}
}
}
function saveLightChildrenIfNeeded(node) {
if (!node._lightChildren) {
var c$ = Array.prototype.slice.call(node.childNodes);
for (var i = 0, l = c$.length, child; i < l && (child = c$[i]); i++) {
child._lightParent = child._lightParent || node;
}
node._lightChildren = c$;
}
}
function hasInsertionPoint(root) {
return Boolean(root._insertionPoints.length);
}
var p = Element.prototype;
var matchesSelector = p.matches || p.matchesSelector || p.mozMatchesSelector || p.msMatchesSelector || p.oMatchesSelector || p.webkitMatchesSelector;
return {
getLightChildren: getLightChildren,
getComposedChildren: getComposedChildren,
removeFromComposedParent: removeFromComposedParent,
saveLightChildrenIfNeeded: saveLightChildrenIfNeeded,
matchesSelector: matchesSelector,
hasInsertionPoint: hasInsertionPoint,
ctor: DomApi,
factory: factory
};
}();
(function () {
Polymer.Base._addFeature({
_prepShady: function () {
this._useContent = this._useContent || Boolean(this._template);
},
_poolContent: function () {
if (this._useContent) {
saveLightChildrenIfNeeded(this);
}
},
_setupRoot: function () {
if (this._useContent) {
this._createLocalRoot();
if (!this.dataHost) {
upgradeLightChildren(this._lightChildren);
}
}
},
_createLocalRoot: function () {
this.shadyRoot = this.root;
this.shadyRoot._distributionClean = false;
this.shadyRoot._isShadyRoot = true;
this.shadyRoot._dirtyRoots = [];
this.shadyRoot._insertionPoints = !this._notes || this._notes._hasContent ? this.shadyRoot.querySelectorAll('content') : [];
saveLightChildrenIfNeeded(this.shadyRoot);
this.shadyRoot.host = this;
},
get domHost() {
var root = Polymer.dom(this).getOwnerRoot();
return root && root.host;
},
distributeContent: function (updateInsertionPoints) {
if (this.shadyRoot) {
var dom = Polymer.dom(this);
if (updateInsertionPoints) {
dom._updateInsertionPoints(this);
}
var host = getTopDistributingHost(this);
dom._lazyDistribute(host);
}
},
_distributeContent: function () {
if (this._useContent && !this.shadyRoot._distributionClean) {
this._beginDistribute();
this._distributeDirtyRoots();
this._finishDistribute();
}
},
_beginDistribute: function () {
if (this._useContent && hasInsertionPoint(this.shadyRoot)) {
this._resetDistribution();
this._distributePool(this.shadyRoot, this._collectPool());
}
},
_distributeDirtyRoots: function () {
var c$ = this.shadyRoot._dirtyRoots;
for (var i = 0, l = c$.length, c; i < l && (c = c$[i]); i++) {
c._distributeContent();
}
this.shadyRoot._dirtyRoots = [];
},
_finishDistribute: function () {
if (this._useContent) {
this.shadyRoot._distributionClean = true;
if (hasInsertionPoint(this.shadyRoot)) {
this._composeTree();
} else {
if (!this.shadyRoot._hasDistributed) {
this.textContent = '';
this._composedChildren = null;
this.appendChild(this.shadyRoot);
} else {
var children = this._composeNode(this);
this._updateChildNodes(this, children);
}
}
this.shadyRoot._hasDistributed = true;
}
},
elementMatches: function (selector, node) {
node = node || this;
return matchesSelector.call(node, selector);
},
_resetDistribution: function () {
var children = getLightChildren(this);
for (var i = 0; i < children.length; i++) {
var child = children[i];
if (child._destinationInsertionPoints) {
child._destinationInsertionPoints = undefined;
}
if (isInsertionPoint(child)) {
clearDistributedDestinationInsertionPoints(child);
}
}
var root = this.shadyRoot;
var p$ = root._insertionPoints;
for (var j = 0; j < p$.length; j++) {
p$[j]._distributedNodes = [];
}
},
_collectPool: function () {
var pool = [];
var children = getLightChildren(this);
for (var i = 0; i < children.length; i++) {
var child = children[i];
if (isInsertionPoint(child)) {
pool.push.apply(pool, child._distributedNodes);
} else {
pool.push(child);
}
}
return pool;
},
_distributePool: function (node, pool) {
var p$ = node._insertionPoints;
for (var i = 0, l = p$.length, p; i < l && (p = p$[i]); i++) {
this._distributeInsertionPoint(p, pool);
maybeRedistributeParent(p, this);
}
},
_distributeInsertionPoint: function (content, pool) {
var anyDistributed = false;
for (var i = 0, l = pool.length, node; i < l; i++) {
node = pool[i];
if (!node) {
continue;
}
if (this._matchesContentSelect(node, content)) {
distributeNodeInto(node, content);
pool[i] = undefined;
anyDistributed = true;
}
}
if (!anyDistributed) {
var children = getLightChildren(content);
for (var j = 0; j < children.length; j++) {
distributeNodeInto(children[j], content);
}
}
},
_composeTree: function () {
this._updateChildNodes(this, this._composeNode(this));
var p$ = this.shadyRoot._insertionPoints;
for (var i = 0, l = p$.length, p, parent; i < l && (p = p$[i]); i++) {
parent = p._lightParent || p.parentNode;
if (!parent._useContent && parent !== this && parent !== this.shadyRoot) {
this._updateChildNodes(parent, this._composeNode(parent));
}
}
},
_composeNode: function (node) {
var children = [];
var c$ = getLightChildren(node.shadyRoot || node);
for (var i = 0; i < c$.length; i++) {
var child = c$[i];
if (isInsertionPoint(child)) {
var distributedNodes = child._distributedNodes;
for (var j = 0; j < distributedNodes.length; j++) {
var distributedNode = distributedNodes[j];
if (isFinalDestination(child, distributedNode)) {
children.push(distributedNode);
}
}
} else {
children.push(child);
}
}
return children;
},
_updateChildNodes: function (container, children) {
var composed = getComposedChildren(container);
var splices = Polymer.ArraySplice.calculateSplices(children, composed);
for (var i = 0, d = 0, s; i < splices.length && (s = splices[i]); i++) {
for (var j = 0, n; j < s.removed.length && (n = s.removed[j]); j++) {
remove(n);
composed.splice(s.index + d, 1);
}
d -= s.addedCount;
}
for (var i = 0, s, next; i < splices.length && (s = splices[i]); i++) {
next = composed[s.index];
for (var j = s.index, n; j < s.index + s.addedCount; j++) {
n = children[j];
insertBefore(container, n, next);
composed.splice(j, 0, n);
}
}
},
_matchesContentSelect: function (node, contentElement) {
var select = contentElement.getAttribute('select');
if (!select) {
return true;
}
select = select.trim();
if (!select) {
return true;
}
if (!(node instanceof Element)) {
return false;
}
var validSelectors = /^(:not\()?[*.#[a-zA-Z_|]/;
if (!validSelectors.test(select)) {
return false;
}
return this.elementMatches(select, node);
},
_elementAdd: function () {
},
_elementRemove: function () {
}
});
var saveLightChildrenIfNeeded = Polymer.DomApi.saveLightChildrenIfNeeded;
var getLightChildren = Polymer.DomApi.getLightChildren;
var matchesSelector = Polymer.DomApi.matchesSelector;
var hasInsertionPoint = Polymer.DomApi.hasInsertionPoint;
var getComposedChildren = Polymer.DomApi.getComposedChildren;
var removeFromComposedParent = Polymer.DomApi.removeFromComposedParent;
function distributeNodeInto(child, insertionPoint) {
insertionPoint._distributedNodes.push(child);
var points = child._destinationInsertionPoints;
if (!points) {
child._destinationInsertionPoints = [insertionPoint];
} else {
points.push(insertionPoint);
}
}
function clearDistributedDestinationInsertionPoints(content) {
var e$ = content._distributedNodes;
if (e$) {
for (var i = 0; i < e$.length; i++) {
var d = e$[i]._destinationInsertionPoints;
if (d) {
d.splice(d.indexOf(content) + 1, d.length);
}
}
}
}
function maybeRedistributeParent(content, host) {
var parent = content._lightParent;
if (parent && parent.shadyRoot && hasInsertionPoint(parent.shadyRoot) && parent.shadyRoot._distributionClean) {
parent.shadyRoot._distributionClean = false;
host.shadyRoot._dirtyRoots.push(parent);
}
}
function isFinalDestination(insertionPoint, node) {
var points = node._destinationInsertionPoints;
return points && points[points.length - 1] === insertionPoint;
}
function isInsertionPoint(node) {
return node.localName == 'content';
}
var nativeInsertBefore = Element.prototype.insertBefore;
var nativeRemoveChild = Element.prototype.removeChild;
function insertBefore(parentNode, newChild, refChild) {
var newChildParent = getComposedParent(newChild);
if (newChildParent !== parentNode) {
removeFromComposedParent(newChildParent, newChild);
}
remove(newChild);
saveLightChildrenIfNeeded(parentNode);
nativeInsertBefore.call(parentNode, newChild, refChild || null);
newChild._composedParent = parentNode;
}
function remove(node) {
var parentNode = getComposedParent(node);
if (parentNode) {
saveLightChildrenIfNeeded(parentNode);
node._composedParent = null;
nativeRemoveChild.call(parentNode, node);
}
}
function getComposedParent(node) {
return node.__patched ? node._composedParent : node.parentNode;
}
function getTopDistributingHost(host) {
while (host && hostNeedsRedistribution(host)) {
host = host.domHost;
}
return host;
}
function hostNeedsRedistribution(host) {
var c$ = Polymer.dom(host).children;
for (var i = 0, c; i < c$.length; i++) {
c = c$[i];
if (c.localName === 'content') {
return host.domHost;
}
}
}
var needsUpgrade = window.CustomElements && !CustomElements.useNative;
function upgradeLightChildren(children) {
if (needsUpgrade && children) {
for (var i = 0; i < children.length; i++) {
CustomElements.upgrade(children[i]);
}
}
}
}());
if (Polymer.Settings.useShadow) {
Polymer.Base._addFeature({
_poolContent: function () {
},
_beginDistribute: function () {
},
distributeContent: function () {
},
_distributeContent: function () {
},
_finishDistribute: function () {
},
_createLocalRoot: function () {
this.createShadowRoot();
this.shadowRoot.appendChild(this.root);
this.root = this.shadowRoot;
}
});
}
Polymer.DomModule = document.createElement('dom-module');
Polymer.Base._addFeature({
_registerFeatures: function () {
this._prepIs();
this._prepAttributes();
this._prepBehaviors();
this._prepConstructor();
this._prepTemplate();
this._prepShady();
},
_prepBehavior: function (b) {
this._addHostAttributes(b.hostAttributes);
},
_initFeatures: function () {
this._poolContent();
this._pushHost();
this._stampTemplate();
this._popHost();
this._marshalHostAttributes();
this._setupDebouncers();
this._marshalBehaviors();
this._tryReady();
},
_marshalBehavior: function (b) {
}
});</script>

<script>Polymer.nar = [];
Polymer.Annotations = {
parseAnnotations: function (template) {
var list = [];
var content = template._content || template.content;
this._parseNodeAnnotations(content, list);
return list;
},
_parseNodeAnnotations: function (node, list) {
return node.nodeType === Node.TEXT_NODE ? this._parseTextNodeAnnotation(node, list) : this._parseElementAnnotations(node, list);
},
_testEscape: function (value) {
var escape = value.slice(0, 2);
if (escape === '{{' || escape === '[[') {
return escape;
}
},
_parseTextNodeAnnotation: function (node, list) {
var v = node.textContent;
var escape = this._testEscape(v);
if (escape) {
node.textContent = ' ';
var annote = {
bindings: [{
kind: 'text',
mode: escape[0],
value: v.slice(2, -2).trim()
}]
};
list.push(annote);
return annote;
}
},
_parseElementAnnotations: function (element, list) {
var annote = {
bindings: [],
events: []
};
if (element.localName === 'content') {
list._hasContent = true;
}
this._parseChildNodesAnnotations(element, annote, list);
if (element.attributes) {
this._parseNodeAttributeAnnotations(element, annote, list);
if (this.prepElement) {
this.prepElement(element);
}
}
if (annote.bindings.length || annote.events.length || annote.id) {
list.push(annote);
}
return annote;
},
_parseChildNodesAnnotations: function (root, annote, list, callback) {
if (root.firstChild) {
for (var i = 0, node = root.firstChild; node; node = node.nextSibling, i++) {
if (node.localName === 'template' && !node.hasAttribute('preserve-content')) {
this._parseTemplate(node, i, list, annote);
}
if (node.nodeType === Node.TEXT_NODE) {
var n = node.nextSibling;
while (n && n.nodeType === Node.TEXT_NODE) {
node.textContent += n.textContent;
root.removeChild(n);
n = n.nextSibling;
}
}
var childAnnotation = this._parseNodeAnnotations(node, list, callback);
if (childAnnotation) {
childAnnotation.parent = annote;
childAnnotation.index = i;
}
}
}
},
_parseTemplate: function (node, index, list, parent) {
var content = document.createDocumentFragment();
content._notes = this.parseAnnotations(node);
content.appendChild(node.content);
list.push({
bindings: Polymer.nar,
events: Polymer.nar,
templateContent: content,
parent: parent,
index: index
});
},
_parseNodeAttributeAnnotations: function (node, annotation) {
for (var i = node.attributes.length - 1, a; a = node.attributes[i]; i--) {
var n = a.name, v = a.value;
if (n === 'id' && !this._testEscape(v)) {
annotation.id = v;
} else if (n.slice(0, 3) === 'on-') {
node.removeAttribute(n);
annotation.events.push({
name: n.slice(3),
value: v
});
} else {
var b = this._parseNodeAttributeAnnotation(node, n, v);
if (b) {
annotation.bindings.push(b);
}
}
}
},
_parseNodeAttributeAnnotation: function (node, n, v) {
var escape = this._testEscape(v);
if (escape) {
var customEvent;
var name = n;
var mode = escape[0];
v = v.slice(2, -2).trim();
var not = false;
if (v[0] == '!') {
v = v.substring(1);
not = true;
}
var kind = 'property';
if (n[n.length - 1] == '$') {
name = n.slice(0, -1);
kind = 'attribute';
}
var notifyEvent, colon;
if (mode == '{' && (colon = v.indexOf('::')) > 0) {
notifyEvent = v.substring(colon + 2);
v = v.substring(0, colon);
customEvent = true;
}
if (node.localName == 'input' && n == 'value') {
node.setAttribute(n, '');
}
node.removeAttribute(n);
if (kind === 'property') {
name = Polymer.CaseMap.dashToCamelCase(name);
}
return {
kind: kind,
mode: mode,
name: name,
value: v,
negate: not,
event: notifyEvent,
customEvent: customEvent
};
}
},
_localSubTree: function (node, host) {
return node === host ? node.childNodes : node._lightChildren || node.childNodes;
},
findAnnotatedNode: function (root, annote) {
var parent = annote.parent && Polymer.Annotations.findAnnotatedNode(root, annote.parent);
return !parent ? root : Polymer.Annotations._localSubTree(parent, root)[annote.index];
}
};
(function () {
function resolveCss(cssText, ownerDocument) {
return cssText.replace(CSS_URL_RX, function (m, pre, url, post) {
return pre + '\'' + resolve(url.replace(/["']/g, ''), ownerDocument) + '\'' + post;
});
}
function resolveAttrs(element, ownerDocument) {
for (var name in URL_ATTRS) {
var a$ = URL_ATTRS[name];
for (var i = 0, l = a$.length, a, at, v; i < l && (a = a$[i]); i++) {
if (name === '*' || element.localName === name) {
at = element.attributes[a];
v = at && at.value;
if (v && v.search(BINDING_RX) < 0) {
at.value = a === 'style' ? resolveCss(v, ownerDocument) : resolve(v, ownerDocument);
}
}
}
}
}
function resolve(url, ownerDocument) {
if (url && url[0] === '#') {
return url;
}
var resolver = getUrlResolver(ownerDocument);
resolver.href = url;
return resolver.href || url;
}
var tempDoc;
var tempDocBase;
function resolveUrl(url, baseUri) {
if (!tempDoc) {
tempDoc = document.implementation.createHTMLDocument('temp');
tempDocBase = tempDoc.createElement('base');
tempDoc.head.appendChild(tempDocBase);
}
tempDocBase.href = baseUri;
return resolve(url, tempDoc);
}
function getUrlResolver(ownerDocument) {
return ownerDocument.__urlResolver || (ownerDocument.__urlResolver = ownerDocument.createElement('a'));
}
var CSS_URL_RX = /(url\()([^)]*)(\))/g;
var URL_ATTRS = {
'*': [
'href',
'src',
'style',
'url'
],
form: ['action']
};
var BINDING_RX = /\{\{|\[\[/;
Polymer.ResolveUrl = {
resolveCss: resolveCss,
resolveAttrs: resolveAttrs,
resolveUrl: resolveUrl
};
}());
Polymer.Base._addFeature({
_prepAnnotations: function () {
if (!this._template) {
this._notes = [];
} else {
Polymer.Annotations.prepElement = this._prepElement.bind(this);
this._notes = Polymer.Annotations.parseAnnotations(this._template);
this._processAnnotations(this._notes);
Polymer.Annotations.prepElement = null;
}
},
_processAnnotations: function (notes) {
for (var i = 0; i < notes.length; i++) {
var note = notes[i];
for (var j = 0; j < note.bindings.length; j++) {
var b = note.bindings[j];
b.signature = this._parseMethod(b.value);
if (!b.signature) {
b.model = this._modelForPath(b.value);
}
}
if (note.templateContent) {
this._processAnnotations(note.templateContent._notes);
var pp = note.templateContent._parentProps = this._discoverTemplateParentProps(note.templateContent._notes);
var bindings = [];
for (var prop in pp) {
bindings.push({
index: note.index,
kind: 'property',
mode: '{',
name: '_parent_' + prop,
model: prop,
value: prop
});
}
note.bindings = note.bindings.concat(bindings);
}
}
},
_discoverTemplateParentProps: function (notes) {
var pp = {};
notes.forEach(function (n) {
n.bindings.forEach(function (b) {
if (b.signature) {
var args = b.signature.args;
for (var k = 0; k < args.length; k++) {
pp[args[k].model] = true;
}
} else {
pp[b.model] = true;
}
});
if (n.templateContent) {
var tpp = n.templateContent._parentProps;
Polymer.Base.mixin(pp, tpp);
}
});
return pp;
},
_prepElement: function (element) {
Polymer.ResolveUrl.resolveAttrs(element, this._template.ownerDocument);
},
_findAnnotatedNode: Polymer.Annotations.findAnnotatedNode,
_marshalAnnotationReferences: function () {
if (this._template) {
this._marshalIdNodes();
this._marshalAnnotatedNodes();
this._marshalAnnotatedListeners();
}
},
_configureAnnotationReferences: function () {
this._configureTemplateContent();
},
_configureTemplateContent: function () {
this._notes.forEach(function (note, i) {
if (note.templateContent) {
this._nodes[i]._content = note.templateContent;
}
}, this);
},
_marshalIdNodes: function () {
this.$ = {};
this._notes.forEach(function (a) {
if (a.id) {
this.$[a.id] = this._findAnnotatedNode(this.root, a);
}
}, this);
},
_marshalAnnotatedNodes: function () {
if (this._nodes) {
this._nodes = this._nodes.map(function (a) {
return this._findAnnotatedNode(this.root, a);
}, this);
}
},
_marshalAnnotatedListeners: function () {
this._notes.forEach(function (a) {
if (a.events && a.events.length) {
var node = this._findAnnotatedNode(this.root, a);
a.events.forEach(function (e) {
this.listen(node, e.name, e.value);
}, this);
}
}, this);
}
});
Polymer.Base._addFeature({
listeners: {},
_listenListeners: function (listeners) {
var node, name, key;
for (key in listeners) {
if (key.indexOf('.') < 0) {
node = this;
name = key;
} else {
name = key.split('.');
node = this.$[name[0]];
name = name[1];
}
this.listen(node, name, listeners[key]);
}
},
listen: function (node, eventName, methodName) {
this._listen(node, eventName, this._createEventHandler(node, eventName, methodName));
},
_boundListenerKey: function (eventName, methodName) {
return eventName + ':' + methodName;
},
_recordEventHandler: function (host, eventName, target, methodName, handler) {
var hbl = host.__boundListeners;
if (!hbl) {
hbl = host.__boundListeners = new WeakMap();
}
var bl = hbl.get(target);
if (!bl) {
bl = {};
hbl.set(target, bl);
}
var key = this._boundListenerKey(eventName, methodName);
bl[key] = handler;
},
_recallEventHandler: function (host, eventName, target, methodName) {
var hbl = host.__boundListeners;
if (!hbl) {
return;
}
var bl = hbl.get(target);
if (!bl) {
return;
}
var key = this._boundListenerKey(eventName, methodName);
return bl[key];
},
_createEventHandler: function (node, eventName, methodName) {
var host = this;
var handler = function (e) {
if (host[methodName]) {
host[methodName](e, e.detail);
} else {
host._warn(host._logf('_createEventHandler', 'listener method `' + methodName + '` not defined'));
}
};
this._recordEventHandler(host, eventName, node, methodName, handler);
return handler;
},
unlisten: function (node, eventName, methodName) {
var handler = this._recallEventHandler(this, eventName, node, methodName);
if (handler) {
this._unlisten(node, eventName, handler);
}
},
_listen: function (node, eventName, handler) {
node.addEventListener(eventName, handler);
},
_unlisten: function (node, eventName, handler) {
node.removeEventListener(eventName, handler);
}
});
(function () {
'use strict';
var HAS_NATIVE_TA = typeof document.head.style.touchAction === 'string';
var GESTURE_KEY = '__polymerGestures';
var HANDLED_OBJ = '__polymerGesturesHandled';
var TOUCH_ACTION = '__polymerGesturesTouchAction';
var TAP_DISTANCE = 25;
var TRACK_DISTANCE = 5;
var TRACK_LENGTH = 2;
var MOUSE_TIMEOUT = 2500;
var MOUSE_EVENTS = [
'mousedown',
'mousemove',
'mouseup',
'click'
];
var MOUSE_WHICH_TO_BUTTONS = [
0,
1,
4,
2
];
var MOUSE_HAS_BUTTONS = function () {
try {
return new MouseEvent('test', { buttons: 1 }).buttons === 1;
} catch (e) {
return false;
}
}();
var IS_TOUCH_ONLY = navigator.userAgent.match(/iP(?:[oa]d|hone)|Android/);
var mouseCanceller = function (mouseEvent) {
mouseEvent[HANDLED_OBJ] = { skip: true };
if (mouseEvent.type === 'click') {
var path = Polymer.dom(mouseEvent).path;
for (var i = 0; i < path.length; i++) {
if (path[i] === POINTERSTATE.mouse.target) {
return;
}
}
mouseEvent.preventDefault();
mouseEvent.stopPropagation();
}
};
function setupTeardownMouseCanceller(setup) {
for (var i = 0, en; i < MOUSE_EVENTS.length; i++) {
en = MOUSE_EVENTS[i];
if (setup) {
document.addEventListener(en, mouseCanceller, true);
} else {
document.removeEventListener(en, mouseCanceller, true);
}
}
}
function ignoreMouse() {
if (IS_TOUCH_ONLY) {
return;
}
if (!POINTERSTATE.mouse.mouseIgnoreJob) {
setupTeardownMouseCanceller(true);
}
var unset = function () {
setupTeardownMouseCanceller();
POINTERSTATE.mouse.target = null;
POINTERSTATE.mouse.mouseIgnoreJob = null;
};
POINTERSTATE.mouse.mouseIgnoreJob = Polymer.Debounce(POINTERSTATE.mouse.mouseIgnoreJob, unset, MOUSE_TIMEOUT);
}
function hasLeftMouseButton(ev) {
var type = ev.type;
if (MOUSE_EVENTS.indexOf(type) === -1) {
return false;
}
if (type === 'mousemove') {
var buttons = ev.buttons === undefined ? 1 : ev.buttons;
if (ev instanceof window.MouseEvent && !MOUSE_HAS_BUTTONS) {
buttons = MOUSE_WHICH_TO_BUTTONS[ev.which] || 0;
}
return Boolean(buttons & 1);
} else {
var button = ev.button === undefined ? 0 : ev.button;
return button === 0;
}
}
function isSyntheticClick(ev) {
if (ev.type === 'click') {
if (ev.detail === 0) {
return true;
}
var t = Gestures.findOriginalTarget(ev);
var bcr = t.getBoundingClientRect();
var x = ev.pageX, y = ev.pageY;
return !(x >= bcr.left && x <= bcr.right && (y >= bcr.top && y <= bcr.bottom));
}
return false;
}
var POINTERSTATE = {
mouse: {
target: null,
mouseIgnoreJob: null
},
touch: {
x: 0,
y: 0,
id: -1,
scrollDecided: false
}
};
function firstTouchAction(ev) {
var path = Polymer.dom(ev).path;
var ta = 'auto';
for (var i = 0, n; i < path.length; i++) {
n = path[i];
if (n[TOUCH_ACTION]) {
ta = n[TOUCH_ACTION];
break;
}
}
return ta;
}
function trackDocument(stateObj, movefn, upfn) {
stateObj.movefn = movefn;
stateObj.upfn = upfn;
document.addEventListener('mousemove', movefn);
document.addEventListener('mouseup', upfn);
}
function untrackDocument(stateObj) {
document.removeEventListener('mousemove', stateObj.movefn);
document.removeEventListener('mouseup', stateObj.upfn);
}
var Gestures = {
gestures: {},
recognizers: [],
deepTargetFind: function (x, y) {
var node = document.elementFromPoint(x, y);
var next = node;
while (next && next.shadowRoot) {
next = next.shadowRoot.elementFromPoint(x, y);
if (next) {
node = next;
}
}
return node;
},
findOriginalTarget: function (ev) {
if (ev.path) {
return ev.path[0];
}
return ev.target;
},
handleNative: function (ev) {
var handled;
var type = ev.type;
var node = ev.currentTarget;
var gobj = node[GESTURE_KEY];
var gs = gobj[type];
if (!gs) {
return;
}
if (!ev[HANDLED_OBJ]) {
ev[HANDLED_OBJ] = {};
if (type.slice(0, 5) === 'touch') {
var t = ev.changedTouches[0];
if (type === 'touchstart') {
if (ev.touches.length === 1) {
POINTERSTATE.touch.id = t.identifier;
}
}
if (POINTERSTATE.touch.id !== t.identifier) {
return;
}
if (!HAS_NATIVE_TA) {
if (type === 'touchstart' || type === 'touchmove') {
Gestures.handleTouchAction(ev);
}
}
if (type === 'touchend') {
POINTERSTATE.mouse.target = Polymer.dom(ev).rootTarget;
ignoreMouse(true);
}
}
}
handled = ev[HANDLED_OBJ];
if (handled.skip) {
return;
}
var recognizers = Gestures.recognizers;
for (var i = 0, r; i < recognizers.length; i++) {
r = recognizers[i];
if (gs[r.name] && !handled[r.name]) {
if (r.flow && r.flow.start.indexOf(ev.type) > -1) {
if (r.reset) {
r.reset();
}
}
}
}
for (var i = 0, r; i < recognizers.length; i++) {
r = recognizers[i];
if (gs[r.name] && !handled[r.name]) {
handled[r.name] = true;
r[type](ev);
}
}
},
handleTouchAction: function (ev) {
var t = ev.changedTouches[0];
var type = ev.type;
if (type === 'touchstart') {
POINTERSTATE.touch.x = t.clientX;
POINTERSTATE.touch.y = t.clientY;
POINTERSTATE.touch.scrollDecided = false;
} else if (type === 'touchmove') {
if (POINTERSTATE.touch.scrollDecided) {
return;
}
POINTERSTATE.touch.scrollDecided = true;
var ta = firstTouchAction(ev);
var prevent = false;
var dx = Math.abs(POINTERSTATE.touch.x - t.clientX);
var dy = Math.abs(POINTERSTATE.touch.y - t.clientY);
if (!ev.cancelable) {
} else if (ta === 'none') {
prevent = true;
} else if (ta === 'pan-x') {
prevent = dy > dx;
} else if (ta === 'pan-y') {
prevent = dx > dy;
}
if (prevent) {
ev.preventDefault();
} else {
Gestures.prevent('track');
}
}
},
add: function (node, evType, handler) {
var recognizer = this.gestures[evType];
var deps = recognizer.deps;
var name = recognizer.name;
var gobj = node[GESTURE_KEY];
if (!gobj) {
node[GESTURE_KEY] = gobj = {};
}
for (var i = 0, dep, gd; i < deps.length; i++) {
dep = deps[i];
if (IS_TOUCH_ONLY && MOUSE_EVENTS.indexOf(dep) > -1) {
continue;
}
gd = gobj[dep];
if (!gd) {
gobj[dep] = gd = { _count: 0 };
}
if (gd._count === 0) {
node.addEventListener(dep, this.handleNative);
}
gd[name] = (gd[name] || 0) + 1;
gd._count = (gd._count || 0) + 1;
}
node.addEventListener(evType, handler);
if (recognizer.touchAction) {
this.setTouchAction(node, recognizer.touchAction);
}
},
remove: function (node, evType, handler) {
var recognizer = this.gestures[evType];
var deps = recognizer.deps;
var name = recognizer.name;
var gobj = node[GESTURE_KEY];
if (gobj) {
for (var i = 0, dep, gd; i < deps.length; i++) {
dep = deps[i];
gd = gobj[dep];
if (gd && gd[name]) {
gd[name] = (gd[name] || 1) - 1;
gd._count = (gd._count || 1) - 1;
}
if (gd._count === 0) {
node.removeEventListener(dep, this.handleNative);
}
}
}
node.removeEventListener(evType, handler);
},
register: function (recog) {
this.recognizers.push(recog);
for (var i = 0; i < recog.emits.length; i++) {
this.gestures[recog.emits[i]] = recog;
}
},
findRecognizerByEvent: function (evName) {
for (var i = 0, r; i < this.recognizers.length; i++) {
r = this.recognizers[i];
for (var j = 0, n; j < r.emits.length; j++) {
n = r.emits[j];
if (n === evName) {
return r;
}
}
}
return null;
},
setTouchAction: function (node, value) {
if (HAS_NATIVE_TA) {
node.style.touchAction = value;
}
node[TOUCH_ACTION] = value;
},
fire: function (target, type, detail) {
var ev = Polymer.Base.fire(type, detail, {
node: target,
bubbles: true,
cancelable: true
});
if (ev.defaultPrevented) {
var se = detail.sourceEvent;
if (se && se.preventDefault) {
se.preventDefault();
}
}
},
prevent: function (evName) {
var recognizer = this.findRecognizerByEvent(evName);
if (recognizer.info) {
recognizer.info.prevent = true;
}
}
};
Gestures.register({
name: 'downup',
deps: [
'mousedown',
'touchstart',
'touchend'
],
flow: {
start: [
'mousedown',
'touchstart'
],
end: [
'mouseup',
'touchend'
]
},
emits: [
'down',
'up'
],
info: {
movefn: function () {
},
upfn: function () {
}
},
reset: function () {
untrackDocument(this.info);
},
mousedown: function (e) {
if (!hasLeftMouseButton(e)) {
return;
}
var t = Gestures.findOriginalTarget(e);
var self = this;
var movefn = function movefn(e) {
if (!hasLeftMouseButton(e)) {
self.fire('up', t, e);
untrackDocument(self.info);
}
};
var upfn = function upfn(e) {
if (hasLeftMouseButton(e)) {
self.fire('up', t, e);
}
untrackDocument(self.info);
};
trackDocument(this.info, movefn, upfn);
this.fire('down', t, e);
},
touchstart: function (e) {
this.fire('down', Gestures.findOriginalTarget(e), e.changedTouches[0]);
},
touchend: function (e) {
this.fire('up', Gestures.findOriginalTarget(e), e.changedTouches[0]);
},
fire: function (type, target, event) {
var self = this;
Gestures.fire(target, type, {
x: event.clientX,
y: event.clientY,
sourceEvent: event,
prevent: Gestures.prevent.bind(Gestures)
});
}
});
Gestures.register({
name: 'track',
touchAction: 'none',
deps: [
'mousedown',
'touchstart',
'touchmove',
'touchend'
],
flow: {
start: [
'mousedown',
'touchstart'
],
end: [
'mouseup',
'touchend'
]
},
emits: ['track'],
info: {
x: 0,
y: 0,
state: 'start',
started: false,
moves: [],
addMove: function (move) {
if (this.moves.length > TRACK_LENGTH) {
this.moves.shift();
}
this.moves.push(move);
},
movefn: function () {
},
upfn: function () {
},
prevent: false
},
reset: function () {
this.info.state = 'start';
this.info.started = false;
this.info.moves = [];
this.info.x = 0;
this.info.y = 0;
this.info.prevent = false;
untrackDocument(this.info);
},
hasMovedEnough: function (x, y) {
if (this.info.prevent) {
return false;
}
if (this.info.started) {
return true;
}
var dx = Math.abs(this.info.x - x);
var dy = Math.abs(this.info.y - y);
return dx >= TRACK_DISTANCE || dy >= TRACK_DISTANCE;
},
mousedown: function (e) {
if (!hasLeftMouseButton(e)) {
return;
}
var t = Gestures.findOriginalTarget(e);
var self = this;
var movefn = function movefn(e) {
var x = e.clientX, y = e.clientY;
if (self.hasMovedEnough(x, y)) {
self.info.state = self.info.started ? e.type === 'mouseup' ? 'end' : 'track' : 'start';
self.info.addMove({
x: x,
y: y
});
if (!hasLeftMouseButton(e)) {
self.info.state = 'end';
untrackDocument(self.info);
}
self.fire(t, e);
self.info.started = true;
}
};
var upfn = function upfn(e) {
if (self.info.started) {
Gestures.prevent('tap');
movefn(e);
}
untrackDocument(self.info);
};
trackDocument(this.info, movefn, upfn);
this.info.x = e.clientX;
this.info.y = e.clientY;
},
touchstart: function (e) {
var ct = e.changedTouches[0];
this.info.x = ct.clientX;
this.info.y = ct.clientY;
},
touchmove: function (e) {
var t = Gestures.findOriginalTarget(e);
var ct = e.changedTouches[0];
var x = ct.clientX, y = ct.clientY;
if (this.hasMovedEnough(x, y)) {
this.info.addMove({
x: x,
y: y
});
this.fire(t, ct);
this.info.state = 'track';
this.info.started = true;
}
},
touchend: function (e) {
var t = Gestures.findOriginalTarget(e);
var ct = e.changedTouches[0];
if (this.info.started) {
Gestures.prevent('tap');
this.info.state = 'end';
this.info.addMove({
x: ct.clientX,
y: ct.clientY
});
this.fire(t, ct);
}
},
fire: function (target, touch) {
var secondlast = this.info.moves[this.info.moves.length - 2];
var lastmove = this.info.moves[this.info.moves.length - 1];
var dx = lastmove.x - this.info.x;
var dy = lastmove.y - this.info.y;
var ddx, ddy = 0;
if (secondlast) {
ddx = lastmove.x - secondlast.x;
ddy = lastmove.y - secondlast.y;
}
return Gestures.fire(target, 'track', {
state: this.info.state,
x: touch.clientX,
y: touch.clientY,
dx: dx,
dy: dy,
ddx: ddx,
ddy: ddy,
sourceEvent: touch,
hover: function () {
return Gestures.deepTargetFind(touch.clientX, touch.clientY);
}
});
}
});
Gestures.register({
name: 'tap',
deps: [
'mousedown',
'click',
'touchstart',
'touchend'
],
flow: {
start: [
'mousedown',
'touchstart'
],
end: [
'click',
'touchend'
]
},
emits: ['tap'],
info: {
x: NaN,
y: NaN,
prevent: false
},
reset: function () {
this.info.x = NaN;
this.info.y = NaN;
this.info.prevent = false;
},
save: function (e) {
this.info.x = e.clientX;
this.info.y = e.clientY;
},
mousedown: function (e) {
if (hasLeftMouseButton(e)) {
this.save(e);
}
},
click: function (e) {
if (hasLeftMouseButton(e)) {
this.forward(e);
}
},
touchstart: function (e) {
this.save(e.changedTouches[0]);
},
touchend: function (e) {
this.forward(e.changedTouches[0]);
},
forward: function (e) {
var dx = Math.abs(e.clientX - this.info.x);
var dy = Math.abs(e.clientY - this.info.y);
var t = Gestures.findOriginalTarget(e);
if (isNaN(dx) || isNaN(dy) || dx <= TAP_DISTANCE && dy <= TAP_DISTANCE || isSyntheticClick(e)) {
if (!this.info.prevent) {
Gestures.fire(t, 'tap', {
x: e.clientX,
y: e.clientY,
sourceEvent: e
});
}
}
}
});
var DIRECTION_MAP = {
x: 'pan-x',
y: 'pan-y',
none: 'none',
all: 'auto'
};
Polymer.Base._addFeature({
_listen: function (node, eventName, handler) {
if (Gestures.gestures[eventName]) {
Gestures.add(node, eventName, handler);
} else {
node.addEventListener(eventName, handler);
}
},
_unlisten: function (node, eventName, handler) {
if (Gestures.gestures[eventName]) {
Gestures.remove(node, eventName, handler);
} else {
node.removeEventListener(eventName, handler);
}
},
setScrollDirection: function (direction, node) {
node = node || this;
Gestures.setTouchAction(node, DIRECTION_MAP[direction] || 'auto');
}
});
Polymer.Gestures = Gestures;
}());
Polymer.Async = {
_currVal: 0,
_lastVal: 0,
_callbacks: [],
_twiddleContent: 0,
_twiddle: document.createTextNode(''),
run: function (callback, waitTime) {
if (waitTime > 0) {
return ~setTimeout(callback, waitTime);
} else {
this._twiddle.textContent = this._twiddleContent++;
this._callbacks.push(callback);
return this._currVal++;
}
},
cancel: function (handle) {
if (handle < 0) {
clearTimeout(~handle);
} else {
var idx = handle - this._lastVal;
if (idx >= 0) {
if (!this._callbacks[idx]) {
throw 'invalid async handle: ' + handle;
}
this._callbacks[idx] = null;
}
}
},
_atEndOfMicrotask: function () {
var len = this._callbacks.length;
for (var i = 0; i < len; i++) {
var cb = this._callbacks[i];
if (cb) {
try {
cb();
} catch (e) {
i++;
this._callbacks.splice(0, i);
this._lastVal += i;
this._twiddle.textContent = this._twiddleContent++;
throw e;
}
}
}
this._callbacks.splice(0, len);
this._lastVal += len;
}
};
new (window.MutationObserver || JsMutationObserver)(Polymer.Async._atEndOfMicrotask.bind(Polymer.Async)).observe(Polymer.Async._twiddle, { characterData: true });
Polymer.Debounce = function () {
var Async = Polymer.Async;
var Debouncer = function (context) {
this.context = context;
this.boundComplete = this.complete.bind(this);
};
Debouncer.prototype = {
go: function (callback, wait) {
var h;
this.finish = function () {
Async.cancel(h);
};
h = Async.run(this.boundComplete, wait);
this.callback = callback;
},
stop: function () {
if (this.finish) {
this.finish();
this.finish = null;
}
},
complete: function () {
if (this.finish) {
this.stop();
this.callback.call(this.context);
}
}
};
function debounce(debouncer, callback, wait) {
if (debouncer) {
debouncer.stop();
} else {
debouncer = new Debouncer(this);
}
debouncer.go(callback, wait);
return debouncer;
}
return debounce;
}();
Polymer.Base._addFeature({
$$: function (slctr) {
return Polymer.dom(this.root).querySelector(slctr);
},
toggleClass: function (name, bool, node) {
node = node || this;
if (arguments.length == 1) {
bool = !node.classList.contains(name);
}
if (bool) {
Polymer.dom(node).classList.add(name);
} else {
Polymer.dom(node).classList.remove(name);
}
},
toggleAttribute: function (name, bool, node) {
node = node || this;
if (arguments.length == 1) {
bool = !node.hasAttribute(name);
}
if (bool) {
Polymer.dom(node).setAttribute(name, '');
} else {
Polymer.dom(node).removeAttribute(name);
}
},
classFollows: function (name, toElement, fromElement) {
if (fromElement) {
Polymer.dom(fromElement).classList.remove(name);
}
if (toElement) {
Polymer.dom(toElement).classList.add(name);
}
},
attributeFollows: function (name, toElement, fromElement) {
if (fromElement) {
Polymer.dom(fromElement).removeAttribute(name);
}
if (toElement) {
Polymer.dom(toElement).setAttribute(name, '');
}
},
getContentChildNodes: function (slctr) {
var content = Polymer.dom(this.root).querySelector(slctr || 'content');
return content ? Polymer.dom(content).getDistributedNodes() : [];
},
getContentChildren: function (slctr) {
return this.getContentChildNodes(slctr).filter(function (n) {
return n.nodeType === Node.ELEMENT_NODE;
});
},
fire: function (type, detail, options) {
options = options || Polymer.nob;
var node = options.node || this;
var detail = detail === null || detail === undefined ? Polymer.nob : detail;
var bubbles = options.bubbles === undefined ? true : options.bubbles;
var cancelable = Boolean(options.cancelable);
var event = new CustomEvent(type, {
bubbles: Boolean(bubbles),
cancelable: cancelable,
detail: detail
});
node.dispatchEvent(event);
return event;
},
async: function (callback, waitTime) {
return Polymer.Async.run(callback.bind(this), waitTime);
},
cancelAsync: function (handle) {
Polymer.Async.cancel(handle);
},
arrayDelete: function (path, item) {
var index;
if (Array.isArray(path)) {
index = path.indexOf(item);
if (index >= 0) {
return path.splice(index, 1);
}
} else {
var arr = this.get(path);
index = arr.indexOf(item);
if (index >= 0) {
return this.splice(path, index, 1);
}
}
},
transform: function (transform, node) {
node = node || this;
node.style.webkitTransform = transform;
node.style.transform = transform;
},
translate3d: function (x, y, z, node) {
node = node || this;
this.transform('translate3d(' + x + ',' + y + ',' + z + ')', node);
},
importHref: function (href, onload, onerror) {
var l = document.createElement('link');
l.rel = 'import';
l.href = href;
if (onload) {
l.onload = onload.bind(this);
}
if (onerror) {
l.onerror = onerror.bind(this);
}
document.head.appendChild(l);
return l;
},
create: function (tag, props) {
var elt = document.createElement(tag);
if (props) {
for (var n in props) {
elt[n] = props[n];
}
}
return elt;
}
});
Polymer.Bind = {
prepareModel: function (model) {
model._propertyEffects = {};
model._bindListeners = [];
Polymer.Base.mixin(model, this._modelApi);
},
_modelApi: {
_notifyChange: function (property) {
var eventName = Polymer.CaseMap.camelToDashCase(property) + '-changed';
Polymer.Base.fire(eventName, { value: this[property] }, {
bubbles: false,
node: this
});
},
_propertySetter: function (property, value, effects, fromAbove) {
var old = this.__data__[property];
if (old !== value && (old === old || value === value)) {
this.__data__[property] = value;
if (typeof value == 'object') {
this._clearPath(property);
}
if (this._propertyChanged) {
this._propertyChanged(property, value, old);
}
if (effects) {
this._effectEffects(property, value, effects, old, fromAbove);
}
}
return old;
},
__setProperty: function (property, value, quiet, node) {
node = node || this;
var effects = node._propertyEffects && node._propertyEffects[property];
if (effects) {
node._propertySetter(property, value, effects, quiet);
} else {
node[property] = value;
}
},
_effectEffects: function (property, value, effects, old, fromAbove) {
effects.forEach(function (fx) {
var fn = Polymer.Bind['_' + fx.kind + 'Effect'];
if (fn) {
fn.call(this, property, value, fx.effect, old, fromAbove);
}
}, this);
},
_clearPath: function (path) {
for (var prop in this.__data__) {
if (prop.indexOf(path + '.') === 0) {
this.__data__[prop] = undefined;
}
}
}
},
ensurePropertyEffects: function (model, property) {
var fx = model._propertyEffects[property];
if (!fx) {
fx = model._propertyEffects[property] = [];
}
return fx;
},
addPropertyEffect: function (model, property, kind, effect) {
var fx = this.ensurePropertyEffects(model, property);
fx.push({
kind: kind,
effect: effect
});
},
createBindings: function (model) {
var fx$ = model._propertyEffects;
if (fx$) {
for (var n in fx$) {
var fx = fx$[n];
fx.sort(this._sortPropertyEffects);
this._createAccessors(model, n, fx);
}
}
},
_sortPropertyEffects: function () {
var EFFECT_ORDER = {
'compute': 0,
'annotation': 1,
'computedAnnotation': 2,
'reflect': 3,
'notify': 4,
'observer': 5,
'complexObserver': 6,
'function': 7
};
return function (a, b) {
return EFFECT_ORDER[a.kind] - EFFECT_ORDER[b.kind];
};
}(),
_createAccessors: function (model, property, effects) {
var defun = {
get: function () {
return this.__data__[property];
}
};
var setter = function (value) {
this._propertySetter(property, value, effects);
};
var info = model.getPropertyInfo && model.getPropertyInfo(property);
if (info && info.readOnly) {
if (!info.computed) {
model['_set' + this.upper(property)] = setter;
}
} else {
defun.set = setter;
}
Object.defineProperty(model, property, defun);
},
upper: function (name) {
return name[0].toUpperCase() + name.substring(1);
},
_addAnnotatedListener: function (model, index, property, path, event) {
var fn = this._notedListenerFactory(property, path, this._isStructured(path), this._isEventBogus);
var eventName = event || Polymer.CaseMap.camelToDashCase(property) + '-changed';
model._bindListeners.push({
index: index,
property: property,
path: path,
changedFn: fn,
event: eventName
});
},
_isStructured: function (path) {
return path.indexOf('.') > 0;
},
_isEventBogus: function (e, target) {
return e.path && e.path[0] !== target;
},
_notedListenerFactory: function (property, path, isStructured, bogusTest) {
return function (e, target) {
if (!bogusTest(e, target)) {
if (e.detail && e.detail.path) {
this.notifyPath(this._fixPath(path, property, e.detail.path), e.detail.value);
} else {
var value = target[property];
if (!isStructured) {
this[path] = target[property];
} else {
if (this.__data__[path] != value) {
this.set(path, value);
}
}
}
}
};
},
prepareInstance: function (inst) {
inst.__data__ = Object.create(null);
},
setupBindListeners: function (inst) {
inst._bindListeners.forEach(function (info) {
var node = inst._nodes[info.index];
node.addEventListener(info.event, inst._notifyListener.bind(inst, info.changedFn));
});
}
};
Polymer.Base.extend(Polymer.Bind, {
_shouldAddListener: function (effect) {
return effect.name && effect.mode === '{' && !effect.negate && effect.kind != 'attribute';
},
_annotationEffect: function (source, value, effect) {
if (source != effect.value) {
value = this.get(effect.value);
this.__data__[effect.value] = value;
}
var calc = effect.negate ? !value : value;
if (!effect.customEvent || this._nodes[effect.index][effect.name] !== calc) {
return this._applyEffectValue(calc, effect);
}
},
_reflectEffect: function (source) {
this.reflectPropertyToAttribute(source);
},
_notifyEffect: function (source, value, effect, old, fromAbove) {
if (!fromAbove) {
this._notifyChange(source);
}
},
_functionEffect: function (source, value, fn, old, fromAbove) {
fn.call(this, source, value, old, fromAbove);
},
_observerEffect: function (source, value, effect, old) {
var fn = this[effect.method];
if (fn) {
fn.call(this, value, old);
} else {
this._warn(this._logf('_observerEffect', 'observer method `' + effect.method + '` not defined'));
}
},
_complexObserverEffect: function (source, value, effect) {
var fn = this[effect.method];
if (fn) {
var args = Polymer.Bind._marshalArgs(this.__data__, effect, source, value);
if (args) {
fn.apply(this, args);
}
} else {
this._warn(this._logf('_complexObserverEffect', 'observer method `' + effect.method + '` not defined'));
}
},
_computeEffect: function (source, value, effect) {
var args = Polymer.Bind._marshalArgs(this.__data__, effect, source, value);
if (args) {
var fn = this[effect.method];
if (fn) {
this.__setProperty(effect.property, fn.apply(this, args));
} else {
this._warn(this._logf('_computeEffect', 'compute method `' + effect.method + '` not defined'));
}
}
},
_annotatedComputationEffect: function (source, value, effect) {
var computedHost = this._rootDataHost || this;
var fn = computedHost[effect.method];
if (fn) {
var args = Polymer.Bind._marshalArgs(this.__data__, effect, source, value);
if (args) {
var computedvalue = fn.apply(computedHost, args);
if (effect.negate) {
computedvalue = !computedvalue;
}
this._applyEffectValue(computedvalue, effect);
}
} else {
computedHost._warn(computedHost._logf('_annotatedComputationEffect', 'compute method `' + effect.method + '` not defined'));
}
},
_marshalArgs: function (model, effect, path, value) {
var values = [];
var args = effect.args;
for (var i = 0, l = args.length; i < l; i++) {
var arg = args[i];
var name = arg.name;
var v;
if (arg.literal) {
v = arg.value;
} else if (arg.structured) {
v = Polymer.Base.get(name, model);
} else {
v = model[name];
}
if (args.length > 1 && v === undefined) {
return;
}
if (arg.wildcard) {
var baseChanged = name.indexOf(path + '.') === 0;
var matches = effect.trigger.name.indexOf(name) === 0 && !baseChanged;
values[i] = {
path: matches ? path : name,
value: matches ? value : v,
base: v
};
} else {
values[i] = v;
}
}
return values;
}
});
Polymer.Base._addFeature({
_addPropertyEffect: function (property, kind, effect) {
Polymer.Bind.addPropertyEffect(this, property, kind, effect);
},
_prepEffects: function () {
Polymer.Bind.prepareModel(this);
this._addAnnotationEffects(this._notes);
},
_prepBindings: function () {
Polymer.Bind.createBindings(this);
},
_addPropertyEffects: function (properties) {
if (properties) {
for (var p in properties) {
var prop = properties[p];
if (prop.observer) {
this._addObserverEffect(p, prop.observer);
}
if (prop.computed) {
prop.readOnly = true;
this._addComputedEffect(p, prop.computed);
}
if (prop.notify) {
this._addPropertyEffect(p, 'notify');
}
if (prop.reflectToAttribute) {
this._addPropertyEffect(p, 'reflect');
}
if (prop.readOnly) {
Polymer.Bind.ensurePropertyEffects(this, p);
}
}
}
},
_addComputedEffect: function (name, expression) {
var sig = this._parseMethod(expression);
sig.args.forEach(function (arg) {
this._addPropertyEffect(arg.model, 'compute', {
method: sig.method,
args: sig.args,
trigger: arg,
property: name
});
}, this);
},
_addObserverEffect: function (property, observer) {
this._addPropertyEffect(property, 'observer', {
method: observer,
property: property
});
},
_addComplexObserverEffects: function (observers) {
if (observers) {
observers.forEach(function (observer) {
this._addComplexObserverEffect(observer);
}, this);
}
},
_addComplexObserverEffect: function (observer) {
var sig = this._parseMethod(observer);
sig.args.forEach(function (arg) {
this._addPropertyEffect(arg.model, 'complexObserver', {
method: sig.method,
args: sig.args,
trigger: arg
});
}, this);
},
_addAnnotationEffects: function (notes) {
this._nodes = [];
notes.forEach(function (note) {
var index = this._nodes.push(note) - 1;
note.bindings.forEach(function (binding) {
this._addAnnotationEffect(binding, index);
}, this);
}, this);
},
_addAnnotationEffect: function (note, index) {
if (Polymer.Bind._shouldAddListener(note)) {
Polymer.Bind._addAnnotatedListener(this, index, note.name, note.value, note.event);
}
if (note.signature) {
this._addAnnotatedComputationEffect(note, index);
} else {
note.index = index;
this._addPropertyEffect(note.model, 'annotation', note);
}
},
_addAnnotatedComputationEffect: function (note, index) {
var sig = note.signature;
if (sig.static) {
this.__addAnnotatedComputationEffect('__static__', index, note, sig, null);
} else {
sig.args.forEach(function (arg) {
if (!arg.literal) {
this.__addAnnotatedComputationEffect(arg.model, index, note, sig, arg);
}
}, this);
}
},
__addAnnotatedComputationEffect: function (property, index, note, sig, trigger) {
this._addPropertyEffect(property, 'annotatedComputation', {
index: index,
kind: note.kind,
property: note.name,
negate: note.negate,
method: sig.method,
args: sig.args,
trigger: trigger
});
},
_parseMethod: function (expression) {
var m = expression.match(/([^\s]+)\((.*)\)/);
if (m) {
var sig = {
method: m[1],
static: true
};
if (m[2].trim()) {
var args = m[2].replace(/\\,/g, '&comma;').split(',');
return this._parseArgs(args, sig);
} else {
sig.args = Polymer.nar;
return sig;
}
}
},
_parseArgs: function (argList, sig) {
sig.args = argList.map(function (rawArg) {
var arg = this._parseArg(rawArg);
if (!arg.literal) {
sig.static = false;
}
return arg;
}, this);
return sig;
},
_parseArg: function (rawArg) {
var arg = rawArg.trim().replace(/&comma;/g, ',').replace(/\\(.)/g, '$1');
var a = {
name: arg,
model: this._modelForPath(arg)
};
var fc = arg[0];
if (fc >= '0' && fc <= '9') {
fc = '#';
}
switch (fc) {
case '\'':
case '"':
a.value = arg.slice(1, -1);
a.literal = true;
break;
case '#':
a.value = Number(arg);
a.literal = true;
break;
}
if (!a.literal) {
a.structured = arg.indexOf('.') > 0;
if (a.structured) {
a.wildcard = arg.slice(-2) == '.*';
if (a.wildcard) {
a.name = arg.slice(0, -2);
}
}
}
return a;
},
_marshalInstanceEffects: function () {
Polymer.Bind.prepareInstance(this);
Polymer.Bind.setupBindListeners(this);
},
_applyEffectValue: function (value, info) {
var node = this._nodes[info.index];
var property = info.property || info.name || 'textContent';
if (info.kind == 'attribute') {
this.serializeValueToAttribute(value, property, node);
} else {
if (property === 'className') {
value = this._scopeElementClass(node, value);
}
if (property === 'textContent' || node.localName == 'input' && property == 'value') {
value = value == undefined ? '' : value;
}
return node[property] = value;
}
},
_executeStaticEffects: function () {
if (this._propertyEffects.__static__) {
this._effectEffects('__static__', null, this._propertyEffects.__static__);
}
}
});
Polymer.Base._addFeature({
_setupConfigure: function (initialConfig) {
this._config = {};
for (var i in initialConfig) {
if (initialConfig[i] !== undefined) {
this._config[i] = initialConfig[i];
}
}
this._handlers = [];
},
_marshalAttributes: function () {
this._takeAttributesToModel(this._config);
},
_attributeChangedImpl: function (name) {
var model = this._clientsReadied ? this : this._config;
this._setAttributeToProperty(model, name);
},
_configValue: function (name, value) {
this._config[name] = value;
},
_beforeClientsReady: function () {
this._configure();
},
_configure: function () {
this._configureAnnotationReferences();
this._aboveConfig = this.mixin({}, this._config);
var config = {};
this.behaviors.forEach(function (b) {
this._configureProperties(b.properties, config);
}, this);
this._configureProperties(this.properties, config);
this._mixinConfigure(config, this._aboveConfig);
this._config = config;
this._distributeConfig(this._config);
},
_configureProperties: function (properties, config) {
for (var i in properties) {
var c = properties[i];
if (c.value !== undefined) {
var value = c.value;
if (typeof value == 'function') {
value = value.call(this, this._config);
}
config[i] = value;
}
}
},
_mixinConfigure: function (a, b) {
for (var prop in b) {
if (!this.getPropertyInfo(prop).readOnly) {
a[prop] = b[prop];
}
}
},
_distributeConfig: function (config) {
var fx$ = this._propertyEffects;
if (fx$) {
for (var p in config) {
var fx = fx$[p];
if (fx) {
for (var i = 0, l = fx.length, x; i < l && (x = fx[i]); i++) {
if (x.kind === 'annotation') {
var node = this._nodes[x.effect.index];
if (node._configValue) {
var value = p === x.effect.value ? config[p] : this.get(x.effect.value, config);
node._configValue(x.effect.name, value);
}
}
}
}
}
}
},
_afterClientsReady: function () {
this._executeStaticEffects();
this._applyConfig(this._config, this._aboveConfig);
this._flushHandlers();
},
_applyConfig: function (config, aboveConfig) {
for (var n in config) {
if (this[n] === undefined) {
this.__setProperty(n, config[n], n in aboveConfig);
}
}
},
_notifyListener: function (fn, e) {
if (!this._clientsReadied) {
this._queueHandler([
fn,
e,
e.target
]);
} else {
return fn.call(this, e, e.target);
}
},
_queueHandler: function (args) {
this._handlers.push(args);
},
_flushHandlers: function () {
var h$ = this._handlers;
for (var i = 0, l = h$.length, h; i < l && (h = h$[i]); i++) {
h[0].call(this, h[1], h[2]);
}
}
});
(function () {
'use strict';
Polymer.Base._addFeature({
notifyPath: function (path, value, fromAbove) {
var old = this._propertySetter(path, value);
if (old !== value && (old === old || value === value)) {
this._pathEffector(path, value);
if (!fromAbove) {
this._notifyPath(path, value);
}
return true;
}
},
_getPathParts: function (path) {
if (Array.isArray(path)) {
var parts = [];
for (var i = 0; i < path.length; i++) {
var args = path[i].toString().split('.');
for (var j = 0; j < args.length; j++) {
parts.push(args[j]);
}
}
return parts;
} else {
return path.toString().split('.');
}
},
set: function (path, value, root) {
var prop = root || this;
var parts = this._getPathParts(path);
var array;
var last = parts[parts.length - 1];
if (parts.length > 1) {
for (var i = 0; i < parts.length - 1; i++) {
var part = parts[i];
prop = prop[part];
if (array && parseInt(part) == part) {
parts[i] = Polymer.Collection.get(array).getKey(prop);
}
if (!prop) {
return;
}
array = Array.isArray(prop) ? prop : null;
}
if (array && parseInt(last) == last) {
var coll = Polymer.Collection.get(array);
var old = prop[last];
var key = coll.getKey(old);
parts[i] = key;
coll.setItem(key, value);
}
prop[last] = value;
if (!root) {
this.notifyPath(parts.join('.'), value);
}
} else {
prop[path] = value;
}
},
get: function (path, root) {
var prop = root || this;
var parts = this._getPathParts(path);
var last = parts.pop();
while (parts.length) {
prop = prop[parts.shift()];
if (!prop) {
return;
}
}
return prop[last];
},
_pathEffector: function (path, value) {
var model = this._modelForPath(path);
var fx$ = this._propertyEffects[model];
if (fx$) {
fx$.forEach(function (fx) {
var fxFn = this['_' + fx.kind + 'PathEffect'];
if (fxFn) {
fxFn.call(this, path, value, fx.effect);
}
}, this);
}
if (this._boundPaths) {
this._notifyBoundPaths(path, value);
}
},
_annotationPathEffect: function (path, value, effect) {
if (effect.value === path || effect.value.indexOf(path + '.') === 0) {
Polymer.Bind._annotationEffect.call(this, path, value, effect);
} else if (path.indexOf(effect.value + '.') === 0 && !effect.negate) {
var node = this._nodes[effect.index];
if (node && node.notifyPath) {
var p = this._fixPath(effect.name, effect.value, path);
node.notifyPath(p, value, true);
}
}
},
_complexObserverPathEffect: function (path, value, effect) {
if (this._pathMatchesEffect(path, effect)) {
Polymer.Bind._complexObserverEffect.call(this, path, value, effect);
}
},
_computePathEffect: function (path, value, effect) {
if (this._pathMatchesEffect(path, effect)) {
Polymer.Bind._computeEffect.call(this, path, value, effect);
}
},
_annotatedComputationPathEffect: function (path, value, effect) {
if (this._pathMatchesEffect(path, effect)) {
Polymer.Bind._annotatedComputationEffect.call(this, path, value, effect);
}
},
_pathMatchesEffect: function (path, effect) {
var effectArg = effect.trigger.name;
return effectArg == path || effectArg.indexOf(path + '.') === 0 || effect.trigger.wildcard && path.indexOf(effectArg) === 0;
},
linkPaths: function (to, from) {
this._boundPaths = this._boundPaths || {};
if (from) {
this._boundPaths[to] = from;
} else {
this.unbindPath(to);
}
},
unlinkPaths: function (path) {
if (this._boundPaths) {
delete this._boundPaths[path];
}
},
_notifyBoundPaths: function (path, value) {
var from, to;
for (var a in this._boundPaths) {
var b = this._boundPaths[a];
if (path.indexOf(a + '.') == 0) {
from = a;
to = b;
break;
}
if (path.indexOf(b + '.') == 0) {
from = b;
to = a;
break;
}
}
if (from && to) {
var p = this._fixPath(to, from, path);
this.notifyPath(p, value);
}
},
_fixPath: function (property, root, path) {
return property + path.slice(root.length);
},
_notifyPath: function (path, value) {
var rootName = this._modelForPath(path);
var dashCaseName = Polymer.CaseMap.camelToDashCase(rootName);
var eventName = dashCaseName + this._EVENT_CHANGED;
this.fire(eventName, {
path: path,
value: value
}, { bubbles: false });
},
_modelForPath: function (path) {
var dot = path.indexOf('.');
return dot < 0 ? path : path.slice(0, dot);
},
_EVENT_CHANGED: '-changed',
_notifySplice: function (array, path, index, added, removed) {
var splices = [{
index: index,
addedCount: added,
removed: removed,
object: array,
type: 'splice'
}];
var change = {
keySplices: Polymer.Collection.applySplices(array, splices),
indexSplices: splices
};
this.set(path + '.splices', change);
if (added != removed.length) {
this.notifyPath(path + '.length', array.length);
}
change.keySplices = null;
change.indexSplices = null;
},
push: function (path) {
var array = this.get(path);
var args = Array.prototype.slice.call(arguments, 1);
var len = array.length;
var ret = array.push.apply(array, args);
if (args.length) {
this._notifySplice(array, path, len, args.length, []);
}
return ret;
},
pop: function (path) {
var array = this.get(path);
var hadLength = Boolean(array.length);
var args = Array.prototype.slice.call(arguments, 1);
var ret = array.pop.apply(array, args);
if (hadLength) {
this._notifySplice(array, path, array.length, 0, [ret]);
}
return ret;
},
splice: function (path, start, deleteCount) {
var array = this.get(path);
if (start < 0) {
start = array.length - Math.floor(-start);
} else {
start = Math.floor(start);
}
if (!start) {
start = 0;
}
var args = Array.prototype.slice.call(arguments, 1);
var ret = array.splice.apply(array, args);
var addedCount = Math.max(args.length - 2, 0);
if (addedCount || ret.length) {
this._notifySplice(array, path, start, addedCount, ret);
}
return ret;
},
shift: function (path) {
var array = this.get(path);
var hadLength = Boolean(array.length);
var args = Array.prototype.slice.call(arguments, 1);
var ret = array.shift.apply(array, args);
if (hadLength) {
this._notifySplice(array, path, 0, 0, [ret]);
}
return ret;
},
unshift: function (path) {
var array = this.get(path);
var args = Array.prototype.slice.call(arguments, 1);
var ret = array.unshift.apply(array, args);
if (args.length) {
this._notifySplice(array, path, 0, args.length, []);
}
return ret;
}
});
}());
Polymer.Base._addFeature({
resolveUrl: function (url) {
var module = Polymer.DomModule.import(this.is);
var root = '';
if (module) {
var assetPath = module.getAttribute('assetpath') || '';
root = Polymer.ResolveUrl.resolveUrl(assetPath, module.ownerDocument.baseURI);
}
return Polymer.ResolveUrl.resolveUrl(url, root);
}
});
Polymer.CssParse = function () {
var api = {
parse: function (text) {
text = this._clean(text);
return this._parseCss(this._lex(text), text);
},
_clean: function (cssText) {
return cssText.replace(this._rx.comments, '').replace(this._rx.port, '');
},
_lex: function (text) {
var root = {
start: 0,
end: text.length
};
var n = root;
for (var i = 0, s = 0, l = text.length; i < l; i++) {
switch (text[i]) {
case this.OPEN_BRACE:
if (!n.rules) {
n.rules = [];
}
var p = n;
var previous = p.rules[p.rules.length - 1];
n = {
start: i + 1,
parent: p,
previous: previous
};
p.rules.push(n);
break;
case this.CLOSE_BRACE:
n.end = i + 1;
n = n.parent || root;
break;
}
}
return root;
},
_parseCss: function (node, text) {
var t = text.substring(node.start, node.end - 1);
node.parsedCssText = node.cssText = t.trim();
if (node.parent) {
var ss = node.previous ? node.previous.end : node.parent.start;
t = text.substring(ss, node.start - 1);
t = t.substring(t.lastIndexOf(';') + 1);
var s = node.parsedSelector = node.selector = t.trim();
node.atRule = s.indexOf(this.AT_START) === 0;
if (node.atRule) {
if (s.indexOf(this.MEDIA_START) === 0) {
node.type = this.types.MEDIA_RULE;
} else if (s.match(this._rx.keyframesRule)) {
node.type = this.types.KEYFRAMES_RULE;
}
} else {
if (s.indexOf(this.VAR_START) === 0) {
node.type = this.types.MIXIN_RULE;
} else {
node.type = this.types.STYLE_RULE;
}
}
}
var r$ = node.rules;
if (r$) {
for (var i = 0, l = r$.length, r; i < l && (r = r$[i]); i++) {
this._parseCss(r, text);
}
}
return node;
},
stringify: function (node, preserveProperties, text) {
text = text || '';
var cssText = '';
if (node.cssText || node.rules) {
var r$ = node.rules;
if (r$ && (preserveProperties || !this._hasMixinRules(r$))) {
for (var i = 0, l = r$.length, r; i < l && (r = r$[i]); i++) {
cssText = this.stringify(r, preserveProperties, cssText);
}
} else {
cssText = preserveProperties ? node.cssText : this.removeCustomProps(node.cssText);
cssText = cssText.trim();
if (cssText) {
cssText = '  ' + cssText + '\n';
}
}
}
if (cssText) {
if (node.selector) {
text += node.selector + ' ' + this.OPEN_BRACE + '\n';
}
text += cssText;
if (node.selector) {
text += this.CLOSE_BRACE + '\n\n';
}
}
return text;
},
_hasMixinRules: function (rules) {
return rules[0].selector.indexOf(this.VAR_START) >= 0;
},
removeCustomProps: function (cssText) {
cssText = this.removeCustomPropAssignment(cssText);
return this.removeCustomPropApply(cssText);
},
removeCustomPropAssignment: function (cssText) {
return cssText.replace(this._rx.customProp, '').replace(this._rx.mixinProp, '');
},
removeCustomPropApply: function (cssText) {
return cssText.replace(this._rx.mixinApply, '').replace(this._rx.varApply, '');
},
types: {
STYLE_RULE: 1,
KEYFRAMES_RULE: 7,
MEDIA_RULE: 4,
MIXIN_RULE: 1000
},
OPEN_BRACE: '{',
CLOSE_BRACE: '}',
_rx: {
comments: /\/\*[^*]*\*+([^\/*][^*]*\*+)*\//gim,
port: /@import[^;]*;/gim,
customProp: /(?:^|[\s;])--[^;{]*?:[^{};]*?(?:[;\n]|$)/gim,
mixinProp: /(?:^|[\s;])--[^;{]*?:[^{;]*?{[^}]*?}(?:[;\n]|$)?/gim,
mixinApply: /@apply[\s]*\([^)]*?\)[\s]*(?:[;\n]|$)?/gim,
varApply: /[^;:]*?:[^;]*var[^;]*(?:[;\n]|$)?/gim,
keyframesRule: /^@[^\s]*keyframes/
},
VAR_START: '--',
MEDIA_START: '@media',
AT_START: '@'
};
return api;
}();
Polymer.StyleUtil = function () {
return {
MODULE_STYLES_SELECTOR: 'style, link[rel=import][type~=css]',
toCssText: function (rules, callback, preserveProperties) {
if (typeof rules === 'string') {
rules = this.parser.parse(rules);
}
if (callback) {
this.forEachStyleRule(rules, callback);
}
return this.parser.stringify(rules, preserveProperties);
},
forRulesInStyles: function (styles, callback) {
if (styles) {
for (var i = 0, l = styles.length, s; i < l && (s = styles[i]); i++) {
this.forEachStyleRule(this.rulesForStyle(s), callback);
}
}
},
rulesForStyle: function (style) {
if (!style.__cssRules && style.textContent) {
style.__cssRules = this.parser.parse(style.textContent);
}
return style.__cssRules;
},
clearStyleRules: function (style) {
style.__cssRules = null;
},
forEachStyleRule: function (node, callback) {
var s = node.parsedSelector;
var skipRules = false;
if (node.type === this.ruleTypes.STYLE_RULE) {
callback(node);
} else if (node.type === this.ruleTypes.KEYFRAMES_RULE || node.type === this.ruleTypes.MIXIN_RULE) {
skipRules = true;
}
var r$ = node.rules;
if (r$ && !skipRules) {
for (var i = 0, l = r$.length, r; i < l && (r = r$[i]); i++) {
this.forEachStyleRule(r, callback);
}
}
},
applyCss: function (cssText, moniker, target, afterNode) {
var style = document.createElement('style');
if (moniker) {
style.setAttribute('scope', moniker);
}
style.textContent = cssText;
target = target || document.head;
if (!afterNode) {
var n$ = target.querySelectorAll('style[scope]');
afterNode = n$[n$.length - 1];
}
target.insertBefore(style, afterNode && afterNode.nextSibling || target.firstChild);
return style;
},
cssFromModule: function (moduleId) {
var m = Polymer.DomModule.import(moduleId);
if (m && !m._cssText) {
var cssText = '';
var e$ = Array.prototype.slice.call(m.querySelectorAll(this.MODULE_STYLES_SELECTOR));
for (var i = 0, e; i < e$.length; i++) {
e = e$[i];
if (e.localName === 'style') {
e = e.__appliedElement || e;
e.parentNode.removeChild(e);
} else {
e = e.import && e.import.body;
}
if (e) {
cssText += Polymer.ResolveUrl.resolveCss(e.textContent, e.ownerDocument);
}
}
m._cssText = cssText;
}
return m && m._cssText || '';
},
parser: Polymer.CssParse,
ruleTypes: Polymer.CssParse.types
};
}();
Polymer.StyleTransformer = function () {
var nativeShadow = Polymer.Settings.useNativeShadow;
var styleUtil = Polymer.StyleUtil;
var api = {
dom: function (node, scope, useAttr, shouldRemoveScope) {
this._transformDom(node, scope || '', useAttr, shouldRemoveScope);
},
_transformDom: function (node, selector, useAttr, shouldRemoveScope) {
if (node.setAttribute) {
this.element(node, selector, useAttr, shouldRemoveScope);
}
var c$ = Polymer.dom(node).childNodes;
for (var i = 0; i < c$.length; i++) {
this._transformDom(c$[i], selector, useAttr, shouldRemoveScope);
}
},
element: function (element, scope, useAttr, shouldRemoveScope) {
if (useAttr) {
if (shouldRemoveScope) {
element.removeAttribute(SCOPE_NAME);
} else {
element.setAttribute(SCOPE_NAME, scope);
}
} else {
if (scope) {
if (element.classList) {
if (shouldRemoveScope) {
element.classList.remove(SCOPE_NAME);
element.classList.remove(scope);
} else {
element.classList.add(SCOPE_NAME);
element.classList.add(scope);
}
} else if (element.getAttribute) {
var c = element.getAttribute(CLASS);
if (shouldRemoveScope) {
if (c) {
element.setAttribute(CLASS, c.replace(SCOPE_NAME, '').replace(scope, ''));
}
} else {
element.setAttribute(CLASS, c + (c ? ' ' : '') + SCOPE_NAME + ' ' + scope);
}
}
}
}
},
elementStyles: function (element, callback) {
var styles = element._styles;
var cssText = '';
for (var i = 0, l = styles.length, s, text; i < l && (s = styles[i]); i++) {
var rules = styleUtil.rulesForStyle(s);
cssText += nativeShadow ? styleUtil.toCssText(rules, callback) : this.css(rules, element.is, element.extends, callback, element._scopeCssViaAttr) + '\n\n';
}
return cssText.trim();
},
css: function (rules, scope, ext, callback, useAttr) {
var hostScope = this._calcHostScope(scope, ext);
scope = this._calcElementScope(scope, useAttr);
var self = this;
return styleUtil.toCssText(rules, function (rule) {
if (!rule.isScoped) {
self.rule(rule, scope, hostScope);
rule.isScoped = true;
}
if (callback) {
callback(rule, scope, hostScope);
}
});
},
_calcElementScope: function (scope, useAttr) {
if (scope) {
return useAttr ? CSS_ATTR_PREFIX + scope + CSS_ATTR_SUFFIX : CSS_CLASS_PREFIX + scope;
} else {
return '';
}
},
_calcHostScope: function (scope, ext) {
return ext ? '[is=' + scope + ']' : scope;
},
rule: function (rule, scope, hostScope) {
this._transformRule(rule, this._transformComplexSelector, scope, hostScope);
},
_transformRule: function (rule, transformer, scope, hostScope) {
var p$ = rule.selector.split(COMPLEX_SELECTOR_SEP);
for (var i = 0, l = p$.length, p; i < l && (p = p$[i]); i++) {
p$[i] = transformer.call(this, p, scope, hostScope);
}
rule.selector = rule.transformedSelector = p$.join(COMPLEX_SELECTOR_SEP);
},
_transformComplexSelector: function (selector, scope, hostScope) {
var stop = false;
var hostContext = false;
var self = this;
selector = selector.replace(SIMPLE_SELECTOR_SEP, function (m, c, s) {
if (!stop) {
var info = self._transformCompoundSelector(s, c, scope, hostScope);
stop = stop || info.stop;
hostContext = hostContext || info.hostContext;
c = info.combinator;
s = info.value;
} else {
s = s.replace(SCOPE_JUMP, ' ');
}
return c + s;
});
if (hostContext) {
selector = selector.replace(HOST_CONTEXT_PAREN, function (m, pre, paren, post) {
return pre + paren + ' ' + hostScope + post + COMPLEX_SELECTOR_SEP + ' ' + pre + hostScope + paren + post;
});
}
return selector;
},
_transformCompoundSelector: function (selector, combinator, scope, hostScope) {
var jumpIndex = selector.search(SCOPE_JUMP);
var hostContext = false;
if (selector.indexOf(HOST_CONTEXT) >= 0) {
hostContext = true;
} else if (selector.indexOf(HOST) >= 0) {
selector = selector.replace(HOST_PAREN, function (m, host, paren) {
return hostScope + paren;
});
selector = selector.replace(HOST, hostScope);
} else if (jumpIndex !== 0) {
selector = scope ? this._transformSimpleSelector(selector, scope) : selector;
}
if (selector.indexOf(CONTENT) >= 0) {
combinator = '';
}
var stop;
if (jumpIndex >= 0) {
selector = selector.replace(SCOPE_JUMP, ' ');
stop = true;
}
return {
value: selector,
combinator: combinator,
stop: stop,
hostContext: hostContext
};
},
_transformSimpleSelector: function (selector, scope) {
var p$ = selector.split(PSEUDO_PREFIX);
p$[0] += scope;
return p$.join(PSEUDO_PREFIX);
},
documentRule: function (rule) {
rule.selector = rule.parsedSelector;
this.normalizeRootSelector(rule);
if (!nativeShadow) {
this._transformRule(rule, this._transformDocumentSelector);
}
},
normalizeRootSelector: function (rule) {
if (rule.selector === ROOT) {
rule.selector = 'body';
}
},
_transformDocumentSelector: function (selector) {
return selector.match(SCOPE_JUMP) ? this._transformComplexSelector(selector, SCOPE_DOC_SELECTOR) : this._transformSimpleSelector(selector.trim(), SCOPE_DOC_SELECTOR);
},
SCOPE_NAME: 'style-scope'
};
var SCOPE_NAME = api.SCOPE_NAME;
var SCOPE_DOC_SELECTOR = ':not([' + SCOPE_NAME + '])' + ':not(.' + SCOPE_NAME + ')';
var COMPLEX_SELECTOR_SEP = ',';
var SIMPLE_SELECTOR_SEP = /(^|[\s>+~]+)([^\s>+~]+)/g;
var HOST = ':host';
var ROOT = ':root';
var HOST_PAREN = /(\:host)(?:\(((?:\([^)(]*\)|[^)(]*)+?)\))/g;
var HOST_CONTEXT = ':host-context';
var HOST_CONTEXT_PAREN = /(.*)(?:\:host-context)(?:\(((?:\([^)(]*\)|[^)(]*)+?)\))(.*)/;
var CONTENT = '::content';
var SCOPE_JUMP = /\:\:content|\:\:shadow|\/deep\//;
var CSS_CLASS_PREFIX = '.';
var CSS_ATTR_PREFIX = '[' + SCOPE_NAME + '~=';
var CSS_ATTR_SUFFIX = ']';
var PSEUDO_PREFIX = ':';
var CLASS = 'class';
return api;
}();
Polymer.StyleExtends = function () {
var styleUtil = Polymer.StyleUtil;
return {
hasExtends: function (cssText) {
return Boolean(cssText.match(this.rx.EXTEND));
},
transform: function (style) {
var rules = styleUtil.rulesForStyle(style);
var self = this;
styleUtil.forEachStyleRule(rules, function (rule) {
var map = self._mapRule(rule);
if (rule.parent) {
var m;
while (m = self.rx.EXTEND.exec(rule.cssText)) {
var extend = m[1];
var extendor = self._findExtendor(extend, rule);
if (extendor) {
self._extendRule(rule, extendor);
}
}
}
rule.cssText = rule.cssText.replace(self.rx.EXTEND, '');
});
return styleUtil.toCssText(rules, function (rule) {
if (rule.selector.match(self.rx.STRIP)) {
rule.cssText = '';
}
}, true);
},
_mapRule: function (rule) {
if (rule.parent) {
var map = rule.parent.map || (rule.parent.map = {});
var parts = rule.selector.split(',');
for (var i = 0, p; i < parts.length; i++) {
p = parts[i];
map[p.trim()] = rule;
}
return map;
}
},
_findExtendor: function (extend, rule) {
return rule.parent && rule.parent.map && rule.parent.map[extend] || this._findExtendor(extend, rule.parent);
},
_extendRule: function (target, source) {
if (target.parent !== source.parent) {
this._cloneAndAddRuleToParent(source, target.parent);
}
target.extends = target.extends || (target.extends = []);
target.extends.push(source);
source.selector = source.selector.replace(this.rx.STRIP, '');
source.selector = (source.selector && source.selector + ',\n') + target.selector;
if (source.extends) {
source.extends.forEach(function (e) {
this._extendRule(target, e);
}, this);
}
},
_cloneAndAddRuleToParent: function (rule, parent) {
rule = Object.create(rule);
rule.parent = parent;
if (rule.extends) {
rule.extends = rule.extends.slice();
}
parent.rules.push(rule);
},
rx: {
EXTEND: /@extends\(([^)]*)\)\s*?;/gim,
STRIP: /%[^,]*$/
}
};
}();
(function () {
var prepElement = Polymer.Base._prepElement;
var nativeShadow = Polymer.Settings.useNativeShadow;
var styleUtil = Polymer.StyleUtil;
var styleTransformer = Polymer.StyleTransformer;
var styleExtends = Polymer.StyleExtends;
Polymer.Base._addFeature({
_prepElement: function (element) {
if (this._encapsulateStyle) {
styleTransformer.element(element, this.is, this._scopeCssViaAttr);
}
prepElement.call(this, element);
},
_prepStyles: function () {
if (this._encapsulateStyle === undefined) {
this._encapsulateStyle = !nativeShadow && Boolean(this._template);
}
this._styles = this._collectStyles();
var cssText = styleTransformer.elementStyles(this);
if (cssText && this._template) {
var style = styleUtil.applyCss(cssText, this.is, nativeShadow ? this._template.content : null);
if (!nativeShadow) {
this._scopeStyle = style;
}
}
},
_collectStyles: function () {
var styles = [];
var cssText = '', m$ = this.styleModules;
if (m$) {
for (var i = 0, l = m$.length, m; i < l && (m = m$[i]); i++) {
cssText += styleUtil.cssFromModule(m);
}
}
cssText += styleUtil.cssFromModule(this.is);
if (cssText) {
var style = document.createElement('style');
style.textContent = cssText;
if (styleExtends.hasExtends(style.textContent)) {
cssText = styleExtends.transform(style);
}
styles.push(style);
}
return styles;
},
_elementAdd: function (node) {
if (this._encapsulateStyle) {
if (node.__styleScoped) {
node.__styleScoped = false;
} else {
styleTransformer.dom(node, this.is, this._scopeCssViaAttr);
}
}
},
_elementRemove: function (node) {
if (this._encapsulateStyle) {
styleTransformer.dom(node, this.is, this._scopeCssViaAttr, true);
}
},
scopeSubtree: function (container, shouldObserve) {
if (nativeShadow) {
return;
}
var self = this;
var scopify = function (node) {
if (node.nodeType === Node.ELEMENT_NODE) {
node.className = self._scopeElementClass(node, node.className);
var n$ = node.querySelectorAll('*');
Array.prototype.forEach.call(n$, function (n) {
n.className = self._scopeElementClass(n, n.className);
});
}
};
scopify(container);
if (shouldObserve) {
var mo = new MutationObserver(function (mxns) {
mxns.forEach(function (m) {
if (m.addedNodes) {
for (var i = 0; i < m.addedNodes.length; i++) {
scopify(m.addedNodes[i]);
}
}
});
});
mo.observe(container, {
childList: true,
subtree: true
});
return mo;
}
}
});
}());
Polymer.StyleProperties = function () {
'use strict';
var nativeShadow = Polymer.Settings.useNativeShadow;
var matchesSelector = Polymer.DomApi.matchesSelector;
var styleUtil = Polymer.StyleUtil;
var styleTransformer = Polymer.StyleTransformer;
return {
decorateStyles: function (styles) {
var self = this, props = {};
styleUtil.forRulesInStyles(styles, function (rule) {
self.decorateRule(rule);
self.collectPropertiesInCssText(rule.propertyInfo.cssText, props);
});
var names = [];
for (var i in props) {
names.push(i);
}
return names;
},
decorateRule: function (rule) {
if (rule.propertyInfo) {
return rule.propertyInfo;
}
var info = {}, properties = {};
var hasProperties = this.collectProperties(rule, properties);
if (hasProperties) {
info.properties = properties;
rule.rules = null;
}
info.cssText = this.collectCssText(rule);
rule.propertyInfo = info;
return info;
},
collectProperties: function (rule, properties) {
var info = rule.propertyInfo;
if (info) {
if (info.properties) {
Polymer.Base.mixin(properties, info.properties);
return true;
}
} else {
var m, rx = this.rx.VAR_ASSIGN;
var cssText = rule.parsedCssText;
var any;
while (m = rx.exec(cssText)) {
properties[m[1]] = (m[2] || m[3]).trim();
any = true;
}
return any;
}
},
collectCssText: function (rule) {
var customCssText = '';
var cssText = rule.parsedCssText;
cssText = cssText.replace(this.rx.BRACKETED, '').replace(this.rx.VAR_ASSIGN, '');
var parts = cssText.split(';');
for (var i = 0, p; i < parts.length; i++) {
p = parts[i];
if (p.match(this.rx.MIXIN_MATCH) || p.match(this.rx.VAR_MATCH)) {
customCssText += p + ';\n';
}
}
return customCssText;
},
collectPropertiesInCssText: function (cssText, props) {
var m;
while (m = this.rx.VAR_CAPTURE.exec(cssText)) {
props[m[1]] = true;
var def = m[2];
if (def && def.match(this.rx.IS_VAR)) {
props[def] = true;
}
}
},
reify: function (props) {
var names = Object.getOwnPropertyNames(props);
for (var i = 0, n; i < names.length; i++) {
n = names[i];
props[n] = this.valueForProperty(props[n], props);
}
},
valueForProperty: function (property, props) {
if (property) {
if (property.indexOf(';') >= 0) {
property = this.valueForProperties(property, props);
} else {
var self = this;
var fn = function (all, prefix, value, fallback) {
var propertyValue = self.valueForProperty(props[value], props) || (props[fallback] ? self.valueForProperty(props[fallback], props) : fallback);
return prefix + (propertyValue || '');
};
property = property.replace(this.rx.VAR_MATCH, fn);
}
}
return property && property.trim() || '';
},
valueForProperties: function (property, props) {
var parts = property.split(';');
for (var i = 0, p, m; i < parts.length; i++) {
if (p = parts[i]) {
m = p.match(this.rx.MIXIN_MATCH);
if (m) {
p = this.valueForProperty(props[m[1]], props);
} else {
var pp = p.split(':');
if (pp[1]) {
pp[1] = pp[1].trim();
pp[1] = this.valueForProperty(pp[1], props) || pp[1];
}
p = pp.join(':');
}
parts[i] = p && p.lastIndexOf(';') === p.length - 1 ? p.slice(0, -1) : p || '';
}
}
return parts.join(';');
},
applyProperties: function (rule, props) {
var output = '';
if (!rule.propertyInfo) {
this.decorateRule(rule);
}
if (rule.propertyInfo.cssText) {
output = this.valueForProperties(rule.propertyInfo.cssText, props);
}
rule.cssText = output;
},
propertyDataFromStyles: function (styles, element) {
var props = {}, self = this;
var o = [], i = 0;
styleUtil.forRulesInStyles(styles, function (rule) {
if (!rule.propertyInfo) {
self.decorateRule(rule);
}
if (element && rule.propertyInfo.properties && matchesSelector.call(element, rule.transformedSelector || rule.parsedSelector)) {
self.collectProperties(rule, props);
addToBitMask(i, o);
}
i++;
});
return {
properties: props,
key: o
};
},
scopePropertiesFromStyles: function (styles) {
if (!styles._scopeStyleProperties) {
styles._scopeStyleProperties = this.selectedPropertiesFromStyles(styles, this.SCOPE_SELECTORS);
}
return styles._scopeStyleProperties;
},
hostPropertiesFromStyles: function (styles) {
if (!styles._hostStyleProperties) {
styles._hostStyleProperties = this.selectedPropertiesFromStyles(styles, this.HOST_SELECTORS);
}
return styles._hostStyleProperties;
},
selectedPropertiesFromStyles: function (styles, selectors) {
var props = {}, self = this;
styleUtil.forRulesInStyles(styles, function (rule) {
if (!rule.propertyInfo) {
self.decorateRule(rule);
}
for (var i = 0; i < selectors.length; i++) {
if (rule.parsedSelector === selectors[i]) {
self.collectProperties(rule, props);
return;
}
}
});
return props;
},
transformStyles: function (element, properties, scopeSelector) {
var self = this;
var hostSelector = styleTransformer._calcHostScope(element.is, element.extends);
var rxHostSelector = element.extends ? '\\' + hostSelector.slice(0, -1) + '\\]' : hostSelector;
var hostRx = new RegExp(this.rx.HOST_PREFIX + rxHostSelector + this.rx.HOST_SUFFIX);
return styleTransformer.elementStyles(element, function (rule) {
self.applyProperties(rule, properties);
if (rule.cssText && !nativeShadow) {
self._scopeSelector(rule, hostRx, hostSelector, element._scopeCssViaAttr, scopeSelector);
}
});
},
_scopeSelector: function (rule, hostRx, hostSelector, viaAttr, scopeId) {
rule.transformedSelector = rule.transformedSelector || rule.selector;
var selector = rule.transformedSelector;
var scope = viaAttr ? '[' + styleTransformer.SCOPE_NAME + '~=' + scopeId + ']' : '.' + scopeId;
var parts = selector.split(',');
for (var i = 0, l = parts.length, p; i < l && (p = parts[i]); i++) {
parts[i] = p.match(hostRx) ? p.replace(hostSelector, hostSelector + scope) : scope + ' ' + p;
}
rule.selector = parts.join(',');
},
applyElementScopeSelector: function (element, selector, old, viaAttr) {
var c = viaAttr ? element.getAttribute(styleTransformer.SCOPE_NAME) : element.className;
var v = old ? c.replace(old, selector) : (c ? c + ' ' : '') + this.XSCOPE_NAME + ' ' + selector;
if (c !== v) {
if (viaAttr) {
element.setAttribute(styleTransformer.SCOPE_NAME, v);
} else {
element.className = v;
}
}
},
applyElementStyle: function (element, properties, selector, style) {
var cssText = style ? style.textContent || '' : this.transformStyles(element, properties, selector);
var s = element._customStyle;
if (s && !nativeShadow && s !== style) {
s._useCount--;
if (s._useCount <= 0 && s.parentNode) {
s.parentNode.removeChild(s);
}
}
if (nativeShadow || (!style || !style.parentNode)) {
if (nativeShadow && element._customStyle) {
element._customStyle.textContent = cssText;
style = element._customStyle;
} else if (cssText) {
style = styleUtil.applyCss(cssText, selector, nativeShadow ? element.root : null, element._scopeStyle);
}
}
if (style) {
style._useCount = style._useCount || 0;
if (element._customStyle != style) {
style._useCount++;
}
element._customStyle = style;
}
return style;
},
mixinCustomStyle: function (props, customStyle) {
var v;
for (var i in customStyle) {
v = customStyle[i];
if (v || v === 0) {
props[i] = v;
}
}
},
rx: {
VAR_ASSIGN: /(?:^|[;\n]\s*)(--[\w-]*?):\s*(?:([^;{]*)|{([^}]*)})(?:(?=[;\n])|$)/gi,
MIXIN_MATCH: /(?:^|\W+)@apply[\s]*\(([^)]*)\)/i,
VAR_MATCH: /(^|\W+)var\([\s]*([^,)]*)[\s]*,?[\s]*((?:[^,)]*)|(?:[^;]*\([^;)]*\)))[\s]*?\)/gi,
VAR_CAPTURE: /\([\s]*(--[^,\s)]*)(?:,[\s]*(--[^,\s)]*))?(?:\)|,)/gi,
IS_VAR: /^--/,
BRACKETED: /\{[^}]*\}/g,
HOST_PREFIX: '(?:^|[^.#[:])',
HOST_SUFFIX: '($|[.:[\\s>+~])'
},
HOST_SELECTORS: [':host'],
SCOPE_SELECTORS: [':root'],
XSCOPE_NAME: 'x-scope'
};
function addToBitMask(n, bits) {
var o = parseInt(n / 32);
var v = 1 << n % 32;
bits[o] = (bits[o] || 0) | v;
}
}();
(function () {
Polymer.StyleCache = function () {
this.cache = {};
};
Polymer.StyleCache.prototype = {
MAX: 100,
store: function (is, data, keyValues, keyStyles) {
data.keyValues = keyValues;
data.styles = keyStyles;
var s$ = this.cache[is] = this.cache[is] || [];
s$.push(data);
if (s$.length > this.MAX) {
s$.shift();
}
},
retrieve: function (is, keyValues, keyStyles) {
var cache = this.cache[is];
if (cache) {
for (var i = cache.length - 1, data; i >= 0; i--) {
data = cache[i];
if (keyStyles === data.styles && this._objectsEqual(keyValues, data.keyValues)) {
return data;
}
}
}
},
clear: function () {
this.cache = {};
},
_objectsEqual: function (target, source) {
var t, s;
for (var i in target) {
t = target[i], s = source[i];
if (!(typeof t === 'object' && t ? this._objectsStrictlyEqual(t, s) : t === s)) {
return false;
}
}
if (Array.isArray(target)) {
return target.length === source.length;
}
return true;
},
_objectsStrictlyEqual: function (target, source) {
return this._objectsEqual(target, source) && this._objectsEqual(source, target);
}
};
}());
Polymer.StyleDefaults = function () {
var styleProperties = Polymer.StyleProperties;
var styleUtil = Polymer.StyleUtil;
var StyleCache = Polymer.StyleCache;
var api = {
_styles: [],
_properties: null,
customStyle: {},
_styleCache: new StyleCache(),
addStyle: function (style) {
this._styles.push(style);
this._properties = null;
},
get _styleProperties() {
if (!this._properties) {
styleProperties.decorateStyles(this._styles);
this._styles._scopeStyleProperties = null;
this._properties = styleProperties.scopePropertiesFromStyles(this._styles);
styleProperties.mixinCustomStyle(this._properties, this.customStyle);
styleProperties.reify(this._properties);
}
return this._properties;
},
_needsStyleProperties: function () {
},
_computeStyleProperties: function () {
return this._styleProperties;
},
updateStyles: function (properties) {
this._properties = null;
if (properties) {
Polymer.Base.mixin(this.customStyle, properties);
}
this._styleCache.clear();
for (var i = 0, s; i < this._styles.length; i++) {
s = this._styles[i];
s = s.__importElement || s;
s._apply();
}
}
};
return api;
}();
(function () {
'use strict';
var serializeValueToAttribute = Polymer.Base.serializeValueToAttribute;
var propertyUtils = Polymer.StyleProperties;
var styleTransformer = Polymer.StyleTransformer;
var styleUtil = Polymer.StyleUtil;
var styleDefaults = Polymer.StyleDefaults;
var nativeShadow = Polymer.Settings.useNativeShadow;
Polymer.Base._addFeature({
_prepStyleProperties: function () {
this._ownStylePropertyNames = this._styles ? propertyUtils.decorateStyles(this._styles) : [];
},
customStyle: {},
_setupStyleProperties: function () {
this.customStyle = {};
},
_needsStyleProperties: function () {
return Boolean(this._ownStylePropertyNames && this._ownStylePropertyNames.length);
},
_beforeAttached: function () {
if (!this._scopeSelector && this._needsStyleProperties()) {
this._updateStyleProperties();
}
},
_findStyleHost: function () {
var e = this, root;
while (root = Polymer.dom(e).getOwnerRoot()) {
if (Polymer.isInstance(root.host)) {
return root.host;
}
e = root.host;
}
return styleDefaults;
},
_updateStyleProperties: function () {
var info, scope = this._findStyleHost();
if (!scope._styleCache) {
scope._styleCache = new Polymer.StyleCache();
}
var scopeData = propertyUtils.propertyDataFromStyles(scope._styles, this);
scopeData.key.customStyle = this.customStyle;
info = scope._styleCache.retrieve(this.is, scopeData.key, this._styles);
var scopeCached = Boolean(info);
if (scopeCached) {
this._styleProperties = info._styleProperties;
} else {
this._computeStyleProperties(scopeData.properties);
}
this._computeOwnStyleProperties();
if (!scopeCached) {
info = styleCache.retrieve(this.is, this._ownStyleProperties, this._styles);
}
var globalCached = Boolean(info) && !scopeCached;
var style = this._applyStyleProperties(info);
if (!scopeCached) {
style = style && nativeShadow ? style.cloneNode(true) : style;
info = {
style: style,
_scopeSelector: this._scopeSelector,
_styleProperties: this._styleProperties
};
scopeData.key.customStyle = {};
this.mixin(scopeData.key.customStyle, this.customStyle);
scope._styleCache.store(this.is, info, scopeData.key, this._styles);
if (!globalCached) {
styleCache.store(this.is, Object.create(info), this._ownStyleProperties, this._styles);
}
}
},
_computeStyleProperties: function (scopeProps) {
var scope = this._findStyleHost();
if (!scope._styleProperties) {
scope._computeStyleProperties();
}
var props = Object.create(scope._styleProperties);
this.mixin(props, propertyUtils.hostPropertiesFromStyles(this._styles));
scopeProps = scopeProps || propertyUtils.propertyDataFromStyles(scope._styles, this).properties;
this.mixin(props, scopeProps);
this.mixin(props, propertyUtils.scopePropertiesFromStyles(this._styles));
propertyUtils.mixinCustomStyle(props, this.customStyle);
propertyUtils.reify(props);
this._styleProperties = props;
},
_computeOwnStyleProperties: function () {
var props = {};
for (var i = 0, n; i < this._ownStylePropertyNames.length; i++) {
n = this._ownStylePropertyNames[i];
props[n] = this._styleProperties[n];
}
this._ownStyleProperties = props;
},
_scopeCount: 0,
_applyStyleProperties: function (info) {
var oldScopeSelector = this._scopeSelector;
this._scopeSelector = info ? info._scopeSelector : this.is + '-' + this.__proto__._scopeCount++;
var style = propertyUtils.applyElementStyle(this, this._styleProperties, this._scopeSelector, info && info.style);
if (!nativeShadow) {
propertyUtils.applyElementScopeSelector(this, this._scopeSelector, oldScopeSelector, this._scopeCssViaAttr);
}
return style;
},
serializeValueToAttribute: function (value, attribute, node) {
node = node || this;
if (attribute === 'class' && !nativeShadow) {
var host = node === this ? this.domHost || this.dataHost : this;
if (host) {
value = host._scopeElementClass(node, value);
}
}
node = Polymer.dom(node);
serializeValueToAttribute.call(this, value, attribute, node);
},
_scopeElementClass: function (element, selector) {
if (!nativeShadow && !this._scopeCssViaAttr) {
selector += (selector ? ' ' : '') + SCOPE_NAME + ' ' + this.is + (element._scopeSelector ? ' ' + XSCOPE_NAME + ' ' + element._scopeSelector : '');
}
return selector;
},
updateStyles: function (properties) {
if (this.isAttached) {
if (properties) {
this.mixin(this.customStyle, properties);
}
if (this._needsStyleProperties()) {
this._updateStyleProperties();
} else {
this._styleProperties = null;
}
if (this._styleCache) {
this._styleCache.clear();
}
this._updateRootStyles();
}
},
_updateRootStyles: function (root) {
root = root || this.root;
var c$ = Polymer.dom(root)._query(function (e) {
return e.shadyRoot || e.shadowRoot;
});
for (var i = 0, l = c$.length, c; i < l && (c = c$[i]); i++) {
if (c.updateStyles) {
c.updateStyles();
}
}
}
});
Polymer.updateStyles = function (properties) {
styleDefaults.updateStyles(properties);
Polymer.Base._updateRootStyles(document);
};
var styleCache = new Polymer.StyleCache();
Polymer.customStyleCache = styleCache;
var SCOPE_NAME = styleTransformer.SCOPE_NAME;
var XSCOPE_NAME = propertyUtils.XSCOPE_NAME;
}());
Polymer.Base._addFeature({
_registerFeatures: function () {
this._prepIs();
this._prepAttributes();
this._prepConstructor();
this._prepTemplate();
this._prepStyles();
this._prepStyleProperties();
this._prepAnnotations();
this._prepEffects();
this._prepBehaviors();
this._prepBindings();
this._prepShady();
},
_prepBehavior: function (b) {
this._addPropertyEffects(b.properties);
this._addComplexObserverEffects(b.observers);
this._addHostAttributes(b.hostAttributes);
},
_initFeatures: function () {
this._poolContent();
this._setupConfigure();
this._setupStyleProperties();
this._pushHost();
this._stampTemplate();
this._popHost();
this._marshalAnnotationReferences();
this._setupDebouncers();
this._marshalInstanceEffects();
this._marshalHostAttributes();
this._marshalBehaviors();
this._marshalAttributes();
this._tryReady();
},
_marshalBehavior: function (b) {
this._listenListeners(b.listeners);
}
});
(function () {
var nativeShadow = Polymer.Settings.useNativeShadow;
var propertyUtils = Polymer.StyleProperties;
var styleUtil = Polymer.StyleUtil;
var cssParse = Polymer.CssParse;
var styleDefaults = Polymer.StyleDefaults;
var styleTransformer = Polymer.StyleTransformer;
Polymer({
is: 'custom-style',
extends: 'style',
created: function () {
this._tryApply();
},
attached: function () {
this._tryApply();
},
_tryApply: function () {
if (!this._appliesToDocument) {
if (this.parentNode && this.parentNode.localName !== 'dom-module') {
this._appliesToDocument = true;
var e = this.__appliedElement || this;
styleDefaults.addStyle(e);
if (e.textContent) {
this._apply();
} else {
var observer = new MutationObserver(function () {
observer.disconnect();
this._apply();
}.bind(this));
observer.observe(e, { childList: true });
}
}
}
},
_apply: function () {
var e = this.__appliedElement || this;
this._computeStyleProperties();
var props = this._styleProperties;
var self = this;
e.textContent = styleUtil.toCssText(styleUtil.rulesForStyle(e), function (rule) {
var css = rule.cssText = rule.parsedCssText;
if (rule.propertyInfo && rule.propertyInfo.cssText) {
css = cssParse.removeCustomPropAssignment(css);
rule.cssText = propertyUtils.valueForProperties(css, props);
}
styleTransformer.documentRule(rule);
});
}
});
}());
Polymer.Templatizer = {
properties: { __hideTemplateChildren__: { observer: '_showHideChildren' } },
_instanceProps: Polymer.nob,
_parentPropPrefix: '_parent_',
templatize: function (template) {
if (!template._content) {
template._content = template.content;
}
if (template._content._ctor) {
this.ctor = template._content._ctor;
this._prepParentProperties(this.ctor.prototype, template);
return;
}
var archetype = Object.create(Polymer.Base);
this._customPrepAnnotations(archetype, template);
archetype._prepEffects();
this._customPrepEffects(archetype);
archetype._prepBehaviors();
archetype._prepBindings();
this._prepParentProperties(archetype, template);
archetype._notifyPath = this._notifyPathImpl;
archetype._scopeElementClass = this._scopeElementClassImpl;
archetype.listen = this._listenImpl;
archetype._showHideChildren = this._showHideChildrenImpl;
var _constructor = this._constructorImpl;
var ctor = function TemplateInstance(model, host) {
_constructor.call(this, model, host);
};
ctor.prototype = archetype;
archetype.constructor = ctor;
template._content._ctor = ctor;
this.ctor = ctor;
},
_getRootDataHost: function () {
return this.dataHost && this.dataHost._rootDataHost || this.dataHost;
},
_showHideChildrenImpl: function (hide) {
var c = this._children;
for (var i = 0; i < c.length; i++) {
var n = c[i];
if (Boolean(hide) != Boolean(n.__hideTemplateChildren__)) {
if (n.nodeType === Node.TEXT_NODE) {
if (hide) {
n.__polymerTextContent__ = n.textContent;
n.textContent = '';
} else {
n.textContent = n.__polymerTextContent__;
}
} else if (n.style) {
if (hide) {
n.__polymerDisplay__ = n.style.display;
n.style.display = 'none';
} else {
n.style.display = n.__polymerDisplay__;
}
}
}
n.__hideTemplateChildren__ = hide;
}
},
_debounceTemplate: function (fn) {
Polymer.dom.addDebouncer(this.debounce('_debounceTemplate', fn));
},
_flushTemplates: function (debouncerExpired) {
Polymer.dom.flush();
},
_customPrepEffects: function (archetype) {
var parentProps = archetype._parentProps;
for (var prop in parentProps) {
archetype._addPropertyEffect(prop, 'function', this._createHostPropEffector(prop));
}
for (var prop in this._instanceProps) {
archetype._addPropertyEffect(prop, 'function', this._createInstancePropEffector(prop));
}
},
_customPrepAnnotations: function (archetype, template) {
archetype._template = template;
var c = template._content;
if (!c._notes) {
var rootDataHost = archetype._rootDataHost;
if (rootDataHost) {
Polymer.Annotations.prepElement = rootDataHost._prepElement.bind(rootDataHost);
}
c._notes = Polymer.Annotations.parseAnnotations(template);
Polymer.Annotations.prepElement = null;
this._processAnnotations(c._notes);
}
archetype._notes = c._notes;
archetype._parentProps = c._parentProps;
},
_prepParentProperties: function (archetype, template) {
var parentProps = this._parentProps = archetype._parentProps;
if (this._forwardParentProp && parentProps) {
var proto = archetype._parentPropProto;
var prop;
if (!proto) {
for (prop in this._instanceProps) {
delete parentProps[prop];
}
proto = archetype._parentPropProto = Object.create(null);
if (template != this) {
Polymer.Bind.prepareModel(proto);
}
for (prop in parentProps) {
var parentProp = this._parentPropPrefix + prop;
var effects = [
{
kind: 'function',
effect: this._createForwardPropEffector(prop)
},
{ kind: 'notify' }
];
Polymer.Bind._createAccessors(proto, parentProp, effects);
}
}
if (template != this) {
Polymer.Bind.prepareInstance(template);
template._forwardParentProp = this._forwardParentProp.bind(this);
}
this._extendTemplate(template, proto);
}
},
_createForwardPropEffector: function (prop) {
return function (source, value) {
this._forwardParentProp(prop, value);
};
},
_createHostPropEffector: function (prop) {
var prefix = this._parentPropPrefix;
return function (source, value) {
this.dataHost[prefix + prop] = value;
};
},
_createInstancePropEffector: function (prop) {
return function (source, value, old, fromAbove) {
if (!fromAbove) {
this.dataHost._forwardInstanceProp(this, prop, value);
}
};
},
_extendTemplate: function (template, proto) {
Object.getOwnPropertyNames(proto).forEach(function (n) {
var val = template[n];
var pd = Object.getOwnPropertyDescriptor(proto, n);
Object.defineProperty(template, n, pd);
if (val !== undefined) {
template._propertySetter(n, val);
}
});
},
_showHideChildren: function (hidden) {
},
_forwardInstancePath: function (inst, path, value) {
},
_forwardInstanceProp: function (inst, prop, value) {
},
_notifyPathImpl: function (path, value) {
var dataHost = this.dataHost;
var dot = path.indexOf('.');
var root = dot < 0 ? path : path.slice(0, dot);
dataHost._forwardInstancePath.call(dataHost, this, path, value);
if (root in dataHost._parentProps) {
dataHost.notifyPath(dataHost._parentPropPrefix + path, value);
}
},
_pathEffector: function (path, value, fromAbove) {
if (this._forwardParentPath) {
if (path.indexOf(this._parentPropPrefix) === 0) {
this._forwardParentPath(path.substring(8), value);
}
}
Polymer.Base._pathEffector.apply(this, arguments);
},
_constructorImpl: function (model, host) {
this._rootDataHost = host._getRootDataHost();
this._setupConfigure(model);
this._pushHost(host);
this.root = this.instanceTemplate(this._template);
this.root.__noContent = !this._notes._hasContent;
this.root.__styleScoped = true;
this._popHost();
this._marshalAnnotatedNodes();
this._marshalInstanceEffects();
this._marshalAnnotatedListeners();
var children = [];
for (var n = this.root.firstChild; n; n = n.nextSibling) {
children.push(n);
n._templateInstance = this;
}
this._children = children;
if (host.__hideTemplateChildren__) {
this._showHideChildren(true);
}
this._tryReady();
},
_listenImpl: function (node, eventName, methodName) {
var model = this;
var host = this._rootDataHost;
var handler = host._createEventHandler(node, eventName, methodName);
var decorated = function (e) {
e.model = model;
handler(e);
};
host._listen(node, eventName, decorated);
},
_scopeElementClassImpl: function (node, value) {
var host = this._rootDataHost;
if (host) {
return host._scopeElementClass(node, value);
}
},
stamp: function (model) {
model = model || {};
if (this._parentProps) {
for (var prop in this._parentProps) {
model[prop] = this[this._parentPropPrefix + prop];
}
}
return new this.ctor(model, this);
},
modelForElement: function (el) {
var model;
while (el) {
if (model = el._templateInstance) {
if (model.dataHost != this) {
el = model.dataHost;
} else {
return model;
}
} else {
el = el.parentNode;
}
}
}
};
Polymer({
is: 'dom-template',
extends: 'template',
behaviors: [Polymer.Templatizer],
ready: function () {
this.templatize(this);
}
});
Polymer._collections = new WeakMap();
Polymer.Collection = function (userArray) {
Polymer._collections.set(userArray, this);
this.userArray = userArray;
this.store = userArray.slice();
this.initMap();
};
Polymer.Collection.prototype = {
constructor: Polymer.Collection,
initMap: function () {
var omap = this.omap = new WeakMap();
var pmap = this.pmap = {};
var s = this.store;
for (var i = 0; i < s.length; i++) {
var item = s[i];
if (item && typeof item == 'object') {
omap.set(item, i);
} else {
pmap[item] = i;
}
}
},
add: function (item) {
var key = this.store.push(item) - 1;
if (item && typeof item == 'object') {
this.omap.set(item, key);
} else {
this.pmap[item] = key;
}
return key;
},
removeKey: function (key) {
this._removeFromMap(this.store[key]);
delete this.store[key];
},
_removeFromMap: function (item) {
if (item && typeof item == 'object') {
this.omap.delete(item);
} else {
delete this.pmap[item];
}
},
remove: function (item) {
var key = this.getKey(item);
this.removeKey(key);
return key;
},
getKey: function (item) {
if (item && typeof item == 'object') {
return this.omap.get(item);
} else {
return this.pmap[item];
}
},
getKeys: function () {
return Object.keys(this.store);
},
setItem: function (key, item) {
var old = this.store[key];
if (old) {
this._removeFromMap(old);
}
if (item && typeof item == 'object') {
this.omap.set(item, key);
} else {
this.pmap[item] = key;
}
this.store[key] = item;
},
getItem: function (key) {
return this.store[key];
},
getItems: function () {
var items = [], store = this.store;
for (var key in store) {
items.push(store[key]);
}
return items;
},
_applySplices: function (splices) {
var keySplices = [];
for (var i = 0; i < splices.length; i++) {
var j, o, key, s = splices[i];
var removed = [];
for (j = 0; j < s.removed.length; j++) {
o = s.removed[j];
key = this.remove(o);
removed.push(key);
}
var added = [];
for (j = 0; j < s.addedCount; j++) {
o = this.userArray[s.index + j];
key = this.add(o);
added.push(key);
}
keySplices.push({
index: s.index,
removed: removed,
removedItems: s.removed,
added: added
});
}
return keySplices;
}
};
Polymer.Collection.get = function (userArray) {
return Polymer._collections.get(userArray) || new Polymer.Collection(userArray);
};
Polymer.Collection.applySplices = function (userArray, splices) {
var coll = Polymer._collections.get(userArray);
return coll ? coll._applySplices(splices) : null;
};
Polymer({
is: 'dom-repeat',
extends: 'template',
properties: {
items: { type: Array },
as: {
type: String,
value: 'item'
},
indexAs: {
type: String,
value: 'index'
},
sort: {
type: Function,
observer: '_sortChanged'
},
filter: {
type: Function,
observer: '_filterChanged'
},
observe: {
type: String,
observer: '_observeChanged'
},
delay: Number
},
behaviors: [Polymer.Templatizer],
observers: ['_itemsChanged(items.*)'],
created: function () {
this._instances = [];
},
detached: function () {
for (var i = 0; i < this._instances.length; i++) {
this._detachRow(i);
}
},
attached: function () {
var parentNode = Polymer.dom(this).parentNode;
for (var i = 0; i < this._instances.length; i++) {
Polymer.dom(parentNode).insertBefore(this._instances[i].root, this);
}
},
ready: function () {
this._instanceProps = { __key__: true };
this._instanceProps[this.as] = true;
this._instanceProps[this.indexAs] = true;
if (!this.ctor) {
this.templatize(this);
}
},
_sortChanged: function () {
var dataHost = this._getRootDataHost();
var sort = this.sort;
this._sortFn = sort && (typeof sort == 'function' ? sort : function () {
return dataHost[sort].apply(dataHost, arguments);
});
this._needFullRefresh = true;
if (this.items) {
this._debounceTemplate(this._render);
}
},
_filterChanged: function () {
var dataHost = this._getRootDataHost();
var filter = this.filter;
this._filterFn = filter && (typeof filter == 'function' ? filter : function () {
return dataHost[filter].apply(dataHost, arguments);
});
this._needFullRefresh = true;
if (this.items) {
this._debounceTemplate(this._render);
}
},
_observeChanged: function () {
this._observePaths = this.observe && this.observe.replace('.*', '.').split(' ');
},
_itemsChanged: function (change) {
if (change.path == 'items') {
if (Array.isArray(this.items)) {
this.collection = Polymer.Collection.get(this.items);
} else if (!this.items) {
this.collection = null;
} else {
this._error(this._logf('dom-repeat', 'expected array for `items`,' + ' found', this.items));
}
this._splices = [];
this._needFullRefresh = true;
this._debounceTemplate(this._render);
} else if (change.path == 'items.splices') {
this._splices = this._splices.concat(change.value.keySplices);
this._debounceTemplate(this._render);
} else {
var subpath = change.path.slice(6);
this._forwardItemPath(subpath, change.value);
this._checkObservedPaths(subpath);
}
},
_checkObservedPaths: function (path) {
if (this._observePaths) {
path = path.substring(path.indexOf('.') + 1);
var paths = this._observePaths;
for (var i = 0; i < paths.length; i++) {
if (path.indexOf(paths[i]) === 0) {
this._needFullRefresh = true;
if (this.delay) {
this.debounce('render', this._render, this.delay);
} else {
this._debounceTemplate(this._render);
}
return;
}
}
}
},
render: function () {
this._needFullRefresh = true;
this._debounceTemplate(this._render);
this._flushTemplates();
},
_render: function () {
var c = this.collection;
if (this._needFullRefresh) {
this._applyFullRefresh();
this._needFullRefresh = false;
} else {
if (this._sortFn) {
this._applySplicesUserSort(this._splices);
} else {
if (this._filterFn) {
this._applyFullRefresh();
} else {
this._applySplicesArrayOrder(this._splices);
}
}
}
this._splices = [];
var keyToIdx = this._keyToInstIdx = {};
for (var i = 0; i < this._instances.length; i++) {
var inst = this._instances[i];
keyToIdx[inst.__key__] = i;
inst.__setProperty(this.indexAs, i, true);
}
this.fire('dom-change');
},
_applyFullRefresh: function () {
var c = this.collection;
var keys;
if (this._sortFn) {
keys = c ? c.getKeys() : [];
} else {
keys = [];
var items = this.items;
if (items) {
for (var i = 0; i < items.length; i++) {
keys.push(c.getKey(items[i]));
}
}
}
if (this._filterFn) {
keys = keys.filter(function (a) {
return this._filterFn(c.getItem(a));
}, this);
}
if (this._sortFn) {
keys.sort(function (a, b) {
return this._sortFn(c.getItem(a), c.getItem(b));
}.bind(this));
}
for (var i = 0; i < keys.length; i++) {
var key = keys[i];
var inst = this._instances[i];
if (inst) {
inst.__setProperty('__key__', key, true);
inst.__setProperty(this.as, c.getItem(key), true);
} else {
this._instances.push(this._insertRow(i, key));
}
}
for (; i < this._instances.length; i++) {
this._detachRow(i);
}
this._instances.splice(keys.length, this._instances.length - keys.length);
},
_keySort: function (a, b) {
return this.collection.getKey(a) - this.collection.getKey(b);
},
_applySplicesUserSort: function (splices) {
var c = this.collection;
var instances = this._instances;
var keyMap = {};
var pool = [];
var sortFn = this._sortFn || this._keySort.bind(this);
splices.forEach(function (s) {
for (var i = 0; i < s.removed.length; i++) {
var key = s.removed[i];
keyMap[key] = keyMap[key] ? null : -1;
}
for (var i = 0; i < s.added.length; i++) {
var key = s.added[i];
keyMap[key] = keyMap[key] ? null : 1;
}
}, this);
var removedIdxs = [];
var addedKeys = [];
for (var key in keyMap) {
if (keyMap[key] === -1) {
removedIdxs.push(this._keyToInstIdx[key]);
}
if (keyMap[key] === 1) {
addedKeys.push(key);
}
}
if (removedIdxs.length) {
removedIdxs.sort();
for (var i = removedIdxs.length - 1; i >= 0; i--) {
var idx = removedIdxs[i];
if (idx !== undefined) {
pool.push(this._detachRow(idx));
instances.splice(idx, 1);
}
}
}
if (addedKeys.length) {
if (this._filterFn) {
addedKeys = addedKeys.filter(function (a) {
return this._filterFn(c.getItem(a));
}, this);
}
addedKeys.sort(function (a, b) {
return this._sortFn(c.getItem(a), c.getItem(b));
}.bind(this));
var start = 0;
for (var i = 0; i < addedKeys.length; i++) {
start = this._insertRowUserSort(start, addedKeys[i], pool);
}
}
},
_insertRowUserSort: function (start, key, pool) {
var c = this.collection;
var item = c.getItem(key);
var end = this._instances.length - 1;
var idx = -1;
var sortFn = this._sortFn || this._keySort.bind(this);
while (start <= end) {
var mid = start + end >> 1;
var midKey = this._instances[mid].__key__;
var cmp = sortFn(c.getItem(midKey), item);
if (cmp < 0) {
start = mid + 1;
} else if (cmp > 0) {
end = mid - 1;
} else {
idx = mid;
break;
}
}
if (idx < 0) {
idx = end + 1;
}
this._instances.splice(idx, 0, this._insertRow(idx, key, pool));
return idx;
},
_applySplicesArrayOrder: function (splices) {
var pool = [];
var c = this.collection;
splices.forEach(function (s) {
for (var i = 0; i < s.removed.length; i++) {
var inst = this._detachRow(s.index + i);
if (!inst.isPlaceholder) {
pool.push(inst);
}
}
this._instances.splice(s.index, s.removed.length);
for (var i = 0; i < s.added.length; i++) {
var inst = {
isPlaceholder: true,
key: s.added[i]
};
this._instances.splice(s.index + i, 0, inst);
}
}, this);
for (var i = this._instances.length - 1; i >= 0; i--) {
var inst = this._instances[i];
if (inst.isPlaceholder) {
this._instances[i] = this._insertRow(i, inst.key, pool, true);
}
}
},
_detachRow: function (idx) {
var inst = this._instances[idx];
if (!inst.isPlaceholder) {
var parentNode = Polymer.dom(this).parentNode;
for (var i = 0; i < inst._children.length; i++) {
var el = inst._children[i];
Polymer.dom(inst.root).appendChild(el);
}
}
return inst;
},
_insertRow: function (idx, key, pool, replace) {
var inst;
if (inst = pool && pool.pop()) {
inst.__setProperty(this.as, this.collection.getItem(key), true);
inst.__setProperty('__key__', key, true);
} else {
inst = this._generateRow(idx, key);
}
var beforeRow = this._instances[replace ? idx + 1 : idx];
var beforeNode = beforeRow ? beforeRow._children[0] : this;
var parentNode = Polymer.dom(this).parentNode;
Polymer.dom(parentNode).insertBefore(inst.root, beforeNode);
return inst;
},
_generateRow: function (idx, key) {
var model = { __key__: key };
model[this.as] = this.collection.getItem(key);
model[this.indexAs] = idx;
var inst = this.stamp(model);
return inst;
},
_showHideChildren: function (hidden) {
for (var i = 0; i < this._instances.length; i++) {
this._instances[i]._showHideChildren(hidden);
}
},
_forwardInstanceProp: function (inst, prop, value) {
if (prop == this.as) {
var idx;
if (this._sortFn || this._filterFn) {
idx = this.items.indexOf(this.collection.getItem(inst.__key__));
} else {
idx = inst[this.indexAs];
}
this.set('items.' + idx, value);
}
},
_forwardInstancePath: function (inst, path, value) {
if (path.indexOf(this.as + '.') === 0) {
this.notifyPath('items.' + inst.__key__ + '.' + path.slice(this.as.length + 1), value);
}
},
_forwardParentProp: function (prop, value) {
this._instances.forEach(function (inst) {
inst.__setProperty(prop, value, true);
}, this);
},
_forwardParentPath: function (path, value) {
this._instances.forEach(function (inst) {
inst.notifyPath(path, value, true);
}, this);
},
_forwardItemPath: function (path, value) {
if (this._keyToInstIdx) {
var dot = path.indexOf('.');
var key = path.substring(0, dot < 0 ? path.length : dot);
var idx = this._keyToInstIdx[key];
var inst = this._instances[idx];
if (inst) {
if (dot >= 0) {
path = this.as + '.' + path.substring(dot + 1);
inst.notifyPath(path, value, true);
} else {
inst.__setProperty(this.as, value, true);
}
}
}
},
itemForElement: function (el) {
var instance = this.modelForElement(el);
return instance && instance[this.as];
},
keyForElement: function (el) {
var instance = this.modelForElement(el);
return instance && instance.__key__;
},
indexForElement: function (el) {
var instance = this.modelForElement(el);
return instance && instance[this.indexAs];
}
});
Polymer({
is: 'array-selector',
properties: {
items: {
type: Array,
observer: '_resetSelection'
},
multi: {
type: Boolean,
value: false,
observer: '_resetSelection'
},
selected: {
type: Object,
notify: true
},
toggle: {
type: Boolean,
value: false
}
},
_resetSelection: function () {
if (Array.isArray(this.selected)) {
for (var i = 0; i < this.selected.length; i++) {
this.unlinkPaths('selected.' + i);
}
} else {
this.unlinkPaths('selected');
}
if (this.multi) {
if (!this.selected || this.selected.length) {
this.selected = [];
this._selectedColl = Polymer.Collection.get(this.selected);
}
} else {
this.selected = null;
this._selectedColl = null;
}
},
isSelected: function (item) {
if (this.multi) {
return this._selectedColl.getKey(item) !== undefined;
} else {
return this.selected == item;
}
},
deselect: function (item) {
if (this.multi) {
if (this.isSelected(item)) {
var skey = this._selectedColl.getKey(item);
this.arrayDelete('selected', item);
this.unlinkPaths('selected.' + skey);
}
} else {
this.selected = null;
this.unlinkPaths('selected');
}
},
select: function (item) {
var icol = Polymer.Collection.get(this.items);
var key = icol.getKey(item);
if (this.multi) {
if (this.isSelected(item)) {
if (this.toggle) {
this.deselect(item);
}
} else {
this.push('selected', item);
skey = this._selectedColl.getKey(item);
this.linkPaths('selected.' + skey, 'items.' + key);
}
} else {
if (this.toggle && item == this.selected) {
this.deselect();
} else {
this.linkPaths('selected', 'items.' + key);
this.selected = item;
}
}
}
});
Polymer({
is: 'dom-if',
extends: 'template',
properties: {
'if': {
type: Boolean,
value: false,
observer: '_queueRender'
},
restamp: {
type: Boolean,
value: false,
observer: '_queueRender'
}
},
behaviors: [Polymer.Templatizer],
_queueRender: function () {
this._debounceTemplate(this._render);
},
detached: function () {
this._teardownInstance();
},
attached: function () {
if (this.if && this.ctor) {
this.async(this._ensureInstance);
}
},
render: function () {
this._flushTemplates();
},
_render: function () {
if (this.if) {
if (!this.ctor) {
this.templatize(this);
}
this._ensureInstance();
this._showHideChildren();
} else if (this.restamp) {
this._teardownInstance();
}
if (!this.restamp && this._instance) {
this._showHideChildren();
}
if (this.if != this._lastIf) {
this.fire('dom-change');
this._lastIf = this.if;
}
},
_ensureInstance: function () {
if (!this._instance) {
this._instance = this.stamp();
var root = this._instance.root;
var parent = Polymer.dom(Polymer.dom(this).parentNode);
parent.insertBefore(root, this);
}
},
_teardownInstance: function () {
if (this._instance) {
var c = this._instance._children;
if (c) {
var parent = Polymer.dom(Polymer.dom(c[0]).parentNode);
c.forEach(function (n) {
parent.removeChild(n);
});
}
this._instance = null;
}
},
_showHideChildren: function () {
var hidden = this.__hideTemplateChildren__ || !this.if;
if (this._instance) {
this._instance._showHideChildren(hidden);
}
},
_forwardParentProp: function (prop, value) {
if (this._instance) {
this._instance[prop] = value;
}
},
_forwardParentPath: function (path, value) {
if (this._instance) {
this._instance.notifyPath(path, value, true);
}
}
});
Polymer({
is: 'dom-bind',
extends: 'template',
created: function () {
Polymer.RenderStatus.whenReady(this._markImportsReady.bind(this));
},
_ensureReady: function () {
if (!this._readied) {
this._readySelf();
}
},
_markImportsReady: function () {
this._importsReady = true;
this._ensureReady();
},
_registerFeatures: function () {
this._prepConstructor();
},
_insertChildren: function () {
var parentDom = Polymer.dom(Polymer.dom(this).parentNode);
parentDom.insertBefore(this.root, this);
},
_removeChildren: function () {
if (this._children) {
for (var i = 0; i < this._children.length; i++) {
this.root.appendChild(this._children[i]);
}
}
},
_initFeatures: function () {
},
_scopeElementClass: function (element, selector) {
if (this.dataHost) {
return this.dataHost._scopeElementClass(element, selector);
} else {
return selector;
}
},
_prepConfigure: function () {
var config = {};
for (var prop in this._propertyEffects) {
config[prop] = this[prop];
}
this._setupConfigure = this._setupConfigure.bind(this, config);
},
attached: function () {
if (this._importsReady) {
this.render();
}
},
detached: function () {
this._removeChildren();
},
render: function () {
this._ensureReady();
if (!this._children) {
this._template = this;
this._prepAnnotations();
this._prepEffects();
this._prepBehaviors();
this._prepConfigure();
this._prepBindings();
Polymer.Base._initFeatures.call(this);
this._children = Array.prototype.slice.call(this.root.childNodes);
}
this._insertChildren();
this.fire('dom-change');
}
});</script>
<style>
  /*******************************
            Flex Layout
  *******************************/
  .layout.horizontal,
  .layout.horizontal-reverse,
  .layout.vertical,
  .layout.vertical-reverse {
    display: -ms-flexbox;
    display: -webkit-flex;
    display: flex;
  }
  .layout.inline {
    display: -ms-inline-flexbox;
    display: -webkit-inline-flex;
    display: inline-flex;
  }
  .layout.horizontal {
    -ms-flex-direction: row;
    -webkit-flex-direction: row;
    flex-direction: row;
  }
  .layout.horizontal-reverse {
    -ms-flex-direction: row-reverse;
    -webkit-flex-direction: row-reverse;
    flex-direction: row-reverse;
  }
  .layout.vertical {
    -ms-flex-direction: column;
    -webkit-flex-direction: column;
    flex-direction: column;
  }
  .layout.vertical-reverse {
    -ms-flex-direction: column-reverse;
    -webkit-flex-direction: column-reverse;
    flex-direction: column-reverse;
  }
  .layout.wrap {
    -ms-flex-wrap: wrap;
    -webkit-flex-wrap: wrap;
    flex-wrap: wrap;
  }
  .layout.wrap-reverse {
    -ms-flex-wrap: wrap-reverse;
    -webkit-flex-wrap: wrap-reverse;
    flex-wrap: wrap-reverse;
  }
  .flex-auto {
    -ms-flex: 1 1 auto;
    -webkit-flex: 1 1 auto;
    flex: 1 1 auto;
  }
  .flex-none {
    -ms-flex: none;
    -webkit-flex: none;
    flex: none;
  }
  .flex,
  .flex-1 {
    -ms-flex: 1;
    -webkit-flex: 1;
    flex: 1;
  }
  .flex-2 {
    -ms-flex: 2;
    -webkit-flex: 2;
    flex: 2;
  }
  .flex-3 {
    -ms-flex: 3;
    -webkit-flex: 3;
    flex: 3;
  }
  .flex-4 {
    -ms-flex: 4;
    -webkit-flex: 4;
    flex: 4;
  }
  .flex-5 {
    -ms-flex: 5;
    -webkit-flex: 5;
    flex: 5;
  }
  .flex-6 {
    -ms-flex: 6;
    -webkit-flex: 6;
    flex: 6;
  }
  .flex-7 {
    -ms-flex: 7;
    -webkit-flex: 7;
    flex: 7;
  }
  .flex-8 {
    -ms-flex: 8;
    -webkit-flex: 8;
    flex: 8;
  }
  .flex-9 {
    -ms-flex: 9;
    -webkit-flex: 9;
    flex: 9;
  }
  .flex-10 {
    -ms-flex: 10;
    -webkit-flex: 10;
    flex: 10;
  }
  .flex-11 {
    -ms-flex: 11;
    -webkit-flex: 11;
    flex: 11;
  }
  .flex-12 {
    -ms-flex: 12;
    -webkit-flex: 12;
    flex: 12;
  }
  /* alignment in cross axis */
  .layout.start {
    -ms-flex-align: start;
    -webkit-align-items: flex-start;
    align-items: flex-start;
  }
  .layout.center,
  .layout.center-center {
    -ms-flex-align: center;
    -webkit-align-items: center;
    align-items: center;
  }
  .layout.end {
    -ms-flex-align: end;
    -webkit-align-items: flex-end;
    align-items: flex-end;
  }
  /* alignment in main axis */
  .layout.start-justified {
    -ms-flex-pack: start;
    -webkit-justify-content: flex-start;
    justify-content: flex-start;
  }
  .layout.center-justified,
  .layout.center-center {
    -ms-flex-pack: center;
    -webkit-justify-content: center;
    justify-content: center;
  }
  .layout.end-justified {
    -ms-flex-pack: end;
    -webkit-justify-content: flex-end;
    justify-content: flex-end;
  }
  .layout.around-justified {
    -ms-flex-pack: around;
    -webkit-justify-content: space-around;
    justify-content: space-around;
  }
  .layout.justified {
    -ms-flex-pack: justify;
    -webkit-justify-content: space-between;
    justify-content: space-between;
  }
  /* self alignment */
  .self-start {
    -ms-align-self: flex-start;
    -webkit-align-self: flex-start;
    align-self: flex-start;
  }
  .self-center {
    -ms-align-self: center;
    -webkit-align-self: center;
    align-self: center;
  }
  .self-end {
    -ms-align-self: flex-end;
    -webkit-align-self: flex-end;
    align-self: flex-end;
  }
  .self-stretch {
    -ms-align-self: stretch;
    -webkit-align-self: stretch;
    align-self: stretch;
  }
  /*******************************
            Other Layout
  *******************************/
  .block {
    display: block;
  }
  /* IE 10 support for HTML5 hidden attr */
  [hidden] {
    display: none !important;
  }
  .invisible {
    visibility: hidden !important;
  }
  .relative {
    position: relative;
  }
  .fit {
    position: absolute;
    top: 0;
    right: 0;
    bottom: 0;
    left: 0;
  }
  body.fullbleed {
    margin: 0;
    height: 100vh;
  }
  .scroll {
    -webkit-overflow-scrolling: touch;
    overflow: auto;
  }
  /* fixed position */
  .fixed-bottom,
  .fixed-left,
  .fixed-right,
  .fixed-top {
    position: fixed;
  }
  .fixed-top {
    top: 0;
    left: 0;
    right: 0;
  }
  .fixed-right {
    top: 0;
    right: 0;
    bottom: 0;
  }
  .fixed-bottom {
    right: 0;
    bottom: 0;
    left: 0;
  }
  .fixed-left {
    top: 0;
    bottom: 0;
    left: 0;
  }
</style>
<script>
  Polymer({
    is: 'ahb-dollar-label',

    properties : {
      value : {
        type : String,
        observer : 'update'
      },
      decimal : {
        type : Boolean,
        value : true
      },
      first : {
        type : Boolean,
        value : true
      },
      timer : {
        type : Number,
        value : -1
      }
    },

    ready : function() {
      this.style.color = '#5cb85c';
      this.style.display = 'inline-block';
    },

    update : function() {
      if( this.first ) {
        this._update();
        this.first = false;
        return;
      }

      this.className = 'animated zoomOut';
      if( this.timer != -1 ) clearTimeout(this.timer);

      this.timer = setTimeout(function(){
        this.timer = -1;

        this._update();
        this.style.visibility = 'hidden';
        this.className = 'animated zoomIn'

        setTimeout(function(){
          this.style.visibility = 'visible';
        }.bind(this), 25);

        setTimeout(function(){
          $(this).removeClass('zoomIn');
        }.bind(this), 1000);

      }.bind(this), 500);
    },

    _update : function() {
      var val = ''+parseFloat(this.value).toFixed(this.decimal ? 2 : 0);
      this.innerHTML = '$'+val.replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "$1,");
    }
  });
</script>
<script>
  Polymer({
    is : 'budget-materials-table',

    ready : function() {
      this.defaultCols = ['Material', 'Notes', 'Amount', 'Units', 'Price', 'SubTotal', 'Remove'];
      this.cols = [];
      this.style.display = 'block';
      this.style.overflowX = 'auto';
      this.controllers = [];

    },

    setOptions : function(options) {
      this.options = options;
    },

    setMaterials : function(data, options) {
      if( options ) this.setOptions(options);

      this.controllers = []
      this.data = data;

      if( Array.isArray(this.data.materials) ) {
        this.initTable(this.data.materials.length);

        for( var i = 0; i < this.data.materials.length; i++ ) {
          var m = FB.materialController.get(this.data.materials[i].name);
          var row = this.initRow(i+2, m, this.data.materials[i]);
          this.controllers.push(row);
        }

      } else {
        this.initTable(Object.keys(this.data.materials).length);
        var c = 2;
        for( var material in this.data.materials ) {
          var m = FB.materialController.get(material);
          var row = this.initRow(c, m, this.data.materials[material]);
          this.controllers.push(row);
          c++;
        }
      }

    },

    initRow : function(row, material, materialImpl) {
      return new FB.MaterialTableRow(
        this.querySelector('table[main] > tbody > tr:nth-child('+row+')'),
        {
          cols : this.cols,
          material : material,
          complexMaterial : this.data,
          isOperation : this.options.isOperation,
          materialImpl : materialImpl,

          onDelete : function(material) {
            this.recalc();

            if( Array.isArray(this.data.materials) && this.data.materials.length == 0 ) {
              this.innerHTML = ''; // remove table
            } else if( Object.keys(this.data.materials).length == 0 ) {
              this.innerHTML = ''; // remove table
            }

            this.fire('delete', material);
          }.bind(this),

          onAmountChange : function(material, amount) {
            this.recalc();
            this.fire('price-change', this.data.price);

          }.bind(this),

          onUnitsChange : function(material, units) {
            this.recalc();
            this.fire('price-change', this.data.price);
          }.bind(this)
        }
      );
    },

    recalc : function() {
      // sniff out material or operation
      if( this.data.schedule ) {
        FB.operationController.recalc();
      } else {
        FB.materialController.recalc();
      }
    },

    updateAmountFromUnits : function(from, to) {
      var value;

      try {
        value = FB.ucum.convert(1, FB.units.math.cleanDollars(from), FB.units.math.cleanDollars(to));
        if( value == 0 ) value = 1;
        value = 1 / value;
      } catch(e) {
        return {
          error : true,
          message : e,
        }
      }

      for( var i = 0; i < this.controllers.length; i++ ) {
        this.controllers[i].updateAmountFromUnits(value);
      }

      return null;
    },

    initTable : function(rows) {
      if( rows == 0 ) {
        this.innerHTML = '';
        return;
      }

      var table = '<table class="table" main>', cell;
      if( !this.options ) this.options = {};

      this.cols = $.extend(true, [], this.defaultCols);
      if( this.options.noRemove ) this.cols.splice(this.cols.indexOf('Remove'), 1);
      if( this.options.noNotes ) this.cols.splice(this.cols.indexOf('Notes'), 1);

      for( var i = 0; i <= rows; i++ ) {
        if( i == 0 ) cell = 'th';
        else cell = 'td';

        table += '<tr>';
        for( var j = 0; j < this.cols.length; j++ ) {
          table += '<'+cell+' type="'+this.cols[j]+'">'+(i == 0 && this.cols[j] != 'Remove' ? this.cols[j] : '')+'</'+cell+'>';
        }
        table += '</tr>';
      }
      this.innerHTML = table+'</table>';
    }
  });

  // controller for the material table row
  FB.MaterialTableRow = function(ele, config){
    var $ele = $(ele), amountTimer = -1, unitTimer = -1, cols = {};

    /* BASEPRICE
    var isBasePrice = false;
    if( config.material.name == config.complexMaterial.name+'--Base Price' ) {
      isBasePrice = true;
    } */

    for( var i = 0; i < config.cols.length; i++ ) {
      cols[config.cols[i]] = $ele.find('[type="'+config.cols[i]+'"]');
    }

    var nameLabel;
    if( config.material.type == 'complex' ) {
      nameLabel = $('<budget-macro></budget-macro>');
    } else {
      nameLabel = $('<budget-material></budget-material>');
    }
    cols.Material.append(nameLabel);

    var errorLabel = $('<div style="display:none" class="text text-danger"></div>');
    cols.Material.append(errorLabel);

    var unitsInput = $('<budget-unit-selector '+(config.material.fixed ? 'disabled' : '')+'></budget-unit-selector>');
    unitsInput.on('units-change', fireUnitsChange);
    cols.Units.append(unitsInput);

    var amountInput = $('<input type="number" class="form-control" style="min-width: 50px" />');
    amountInput.on('input', fireAmountChange);
    cols.Amount.append(amountInput);

    var subtotal = $('<ahb-dollar-label decimal></ahb-dollar-label>');
    cols.SubTotal.append(subtotal);

    var notesInput;
    if( cols.Notes ) {
      notesInput = $('<input type="text" class="form-control" style="min-width: 100px" />');
      notesInput.on('input', updateNotes);
      cols.Notes.append(notesInput);
    }

    cols.Price.css('white-space', 'nowrap');

    var removeBtn;
    if( cols.Remove ) {
      removeBtn = $('<a class="btn btn-link"><i class="fa fa-trash"></i></a>');
      removeBtn.on('click', fireDelete);
      cols.Remove.append(removeBtn);
    }

    function render() {
      setErrorStatus();

      nameLabel[0].material = config.material.name;
      unitsInput[0].units = config.materialImpl.units
      amountInput.val(parseFloat(config.materialImpl.amount.toFixed(4)));


      cols.Price.html(
        (config.material.price ? config.material.price.toFixed(2) : '')+
        (config.material.type === 'complex' ? ' $/' : ' ') +
        FB.units.getLabel(config.material.units, true)
      );

      setPrice();

      if( cols.Notes ) {
        notesInput.val(config.materialImpl.note);
      }

    }

    function setErrorStatus() {
      if( !config.materialImpl.error ) {
        errorLabel.hide();
      } else {
        errorLabel.html(config.materialImpl.message);
        errorLabel.show();
      }
    }

    function updateAmountFromUnits(value) {
      config.materialImpl.amount = value * config.materialImpl.amount;
      amountInput.val(config.materialImpl.amount);
    }

    function fireUnitsChange(e) {
      if( unitTimer == -1 ) clearTimeout(unitTimer);

      unitTimer = setTimeout(function(){
        unitTimer = -1;
        _fireUnitsChange(e);
      }, 200);
    }

    function _fireUnitsChange(e) {
      if( e.originalEvent.detail.error ) return;

      config.materialImpl.units = e.originalEvent.detail.value;

      setErrorStatus();
      config.onUnitsChange(config.materialImpl, e.originalEvent.detail.value);
      setPrice();
    }

    function fireDelete(e) {
      if( Array.isArray(config.complexMaterial.materials) ) {
        for( var i = 0; i < config.complexMaterial.materials.length; i++ ) {
          if( config.complexMaterial.materials[i].id == config.materialImpl.id ) {
            config.complexMaterial.materials.splice(i, 1);
            break;
          }
        }
      } else {
        delete config.complexMaterial.materials[config.material.name];
      }

      $ele.remove();

      config.onDelete(config.materialImpl);
    }

    function fireAmountChange(e) {
      if( amountTimer == -1 ) clearTimeout(amountTimer);

      amountTimer = setTimeout(function(){
        amountTimer = -1;
        _fireAmountChange(e);
      }.bind(), 200);
    }

    function _fireAmountChange(e) {
      config.materialImpl.amount = parseFloat(e.originalEvent.target.value);
      config.materialImpl.originalAmount = config.materialImpl.amount;

      setErrorStatus();
      config.onAmountChange(config.materialImpl, parseFloat(e.originalEvent.target.value));
      setPrice();
    }

    function setPrice() {
      subtotal[0].value = config.materialImpl.price;
    }

    function updateNotes() {
      config.materialImpl.notes = notesInput.val();
    }

    render();

    return {
      updateAmountFromUnits : updateAmountFromUnits
    }

  };
</script>
</head><body><div hidden="" by-vulcanize=""><dom-module id="budget-macro" assetpath="/public/elements/budget-components/">
  <style>
    :host {
      display: inline-block;
    }
    :host.open {
      background-color: #f8f8f8;
      border-radius: 4px;
      padding: 5px
    }

    #expand {
      cursor: pointer;
      white-space: nowrap;
    }
    #expand:hover {
      color: #2196f3;
    }

    .btn-group > .btn.btn-default {
      transition: all 300ms linear;
      -moz-transition: all 300ms linear;
      -ms-transition: all 300ms linear;
    }

    .btn-group > .btn.btn-default.nohover {
      border-top: 1px solid transparent !important;
      border-left: 1px solid transparent !important;
      box-shadow: none !important;
      -moz-box-shadow: none !important;
      -ms-box-shadow: none !important;
      -webkit-box-shadow: none !important;
    }
  </style>

  <template>

    <table>
      <tbody><tr>
        <td>
          <span id="expand"><i class="fa fa-cubes" id="icon"></i> <span id="nameLabel"></span></span>
        </td>
        <td>
          <div style="width: 102px;display:none;" id="btns">
            <div class="btn-group" role="group" style="padding-left: 15px">
              <a class="btn btn-default nohover" id="editBtn"><i class="fa fa-pencil"></i></a>
              <a class="btn btn-default nohover" on-click="toggleView" id="toggleView"><i class="fa fa-angle-down"></i></a>
            </div>
          </div>
        </td>
      </tr>
      <tr>
        <td colspan="2"><div id="main" style="display:none"></div></td>
      </tr>
    </tbody></table>

  </template>
</dom-module>

<script>
  Polymer({
    is : 'budget-macro',

    properties : {
      material : {
        type : String,
        observer : 'updateMaterial'
      }
    },

    ready : function() {
      this.editUnitsTimer = -1;

      this.data = {
        name : '[Not Set]',
        materials : {},
        price : 0,
        units : ''
      };

      FB.materialController.on('material-update', this.onUpdate.bind(this));

      $(this).hover(function(){
        $(this).find('.nohover').removeClass('nohover');
      },function(){
        $(this).find('.btn-group > .btn').addClass('nohover');
      });

      $(this.$.expand).on('click',function() {
        $(this.$.main).toggle();
        $(this.$.btns).toggle();
        $(this).toggleClass('open');
      }.bind(this));
    },

    attached : function() {
      this.popup = document.querySelector('budget-complex-material-popup');
      this.render();
      this.updateMaterial();
    },

    updateMaterial : function(material) {
      if( material ) this.material = material;
      if( !this.material ) return;

      var m = FB.materialController.get(this.material);

      this.$.editBtn.setAttribute('href','#budget/materials/'+this.material);

      // TODO: set error message!!
      if( m.error ) {
        return alert(JSON.stringify(m));
      }

      this.data = m;

      this.render(this.renderType);
    },

    rerender : function() {
      this.render(this.renderType);
    },

    // render display. type
    render : function(type) {
      this.renderType = type;
      this.$.nameLabel.innerHTML = '<b>'+this.data.name+'</b> ';

      if( this.renderType == 'tree' ) {
        this.renderTree();
        this.$.toggleView.innerHTML = '<i class="fa fa-angle-down"></i>';
      } else {
        this.renderCompressed();
        this.$.toggleView.innerHTML = '<i class="fa fa-angle-double-down"></i>';
      }

      this.checkError();
    },

    checkError : function() {
      for( var key in this.data.materials ) {
        if( this.data.materials[key].error ) {
          this.$.icon.className = 'fa fa-warning';
          this.$.icon.style.color = 'red';
          this.error = true;
          return;
        }
      }

      this.error = false;
      this.$.icon.className = 'fa fa-cubes';
      this.$.icon.style.color = '';
    },

    toggleView : function(e) {
      if( e && e.preventDefault ){
        e.preventDefault();
        e.stopPropagation();
      }

      if( this.renderType == 'tree' ) {
        this.render('compressed');
      } else {
        this.render('tree');
      }
    },

    renderTree : function() {
      var list = [];
      this.getTreeMaterialList(this.data.materials, '', list);

      var html = '<table class="table" style="padding-top:5px;margin-bottom:0">';
      for( var i = 0; i < list.length; i++ ) {
        if( list[i].error ) {
          html += this.renderError(list[i]);
          continue;
        }

        html += '<tr><td style="white-space: nowrap">' +
            '<i>'+list[i].path + '</i> '+
            (list[i].type == 'complex' ? '<b><i class="fa fa-cubes"></i>' +list[i].name + '</b>' : '<budget-material material="'+list[i].name+'"></budget-material>' )+'</td><td style="white-space: nowrap">' +

              list[i].amount+' '+FB.units.getLabel(list[i].units, true)+' = $'+
              list[i].price.toFixed(2)+' </span>'
          '</td></tr>';
      }

      this.$.main.innerHTML = this.getPriceLabel()+html+'</table>';
      $(this.$.main)
        .find('.btn-create')
        .on('click', function(){
          document.querySelector('budget-material-popup').create($(this).attr('material'));
        });
    },

    getPriceLabel : function() {
      return '<div class="text text-success" style="text-align:center;padding-top:5px">$' +
            (this.data.price ? this.data.price.toFixed(2) : '0')  +
            ' per '+FB.units.getLabel(this.data.units, true)+'</div>';
    },

    renderCompressed : function() {
      var list = [];
      this.getCompressedMaterialList(this.data.materials, list);

      var html = '<table class="table" style="padding-top:5px;margin-bottom:0">';
      for( var i = 0; i < list.length; i++ ) {
        if( list[i].error ) {
          html += this.renderError(list[i]);
          continue;
        }

        html += '<tr><td style="white-space: nowrap">' +
            list[i].count+'x ' +
            (list[i].type == 'complex' ? '<b><i class="fa fa-cubes"></i>' +list[i].name + '</b>' : '<budget-material material="'+list[i].name+'"></budget-material>' )+'</td><td style="white-space: nowrap">' +
            ' '+(list[i].price ? list[i].price.toFixed(2) : '')+' '+FB.units.getLabel(list[i].units, true)+'</span>'
          '</td></tr>';
      }

      this.$.main.innerHTML = this.getPriceLabel()+html+'</table>';
      $(this.$.main)
        .find('.btn-create')
        .on('click', function(){
          document.querySelector('budget-material-popup').create($(this).attr('material'));
        });
    },

    renderError : function(err) {
      return '<tr><td class="text text-danger">'+err.message+'</td><td>'+
        (err.code === 3 ? '<a class="btn btn-link btn-create" material="'+err.name+'">Create</a>' : '')+
        '</td></tr>';
    },

    getCompressedMaterialList : function(materials, list) {
      for( var material in materials ) {
        var m = FB.materialController.get(material);

        if( m.error ) {
          list.push(m);
          continue;
        }

        var index = this.listMaterialIndex(list, m.name);
        if( index == -1 ) {
          var item = $.extend(true, {}, m);
          item.count = 1;
          list.push(item);
        } else {
          list[index].count++;
        }

        if( m.type === 'complex' && m.materials) {
          this.getCompressedMaterialList(m.materials, list);
        }
      }
    },

    getTreeMaterialList : function(materials, path, list) {
      for( var material in materials ) {
        var m = FB.materialController.get(material);

        if( m.error ) {
          list.push(m);
          continue;
        }

        var item = $.extend(true, {}, m);
        item.path = path;
        item.amount = materials[material].amount;
        item.units = materials[material].units;
        item.price = materials[material].price;
        list.push(item);

        if( m.type === 'complex' &&  m.materials) {
          var p = path+m.name+' - ';
          this.getTreeMaterialList(m.materials, p, list);
        }
      }
    },

    listMaterialIndex : function(list, name) {
      for( var i = 0; i < list.length; i++ ) {
        if( list[i].name == name ) return i;
      }
      return -1;
    },

    // fired whenever any material is updated
    onUpdate : function(e) {
      // renaming something in our list?
      if( e.replaced && this.data.materials[e.replaced] !== undefined ) {
        this.data.materials[e.material.name] = this.data.materials[e.replaced];
        delete this.data.materials[e.replaced];
      }

      // if the material name is not in our chain, we can quit
      if( !FB.materialController.contains(this.data, e.material.name, e.replaced) ) {
        return;
      }

      // rerender
      this.render(this.renderType);
    }
  });
</script>
<dom-module id="budget-complex-material-popup" assetpath="/public/elements/budget-components/">
  <template>
    <div class="modal fade" id="popup">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" aria-label="Close" on-click="hide"><span aria-hidden="true"></span></button>
            <h4 class="modal-title"><i class="fa fa-pencil"></i> Edit Complex Material</h4>
          </div>
          <div class="modal-body" id="body"></div>
        </div>
      </div>
    </div>
  </template>


<script>
  Polymer({
    is : 'budget-complex-material-popup',

    ready : function() {
      this.popup = $(this.$.popup).modal({show: false});
      this.body = $(this.$.body);

      $(window).on('hashchange', this.hide.bind(this));
    },

    show : function(closeCallback) {
      this.closeCallback = closeCallback;
      this.popup.modal('show');
    },

    hide : function() {
      if( this.closeCallback ) {
        this.closeCallback();
        this.closeCallback = null;
      }
      this.popup.modal('hide');
    },

    setBody : function(ele) {
      this.body.html('').append(ele);
    }
  })
</script>
</dom-module><dom-module id="budget-schedule-popup" assetpath="/public/elements/budget-components/">
  <template>
    <div class="modal fade" id="popup">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" aria-label="Close" on-click="hide"><span aria-hidden="true"></span></button>
            <h4 class="modal-title"><i class="fa fa-calendar-o"></i> Edit Schedule</h4>
          </div>
          <div class="modal-body" id="body"></div>
        </div>
      </div>
    </div>
  </template>


<script>
  Polymer({
    is : 'budget-schedule-popup',

    ready : function() {
      this.popup = $(this.$.popup).modal({show: false});
      this.body = $(this.$.body);
    },

    show : function(closeCallback) {
      this.closeCallback = closeCallback;
      this.popup.modal('show');
    },

    hide : function() {
      if( this.closeCallback ) {
        this.closeCallback();
        this.closeCallback = null;
      }
      this.popup.modal('hide');
    },

    setBody : function(ele) {
      this.body.html('').append(ele);
    },

    on : function(e, fn) {
      this.popup.on(e, fn);
    }
  })
</script>
</dom-module><dom-module id="budget-unit-selector" assetpath="/public/elements/budget-components/">
  <style>
    :host {
      display: block;
      width: 100px;
      position: relative;
    }
    #message {
      position: absolute;
      padding: 3px;
      border: 1px solid #ccc;
      background-color: white;
      display: none;
      z-index: 100;
    }
    #input {
      display : block;
    }
    #icon {
      position : absolute;
      bottom : 3px;
      right: 0px;
    }
  </style>

  <template>
    <i id="icon" class="text text-danger fa fa-warning"></i><input id="input" type="text" class="form-control text" on-input="onChange" on-blur="onBlur" on-focus="onFocus">
    <div id="message"></div>
  </template>
</dom-module>

<script>
  Polymer({
    is : 'budget-unit-selector',

    properties : {
      units : {
        type : String,
        observer: 'unitsObserver',
        value : ''
      },
      block : {
        type : Boolean,
        observer: 'setDisplayBlock',
        value : false
      },
      disabled : {
        type : Boolean,
        observer: 'setDisabled',
        value : false
      }
    },

    attached : function() {
      this.checkError();
      this.onBlur();
    },

    setDisplayBlock : function() {
      if( this.block ) {
        this.style.display = 'block';
        this.$.input.style.display = 'block';
        this.style.width = '100%';
      } else {
        this.style.display = 'inline-block';
        this.$.input.style.display = 'inline-block';
      }
    },

    setDisabled : function() {
      if( this.disabled ) this.$.input.setAttribute('disabled', 'disabled');
      else this.$.input.removeAttribute('disabled');
    },

    unitsObserver : function() {
      this.setUnits();
    },

    setUnits : function(units) {
      if( units !== undefined ) this.units = units;
      this.$.input.value = this.units;
      this.checkError();
    },

    getUnits : function() {
      return this.$.input.value;
    },

    onChange : function(){
      if( this.$.input.value == '' ) {
        this.clearError();
        return;
      }

      this.checkError();
      this.fire('units-change', {
        value : this.$.input.value,
        error : this.error
      });
    },

    checkError : function() {
      try {
        FB.ucum.parse(FB.units.math.cleanDollars(this.$.input.value));
      } catch(e) {
        $(this).addClass('has-error');
        $(this.$.input).addClass('text-danger');
        this.error = true;

        this.$.icon.style.display = 'inline';

        this.$.message.innerHTML = '<div class="text text-danger">Invalid Units</div>'+this.getReminders();

        $(this.$.message)
          .find('a')
          .on('click', function(e){
            this.$.input.value = e.currentTarget.innerHTML;
            this.onChange();
          }.bind(this));
        return;
      }
      this.clearError();
    },

    clearError : function() {
      this.error = false;
      $(this).removeClass('has-error');
      $(this.$.input).removeClass('text-danger');
      this.$.message.innerHTML = '<span class="text text-success">Valid</span>';

      this.$.icon.style.display = 'none';
    },

    onFocus : function() {
      this.$.message.style.display = 'block';

      if( this.block ) return;
      this.style.width = '150px';
      this.$.input.style.width = '150px';
    },

    onBlur : function() {
      setTimeout(function(){
        this.$.message.style.display = 'none';
        if( this.block ) return;
        this.style.width = '100px';
        this.$.input.style.width = '100px';
      }.bind(this), 100);


    },

    getReminders : function() {
      var parts = this.$.input.value.replace(/[\]\[\.\/]/g, ' ').replace(/\s+/g,' ').split(' ');

      var reminders = [];
      var used = [];

      for( var i = 0; i < parts.length; i++ ) {
        if( parts[i] == '' ) continue;
        var re = new RegExp('.*'+parts[i].trim()+'.*','i');

        for( var key in FB.units.lookup ) {
          if( key.match(re) && used.indexOf(key) == -1 && used.indexOf(FB.units.lookup[key].symbol) == -1 ) {
            if( FB.units.lookup[key].symbol != key ) {
              reminders.push('<b>'+key+'</b> = <a style="cursor:pointer">'+FB.units.lookup[key].symbol+'</a>');
            } else {
              reminders.push('<a style="cursor:pointer">'+FB.units.lookup[key].symbol+'</a>');
            }

            used.push(key);
            used.push(FB.units.lookup[key].symbol);
          }
        }
      }

      if( reminders.length == 0 ) return '';
      return '<div class="well well-sm"><div>Reminders</div><div>'+reminders.join('</div><div>')+'</div></div>';
    }
  });
</script>
<dom-module id="budget-operation-scheduler" assetpath="/public/elements/budget-components/">
  <style>
    :host {
      display: block;
      position: relative;
      padding: 4px;
      border-radius: 4px;
    }
    :host:hover {
      background-color: #f8f8f8;
      color: #2196f3;
    }
    #inputPanel {
      font-size: 14px;
      color: #333;
    }
    #title {
      cursor: pointer;
    }
    .length-label {
      padding: 10px;
      color: #666;
    }
  </style>

  <template>

    <div on-click="toggle" id="title">
      <div><i class="fa fa-calendar-o"></i> Schedule: <span>{{displayText}}</span> <i class="fa fa-pencil" id="edit" style="display:none"></i></div>
      <div><small id="dateRangeText"></small></div>
    </div>

    <div id="inputPanel">
      <h5 class="page-header" style="text-align:center; margin-top: 0px">{{operationName}}</h5>

      <div class="form-horizontal">

        <div class="form-group" id="dates">
          <label for="datesInput" class="col-sm-3 control-label"><i class="fa fa-calendar-plus-o"></i> Add Dates</label>
          <div class="col-sm-9">
            <div id="inputRoot"></div>
            <div id="selectedDates">


              <template is="dom-repeat" items="{{dates}}">
                <div>

                  <div class="layout horizontal" style="margin-top:15px">
                    <div class="flex"><h6 style="padding-right: 20px">{{item.dateFormatted}}</h6></div>

                    <div class="length-label">Length:</div>
                    <div>
                      <input type="number" value="{{item.length::input}}" class="form-control" on-input="onLengthUpdate" style="max-width: 75px; margin-right: 5px">
                    </div>

                    <div>
                      <select value="{{item.units::input}}" class="form-control" on-change="onLengthUpdate">
                        <option value="day">Day(s)</option>
                        <option value="month">Month(s)</option>
                        <option value="year">Year(s)</option>
                      </select>
                    </div>

                    <div>
                      <a class="btn btn-link" index$="{{index}}" on-click="removeDate"><i class="fa fa-calendar-times-o"></i></a>
                    </div>
                  </div> 

                </div>
              </template>
            </div>

          </div>
        </div>
      </div> 

      <div id="chart" style="height:100px"></div>

    </div> 
  </template>
</dom-module>

<script>
  Polymer({
    is : 'budget-operation-scheduler',

    ready : function() {
      this.displayText = '';
      this.dateRangeText = '';

      this.data = [];
      this.dates = [];

      $(this.$.title)
        .on('mouseover', function(){
          this.$.edit.style.display = 'inline';
        }.bind(this))
        .on('mouseleave', function(){
          this.$.edit.style.display = 'none';
        }.bind(this))

      this.update();
      $(window).on('resize', this.updateChart.bind(this));
    },

    attached : function() {
      this.popup = document.querySelector('budget-schedule-popup');
      this.popup.on('hidden.bs.modal', function (e) {
        this.editing = false;
      }.bind(this));

      this.removeChild(this.$.inputPanel);
    },

    set : function(data, name) {
      this.data = data;
      this.operationName = name;

      this.copyDataArray();

      this.update(true);
    },

    // Polymer hack and keeping UI code out of data
    copyDataArray : function() {
      var tmp = [];

      for( var i = 0; i < this.data.length; i++ ) {
        var date = this.toDate(this.data[i].date);

        tmp.push({
          length : this.data[i].length,
          units : this.data[i].units,
          date : date,
          dateFormatted : date.toDateString()
        })
      }

      this.dates = tmp;
    },

    onLengthUpdate : function() {
      this.update();
    },

    update : function(noEvent) {
      this.$.dates.style.display = 'block';
      this.displayText = ' x'+this.dates.length;

      this.dates.sort(function(a, b){
        if( a.date.getTime() > b.date.getTime() ) return 1;
        else if( a.date.getTime() < b.date.getTime() ) return -1;
        return 0;
      });

      var tmp = [];
      for( var i = 0; i < this.dates.length; i++ ) {
        tmp.push(this.toDateString(this.dates[i]));
      }

      this.data = tmp;
      this.copyDataArray();

      if( this.dates.length > 1 ) {
        this.dateRangeText = this.dates[0].date.toDateString() + ' <i class="fa fa-long-arrow-right"></i> '+
                            this.dates[this.dates.length-1].date.toDateString();
      } else if( this.dates.length == 1 ) {
        this.dateRangeText = this.toDateString(this.dates[0]).date;
      } else {
        this.dateRangeText = '';
      }
      this.$.dateRangeText.innerHTML = this.dateRangeText;

      if( !noEvent ) this.fire('schedule-update', this.data);

      this.updateChart();
    },

    updateChart : function() {
      if( !this.editing ) return;

      var container = this.$.chart;
      var chart = new google.visualization.Timeline(container);
      var dataTable = new google.visualization.DataTable();

      dataTable.addColumn({ type: 'string', id: 'Operation' });
      dataTable.addColumn({ type: 'date', id: 'Start' });
      dataTable.addColumn({ type: 'date', id: 'End' });

      var arr = [];
      this.dates.forEach(function(d){
        var end = new Date(d.date.getTime()+this.getIntervalTime(d));
        arr.push([this.operationName, d.date, end]);
      }.bind(this));

      if( arr.length == 0 ) {
        return container.innerHTML = '<div class="alert alert-warning">This operation is not scheduled.</div>';
      }

      dataTable.addRows(arr);
      chart.draw(dataTable);
    },

    getIntervalTime : function(date) {
      var l = parseInt(date.length);
      if( date.units == 'year' ) {
        return l * 86400000 * 365;
      } else if( date.units == 'day' ){
        return l * 86400000;
      } else {
        return l * 86400000 * 30;
      }
    },

    toDate : function(dateStr) {
      try {
        var parts = dateStr.split('-');
        return new Date(parseInt(parts[0]), parseInt(parts[1])-1, parseInt(parts[2]));
      } catch(e) {
        return new Date();
      }
    },

    toDateString : function(d) {
      return {
        length : d.length,
        units : d.units,
        date : (d.date.getYear()+1900)+'-'+(d.date.getMonth()+1)+'-'+(d.date.getDate())
      }
    },

    removeDate : function(e) {
      var index = parseInt(e.currentTarget.getAttribute('index'));

      this.data.splice(index, 1);
      this.dates.splice(index, 1);

      this.update();
    },

    recreateInput : function() {
      var input = $('<div class="layout horizontal center">'+
        '<div class="flex" style="padding-right: 15px">'+
          '<input id="datesInput" class="form-control" placeholder="New Date (mm/dd/yyyy)"/>'+
        '</div>'+
        '<div><a class="btn btn-primary" disabled><i class="fa fa-plus"></i></a></div>'+
      '</div>');
      $(this.$.inputRoot).html('').append(input);

      var cDate = null;
      var btn = input.find('a');

      input
        .find('input')
        .datepicker({
          format: 'mm/dd/yyyy',
          orientation : 'top auto'
        })
        .on('changeDate', function(e){
          var date = e.date;
          if( date.getFullYear() < 1900 || date.getFullYear() > 2200 ) {
            cDate = null;
            btn.attr('disabled', 'disabled');
            return;
          }

          btn.removeAttr('disabled');
          cDate = date;
        }.bind(this));

      btn
        .on('click', function(){
          if( cDate == null ) return;

          this.dates.push({
            date : cDate,
            length : 1,
            units : 'month'
          });
          this.update();
          $(this.$.datesInput).datepicker('hide');
        }.bind(this));

    },

    toggle : function() {
      this.editing = true;

      this.popup.setBody(this.$.inputPanel);
      this.popup.show();

      this.recreateInput();


      setTimeout(this.updateChart.bind(this), 500);
    }
  });
</script>
<dom-module id="budget-operation" assetpath="/public/elements/budget-components/">
  <style>
    :host {
      display: block;
      padding: 15px;
      margin: 15px;
      box-shadow: 0 0 8px #ccc;
    }
    @media(max-width: 768px) {
      :host {
        padding: 5px;
        margin: 5px 0px;
      }
    }
  </style>

  <template>

    <h4 class="page-header" style="margin-top: 5px; text-transform: capitalize">
      <div style="margin-bottom: 5px"><a on-click="toggleContent" class="btn btn-default" style="font-size:17px"><i class="fa fa-toggle-right" id="icon"></i></a>

      <input type="text" class="form-control" style="display:none; width: 300px" id="nameInput" on-keyup="onNameInputKeyUp" on-blur="saveNewName">
      <span id="nameLabel" style="cursor:pointer" on-mouseenter="onMouseEnterName" on-mouseleave="onMouseLeaveName" on-click="editName"></span>
      <span id="nameMsg" class="text text-danger" style="font-size: 14px"></span>
      <i class="fa fa-pencil" style="display:none" id="renameIcon"></i>

      <i class="fa fa-warning text text-danger" style="display:none" id="errorIcon"></i>
    </div></h4>

    <div class="row">
      <div class="col-sm-8">
        <h5>
          <budget-operation-scheduler on-schedule-update="onScheduleUpdate" id="schedule"></budget-operation-scheduler>
        </h5>

      </div>
      <div class="col-sm-4">
        <table class="padding: 15px">
          <tbody><tr>
            <td><h4>Subtotal</h4></td>
            <td style="padding-left: 10px ">
              <h4 class="text text-success"><ahb-dollar-label id="subtotal"></ahb-dollar-label>
              <span id="subtotalInfo"></span></h4>
            </td>
          </tr>
          <tr>
            <td><h4>Total</h4></td>
            <td style="padding-left: 10px "><h4 class="text text-success"><ahb-dollar-label id="total"></ahb-dollar-label></h4></td>
          </tr>
        </tbody></table>
      </div>
    </div>

    <div id="content" style="display:none" class="animated zoomIn">
      <div class="form-horizontal" style="margin: 25px 0 ">
        <div class="form-group">
          <label for="materialSearchInput" class="col-sm-3 control-label">Add Materials</label>
          <div class="col-sm-9">
            <budget-material-search on-material-select="onMaterialSelect"></budget-material-search>
          </div>
        </div>
      </div>

      <budget-materials-table id="materialTable" on-price-change="updateTotals" on-delete="onMaterialDelete"></budget-materials-table>

      <a class="btn btn-link" on-click="delete"><i class="fa fa-trash"></i> Delete Operation</a>
    </div>

  </template>
</dom-module>

<script>
  Polymer({
    is : 'budget-operation',

    properties : {
      operationname : {
        type : String,
        observer : 'update'
      }
    },

    ready : function() {
      this.firstScheduleEvent = true;
      FB.operationController.on('operation-update', this.onOperationUpdate.bind(this));
      FB.materialController.on('material-update', this.onMaterialUpdate.bind(this));
    },

    attached : function() {
      if( this.operation ) this.update();
    },

    // fired from operation controller
    onOperationUpdate : function(operation) {
      if( !this.operation ) return;
      if( operation.name != this.operation.name ) return;

      this.render();
    },

    onMaterialUpdate : function(e) {
      if( !this.operation ) return;
      if( !this.operation.materials ) return;

      for( var i = 0; i < this.operation.materials.length; i++ ) {
        var m = FB.materialController.get(this.operation.materials[i].name);
        if( m.error ) continue;

        if( FB.materialController.contains(m, e.material.name, e.replaced) ) {
          this.render();
          return;
        }
      }
    },

    // fire from schedule element
    onScheduleUpdate : function(e) {
      if( !this.operation ) return;

      this.operation.schedule = e.detail;
      FB.operationController.recalc();
      this.updateTotals();
    },

    update : function() {
      this.operation = FB.operationController.get(this.operationname);
      this.$.schedule.set(this.operation.schedule, this.operation.name);

/*
      this.$.radioEntireFarm.setAttribute('name', this.operation.name+'Radio');
      this.$.radioPerAcre.setAttribute('name', this.operation.name+'Radio');

      if( this.operation.perAcre ) {
        this.$.radioPerAcre.setAttribute('checked', 'checked');
        this.$.radioEntireFarm.removeAttribute('checked');
      } else {
        this.$.radioEntireFarm.setAttribute('checked', 'checked');
        this.$.radioPerAcre.removeAttribute('checked');
      }
*/
      this.render();
    },

    delete : function() {
      if( !confirm('Are your sure you want to delete this operation?') ) return;
      FB.operationController.remove(this.operation.name);
      FB.operationController.recalc();
    },

    showError : function(show) {
      if( show ) this.$.errorIcon.style.display = 'inline';
      else this.$.errorIcon.style.display = 'none';
    },

    checkError : function() {
      for( var i = 0; i < this.operation.materials.length; i++ ) {
        if( this.operation.materials[i].error ) {
          this.showError(true);
          return;
        }
      }
      this.showError(false);
    },

    render : function() {
      if( !this.$.materialTable.setMaterials ) return;

      this.$.nameLabel.innerHTML = this.operation.name;

      if( !this.operation.materials ) return;

      this.$.materialTable.setMaterials(this.operation, {isOperation : true});
      this.updateTotals();
      this.checkError();
    },

    updateTotals : function() {
      var scheduled = this.operation.schedule ? this.operation.schedule.length : 0;
      $(this.$.total).attr('value', this.operation.total);
      $(this.$.subtotal).attr('value', this.operation.subtotal);
      $(this.$.subtotalInfo).html('<span style="color:#888">x'+scheduled+'</span>');
    },

    updateUnit : function() {
      this.operation.perAcre = $(this.$.radioPerAcre).is(':checked') ? true : false;
      FB.operationController.add(this.operation, {replace: true});
      this.updateTotals();
    },

    onMaterialDelete : function(e) {
      FB.operationController.add(this.operation, {replace: true});
      this.updateTotals();
    },

    onMaterialSelect : function(e) {
      var materialDef = e.detail;

      var units;
      if( materialDef.type == 'complex' ) {
        units = materialDef.units;
      } else {
        units = FB.units.invert(materialDef.units);
      }

      FB.operationController.addUpdateMaterial(
        this.operation,
        {
          name : materialDef.name,
          amount : 1,
          units : units
        }
      );

      FB.operationController.add(this.operation, {replace: true});
      this.render();
    },

    toggleContent : function() {
      if( this.$.content.style.display == 'block' ) {
        this.$.content.style.display = 'none'
        this.$.icon.className = 'fa fa-toggle-right';
      } else {
        this.$.content.style.display = 'block'
        this.$.icon.className = 'fa fa-toggle-down';
      }
    },

    onMouseEnterName : function() {
      this.$.renameIcon.style.display = 'inline-block';
    },

    onMouseLeaveName : function() {
      this.$.renameIcon.style.display = 'none';
    },

    editName : function() {
      this.$.nameLabel.style.display = 'none';
      this.$.nameInput.style.display = 'inline-block';
      this.$.nameInput.value = this.operation.name;
      this.$.nameInput.focus();
    },

    onNameInputKeyUp : function(e) {
      if( e.which == 13 ) this.$.nameInput.blur();
    },

    saveNewName : function() {
      if( this.$.nameInput.value.replace(/\s/g, '') == '' ) {
        this.$.nameMsg.innerHTML = 'Invalid Name.';
        return;
      }

      var op = FB.operationController.get(this.$.nameInput.value);
      if( !op.error && this.operation.name !== this.$.nameInput.value ) {
        this.$.nameMsg.innerHTML = 'Invalid Name. An operation with this name already exists';
        return;
      }

      this.$.nameMsg.innerHTML = '';
      var oldName = this.operation.name;
      this.operation.name = this.$.nameInput.value;
      this.$.nameLabel.innerHTML = this.operation.name;
      this.$.nameLabel.style.display = 'inline-block';
      this.$.nameInput.style.display = 'none';

      FB.operationController.add(this.operation,
          {
            noRecalc: true,
            noEvents: true,
            rename : oldName
          }
      );
    }

  });
</script>
<dom-module id="budget-material" assetpath="/public/elements/budget-components/">
  <style>
    :host {
      display: inline-block;
    }
    #label {
      white-space: nowrap;
    }
    #label:hover {
      color: #2196f3;
    }
  </style>

  <template>
    <div id="label" style="cursor:pointer" on-click="toggle"><b><i class="fa fa-cube" id="icon"></i> <span id="nameLabel"></span></b></div>
    <div id="error" class="text text-danger"></div>
    <div id="price" style="white-space: nowrap">
      <div id="forLabel"></div>
      <span id="priceLabel"></span>
      <span id="unitLabel"></span>
      <a class="btn btn-link" id="edit"><i class="fa fa-edit"></i></a>
    </div>
  </template>
</dom-module>

<script>
  Polymer({
    is : 'budget-material',

    properties : {
      material : {
        type : String,
        observer : 'render'
      },
      showPrice : {
        type : Boolean,
        observer : 'render',
        value : false
      }
    },

    attached : function() {
      this.render();
    },

    render : function(material) {
      this.updatePrice();

      this.showError();

      if( typeof material == 'string' ) this.material = material;
      if( !this.material ) return;



      if( this.material.indexOf('--') > -1 ) {
        this.$.forLabel.innerHTML = '(for '+this.material.split('--')[0]+')';
      } else {
        this.$.forLabel.innerHTML = '';
      }

      this.$.edit.href = '#budget/materials/'+this.material;

      var m = FB.materialController.get(this.material);
      if( m.error ) return this.showError(m);

      if( m.fixed ) {
        this.$.edit.style.display = 'none';
        this.$.nameLabel.innerHTML = this.material.replace(/.*--/, '')+' <span class="label label-warning">Fixed</span>';
      } else {
        this.$.edit.style.display = 'inline-block';
        this.$.nameLabel.innerHTML = this.material.replace(/.*--/, '');
      }



      // TODO: don't think this is the best place for this error checkError
      // but at least we are getting it on screen
      if( m.price === undefined ) {
        return this.showError({message: 'No price set for this material'});
      }

      this.$.priceLabel.innerHTML = m.price;
      this.$.unitLabel.innerHTML = FB.units.getLabel(m.units, true);
      //this.data.materials[material].price.toFixed(2)
    },

    showError : function(err) {
      if( !err ) {
        this.$.error.style.display = 'none';
        this.$.label.style.display = 'block';
        return;
      }

      this.$.error.style.display = 'block';
      this.$.label.style.display = 'none';
      this.$.error.innerHTML = err.message;

      if( err.code === 3 ) {
        var a = $('<a class="btn btn-link">Create</a>');
        a.on('click', function(){
          document.querySelector('budget-material-popup').create(err.name);
        });
        $(this.$.error).append(a);
      }
    },

    toggle : function() {
      this.showPrice = !this.showPrice;
      this.updatePrice();
    },

    updatePrice : function() {
      if( this.showPrice ) this.$.price.style.display = 'block';
      else this.$.price.style.display = 'none';
    }
  });
</script>
<dom-module id="budget-section-overview" assetpath="/public/elements/budget-components/sections/">
  <style>
    :host {
      display: block;
      padding-top: 25px;
    }
    .card {
      padding: 15px;
      margin: 15px;
      box-shadow: 0 0 8px #ccc;
    }
    @media(max-width: 768px) {
      .card {
        padding: 5px;
        margin: 5px 0px;
      }
    }
  </style>
  <template>

    <div class="row">
      <div class="col-md-6">

        <div class="card">
          <h4><i class="fa fa-info-circle"></i> Farm Information</h4>
          <table class="table">
            <tbody id="tbody">
              <tr>
                <td>Farm Size</td>
                <td><input type="number" class="form-control" id="sizeInput" on-input="onFarmSizeChange"></td>
              </tr>
            </tbody>
          </table>
        </div>

      </div>
      <div class="col-md-6">

        <div class="card">
          <h4 class="page-header" style="margin-top: 11px"><i class="fa fa-dollar"></i> Total</h4>
          <budget-total id="total"></budget-total>
        </div>

      </div>
    </div>

    <div class="card">
      <h4><i class="fa fa-calendar-o"></i> Operation Timeline</h4>
      <budget-timeline id="timeline"></budget-timeline>

      <h4><i class="fa fa-line-chart"></i> Spending Timeline</h4>
      <budget-spending-timeline id="spendingTimeline"></budget-spending-timeline>
    </div>

    <a class="btn btn-link" on-click="toggleDebug">Toggle Debug</a>
    <div class="card" id="debug" style="display:none">
      <h4>JSON (debug)</h4>
      <textarea id="json" class="form-control" style="height: 400px"></textarea>
    </div>
  </template>
</dom-module>

<script>
  Polymer({
    is : 'budget-section-overview',

    ready : function() {
      FB.operationController.on('total-update', this.setJsonDump.bind(this));
    },

    setData : function(data) {
      if( !data.farm ) return;

      this.$.total.setData(data.farm);

      for( var key in data.farm ) {
        if( key == 'size' ) {
          this.$.sizeInput.value = data.farm[key];
        } else {
          var row = $('<tr><td>'+key+'</td><td>'+data.farm[key]+'</td></tr>')[0];
          this.$.tbody.appendChild(row);
        }
      }
    },

    onFarmSizeChange : function() {
      this.$.total.farm.size = this.$.sizeInput.value;
      this.$.total.onTotalUpdate();
    },

    onShow : function(params) {
      this.$.timeline.onShow();
      this.$.spendingTimeline.onShow();

      if( params.length > 0 && params[0] === 'debug' ) {
        this.$.debug.style.display = 'block';
        this.setJsonDump();
      } else {
        this.$.debug.style.display = 'none';
      }
    },

    toggleDebug : function() {
      if( this.$.debug.style.display == 'block' ) {
        window.location = '#budget/overview';
      } else {
        window.location = '#budget/overview/debug';
      }
    },

    setJsonDump : function() {
      if( !window.appData ) return;

      // get latest data
      var arr = [];

      var materials = FB.materialController.get();

      for( var key in materials.materials ) arr.push(materials.materials[key]);
      for( var key in materials.complex ) arr.push(materials.complex[key]);

      appData.materials = arr;
      appData.operations = FB.operationController.get();

      this.$.json.innerHTML = JSON.stringify(appData, '', '  ');
    }
  });
</script>
<dom-module id="budget-section-operations" assetpath="/public/elements/budget-components/sections/">
  <template>

    <div class="modal fade" id="createPopup" tabindex="-1" role="dialog" aria-labelledby="createPopupLabel">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true"></span></button>
            <h4 class="modal-title" id="createPopupLabel">Create New Operation</h4>
          </div>
          <div class="modal-body">

            <div class="form-horizontal">
              <div class="form-group">
                <label for="filterInput" class="col-sm-2 control-label">Name</label>
                <div class="col-sm-10">
                  <input type="text" class="form-control" id="newNameInput" placeholder="New Operation Name" on-keyup="onNewNameKeyUp">
                  <div id="newNameMsg"></div>
                </div>
              </div>
            </div>

          </div>
          <div class="modal-footer" style="text-align: right">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" on-click="createNew">Create</button>
          </div>

        </div>
      </div>
    </div>

    <div style="text-align: center; padding: 25px 0 15px 0">
      <a class="btn btn-primary btn-lg" on-click="showCreate"><i class="fa fa-cogs"></i> Create New Operation</a>
    </div>

    <div class="row">
      <div class="col-md-10 col-md-offset-1">
        <div class="form-horizontal" style="margin: 25px 0">
          <div class="form-group">
            <label for="filterInput" class="col-sm-2 control-label">Filter</label>
            <div class="col-sm-10">
              <input type="text" class="form-control" id="filterInput" placeholder="Filter Text" on-input="filter">
            </div>
          </div>
        </div>

        <div id="searchMsg"></div>
        <div id="root"></div>
      </div>
    </div>
  </template>
</dom-module>

<script>
  Polymer({
    is : 'budget-section-operations',

    ready : function() {
      this.filterTimer = -1;

      this.popup = $(this.$.createPopup).remove();
      $('body').append(this.popup);
      this.popup.modal({show: false});

      FB.operationController.on('operation-update', this.onOperationsUpdated.bind(this));
      FB.operationController.on('operation-removed', function(e){
        $(this.$.root).find('[operation="'+e.operation.name+'"]').remove();
        this.filter();
      }.bind(this));
    },

    onOperationsUpdated : function(e) {

      if( e.replaced ) {

        var current = $(this.$.root).find('[operation="'+e.replaced +'"]');
        current.attr('operation', operation.name);
        /*var div = $(this.createPanel(e.operation));
        div.insertAfter(current);
        current.remove();*/

      } else {

        var current = $(this.$.root).find('[operation="'+e.operation.name+'"]');
        if( current.length == 0 ) {
          var div = $(this.createPanel(e.operation, e.isNew));
          $(this.$.root).append(div);
        } else {
          current[0].update();
        }
      }

      this.filter();
    },

    setData : function(data) {
      this.data = data;

      this.data.operations.forEach(function(operation){
        var ele = this.createPanel(operation);
        this.$.root.appendChild(ele);
      }.bind(this));

      this._filter();
    },

    createPanel : function(operation, open) {
      var ele = document.createElement('budget-operation');
      ele.setAttribute('operation', operation.name);
      ele.operationname = operation.name;
      if( open ) ele.toggleContent();
      return ele;
    },

    showCreate : function() {
      this.$.newNameInput.value = '';
      this.$.newNameMsg.innerHTML = '';
      this.popup.modal('show');
      setTimeout(function(){
        this.$.newNameInput.focus();
      }.bind(this), 500);
    },

    onShow : function(params) {
      if( params.length > 0 ) {
        this.$.filterInput.value = params[0];
      }

      this._filter();
    },

    onNewNameKeyUp : function(e) {
      if( e.which == 13 ) this.createNew();
    },

    createNew : function() {
      var name = this.$.newNameInput.value;

      if( name.replace(/\s/g, '') == '' ) {
        this.$.newNameMsg.innerHTML = 'Invalid Name.';
        return;
      }

      var op = FB.operationController.get(name);
      if( !op.error && this.operation.name !== this.$.nameInput.value ) {
        this.$.newNameMsg.innerHTML = 'Invalid Name. An operation with this name already exists';
        return;
      }
      this.$.newNameMsg.innerHTML = '';

      var op = {
        name : name,
        materials : [],
        schedule : [],
        units : '[acr_us]'
      };

      FB.operationController.add(op);
      this.$.filterInput.value = name;
      this.popup.modal('hide');
    },

    filter : function() {
      if( this.filterTimer != -1 ) clearTimeout(this.filterTimer);
      this.filterTimer = setTimeout(function(){
        this.filterTimer = -1;
        this._filter();
      }.bind(this));
    },

    _filter : function() {
      var txt = this.$.filterInput.value;

      var matched = [], showAll = false;
      if( txt == '' ) {
        showAll = true;
      } else {
        matched = this.toNameArray(FB.operationController.find(txt));
      }

      var opEles = this.querySelectorAll('budget-operation');
      for( var i = 0; i < opEles.length; i++ ) {
        var ele = opEles[i];
        if( showAll || matched.indexOf(ele.operationname) > -1 ) {
          ele.style.display = 'block';
        } else {
          ele.style.display = 'none';
        }
      }

      if( matched.length == 0 && !showAll ) {
        this.$.searchMsg.innerHTML = '<div class="alert alert-warning">No results found for: '+txt +
        '. <a style="cursor: pointer"><i class="fa fa-plus"></i> Create</a></div>';

        $(this.$.searchMsg)
          .find('a')
          .on('click', function() {
            this.showCreate();
            this.$.newNameInput.value = txt;
          }.bind(this));
      } else if( opEles.length == 0 ) {

        this.$.searchMsg.innerHTML = '<div class="alert alert-warning">Currently there are no operations. '+
        '<a style="cursor: pointer"><i class="fa fa-plus"></i> Create</a></div>';

        $(this.$.searchMsg)
          .find('a')
          .on('click', function() {
            this.showCreate();
          }.bind(this));

      } else {
        this.$.searchMsg.innerHTML = '';
      }

    },

    toNameArray : function(ops) {
      var arr = [];
      ops.forEach(function(op){
        arr.push(op.name);
      });
      return arr;
    }
  });
</script>
<dom-module id="budget-section-materials" assetpath="/public/elements/budget-components/sections/">
  <style>
    .card {
      padding: 15px;
      margin: 15px;
      box-shadow: 0 0 8px #ccc;
    }
    @media(max-width: 768px) {
      .card {
        padding: 5px;
        margin: 5px 0px;
      }
    }
  </style>

  <template>

    <div style="text-align: center; padding: 25px 0 15px 0">
      <a class="btn btn-primary btn-lg" on-click="showCreate"><i class="fa fa-cube"></i> Create New Material</a>
    </div>

    <div class="row">
      <div class="col-md-10 col-md-offset-1">

        <div class="form-horizontal" style="margin: 25px 0">
          <div class="form-group">
            <label for="filterInput" class="col-sm-2 control-label">Filter</label>
            <div class="col-sm-10">
              <input type="text" class="form-control" id="filterInput" placeholder="Filter Text" on-input="filter">

              <div class="checkbox">
                <label>
                  <input type="checkbox" id="thisBudgetInput" on-click="_filter"> Only materials used in this budget.
                </label>
              </div>

            </div>
          </div>
        </div>

        <div id="searchMsg"></div>
        <div id="root"></div>

      </div>
    </div>
  </template>
</dom-module>

<script>
  Polymer({
    is : 'budget-section-materials',

    ready : function() {
      this.filterTimer = -1;
      this.updateTimer = -1;
      FB.materialController.on('material-update', this.onMaterialsUpdated.bind(this));
      FB.materialController.on('material-removed', function(e){
        $(this.$.root).find('[material="'+e.material.name+'"]').remove();
        this.filter();
      }.bind(this));
    },

    attached : function() {
      this.popup = document.querySelector('budget-material-popup');
    },

    onMaterialsUpdated : function(e) {

      var all = FB.materialController.get();
      for( var key in all.materials ) {
        if( key === e.replaced || key === e.material.name ) {
          this.updateMaterialPanel(e.material.name, e.replaced);
          break;
        }
      }

      // now check all complex materials
      for( var key in all.complex ) {
        if( FB.materialController.contains(all.complex[key], e.material.name, e.replaced) ) {
          var replaced = null;
          if( key === e.replaced ) {
            replaced = e.replaced;
          }
          this.updateMaterialPanel(key, replaced);
        }
      }

      this.filter();
    },

    updateMaterialPanel : function(name, replaced) {
      var current = $(this.$.root).find('[material="'+(replaced || name)+'"]');
      var div = $(this.createTable(name));

      if( current.length == 0 ) {
        $(this.$.root).append(div);
      } else {
        div.insertAfter(current);
        current.remove();
      }
    },

    setData : function(data) {
      this.data = data;

      this.$.root.innerHTML = '';

      this.data.materials.forEach(function(material){
        var div = this.createTable(material);
        this.$.root.appendChild(div);
      }.bind(this));

      this._filter();
    },

    onShow : function(params) {
      if( params.length > 0 ) {
        this.$.filterInput.value = params.join('/');
      }

      this._filter();
    },

    showCreate : function() {
      this.popup.create();
    },

    filter : function() {
      if( this.filterTimer != -1 ) clearTimeout(this.filterTimer);
      this.filterTimer = setTimeout(function(){
        this.filterTimer = -1;
        this._filter();
      }.bind(this));
    },

    _filter : function() {
      var txt = this.$.filterInput.value;

      var matched = [], showAll = false;
      if( txt == '' && !$(this.$.thisBudgetInput).is(':checked') ) {
        showAll = true;
      } else {
        matched = this.toNameArray(FB.materialController.find(txt));
      }

      var opEles = this.querySelectorAll('[material]');
      for( var i = 0; i < opEles.length; i++ ) {
        var ele = opEles[i];
        if( showAll || matched.indexOf(ele.getAttribute('material')) > -1 ) {
          ele.style.display = 'block';
        } else {
          ele.style.display = 'none';
        }
      };

      if( matched.length == 0 && !showAll ) {
        this.$.searchMsg.innerHTML = '<div class="alert alert-warning">No results found for: '+txt +
        '. <a style="cursor: pointer"><i class="fa fa-plus"></i> Create</a></div>';

        $(this.$.searchMsg)
          .find('a')
          .on('click', function() {
            document.querySelector('budget-material-popup').create(txt);
          });
      } else {
        this.$.searchMsg.innerHTML = '';
      }

    },

    toNameArray : function(materials) {
      var arr = [], include;
      var thisBudget = $(this.$.thisBudgetInput).is(':checked');

      if( thisBudget ) {
        include = FB.utils.getActiveMaterials();
      }

      materials.forEach(function(material){
        if( thisBudget ) {
          if( include.indexOf(material.name) > -1 ) {
            arr.push(material.name);
          }
        } else {
          arr.push(material.name);
        }

      });
      return arr;
    },

    createTable : function(material) {
      if( typeof material === 'string' ) {
        material = FB.materialController.get(material);
        if( material.error ) return;
      }

      var html =
        '<div class="style-scope budget-section-materials card" material="'+material.name+'" material-table>'+
          '<h5 class="material-name">' +
            '<div class="layout horizontal center">'+
              '<div class="flex">'+
                (material.type == 'complex' ?
                  '<i class="fa fa-cubes"></i> ' :
                  '<i class="fa fa-cube"></i> '
                )+material.name+
              '</div>'+
              '<div>'+
                (material.fixed ? '<span class="label label-warning">Fixed</span>' : '<a class="btn btn-default btn-lg pull-right"><i class="fa fa-pencil"></i></a>') +
            '</div></div>'+
          '</h5>'+
          '<div>'+(material.description || '')+'</div>'+
          '<div style="overflow-x:auto">' +
            '<table class="table">' +
              '<tr><th>Class</th><th>Price</th><th>Units</th></tr>' +
              '<tr>' +
                '<td class="material-class">'+(material.type == 'complex' ? 'Complex Material' : material.class || 'other')+'</td>' +
                '<td class="material-price"><ahb-dollar-label value="'+(material.price || '0')+'"></ahb-dollar-label></td>' +
                //(material.type == 'complex' || material.fixed ?
                //  '<td class="material-price"><ahb-dollar-label value="'+(material.price || '0')+'"></ahb-dollar-label></td>' :
                //  '<td><input type="number" class="form-control material-price" value="'+(material.price || '0')+'" /></td>'
                //) +
                '<td>'+material.units+
                //  (material.fixed ?
                //    (material.units || '') :
                //    '<budget-unit-selector units="'+(material.units || '')+'" ></budget-unit-selector>'
                //  )+
                '</td>' +
              '</tr>' +
            '</table>' +
          '</div>' +
        '</div>';

      var row = $(html);

      row.find('.material-price').on('input', function(){
        this.updateFromEvent(row);
      }.bind(this));
      row.find('budget-unit-selector').on('units-change', function(){
        this.updateFromEvent(row);
      }.bind(this));
      row.find('.btn-lg').on('click', function(){
        document.querySelector('budget-material-popup').edit(material);
      });

      return row[0];
    },

    updateFromEvent : function(ele) {
      if( this.updateTimer != -1 ) clearTimeout(this.updateTimer);

      this.updateTimer = setTimeout(function(){
        this.updateTimer = -1;
        this._updateFromEvent(ele);
      }.bind(this), 300);
    },

    _updateFromEvent : function(ele) {
      var m = FB.materialController.get(ele.attr('material'));

      if( m.error ) {
        return console.log('Error updating material');
      }


      m.price = parseFloat(ele.find('.material-price').val());
      m.units = ele.find('budget-unit-selector')[0].getUnits();

      FB.materialController.add(m, {replace: true});
    }
  });
</script>
<dom-module id="budget-sections" assetpath="/public/elements/budget-components/sections/">
  <style>
    .section {
      display : none;
    }
    .nav > li {
      display: table-cell;
      width: 1%;
    }
    .nav > li > a {
      border-radius: 0;
    }
  </style>

  <template>
    <ul class="nav nav-tabs nav-justified" id="tabs">
      <li role="presentation" class="active" id="btn-overview">
        <a href="#budget/overview"><i class="fa fa-dashboard"></i> Overview</a>
      </li>
      <li role="presentation" id="btn-operations">
        <a href="#budget/operations"><i class="fa fa-cogs"></i> Operations</a>
      </li>
      <li role="presentation" id="btn-materials">
        <a href="#budget/materials"><i class="fa fa-cube"></i> Materials</a>
      </li>
    </ul>

    <budget-section-overview id="overview" class="section"></budget-section-overview>
    <budget-section-operations id="operations" class="section"></budget-section-operations>
    <budget-section-materials id="materials" class="section"></budget-section-materials>
  </template>
</dom-module>

<script>
  Polymer({
    is : 'budget-sections',

    ready : function() {
      $(window).on('hashchange', this.setSection.bind(this));
      this.setSection();
    },

    setSection : function() {
      var parts = window.location.hash.replace(/#/,'').split('/');

      // TODO: remove later
      if( parts.length == 1 && parts[0] == '' ) {
        window.location = '#budget/overview';
      }

      if( parts[0] != 'budget' ) return;

      $(this).find('.section').hide();
      $(this.$.tabs).find('li').removeClass('active');

      var section;
      if( this.$[parts[1]] ) {
        section = this.$[parts[1]];
        $(this.$.tabs).find('#btn-'+parts[1]).addClass('active');
      } else {
        section = this.$.overview;
        $(this.$.tabs).find('#btn-overview').addClass('active');
      }

      section.style.display = 'block';
      if( section.onShow ) section.onShow(parts.splice(2, parts.length-1));
    },

    setData : function(data) {
      var sections = this.querySelectorAll('.section');
      for( var i = 0; i < sections.length; i++ ) {
        if( sections[i].setData ) sections[i].setData(data);
      }
    }
  });
</script>
<dom-module id="ahb-budget" assetpath="/public/elements/budget-components/">
  <template>
    <budget-sections id="sections"></budget-sections>

    Change Example Budget: <select id="budgetSelect" on-change="updateExample"></select>
  </template>
</dom-module>

<script>
  Polymer({
    is : 'ahb-budget',

    properties : {
      example : {
        type : String
      }
    },

    attached : function() {
      var item = window.localStorage.getItem('budget-demo');
      if( item ) this.example = item;

      var html = '';
      for( var key in FB.examples.db ){
        html += '<option value="'+key+'" '+(this.example == key ? 'selected' : '')+'>'+key+'</option>';
      }
      for( var key in FB.examples.app ){
        html += '<option value="'+key+'" '+(this.example == key ? 'selected' : '')+'>'+key+'</option>';
      }
      this.$.budgetSelect.innerHTML = html;

      this.demo();
    },

    updateExample : function() {
      window.localStorage.setItem('budget-demo', this.$.budgetSelect.value);
      window.location.reload();
    },

    demo : function() {
      var appData;

      if( FB.examples.db[this.example] ) {
        appData = FB.transform(FB.examples.db[this.example]);
      } else if( FB.examples.app[this.example] ) {
        appData = FB.examples.app[this.example];
      } else {
        appData = {};
        alert('Unknown static budget: '+this.example);
        return;
      }

      window.appData = appData;

      var options = {
        noEvent : true,
        noRecalc : true
      }

      appData.materials.forEach(function(material){
        FB.materialController.add(material, options);
      });

      FB.materialController.recalc();

      FB.operationController.setFarmSize(appData.farm && appData.farm.size ? parseInt(appData.farm.size) : 1);
      appData.operations.forEach(function(operation){
        FB.operationController.add(operation, options);
      });

      FB.operationController.recalc();

      this.$.sections.setData(appData);
    }

  });
</script>
<dom-module id="budget-total" assetpath="/public/elements/budget-components/">
  <template>
    <h4 style="text-align:right">Duration: <span class="text text-primary" id="durationText"></span></h4>
    <h4 style="text-align:right">
      Crop Lifetime Total:
      <ahb-dollar-label id="totalLabel"></ahb-dollar-label> <small>Per Acre</small>
    </h4>
    <h4 style="text-align:right">
      Crop Lifetime Total:
      <ahb-dollar-label id="completeTotalLabel"></ahb-dollar-label> <small>Total</small>
    </h4>
    <h4 style="text-align:right">Average Monthly Cost: <ahb-dollar-label id="average"></ahb-dollar-label> <small>Per Acre</small></h4>
    <h4 style="text-align:right">Average Yearly Cost: <ahb-dollar-label id="averageYear"></ahb-dollar-label> <small>Per Acre</small></h4>
  </template>
</dom-module>

<script>
  Polymer({
    is : 'budget-total',

    attached : function() {
      FB.operationController.on('total-update', this.onTotalUpdate.bind(this));

      // make sure a total hasn't already been set
      var total = FB.operationController.getCurrentTotal();
      if( total !== null ) {
        this.onTotalUpdate(total);
      }
    },

    setData : function(farm) {
      this.farm = farm;
      this.onTotalUpdate();
    },

    onTotalUpdate : function(e) {
      if( e ) this.data = e;
      if( !this.data ) return;

      this.$.totalLabel.value = this.data.total / ((this.farm && this.farm.size) ? parseInt(this.farm.size) : 1);

      this.$.completeTotalLabel.value = this.data.total;

      if( this.data.range.start !== null && this.data.range.stop !== null ) {
        var months = this.data.spendingByMonth.length;

        this.$.durationText.innerHTML = months+' months <br /><small>('+this.toDateString(this.data.range.start)+' - '+this.toDateString(this.data.range.stop)+')</small>';

        this.$.average.value = this.data.total / months / ((this.farm && this.farm.size) ? parseInt(this.farm.size) : 1);

        var years = months / 12;
        if( years < 1 ) years = 1;
        this.$.averageYear.value = (this.data.total / years) / ((this.farm && this.farm.size) ? parseInt(this.farm.size) : 1);
      } else {
        this.$.durationText.innerHTML = 'Unknown';
      }
    },

    toDateString : function(d) {
      return (d.getMonth()+1)+'/'+(d.getYear()+1900);
    }
  })
</script>
<dom-module id="budget-timeline" assetpath="/public/elements/budget-components/">
  <style>
    :host {
      display : block;
    }
  </style>
  <template>
    <div id="chart" style="height: 450px"></div>
  </template>
</dom-module>

<script>
  Polymer({
    is : 'budget-timeline',

    attached : function() {
      $(window).on('resize', this.drawChart.bind(this));

      this.handlerSet = false;
      FB.operationController.on('total-update', this.drawChart.bind(this));

      // make sure a total hasn't already been set
      var total = FB.operationController.getCurrentTotal();
      if( total !== null ) {
        this.drawChart(total);
      }
    },

    onShow : function() {
      this.drawChart();
    },

    drawChart : function(e) {
      if( e && e.range ) this.data = e.range.all;

      if( !window.google && !this.handlerSet ) {
        googleChartLoadHandlers.push(this.drawChart.bind(this));
        this.handlerSet = true;
        return;
      }

      if( !this.data ) return;

      this.$.chart.innerHTML = '';

      var container = this.$.chart;
      var chart = new google.visualization.Timeline(container);
      var dataTable = new google.visualization.DataTable();

      dataTable.addColumn({ type: 'string', id: 'Operation' });
      dataTable.addColumn({ type: 'date', id: 'Start' });
      dataTable.addColumn({ type: 'date', id: 'End' });

      var arr = [];
      this.data.forEach(function(d){
        var end = new Date(d.date.getTime()+this.getIntervalTime(d));
        arr.push([d.name, d.date, end]);
      }.bind(this));

      if( arr.length == 0 ) {
        return this.showEmpty();
      }

      dataTable.addRows(arr);
      chart.draw(dataTable);

      google.visualization.events.addListener(chart, 'select', function(){
        try {
          window.location = '#budget/operations/'+arr[chart.getSelection()[0].row][0];
        } catch(e) {
          console.log(e);
        }
      });
    },

    showEmpty : function() {
      this.$.chart.innerHTML = '<i class="fa fa-warning"></i> No Data';
    },

    getIntervalTime : function(date) {
      var l = parseInt(date.length);
      if( date.units == 'year' ) {
        return l * 86400000 * 365;
      } else if( date.units == 'day' ) {
        return l * 86400000;
      } else {
        return l * 86400000 * 30;
      }
    }


  })
</script>
<dom-module id="budget-spending-timeline" assetpath="/public/elements/budget-components/">
  <style>
    :host {
      display : block;
    }
  </style>
  <template>
    <div id="chart" style="height: 450px"></div>

    <div class="horizontal layout">
      <div>
        <div class="btn-group" role="group">
          <button type="button" class="btn btn-primary" id="opBtn" on-click="byOperation">By Operation</button>
          <button type="button" class="btn btn-default" id="totalBtn" on-click="byTotal">Total</button>
          <button type="button" class="btn btn-default" id="cumulativeBtn" on-click="byCumlative">Cumulative</button>
        </div>
      </div>
      <div class="flex" id="selected" style="padding: 5px"></div>
    </div>
  </template>
</dom-module>

<script>
  Polymer({
    is : 'budget-spending-timeline',

    attached : function() {
      this.type = 'all';

      $(window).on('resize', this.drawChart.bind(this));

      this.handlerSet = false;
      FB.operationController.on('total-update', this.drawChart.bind(this));

      // make sure a total hasn't already been set
      var total = FB.operationController.getCurrentTotal();
      if( total !== null ) {
        this.drawChart(total);
      }
    },

    byOperation : function() {
      if( this.type == 'all' ) return;
      this.type = 'all';
      this.$.opBtn.className = 'btn btn-primary';
      this.$.totalBtn.className = 'btn btn-default';
      this.$.cumulativeBtn.className = 'btn btn-default';
      this.updateData();
      this.drawChart();
    },

    byTotal : function() {
      if( this.type == 'total' ) return;
      this.type = 'total';
      this.$.opBtn.className = 'btn btn-default';
      this.$.cumulativeBtn.className = 'btn btn-default';
      this.$.totalBtn.className = 'btn btn-primary';
      this.updateData();
      this.drawChart();
    },

    byCumlative : function() {
      if( this.type == 'cumulative' ) return;
      this.type = 'cumulative';
      this.$.opBtn.className = 'btn btn-default';
      this.$.cumulativeBtn.className = 'btn btn-primary';
      this.$.totalBtn.className = 'btn btn-default';
      this.updateData();
      this.drawChart();
    },

    onShow : function() {
      this.drawChart();
    },

    updateData  : function() {
      this.$.selected.innerHTML = '';

      var operations = FB.operationController.get();
      var header = ['Month'];

      if( this.type == 'all' ) {
        for( var i = 0; i < operations.length; i++ ) {
          header.push(operations[i].name);
        }
      } else if( this.type == 'cumulative' ) {
        header.push('cumulative');
      } else {
        header.push('total');
      }
      this.data = [header];

      var c = 0;

      for( var i = 0; i < this.months.length; i++ ) {
        var arr = [this.months[i].month];

        if( this.type == 'all' ) {
          for( var j = 0; j < operations.length; j++ ) {
            if( this.months[i][operations[j].name] ) {
              arr.push(parseFloat(this.months[i][operations[j].name].toFixed(2)));
            } else {
              arr.push(1);
            }
          }
        } else if( this.type == 'cumulative' ) {
          c += this.months[i].total || 0;
          arr.push(parseFloat(c.toFixed(2)));
        } else {
          arr.push(parseFloat(this.months[i].total.toFixed(2)) || 1);
        }

        this.data.push(arr);
      }
    },

    drawChart : function(e) {
      if( e && e.spendingByMonth ) {
        this.months = e.spendingByMonth;
        this.updateData();
      }

      if( !window.google && !this.handlerSet ) {
        googleChartLoadHandlers.push(this.drawChart.bind(this));
        this.handlerSet = true;
        return;
      }

      if( !this.data ) return;

      if( this.data.length == 1 ) {
        this.$.chart.innerHTML = '<i class="fa fa-warning"></i> No Data';
        this.chart = null;
        return;
      }


      if( !this.chart ) {
        this.$.chart.innerHTML = '';
        var container = this.$.chart;

        this.chart = new google.visualization.LineChart(container);
        google.visualization.events.addListener(this.chart, 'select', function(){
          var selection = chart.getSelection()[0];
          this.show(selection.row);
        }.bind(this));
      }

      var dataTable = google.visualization.arrayToDataTable(this.data);

      this.chart.draw(dataTable, {
        vAxis : {
          logScale : true
        },
        animation:{
          duration: 800,
          easing: 'out',
        },
      });


    },

    show : function(row) {
      var info = this.months[row];
      var html = '<div class="well"><h5>'+info.month+'</h5>';

      for( var key in info ) {
        if( key == 'month' ) continue;
        if( key == 'total' ) {
          html += '<div><b>'+key+': </b><ahb-dollar-label value="'+info[key]+'"></ahb-dollar-label></div>';
        } else {
          html += '<div><a href="#budget/operations/'+key+'">'+key+':</a> <ahb-dollar-label value="'+info[key]+'"></ahb-dollar-label></div>';
        }
      }

      this.$.selected.innerHTML = html+'</div>';
    }

  })
</script>
<dom-module id="budget-material-popup" assetpath="/public/elements/budget-components/">
  <template>
    <div class="modal fade" id="popup">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" aria-label="Close" on-click="cancel"><span aria-hidden="true"></span></button>
            <h4 class="modal-title" id="title"></h4>
          </div>
          <div class="modal-body">


            <div class="form-horizontal">

              <div id="parentMaterial"></div>
              <div class="form-group">
                <label for="nameInput" class="col-sm-3 control-label">Name</label>
                <div class="col-sm-9">
                  <input type="text" id="nameInput" class="form-control" on-input="onNameInput">
                  <div class="text text-danger" id="nameInputMessage"></div>
                </div>
              </div>

              <div class="form-group">
                <label for="nameInput" class="col-sm-3 control-label">Description</label>
                <div class="col-sm-9">
                  <textarea id="descriptionInput" class="form-control" on-input="onDescriptionInput"></textarea>
                </div>
              </div>

              <div class="form-group" id="classGroup">
                <label for="optionInput" class="col-sm-3 control-label">Class</label>
                <div class="col-sm-9">
                  <budget-class-selector id="classInput"></budget-class-selector>
                </div>
              </div>

              <div class="form-group" id="unitsGroup">
                <label for="unitsInput" class="col-sm-3 control-label">Units</label>
                <div class="col-sm-9">
                  <div class="layout horizontal center">
                    <div>us$/</div>
                    <div class="flex">
                      <budget-unit-selector id="unitsInput" on-units-change="editUnits" block=""></budget-unit-selector>
                    </div>
                  </div>

                  <div id="unitsInputMsg"></div>
                </div>
              </div>

              <div class="form-group" id="priceGroup">
                <label for="priceInput" class="col-sm-3 control-label" id="priceLabel">Price</label>
                <div class="col-sm-9">
                  <input type="number" id="priceInput" class="form-control" on-input="onPriceInput">
                  
                </div>
              </div>

              <div class="form-group" id="complexGroup">
                <label class="col-sm-3 control-label"><i class="fa fa-cubes"></i></label>
                <div class="col-sm-9">
                  <div class="checkbox">
                    <label>
                      <input type="checkbox" id="isComplexInput" on-click="toggleComplex"> Is complex material
                    </label>
                  </div>
                  <div class="help-block">This material requires other materials.</div>
                </div>
              </div>

            </div> 

            <div id="complexPanel" style="display:none" class="animated fadeIn">
              <h4>Required Materials</h4>

              <div class="form-horizontal" style="margin: 25px 0">
                <div class="form-group">
                  <label for="materialSearchInput" class="col-sm-3 control-label">Add Materials</label>
                  <div class="col-sm-9">
                    <budget-material-search on-material-select="onMaterialSelect"></budget-material-search>

                    <a style="cursor:pointer" on-click="toggleUnique"><i class="fa fa-plus"></i> Create Unique Material</a>


                    <div id="createUniquePanel" style="display:none">
                      <div class="help-block">Create a new required material that is unqiue (only used by) the
                        <span id="nameLabel"></span> material.</div>

                      <div class="form-horizontal">

                        <div class="form-group">
                          <label for="optionInput" class="col-sm-2 control-label">Class</label>
                          <div class="col-sm-10">
                            <budget-class-selector id="uniqueClassInput" on-change="onUniqueClassChange"></budget-class-selector>
                          </div>
                        </div>

                        <div class="form-group">
                          <label for="uniqueNameInput" class="col-sm-2 control-label">Name</label>
                          <div class="col-sm-10">
                            <input type="text" id="uniqueNameInput" class="form-control">
                          </div>
                        </div>

                        <div class="form-group" id="unitsGroup">
                          <label for="uniqueUnitsInput" class="col-sm-2 control-label">Units</label>
                          <div class="col-sm-10">
                            <div class="layout horizontal center">
                              <div>us$/</div>
                              <div class="flex">
                                <budget-unit-selector id="uniqueUnitsInput" block=""></budget-unit-selector>
                              </div>
                            </div>
                          </div>
                        </div>

                        <div class="form-group">
                          <label for="uniquePriceInput" class="col-sm-2 control-label">Price</label>
                          <div class="col-sm-10">
                            <input type="number" id="uniquePriceInput" class="form-control">
                          </div>
                        </div>

                        <div class="form-group" id="unitsGroup">
                          <label class="col-sm-3 control-label"></label>
                          <div class="col-sm-9">
                            <div id="createUniqueMsg" class="text text-danger"></div>
                            <a class="btn btn-primary" on-click="createUnique">Create</a>
                            <a class="btn btn-cancel" on-click="cancelCreateUnique">Cancel</a>
                          </div>
                        </div>
                      </div> 
                    </div> 

                  </div>
                </div>

              </div> 

              <budget-materials-table id="materialTable" on-price-change="onPriceChange" on-delete="onMaterialDelete"></budget-materials-table>

              <h4>Price <small><span id="current-price"></span> <span id="current-units"></span></small></h4>

            </div>

            <div class="horizontal layout center">
              <div class="flex">
                <a class="btn btn-link" on-click="delete"><i class="fa fa-trash"></i> Delete</a>
              </div>
              <div style="text-align:right">
                <a class="btn btn-primary" on-click="save">Save</a>
                <a class="btn btn-cancel" on-click="cancel">Cancel</a>
              </div>
            </div>


          </div> 
        </div>
      </div>
    </div>
  </template>


<script>
  Polymer({
    is : 'budget-material-popup',

    ready : function() {
      this.popup = $(this.$.popup).modal({show: false, backdrop: 'static'});

      this.materialTableOptions = {
        noNotes: true
      };

      $(window).on('hashchange', function(){
        if( !this.showing ) return;

        // when we manually hit the back button bellow this event will be
        // triped again.  you can ignore it.
        if( this.ignoreNextHashEvent ) {
          this.ignoreNextHashEvent = false;
          return;
        }

        if( confirm('Do you want to save and close?') ) {
          this.save();
        } else {
          this.ignoreNextHashEvent = true;
          window.history.back();
        }
      }.bind(this));
    },

    show : function() {
      this.showing = true;
      this.popup.modal('show');
    },

    hide : function() {
      this.showing = false;
      this.popup.modal('hide');
    },

    cancel : function() {
      // remove any unique materials as they were added to the material
      // controller so things didn't break
      if( this.data.type == 'complex' ) {
        for( var key in this.data.materials ) {
          if( key.match(/--/) ) {
            FB.materialController.remove(key);
          }
        }
      }

      // if we were creating
      if( this.action == 'create' ) {
        // not sure we need to do anything right now...

      // cancel an edit
      } else {
        var materials = []

        // reset any original unique materials
        for( var i = 0; i < this.originalUniqueMaterials.length; i++ ) {
          materials.push(this.originalUniqueMaterials[i]);
        }
        materials.push(this.originalData);

        FB.materialController.bulkAdd(materials, {replace: true});
      }

      this.hide();
    },

    edit : function(material, creatingUniqueName) {
      if( this.showing && this.data.name != material.name ) {
        if( confirm('Do you want to save your changes before editing new material?') ) {
          this.save(true);
        } else {
          return;
        }
      }

      this.action = 'edit';
      this.$.title.innerHTML = '<i class="fa fa-pencil"></i> Edit Material';

      this.data = material;

      // make a copy for if we cancel
      this.originalData = $.extend(true, {}, this.data);
      this.originalUniqueMaterials = [];

      if( this.data.name.match(/--/) ) {
        var parts = this.data.name.split('--');
        this.parentMaterial = parts[0];
        this.$.parentMaterial.innerHTML = '<h5 style="border-bottom: 1px solid #ccc; text-align:center">Parent: '+parts[0]+'</h5>';
        this.$.nameInput.value = parts[1];

        this.$.complexGroup.style.display = 'none';
      } else {
        this.$.complexGroup.style.display = 'block';
        this.$.parentMaterial.innerHTML = '';
        this.$.nameInput.value = this.data.name;
      }

      this.$.descriptionInput.value = this.data.description || '';
      this.$.unitsInputMsg.innerHTML = '';

      if( this.data.type == 'complex' ) {
        this.setComplex(true);
        this.$.unitsInput.setUnits(this.data.units);

        this.$.priceInput.value = '';

        // keep track of what we assume the amounts for this material are expecting
        this.materialUnits = this.data.units;

        // snapshot all definitions of unique materials
        for( var key in this.data.materials ) {
          if( key.match(/--/) ) {
            this.originalUniqueMaterials.push($.extend(true, {}, FB.materialController.get(key)));
          }
        }

      } else {
        this.$.unitsInput.setUnits(FB.units.invert(this.data.units));
        this.$.priceInput.value = this.data.price;
        this.setComplex(false);

        if( this.$.classInput.isClass(this.data.class || '') ) {
          this.$.classInput.setValue(this.data.class.toLowerCase());
        }
      }

      if( creatingUniqueName ) {
        this.$.uniqueNameInput.value = creatingUniqueName;
        $(this.$.createUniquePanel).show();
      }

      this.recalc();

      this.show();
    },

    create : function(name) {
      var root = '';
      if( name && name.indexOf('--') > -1 ) {
        root = name.split('--')[0];
      }


      if( this.showing && !(this.action == 'edit' && this.data.name == root) ) {
        if( confirm('Do you want to save your changes before creating new material?') ) {
          this.save(true);
        } else {
          return;
        }
      }

      // see if we actually are trying to create a unique child
      if( root ) {
        var parts = name.split('--');
        var m = FB.materialController.get(parts[0]);
        if( m.type == 'complex' ) {
          this.edit(m, parts[1]);
          return;
        }
      }

      this.data = {
        type : 'simple',
        name : name || '',
        units : '',
        description : '',
        price : 0
      };
      this.action = 'create';

      this.$.title.innerHTML = '<i class="fa fa-cube"></i> Create Material';
      this.$.complexGroup.style.display = 'block';

      this.$.nameInput.value = name || '';
      this.$.unitsInput.setUnits('');
      this.$.unitsInputMsg.innerHTML = '';
      this.$.priceInput.value = '';
      this.$.descriptionInput.value = '';
      this.$.classInput.setValue('other');
      this.setComplex(false);

      this.parentMaterial = null;
      this.$.parentMaterial.innerHTML = '';

      this.show();
    },

    onMaterialSelect : function(e) {
      var materialDef = e.detail;

      var materialImpl = {
        name : materialDef.name,
        amount : 1
      }

      if( materialDef.type == 'complex' ) {
        materialImpl.units = materialDef.units;
      } else {
        materialImpl.units = FB.units.invert(materialDef.units);
      }

      this.data.materials[materialImpl.name] = materialImpl;
      this.recalc();
    },


    setComplex : function(isComplex) {
      // regarless, dismiss the units exhange message
      this.$.unitsInputMsg.innerHTML = '';

      if( isComplex ) {
        this.$.isComplexInput.setAttribute('checked', 'checked');
        this.$.isComplexInput.checked = true;
        this.$.complexPanel.style.display = 'block';

        this.$.classGroup.style.display = 'none';


        this.$.priceGroup.style.display = 'none';

        this.$.materialTable.setMaterials(this.data, this.materialTableOptions);
        this.updatePriceLabel();
      } else {
        this.$.isComplexInput.removeAttribute('checked');
        this.$.isComplexInput.checked = false;
        this.$.complexPanel.style.display = 'none';

        this.$.priceGroup.style.display = 'block';
        this.$.classGroup.style.display = 'Block';
      }
    },

    save : function(noHide) {
      if( this.data.name == '' ) {
        this.$.nameInputMessage.innerHTML = 'A material name is required';
        return;
      } else if( this.data.name.indexOf('--') > -1 ) {
        this.$.nameInputMessage.innerHTML = '"--" is reserved and not allowed in the material name.';
        return;
      }
      this.$.nameInputMessage.innerHTML = '';

      if( this.data.type == 'simple' ) {
        this.data.class = this.$.classInput.getValue();
      }

      var options = {};
      if( this.action == 'edit' ) {
        options.replace = true;

        // if the name has changed, make sure we preform a rename
        if( this.originalData.name != this.data.name ) {
          options.rename = this.originalData.name;
        }
      }

      var result = FB.materialController.add(this.data, options);

      if( result.error ) {
        return alert(result.message);
      }

      // now re-save all required materials, this time we will fire events
      var materials = [];
      if( this.data.type == 'complex' ) {
        for( var key in this.data.materials ) {
          var m = FB.materialController.get(key);
          if( !m.error ) {
            materials.push(m);
          }
        }
      }
      FB.materialController.bulkAdd(materials, {replace: true});

      if( typeof noHide !== 'boolean' || !noHide ) this.hide();
    },

    delete : function() {
      if( !confirm('Are you sure you want to delete this material?') ) return;

      var usedBy = {
        operations : [],
        materials : []
      };

      var operations = FB.operationController.get();
      for( var i = 0; i < operations.length; i++ ) {
        if( !operations[i].materials ) continue;
        if( operations[i].materials[this.data.name] ) {
          usedBy.operations.push(operations[i]);
        }
      }

      var materials = FB.materialController.get().complex;
      for( var key in materials ) {
        if( !materials[key].materials ) continue;
        if( materials[key].materials[this.data.name] ) {
          usedBy.materials.push(materials[key]);
        }
      }

      if( usedBy.operations.length > 0 || usedBy.materials.length > 0 ) {
        if( !confirm('This material is used by '+usedBy.operations.length+' operation(s) and '+usedBy.materials.length+' material(s).  '+
              'Are you still sure you want to delete?  It will be removed from these operations and materials.') ) {
          return;
        }
      }

      // remove from all operations
      var updates = usedBy.operations;
      for( var i = 0; i < usedBy.operations.length; i++ ) {
        delete usedBy.operations[i].materials[this.data.name];
      }
      FB.operationController.bulkAdd(updates, {replace: true});

      // remove from all materials
      updates = usedBy.materials;
      for( var i = 0; i < usedBy.materials.length; i++ ) {
        delete usedBy.materials[i].materials[this.data.name];
      }

      // remove this item
      FB.materialController.remove(this.data.name);

      // if this is complex and has unique materials, remove those as well
      if( this.data.type == 'complex' ) {
        for( var key in this.data.materials ) {
          if( key.match(/--/) ) {
            FB.materialController.remove(key);
          }
        }
      }

      FB.materialController.bulkAdd(updates, {replace: true});

      this.hide();
    },

    /**
     * Start fired by the material table
     */
    onPriceChange : function() {
      FB.materialController.materialRecalc(this.data);

      // do not call recalc, will update material table
      this.updatePriceLabel();
    },

    onMaterialDelete : function(e) {
      this.updatePriceLabel();
    },
    /**
     * End fired by the material table
     */

    /**
     * Start main input control Fn's
     */
    onNameInput : function() {
      var newName = this.$.nameInput.value;

      if( this.parentMaterial ) {
        newName = this.parentMaterial+'--'+newName;
      }

      if( this.data.name == newName || newName == '' ) return;

      var m = FB.materialController.get(newName);
      if( !m.error ) {
        this.$.nameInputMessage.innerHTML = 'A material with this name already exists';
        return;
      }
      this.$.nameInputMessage.innerHTML = '';

      this.$.nameLabel.innerHTML = newName;
      this.data.name = newName;

      // if complex, we need to update the name of all unique materials
      if( this.data.type == 'complex' ) {
        var updated = [];

        for( var key in this.data.materials ) {

          // only want to update unique stuff
          if( key.indexOf('--') > -1 ) {
            // first lets update impl
            var m = this.data.materials[key];
            delete this.data.materials[key];
            var newName = this.data.name+'--'+m.name.replace(/.*--/, '');
            m.name = newName;
            updated.push(m);

            // now update def
            m = FB.materialController.get(key);
            if( m.error ) {
              console.log('BADNESS!');
              continue;
            }
            m.name = newName;

            FB.materialController.add(m, {
              rename: key,
              noRecalc : true,
              noEvent : true
            });

          }
        }

        for( var i = 0; i < updated.length; i++ ) {
          this.data.materials[updated[i].name] = updated[i];
        }

        this.$.materialTable.setMaterials(this.data, this.materialTableOptions);
      }
    },

    onDescriptionInput : function() {
      this.data.description = this.$.descriptionInput.value;
    },

    recalc : function() {
      FB.materialController.materialRecalc(this.data);

      if( this.data.type == 'complex' ) {
        this.$.materialTable.setMaterials(this.data, this.materialTableOptions);
        this.updatePriceLabel();
      }
    },

    updatePriceLabel : function() {
      this.$['current-price'].innerHTML = '$'+this.data.price.toFixed(2);

      var label = FB.units.getLabel(this.data.units);
      if( label != '' ) label = 'per '+label;
      this.$['current-units'].innerHTML = label;
    },

    onPriceInput : function() {
      var val = this.$.priceInput.value;

      /* BASEPRICE
      if( val == '' && this.data.type == 'complex' ) {
        FB.materialController.remove(this.getBasePriceName());
        delete this.data.materials[this.getBasePriceName()];
        this.recalc();
        return;
      } */

      var val = parseFloat(val);
      if( isNaN(val) ) return;

      this.data.price = val;

      this.recalc();
    },

    toggleComplex : function() {
      if( !this.data ) return;

      if( this.data.materials ) {
        var keys = Object.keys(this.data.materials).length;

        // BASEPRICE
        // var hasBase = this.data.materials[this.getBasePriceName()];
        // if( keys === 0 || (keys === 1 && hasBase) ){
        if( keys === 0 ){
          delete this.data.materials;
          delete this.data.class;
          this.data.type = 'simple';

          if( this.data.units ) {
            this.data.units = FB.units.invert(this.data.units);
          }

          this.setComplex(false);

        } else if ( confirm('Are your sure you want to make this a simple material?  All required '+
              'materials will be removed') ) {

          delete this.data.materials;
          delete this.data.class;
          this.data.type = 'simple';
          if( this.data.units ) {
            this.data.units = FB.units.invert(this.data.units);
          }

          this.setComplex(false);
        } else {
          this.setComplex(true);
        }

      } else {
        this.data.type = 'complex';
        this.data.materials = {};

        if( this.data.units ) {
          this.data.units = FB.units.invert(this.data.units);
        }

        // as there a simple price set?  make it the base price material
        if( this.data.price !== undefined ) {
          var price = parseFloat(this.$.priceInput.value);

          if( !isNaN(price) ) {

            this.data.materials.Estimate = {
              amount : price,
              units : 'us$'
            }

            this.recalc();
          }
        }


        this.setComplex(true);
      }
    },

    editUnits : function(e) {
      if( this.editUnitsTimer != -1 ) clearTimeout(this.editUnitsTimer);
      this.editUnitsTimer = setTimeout(function(){
        this.editUnitsTimer = -1;
        this._editUnits(e);
      }.bind(this), 200);
    },

    _editUnits : function(e) {
      if( e.detail.error ) return;

      if( this.data.type == 'complex' ) {
        //var oldUnits = this.data.units;
        var newUnits = e.detail.value;

        this.handleAmountUnitChange(newUnits)

        this.data.units = newUnits;
      } else {
        this.$.unitsInputMsg.innerHTML = '';
        this.data.units = FB.units.invert(e.detail.value);
      }

      this.recalc();
    },

    handleAmountUnitChange : function(newUnits) {
      if( !this.materialUnits || this.materialUnits == newUnits || Object.keys(this.data.materials).length == 0 ) {
        this.$.unitsInputMsg.innerHTML = '';
        return;
      }

      // prompt for update of child material amounts
      var prompt = $(
        '<div class="alert alert-dismissable alert-warning" style="margin-top: 5px">'+
          '<button type="button" class="close"></button>'+
          '<h4>Question!</h4>'+
          '<p>You have updated your materials units from <b>'+this.materialUnits+'</b> to <b>'+newUnits+'</b>. '+
          'You should probably convert the amounts of each required material to match the unit change.</p>'+
          '<div class="layout horizontal" style="margin-top: 5px">'+
            '<div class="flex">'+
              '<button class="btn btn-default" convert>Convert '+this.materialUnits+'<i class="fa fa-long-arrow-right"></i>'+newUnits+'</button>'+
            '</div><div>'+
              '<button class="btn btn-warning" close>Ignore</button>'+
            '</div>'+
          '</div>'+
        '</div>'
      );
      $(this.$.unitsInputMsg).html('').append(prompt);

      prompt
        .find('[convert]')
        .on('click', function(){
          var error = this.$.materialTable.updateAmountFromUnits(this.materialUnits, newUnits);
          if( error ) {
            return alert(error.message);
          }

          this.materialUnits = newUnits;
          this.$.unitsInputMsg.innerHTML = '';
          this.recalc();
        }.bind(this));

      prompt
        .find('.close, [close]')
        .on('click', function(){
          this.materialUnits = newUnits;
          this.$.unitsInputMsg.innerHTML = '';
          this.recalc();
        }.bind(this));
    },


    /**
     * End main input control Fn's
     */


    /**
     * Start Create Unique Fn's
     */
    createUnique : function() {
      var data = {
        class : this.$.uniqueClassInput.getValue(),
        name : this.$.uniqueNameInput.value,
        units : this.$.uniqueUnitsInput.getUnits(),
        price : parseFloat(this.$.uniquePriceInput.value)
      }

      if( data.name == '' ) {
        this.$.createUniqueMsg.innerHTML = 'You must provide a material name';
        return;
      } else if( isNaN(data.price) ) {
        this.$.createUniqueMsg.innerHTML = 'Invalid price';
        return;
      } else if( this.$.uniqueUnitsInput.error ) {
        this.$.createUniqueMsg.innerHTML = 'You must provide valid units';
        return;
      }

      // we are almost good to go
      // update name
      data.name = this.data.name+'--'+data.name;
      data.units = 'us$/'+data.units;

      // add to global controller, make sure no issues
      var resp = FB.materialController.add(data, {
        replace : true,
        noRecalc : true,
        noEvent : true
      });
      if( resp.error ) {
        this.$.createUniqueMsg.innerHTML = resp.message;
        return;
      }

      // do we need to add a simple impl?
      if( !this.data.materials[data.name] ) {
        var impl = {
          name : data.name,
          amount : 1,
          units : FB.units.invert(data.units)
        }
        this.data.materials[impl.name] = impl;
      }


      this.recalc();

      // this just resets and hides
      this.cancelCreateUnique();
    },

    onUniqueClassChange : function() {
      if( this.$.uniqueNameInput.value == '' || this.$.uniqueClassInput.isClass(this.$.uniqueNameInput.value) ) {
        this.$.uniqueNameInput.value = this.$.uniqueClassInput.getValue();
      }
    },

    cancelCreateUnique : function() {
      this.$.uniqueNameInput.value = '';
      this.$.uniqueUnitsInput.units = '';
      this.$.uniquePriceInput.value = '';
      this.$.createUniqueMsg.innerHTML = '';

      this.toggleUnique();
    },

    toggleUnique : function() {
      $(this.$.createUniquePanel).toggle();
    },
    /**
     * End Create Unique Fn's
     */
  })
</script>
</dom-module><dom-module id="budget-material-search" assetpath="/public/elements/budget-components/">
  <style>
    :host {
      display: block;
    }
    #results {
       display: none;
       z-index: 2000;
       position: absolute;
       background-color: white;
       padding: 10px;
       border: 1px solid #ccc;
    }
    .result-card:hover {
      color: #2196f3;
    }
    .result-card:hover h5 {
      color: #2196f3;
    }
    .result-card:hover {
      background-color: #f8f8f8;
    }
    .result-card {
        cursor: pointer;
        padding: 0 10px;
    }

  </style>
  <template>

    <input id="input" class="form-control" on-keyup="search" on-blur="onBlur" on-focus="showResults" placeholder="Search material by name">

    <div id="results" on-click="onResultsClick"></div>
  </template>
</dom-module>

<script>
  Polymer({
    is : 'budget-material-search',

    ready : function() {
      this.blurTimer = -1;
      this.ignore = [];
    },

    setIgnoreList : function(ignore) {
      this.ignore = ignore;
    },

    search : function() {
      var results = FB.materialController.find(this.$.input.value);

      this.cleanResults(results);

      if( results.length > 0 ) {
        var html = '';

        for( var i = 0; i < results.length; i++ ) {
          html +=
            '<div index="'+i+'" class="style-scope budget-material-search result-card" style="'+( i < results.length - 1 ? 'border-bottom: 1px solid #ccc' : '')+'">'+
              '<h5>'+
                '<i class="fa fa-'+(results[i].type == 'complex' ? 'cubes' : 'cube')+'"></i> '+
                  results[i].name +
                  (results[i].class ? ' <small>'+results[i].class+'</small>' : '') +
              '</h5>'+
              '<div class="help-block">' +
                '<ahb-dollar-label value="'+results[i].price+'"></ahb-dollar-label> '+
                this.getUnitsLabel(results[i]) +
              '</div>'+
            '</div>';
        }

        $(this.$.results)
          .html(html)
          .find('.result-card')
          .on('click', function(e){
            this.onResultsClick();
            this.fireSelect(e, results);
            this.hideResults();
          }.bind(this));

      } else {
        $(this.$.results).html('No matches found');
      }
    },

    getUnitsLabel : function(material) {
      var l = '';
      if( material.type === 'complex' ) {
        l = material.units;
      } else {
        l = FB.units.invert(material.units);
      }
      l = FB.units.math.cleanDollars(l);
      if( l == '1' ) return '';
      return 'per '+l;
    },

    fireSelect : function(e, results) {
      var ele = $(e.currentTarget);
      var index = parseInt($(e.currentTarget).attr('index'));
      var material = results[index];

      setTimeout(function(){
        $(this.$.input).val('').blur();
      }.bind(this), 400);

      this.fire('material-select', material);
    },

    showResults : function() {
      this.search();
      this.$.results.style.display = 'block';
    },

    onBlur : function() {
      this.cancelBlur();

      this.blurTimer = setTimeout(function(){
        this.blurTimer = -1;
        this.hideResults();
      }.bind(this), 200);
    },

    cancelBlur : function() {
      if( this.blurTimer == -1 ) return;

      clearTimeout(this.blurTimer);
      this.blurTimer = -1;
    },

    onResultsClick : function() {
      this.cancelBlur();
      this.$.input.focus();
    },

    hideResults : function() {
      this.$.results.style.display = 'none';
    },

    cleanResults : function(results) {
      for( var i = results.length-1; i >= 0; i-- ) {
        if( this.ignore.indexOf(results[i].name) > -1 ) {
          results.splice(i, 1);
        } else if ( results[i].name.match(/^.*--/) ) {
          results.splice(i, 1);
        }
      }
    }

  });
</script>
<dom-module id="budget-class-selector" assetpath="/public/elements/budget-components/">
  <style>
    :host {
      display: block;
    }
  </style>
  <template>
    <select id="input" class="form-control">
      <option value="other">Other</option>
      <option value="equipment">Equipment</option>
      <option value="fertilizer">Fertilizer</option>
      <option value="herbicide">Herbicide</option>
      <option value="insurance">Insurance</option>
      <option value="labor">Labor</option>
      <option value="pesticide">Pesticide</option>
      <option value="processing">Processing</option>
      <option value="seed">Seed</option>
      <option value="water">Water</option>
    </select>
  </template>
</dom-module>

<script>
  Polymer({
    is : 'budget-class-selector',

    properties : {
      value : {
        type : 'String',
        observer : 'valueObserver',
        value : 'other'
      }
    },

    ready : function() {
      this.list = [];
      var options = this.querySelectorAll('option');
      for( var i = 0; i < options.length; i++ ) {
        this.list.push(options[i].getAttribute('value'));
      }
    },

    isClass : function(txt) {
      if( this.list.indexOf(txt.toLowerCase()) > -1 ) {
        return true;
      }
      return false;
    },

    valueObserver : function() {
      this.setValue();
    },

    setValue : function(value) {
      if( value ) this.value = value;
      this.$.input.value = this.value;
    },

    getValue : function() {
      return this.$.input.value;
    }

  })
</script>
</div></body></html>